<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Mybatisæ‰‹æ’¸ï¼ˆäºŒï¼‰åˆ›å»ºç®€å•çš„æ˜ å°„å™¨ä»£ç†å·¥å‚</title>
      <link href="/2022/04/11/hand-mybatis-2/"/>
      <url>/2022/04/11/hand-mybatis-2/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h3 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h3><p>æˆ‘ä»¬åœ¨ä½¿ç”¨Mybatisçš„æ—¶å€™ï¼Œéƒ½ä¼šæœ‰è¿™æ ·å­çš„ä¸€ä¸ªç–‘é—®ï¼šâ€œ<strong>ä¸ºä»€ä¹ˆMybatisåªéœ€å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œä¸ç”¨å†™å®ç°ç±»å°±èƒ½ä½¿ç”¨XMLä¸­æˆ–è€…æ³¨è§£ä¸­çš„SQLè¯­å¥å®Œæˆå¯¹æ•°æ®åº“çš„CRUDå‘¢ï¼Ÿ</strong>â€ã€‚çœ‹è¿‡Mybatisæºç ä¹‹åæ‰çŸ¥é“åŸæ¥Mybatisä½¿ç”¨äº†<code>Mapper</code>æ¥å£ä»£ç†ç±»ï¼ŒæŠŠæ‰€æœ‰çš„æ•°æ®åº“æ“ä½œéƒ½äº¤ç»™äº†ä»£ç†ç±»å¤„ç†ã€‚</p><h3 id="äºŒã€Bindingæ¨¡å—"><a href="#äºŒã€Bindingæ¨¡å—" class="headerlink" title="äºŒã€Bindingæ¨¡å—"></a>äºŒã€Bindingæ¨¡å—</h3><p>è¿™ä¸ª<code>Mapper</code>æ¥å£ä»£ç†ç±»åœ¨<strong>Bindingæ¨¡å—</strong>ï¼Œæ ¸å¿ƒç±»æ˜¯<code>org.apache.ibatis.binding.MapperProxy</code>ã€‚<code>Binding</code>æ¨¡å—æ ¸å¿ƒç±»å¦‚ä¸‹ï¼š</p><ul><li><code>org.apach.ibatis.binding.MapperRegistry</code>ï¼š<code>Mapper</code>æ¥å£æ³¨å†Œç±»ï¼Œç®¡ç†<code>Mapper</code>æ¥å£ç±»å‹å’Œå…¶ä»£ç†åˆ›å»ºå·¥ä½œçš„æ˜ å°„ï¼Œæˆ‘ä»¬åœ¨å¼€å‘ä¸­åˆ›å»ºçš„<code>Mapper</code>æ¥å£ç±»éƒ½ä¼šæ³¨å†Œåˆ°è¿™é‡Œè¿›è¡Œç®¡ç†ã€‚</li><li><code>org.apach.ibatis.binding.MapperProxyFactory</code>ï¼š<code>Mapper</code>æ¥å£ä»£ç†ç±»åˆ›å»ºå·¥å‚ç±»ã€‚</li><li><code>org.apach.ibatis.binding.MapperProxy</code>ï¼š<code>Mapper</code>æ¥å£ä»£ç†ç±»ï¼Œå°è£…äº†<code>SqlSession</code>ç›¸å…³æ“ä½œï¼Œè¿™ä¸ªæˆ‘ä»¬åç»­ä¼šå­¦ä¹ åˆ°ï¼Œæ˜¯ä¸€ä¸ª<code>SQL</code>æ‰§è¡Œã€‚</li><li><code>org.apach.ibatis.binding.MapperMethod</code>ï¼šå°è£…<code>Mapper</code>æ¥å£å¯¹åº”çš„æ–¹æ³•å’Œ<code>SQL</code>æ‰§è¡Œä¿¡æ¯ï¼Œè¿™ä¸ªå°±æ˜¯æˆ‘ä»¬å‘å¼€ä¸­åˆ›å»ºçš„<code>Mapper</code>æ¥å£ç±»æ¯ä¸ªæ–¹æ³•å¯¹åº”<code>XML</code>é…ç½®çš„<code>SQL</code>è¯­å¥ã€‚</li></ul><p>æµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://qtspace.cn/contentimg/47.jpg"></p><h3 id="ä¸‰ã€è®¾è®¡"><a href="#ä¸‰ã€è®¾è®¡" class="headerlink" title="ä¸‰ã€è®¾è®¡"></a>ä¸‰ã€è®¾è®¡</h3><p>é€šå¸¸å¦‚æœèƒ½æ‰¾åˆ°å¤§å®¶æ‰€åšäº‹æƒ…çš„å…±æ€§å†…å®¹ï¼Œå…·æœ‰ç»Ÿä¸€çš„æµç¨‹å¤„ç†ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯å¯ä»¥è¢«å‡èšå’Œæç‚¼çš„ï¼Œå°è£…æˆé€šç”¨çš„ç»„ä»¶æˆ–è€…æœåŠ¡ï¼Œè¢«æ‰€æœ‰äººå…±ç”¨å‡å°‘é‡å¤çš„æ— ç”¨åŠŸã€‚</p><p>å‚è€ƒæˆ‘ä»¬æœ€å¼€ä½¿ç”¨çš„<code>JDBC</code>çš„æ–¹æ³•ï¼Œä»è·å–æ•°æ®åº“è¿æ¥ã€æŸ¥è¯¢ã€å°è£…ç»“æœé›†ã€è¿”å›ç»“æœé›†ï¼Œè¿™äº›æ­¥éª¤éƒ½æ˜¯ä¸€ä¸ªå›ºå®šçš„æµç¨‹ï¼Œé‚£ä¹ˆè¿™ä¸ªæµç¨‹æˆ‘ä»¬æ˜¯å¯ä»¥å°è£…æˆä¸€ä¸ªé€šç”¨ç»„ä»¶æˆ–è€…æœåŠ¡çš„ã€‚</p><p>å½“æˆ‘ä»¬æ¥è®¾è®¡ä¸€ä¸ª<code>ORM</code>æ¡†æ¶çš„è¿‡ç¨‹ä¸­ï¼Œé¦–å…ˆè¦è€ƒè™‘æ€ä¹ˆæŠŠç”¨æˆ·å®šä¹‰çš„æ•°æ®åº“æ“ä½œæ¥å£ã€<code>XML</code>é…ç½®çš„<code>SQL</code>è¯­å¥ã€æ•°æ®åº“ä¸‰è€…è”ç³»èµ·æ¥ã€‚å…¶å®æœ€åˆé€‚çš„æ“ä½œå°±æ˜¯ä¼šç”¨ä»£ç†çš„æ–¹æ³•è¿›è¡Œå¤„ç†ï¼Œå› ä¸ºä»£ç†å¯ä»¥å°è£…ä¸€ä¸ªå¤æ‚çš„æµç¨‹ä¸ºæ¥å£å¯¹è±¡çš„å®ç°ç±»ï¼Œè®¾è®¡å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://qtspace.cn/contentimg/48.jpg"></p><ul><li>é¦–å…ˆæä¾›ä¸€ä¸ª<code>Mappper</code>æ¥å£ä»£ç†ç±»<code>MapperPoxy</code>ï¼Œé€šè¿‡ä»£ç†ç±»åŒ…è£…å¯¹æ•°æ®çš„æ“ä½œï¼Œç›®å‰æˆ‘ä»¬æœ¬ç« èŠ‚ä¼šå…ˆæä¾›ä¸€ä¸ªç®€å•çš„åŒ…è£…ï¼Œæ¨¡æ‹Ÿå¯¹æ•°æ®åº“çš„è°ƒç”¨ã€‚</li><li>ç„¶åä¸º<code>Mapper</code>æ¥å£ä»£ç†ç±»æä¾›ä¸€ä¸ªç®€å•å·¥å‚ç±»<code>MapperProxyFactory</code>è°ƒç”¨<code>instance</code>æ–¹æ³•ä¸ºæ¯ä¸ª<code>Mapper</code>æ¥å£æˆä¸ºä»£ç†ç±»ã€‚</li></ul><h3 id="å››ã€å®ç°"><a href="#å››ã€å®ç°" class="headerlink" title="å››ã€å®ç°"></a>å››ã€å®ç°</h3><p>åœ¨å®ç°ä¹‹å‰ï¼Œå…ˆå¯¹ä»£ç†çŸ¥è¯†è¿›è¡Œäº†ä¸€ä¸ªå­¦ä¹ ï¼Œæˆ‘ä»¬ä½¿ç”¨åˆ°çš„æ˜¯åŠ¨æ€ä»£ç†æ¨¡å¼ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå°<code>demo</code>å¯¹åŠ¨æ€ä»£ç†æ¨¡å¼è¿›è¡Œå­¦ä¹ ï¼Œè¿˜æœ‰å¦å¤–ä¸¤ç§ä»£ç†æ¨¡å¼ï¼šé™æ€ä»£ç†ã€<code>Cglib</code>ä»£ç†ã€‚</p><h4 id="åŠ¨æ€ä»£ç†"><a href="#åŠ¨æ€ä»£ç†" class="headerlink" title="åŠ¨æ€ä»£ç†"></a>åŠ¨æ€ä»£ç†</h4><p>åŠ¨æ€ä»£ç†å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p><ul><li><p>åŠ¨æ€ä»£ç†å¯¹è±¡ä¸éœ€è¦å®ç°æ¥å£ï¼Œåªæœ‰ç›®æ ‡å¯¹è±¡éœ€è¦å®ç°æ¥å£ã€‚</p></li><li><p>å®ç°åŸºäºæ¥å£çš„åŠ¨æ€ä»£ç†éœ€è¦åˆ©ç”¨<code>JDK</code>ä¸­çš„<code>API</code>ï¼Œåœ¨<code>JVM</code>å†…å­˜ä¸­åŠ¨æ€çš„æ„å»º<code>Proxy</code>ï¼Œæ˜¯è¿è¡ŒæœŸç”Ÿæ•ˆã€‚</p></li><li><p>éœ€è¦ä½¿ç”¨<code>java.lang.reflect.Proxy</code>å’Œå…¶<code>newProxyInstance()</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è¦ä¼ å…¥ä¸‰ä¸ªå‚æ•°ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CallerSensitive</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">newProxyInstance</span><span class="params">(ClassLoader loader,</span></span><br><span class="line"><span class="params">                                      Class&lt;?&gt;[] interfaces,</span></span><br><span class="line"><span class="params">                                      InvocationHandler h)</span></span><br><span class="line">    <span class="keyword">throws</span> IllegalArgumentException&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>ClassLoader loader</code>ï¼šæŒ‡å®šå½“å‰ç›®æ ‡å¯¹è±¡ä½¿ç”¨çš„ç±»åŠ è½½ï¼Œè·å–åŠ è½½å™¨çš„æ–¹æ³•æ˜¯<code>getClassLoader()</code>ã€‚</li><li><code>interfaces</code>ï¼šç›®æ ‡å¯¹è±¡å®ç°æ¥å£çš„ç±»å‹ï¼Œä½¿ç”¨æ³›å‹æ–¹å¼ç¡®è®¤ç±»å‹ã€‚</li><li><code>InvocationHandler h</code>ï¼šäº‹ä»¶å¤„ç†ï¼Œæ‰§è¡Œç›®æ ‡æ–¹æ³•å¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œä¼šè§¦å‘äº‹ä»¶å¤„ç†å™¨çš„æ–¹æ³•ï¼Œä¼šæŠŠå½“å‰æ‰§è¡Œç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚</li></ul></li></ul><p>æˆ‘ä»¬é€šè¿‡å…·ä½“çš„å®ç°å¯¹åŠ¨æ€ä»£ç†è¿›è¡Œä¸€ä¸ªæ“ä½œï¼Œç±»ç»“æ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://qtspace.cn/contentimg/49.jpg"></p><p>ä»£ç å®ç°ï¼š</p><p><code>Mapper</code>æ¥å£ä»£ç†ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MapperProxy</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span>, Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">6424540398559729838L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; sqlSession;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;T&gt; mapperInterface;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MapperProxy</span><span class="params">(Map&lt;String, String&gt; sqlSession, Class&lt;T&gt; mapperInterface)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sqlSession = sqlSession;</span><br><span class="line">        <span class="built_in">this</span>.mapperInterface = mapperInterface;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">if</span> (Object.class.equals(method.getDeclaringClass())) &#123;</span><br><span class="line">            <span class="comment">//Objectä¸­çš„æ–¹æ³•ï¼Œç›´æ¥æ‰§è¡Œ</span></span><br><span class="line">            <span class="keyword">return</span> method.invoke(<span class="built_in">this</span>, args);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;ç±»&quot;</span> + mapperInterface.getName() + <span class="string">&quot;è¢«ä»£ç†äº†, æ‰§è¡Œäº†æ–¹æ³•ï¼š&quot;</span> + method.getName() +</span><br><span class="line">                    <span class="string">&quot; ,sqlSessionä¸ºï¼š&quot;</span> + sqlSession;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Mapper</code>æ¥å£ä»£ç†ç±»åˆ›å»ºå·¥å‚ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MapperProxyFactory</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Mapper æ¥å£ç±»å‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;T&gt; mapperInterface;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MapperProxyFactory</span> <span class="params">(Class&lt;T&gt; mapperInterface)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mapperInterface = mapperInterface;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">newInstance</span><span class="params">(Map&lt;String, String&gt; sqlSession)</span> &#123;</span><br><span class="line">        <span class="type">MapperProxy</span> <span class="variable">mapperProxy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MapperProxy</span>(sqlSession, mapperInterface);</span><br><span class="line">        <span class="keyword">return</span> (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;mapperInterface&#125;, mapperProxy);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>IUserDao</code>ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUserDao</span> &#123;</span><br><span class="line">    String <span class="title function_">queryUserName</span><span class="params">(String uId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MapperProxyTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        MapperProxyFactory&lt;IUserDao&gt; factory = <span class="keyword">new</span> <span class="title class_">MapperProxyFactory</span>&lt;IUserDao&gt;(IUserDao.class);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; sqlSession = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        sqlSession.put(<span class="string">&quot;cn.bugstack.mybatis.test.dao.IUserDao.queryUserName&quot;</span>, <span class="string">&quot;æ¨¡æ‹Ÿæ‰§è¡Œ Mapper.xml ä¸­ SQL è¯­å¥çš„æ“ä½œï¼šæŸ¥è¯¢ç”¨æˆ·å§“å&quot;</span>);</span><br><span class="line">        sqlSession.put(<span class="string">&quot;cn.bugstack.mybatis.test.dao.IUserDao.queryUserAge&quot;</span>, <span class="string">&quot;æ¨¡æ‹Ÿæ‰§è¡Œ Mapper.xml ä¸­ SQL è¯­å¥çš„æ“ä½œï¼šæŸ¥è¯¢ç”¨æˆ·å¹´é¾„&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">IUserDao</span> <span class="variable">userDao</span> <span class="operator">=</span> factory.newInstance(sqlSession);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> userDao.queryUserName(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        System.out.println(res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç±»qtspace.cn.binding.IUserDaoè¢«ä»£ç†äº†, æ‰§è¡Œäº†æ–¹æ³•ï¼šqueryUserName ,sqlSessionä¸ºï¼š&#123;cn.bugstack.mybatis.test.dao.IUserDao.queryUserAge=æ¨¡æ‹Ÿæ‰§è¡Œ Mapper.xml ä¸­ SQL è¯­å¥çš„æ“ä½œï¼šæŸ¥è¯¢ç”¨æˆ·å¹´é¾„, cn.bugstack.mybatis.test.dao.IUserDao.queryUserName=æ¨¡æ‹Ÿæ‰§è¡Œ Mapper.xml ä¸­ SQL è¯­å¥çš„æ“ä½œï¼šæŸ¥è¯¢ç”¨æˆ·å§“å&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥ä»ä¸Šé¢çš„æµ‹è¯•ç»“æœçœ‹å‡º<code>IUserDao</code>è¢«ä»£ç†äº†ï¼Œåœ¨æ‰§è¡Œ<code>MapperProxy#invoker()</code>æ–¹æ³•çš„æ—¶å€™ä»£ç†æ‰§è¡Œ<code>IUserDao#queryUserName()</code>æ–¹æ³•ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š<strong>åŠ¨æ€ä»£ç†çš„æ–¹å¼ä¸­ï¼Œæ‰€æœ‰çš„æ–¹æ³•éƒ½ä¼šé€šè¿‡<code>invoker()</code>æ–¹æ³•æ‰§è¡Œï¼Œä½†æ˜¯åŠ¨æ€ä»£ç†æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯å®ƒåªèƒ½ä»£ç†å®ç°äº†æŸä¸ªæ¥å£çš„å®ç°ç±»ï¼Œå¹¶ä¸”ä»£ç†ç±»åªèƒ½ä»£ç†æ¥å£ä¸­å®ç°çš„æ–¹æ³•ï¼Œè¦æ˜¯å®ç°ç±»ä¸­æœ‰è‡ªå·±ç§æœ‰çš„æ–¹æ³•ï¼Œè€Œæ¥å£ä¸­æ²¡æœ‰ï¼Œè¯¥æ–¹æ³•æ˜¯ä¸èƒ½è¢«ä»£ç†çš„ã€‚</strong></p>]]></content>
      
      
      <categories>
          
          <category> Mybatis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mybatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaçº¿ç¨‹æ± å®ç°åŸç†è¯¦è§£</title>
      <link href="/2022/04/08/threadpool-principle/"/>
      <url>/2022/04/08/threadpool-principle/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h3 id="ä¸€ã€ä¸ºä»€ä¹ˆè¦ä½¿ç”¨çº¿ç¨‹æ± ï¼Ÿ"><a href="#ä¸€ã€ä¸ºä»€ä¹ˆè¦ä½¿ç”¨çº¿ç¨‹æ± ï¼Ÿ" class="headerlink" title="ä¸€ã€ä¸ºä»€ä¹ˆè¦ä½¿ç”¨çº¿ç¨‹æ± ï¼Ÿ"></a>ä¸€ã€ä¸ºä»€ä¹ˆè¦ä½¿ç”¨çº¿ç¨‹æ± ï¼Ÿ</h3><p><strong>çº¿ç¨‹æ± </strong>æä¾›äº†ä¸€ç§é™åˆ¶å’Œç®¡ç†èµ„æºï¼ˆçº¿ç¨‹ã€ä»»åŠ¡ï¼‰çš„æ–¹å¼ã€‚</p><p>è¿™é‡Œå€Ÿç”¨ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹æåˆ°çš„æ¥è¯´ä¸€ä¸‹<strong>ä½¿ç”¨çº¿ç¨‹æ± çš„å¥½å¤„</strong>ï¼š</p><ul><li><strong>é™ä½èµ„æºæ¶ˆè€—</strong>ï¼šé€šè¿‡é‡å¤åˆ©ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹é™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„æ¶ˆè€—ã€‚</li><li><strong>æé«˜å“åº”é€Ÿåº¦</strong>ï¼šå½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦ç­‰å¾…åˆ›å»ºçº¿ç¨‹å°±èƒ½ç«‹å³æ‰§è¡Œã€‚</li><li><strong>æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§</strong>ï¼šçº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— çº¿çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§ã€‚</li></ul><h3 id="äºŒã€ThreadPoolExecutorç±»åˆ†æ"><a href="#äºŒã€ThreadPoolExecutorç±»åˆ†æ" class="headerlink" title="äºŒã€ThreadPoolExecutorç±»åˆ†æ"></a>äºŒã€ThreadPoolExecutorç±»åˆ†æ</h3><p><code>Java</code>çº¿ç¨‹æ± ä¸»è¦ç”±<code>Executor</code>æ¡†æ¶å®ç°ï¼Œ<code>Executor</code> æ¡†æ¶ä¸ä»…åŒ…æ‹¬äº†çº¿ç¨‹æ± çš„ç®¡ç†ï¼Œè¿˜æä¾›äº†çº¿ç¨‹å·¥å‚ã€é˜Ÿåˆ—ä»¥åŠæ‹’ç»ç­–ç•¥ç­‰ï¼Œ<code>Executor</code> æ¡†æ¶è®©å¹¶å‘ç¼–ç¨‹å˜å¾—æ›´åŠ ç®€å•ã€‚</p><p>çº¿ç¨‹æ± å®ç°ç±»<code>ThreadPoolExecutor</code>æ˜¯<code>Executor</code>æ¡†æ¶æœ€æ ¸å¿ƒçš„ç±»ï¼Œæˆ‘ä»¬å°±ä»è¿™ä¸ªç±»çš„å­¦ä¹ çº¿ç¨‹æ± çš„å®ç°åŸç†ã€‚</p><h4 id="æ ¸å¿ƒå±æ€§"><a href="#æ ¸å¿ƒå±æ€§" class="headerlink" title="æ ¸å¿ƒå±æ€§"></a>æ ¸å¿ƒå±æ€§</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolExecutor</span> <span class="keyword">extends</span> <span class="title class_">AbstractExecutorService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ§åˆ¶å˜é‡-å­˜æ”¾çŠ¶æ€å’Œçº¿ç¨‹æ•° 32ä½, é«˜3ä½å­˜æ”¾çŠ¶æ€, ä½29ä½å­˜æ”¾çº¿ç¨‹æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">ctl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(ctlOf(RUNNING, <span class="number">0</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä»»åŠ¡é˜Ÿåˆ—ï¼Œ å¿…é¡»æ˜¯é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; workQueue;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å·¥ä½œçº¿ç¨‹é›†åˆï¼Œå­˜æ”¾çº¿ç¨‹æ± ä¸­æ‰€æœ‰çš„(æ´»è·ƒçš„)å·¥ä½œçº¿ç¨‹ï¼Œåªæœ‰åœ¨æŒæœ‰å…¨å±€é”mainLockçš„å‰æä¸‹æ‰èƒ½è®¿é—®æ­¤é›†åˆ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å…¨å±€é”</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// awaitTerminationæ–¹æ³•ä½¿ç”¨çš„ç­‰å¾…æ¡ä»¶å˜é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">termination</span> <span class="operator">=</span> mainLock.newCondition();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®°å½•å³°å€¼çº¿ç¨‹æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> largestPoolSize;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®°å½•å®ŒæˆæˆåŠŸæ‰§è¡Œçš„ä»»åŠ¡æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> completedTaskCount;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// çº¿ç¨‹å·¥å‚, ç”¨äºåˆ›å»ºæ–°çš„çº¿ç¨‹å®ä¾‹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> ThreadFactory threadFactory;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‹’ç»æ‰§è¡Œå¤„ç†å™¨, å¯¹åº”ä¸åŒçš„æ‹’ç»ç­–ç•¥</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> RejectedExecutionHandler handler;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç©ºé—²çº¿ç¨‹ç­‰å¾…ä»»åŠ¡çš„æ—¶é—´å‘¨æœŸï¼Œ å•ä½æ˜¯çº³ç§’</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">long</span> keepAliveTime;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ˜¯å¦å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶, å¦‚æœä¸ºtrueåˆ™keepAliveTimeå¯¹æ ¸å¿ƒçº¿ç¨‹ä¹Ÿç”Ÿæ•ˆ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> allowCoreThreadTimeOut;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ¸å¿ƒçº¿ç¨‹æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> corePoolSize;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// çº¿ç¨‹æ± å®¹é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> maximumPoolSize;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// çœç•¥å…¶ä»–ä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ„é€ æ–¹æ³•"><a href="#æ„é€ æ–¹æ³•" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h4><p>å‚æ•°æœ€å¤šçš„æ„é€ æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ThreadPoolExecutor</span><span class="params">(<span class="type">int</span> corePoolSize,</span></span><br><span class="line"><span class="params">                          <span class="type">int</span> maximumPoolSize,</span></span><br><span class="line"><span class="params">                          <span class="type">long</span> keepAliveTime,</span></span><br><span class="line"><span class="params">                          TimeUnit unit,</span></span><br><span class="line"><span class="params">                          BlockingQueue&lt;Runnable&gt; workQueue,</span></span><br><span class="line"><span class="params">                          ThreadFactory threadFactory,</span></span><br><span class="line"><span class="params">                          RejectedExecutionHandler handler)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(corePoolSize &lt; <span class="number">0</span> ||</span><br><span class="line">       maximumPoolSize &lt;= <span class="number">0</span> ||</span><br><span class="line">       maximumPoolSize &lt; corePoolSize ||</span><br><span class="line">       keepAliveTime &lt; <span class="number">0</span>) </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    <span class="keyword">if</span>(workQueue == <span class="literal">null</span> || threadFactory == <span class="literal">null</span> || handler == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="built_in">this</span>.acc = System.getSecurityManager() == <span class="literal">null</span> ?</span><br><span class="line">                <span class="literal">null</span> :</span><br><span class="line">                AccessController.getContext();</span><br><span class="line">    <span class="built_in">this</span>.corePoolSize = corePoolSize;</span><br><span class="line">    <span class="built_in">this</span>.maximumPoolSize = maximumPoolSize;</span><br><span class="line">    <span class="built_in">this</span>.workQueue = workQueue;</span><br><span class="line">    <span class="built_in">this</span>.keepAliveTime = unit.toNanos(keepAliveTime);</span><br><span class="line">    <span class="built_in">this</span>.threadFactory = threadFactory;</span><br><span class="line">    <span class="built_in">this</span>.handler = handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ ¹æ®è¿™ä¸ªæ„é€ æ–¹æ³•è‡ªå®šä¹‰çº¿ç¨‹æ•°ã€çº¿ç¨‹æ± å®¹é‡ï¼ˆæœ€å¤§çº¿ç¨‹æ•°ï¼‰ã€ç©ºé—²çº¿ç¨‹ç­‰å¾…ä»»åŠ¡å‘¨æœŸã€ä»»åŠ¡é˜Ÿåˆ—ã€çº¿ç¨‹å·¥å‚ã€æ‹’ç»ç­–ç•¥ã€‚</p><p>åœ¨ã€Šé˜¿é‡Œå·´å·´Javaå¼€å‘æ‰‹å†Œã€‹â€œå¹¶å‘å¤„ç†â€è¿™ä¸€ç« èŠ‚ï¼Œæ˜ç¡®æŒ‡å‡ºçº¿ç¨‹èµ„æºå¿…é¡»é€šè¿‡çº¿ç¨‹æ± åˆ›å»ºï¼Œä¸å…è®¸åœ¨åº”ç”¨ä¸­è‡ªè¡Œæ˜¾ç¤ºåˆ›å»ºçº¿ç¨‹ï¼Œè¿™æ˜¯å› ä¸º<strong>ä½¿ç”¨çº¿ç¨‹æ± åˆ›å»ºçº¿ç¨‹å¯ä»¥å‡å°‘åœ¨åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ä¸Šæ‰€æ¶ˆè€—çš„æ—¶é—´ä»¥åŠç³»ç»Ÿèµ„æºçš„å¼€é”€ã€‚</strong></p><p>ã€Šé˜¿é‡Œå·´å·´Javaå¼€å‘æ‰‹å†Œã€‹ä¸­è¿˜å¼ºåˆ¶ä¸èƒ½ä½¿ç”¨<code>Executors</code>å»åˆ›å»ºçº¿ç¨‹æ± ï¼Œè€Œæ˜¯é€šè¿‡ä¸Šé¢çš„<code>ThreadPoolExecutor</code>çš„æ„é€ æ–¹å¼åˆ›å»ºï¼Œè¿™æ ·çš„å¤„ç†æ–¹å¼å¯ä»¥è®©å†™çš„åŒå­¦æ›´åŠ æ˜ç¡®çº¿ç¨‹æ± çš„è¿è¡Œè§„åˆ™ï¼Œé¿å…èµ„æºè€—å°½çš„é£é™©ã€‚</p><p>ä¸‹é¢ç®€å•åˆ†æä¸€ä¸‹æ¯ä¸ªå‚æ•°çš„å«ä¹‰å’Œä½œç”¨ï¼š</p><ul><li><code>corePoolSize</code>ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°é‡ã€‚</li><li><code>maximumPoolSize</code>ï¼šæœ€å¤§çº¿ç¨‹æ•°é‡ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹æ± çš„å®¹é‡ã€‚</li><li><code>keepAliveTime</code>ï¼šçº¿ç¨‹ç©ºé—²ç­‰å¾…æ—¶é—´ï¼Œä¹Ÿå’Œå·¥ä½œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸæœ‰å…³ã€‚</li><li><code>unit</code>ï¼šçº¿ç¨‹ç©ºé—²æ—¶é—´çš„å•ä½ï¼Œæœ€ç»ˆä¼šè½¬ä¸ºæˆçº³ç§’ã€‚</li><li><code>workQueue</code>ï¼šç­‰å¾…é˜Ÿåˆ—æˆ–è€…å«ä»»åŠ¡é˜Ÿåˆ—ã€‚</li><li><code>ThreadFactory</code>ï¼šåˆ›å»ºçº¿ç¨‹çš„å·¥å‚ï¼Œé»˜è®¤ä½¿ç”¨<code>Executors.defaultThreadFactory()</code>ä½œä¸ºçº¿ç¨‹æ± å·¥å‚å®ä¾‹ã€‚</li><li><code>handler</code>ï¼šçº¿ç¨‹æ± çš„æ‰§è¡Œæ‰§è¡Œå¤„ç†å™¨ï¼Œæ›´å¤šçš„æ—¶å€™æˆä¸ºæ‹’ç»ç­–ç•¥ï¼Œæ‹’ç»ç­–ç•¥æ‰§è¡Œçš„æ—¶æœºæ˜¯å½“é˜»å¡é˜Ÿåˆ—å·²æ»¡ã€æ²¡æœ‰ç©ºé—²çš„çº¿ç¨‹ï¼ˆåŒ…å«æ ¸å¿ƒçº¿ç¨‹å’Œéæ ¸å¿ƒçº¿ç¨‹ï¼‰å¹¶ä¸”ç»§ç»­æäº¤ä»»åŠ¡ã€‚æä¾›äº†4ç§æ‹’ç»ç­–ç•¥å®ç°ï¼š<ul><li><code>AbortPolicy</code>ï¼šç›´æ¥æ‹’ç»ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šæ‰§è¡Œä»»åŠ¡ï¼Œç›´æ¥æŠ›å‡º<code>RjectedExecutionExcetion</code>é”™è¯¯ï¼Œé»˜è®¤çš„æ‹’ç»ç­–ç•¥ã€‚</li><li><code>DiscardPolicy</code>ï¼šæŠ›å¼ƒç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥å¿½ç•¥æäº¤çš„ä»»åŠ¡ã€‚</li><li><code>DiscardOldestPolicy</code>ï¼šæŠ›å¼ƒæœ€è€ä»»åŠ¡ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡<code>poll()</code>æ–¹æ³•å–å‡ºä»»åŠ¡é˜Ÿåˆ—å¤´çš„ä»»åŠ¡æŠ›å¼ƒï¼Œç„¶åæ‰§è¡Œå½“å‰æäº¤çš„ä»»åŠ¡ã€‚</li><li><code>CallerRunsPolicy</code>ï¼šè°ƒç”¨è€…æ‰§è¡Œç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯å½“å‰è°ƒç”¨<code>Executor#execute()</code>çš„çº¿ç¨‹ç›´æ¥è°ƒç”¨ä»»åŠ¡<code>Runnable#run()</code>ï¼Œ<strong>ä¸€èˆ¬ä¸å¸Œæœ›ä»»åŠ¡ä¸¢å¤±ä¼šé€‰ç”¨è¿™ç§ç­–ç•¥ï¼Œä½†ä»å®é™…è§’åº¦æ¥çœ‹ï¼ŒåŸæ¥çš„å¼‚æ­¥è°ƒç”¨æ„å›¾ä¼šé€€åŒ–æˆåŒæ­¥è°ƒç”¨ã€‚</strong></li></ul></li></ul><h4 id="çŠ¶æ€æ§åˆ¶"><a href="#çŠ¶æ€æ§åˆ¶" class="headerlink" title="çŠ¶æ€æ§åˆ¶"></a>çŠ¶æ€æ§åˆ¶</h4><p>çŠ¶æ€æ§åˆ¶ä¸»è¦å›´ç»•åŸå­æ•´æ•°æˆå‘˜å˜é‡<code>crl</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">ctl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(ctlOf(RUNNING, <span class="number">0</span>));</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COUNT_BITS</span> <span class="operator">=</span> Integer.SIZE - <span class="number">3</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COUNT_MASK</span> <span class="operator">=</span> (<span class="number">1</span> &lt;&lt; COUNT_BITS) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RUNNING</span>    <span class="operator">=</span> -<span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SHUTDOWN</span>   <span class="operator">=</span>  <span class="number">0</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">STOP</span>       <span class="operator">=</span>  <span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TIDYING</span>    <span class="operator">=</span>  <span class="number">2</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TERMINATED</span> <span class="operator">=</span>  <span class="number">3</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡ctlå€¼è·å–è¿è¡ŒçŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">runStateOf</span><span class="params">(<span class="type">int</span> c)</span>     &#123; <span class="keyword">return</span> c &amp; ~COUNT_MASK; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡ctlå€¼è·å–å·¥ä½œçº¿ç¨‹æ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">workerCountOf</span><span class="params">(<span class="type">int</span> c)</span>  &#123; <span class="keyword">return</span> c &amp; COUNT_MASK; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡è¿è¡ŒçŠ¶æ€å’Œå·¥ä½œçº¿ç¨‹æ•°è®¡ç®—ctlçš„å€¼ï¼Œæˆ–è¿ç®—</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">ctlOf</span><span class="params">(<span class="type">int</span> rs, <span class="type">int</span> wc)</span> &#123; <span class="keyword">return</span> rs | wc; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">runStateLessThan</span><span class="params">(<span class="type">int</span> c, <span class="type">int</span> s)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> c &lt; s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">runStateAtLeast</span><span class="params">(<span class="type">int</span> c, <span class="type">int</span> s)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> c &gt;= s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isRunning</span><span class="params">(<span class="type">int</span> c)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> c &lt; SHUTDOWN;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CASæ“ä½œçº¿ç¨‹æ•°å¢åŠ 1</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">compareAndIncrementWorkerCount</span><span class="params">(<span class="type">int</span> expect)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ctl.compareAndSet(expect, expect + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CASæ“ä½œçº¿ç¨‹æ•°å‡å°‘1</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">compareAndDecrementWorkerCount</span><span class="params">(<span class="type">int</span> expect)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ctl.compareAndSet(expect, expect - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹æ•°ç›´æ¥å‡å°‘1</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">decrementWorkerCount</span><span class="params">()</span> &#123;</span><br><span class="line">    ctl.addAndGet(-<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åˆ†æä¸€ä¸‹çº¿ç¨‹æ± çš„çŠ¶æ€å˜é‡ï¼Œå·¥ä½œçº¿ç¨‹æ•°é‡ä½çš„é•¿åº¦æ˜¯<code>COUNT_BITS</code>ï¼Œå®ƒçš„å€¼æ˜¯<code>Integer.SIZE - 3</code>ï¼Œä¹Ÿå°±æ˜¯æ­£æ•´æ•°29ï¼š</p><blockquote><p>æˆ‘ä»¬çŸ¥é“ï¼Œæ•´æ•°åŒ…è£…ç±»å‹Integerå®ä¾‹çš„å¤§å°æ˜¯4byteï¼Œä¸€å…±æ˜¯32ä½ï¼Œä¹Ÿå°±æ˜¯ä¸€å…±æœ‰32ä½ç”¨äºå­˜æ”¾0å’Œ1ã€‚</p><p>åœ¨ThreadPoolExecutorå®ç°ä¸­ï¼Œä½¿ç”¨32ä½çš„æ•´æ•°åŒ…è£…ç±»å‹å­˜æ”¾å·¥ä½œçº¿ç¨‹æ•°å’Œçº¿ç¨‹çŠ¶æ€ï¼Œå…¶ä¸­ä½29ä½ç”¨äºå­˜æ”¾å·¥ä½œçº¿ç¨‹æ•°ï¼Œè€Œé«˜3ä½ç”¨äºå­˜æ”¾çº¿ç¨‹æ± çŠ¶æ€ï¼Œæ‰€ä»¥çº¿ç¨‹æ± çš„çŠ¶æ€æœ€å¤šåªèƒ½æœ‰2^3ç§ï¼Œå·¥ä½œçº¿ç¨‹ä¸Šé™æ•°é‡ä¸º2^29 - 1ï¼Œè¶…è¿‡5äº¿ï¼Œè¿™ä¸ªæ•°é‡åœ¨çŸ­æ—¶é—´å†…ä¸ç”¨è€ƒè™‘ä¼šè¶…é™ã€‚</p></blockquote><p>æ¥ç€çœ‹å·¥ä½œçº¿ç¨‹ä¸Šçº¿æ•°é‡æ©ç <code>COUNT_MASK</code>ï¼Œå®ƒçš„å€¼æ˜¯(<code>1 &lt; COUNT_BITS - 1</code>)ï¼Œä¹Ÿå°±æ˜¯1å·¦ç§»29ä½ï¼Œå†å‡å»1ï¼Œå¦‚æœè¡¥å…¨32ä½ï¼Œå®ƒçš„ä½ç¤ºå›¾å¦‚ä¸‹ï¼š</p><p><img src="https://qtspace.cn/contentimg/42.jpg"></p><p>ç„¶åå°±æ˜¯çº¿ç¨‹æ± çš„çŠ¶æ€å¸¸é‡ï¼Œæ¯”å¦‚<code>RUNNING</code>çŠ¶æ€ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -1çš„è¡¥ç ä¸ºï¼š111-11111111111111111111111111111</span></span><br><span class="line"><span class="comment">// å·¦ç§»29ä½ï¼š  111-00000000000000000000000000000</span></span><br><span class="line"><span class="comment">// 10è¿›åˆ¶ä¸ºï¼š-536870912 </span></span><br><span class="line"><span class="comment">// é«˜3ä½111çš„å€¼å°±æ˜¯è¡¨ç¤ºçº¿ç¨‹æ± æ­£åœ¨å¤„äºè¿è¡ŒçŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">RUNNING</span> <span class="operator">=</span> -<span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br></pre></td></tr></table></figure><p>çº¿ç¨‹æ± çŠ¶æ€çš„è¿è¡ŒçŠ¶æ€å¸¸é‡ï¼š</p><table><thead><tr><th align="center">çŠ¶æ€åç§°</th><th align="center">ä½å›¾</th><th align="center">åè¿›åˆ¶å€¼</th><th>æè¿°</th></tr></thead><tbody><tr><td align="center"><code>RUNNING</code></td><td align="center"><code>111-0000...</code></td><td align="center">-536870912</td><td>è¿è¡Œä¸­çŠ¶æ€ï¼Œå¯ä»¥æ¥å—æ–°çš„ä»»åŠ¡å’Œæ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚</td></tr><tr><td align="center"><code>SHUTDOWN</code></td><td align="center"><code>000-0000...</code></td><td align="center">0</td><td>å…³é—­çŠ¶æ€ï¼Œä¸å†æ¥æ”¶æ–°çš„ä»»åŠ¡ï¼Œä½†æ˜¯ä¼šæ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚</td></tr><tr><td align="center"><code>STOP</code></td><td align="center"><code>001-0000...</code></td><td align="center">536870912</td><td>åœæ­¢çŠ¶æ€ï¼Œä¸å†æ¥å—æ–°çš„ä»»åŠ¡ï¼Œä¹Ÿä¸ä¼šæ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œä¸­æ–­æ‰€æœ‰æ‰§è¡Œä¸­çš„ä»»åŠ¡ã€‚</td></tr><tr><td align="center"><code>TIDYING</code></td><td align="center"><code>010-0000...</code></td><td align="center">1073741824</td><td>æ•´ç†ä¸­çŠ¶æ€ï¼Œæ‰€æœ‰ä»»åŠ¡éƒ½å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œå·¥ä½œçº¿ç¨‹æ•°ä¸º0ï¼Œè¿‡æ¸¡åˆ°æ­¤çŠ¶æ€çš„å·¥ä½œçº¿ç¨‹ä¼šè°ƒç”¨é’©å­æ–¹æ³•<code>terminated()</code></td></tr><tr><td align="center"><code>TERMINATED</code></td><td align="center"><code>011-0000...</code></td><td align="center">1610612736</td><td>ç»ˆæ­¢çŠ¶æ€ï¼Œé’©å­æ–¹æ³•<code>terminated()</code>æ‰§è¡Œå®Œæ¯•ã€‚</td></tr></tbody></table><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„æŠ€å·§ï¼Œç”±äºè¿è¡ŒçŠ¶æ€å€¼å­˜æ”¾åœ¨é«˜3ä½ï¼Œæ‰€ä»¥ç›´æ¥å¯ä»¥é€šè¿‡åè¿›åˆ¶æ¥æ¯”è¾ƒåˆ¤æ–­çº¿ç¨‹æ± çš„çŠ¶æ€ï¼š</p><blockquote><p><code>RUNNING</code> &lt; <code>SHUTDOWN</code> &lt; <code>STOP</code> &lt; <code>TIDYING</code> &lt; <code>TERMINATED</code></p></blockquote><p>ä¸‹é¢çš„3ä¸ªæ–¹æ³•å°±æ˜¯ä½¿ç”¨è¿™ç§æŠ€å·§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ctlå’ŒçŠ¶æ€å¸¸é‡æ¯”è¾ƒï¼Œåˆ¤æ–­æ˜¯å¦å°äº</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">runStateLessThan</span><span class="params">(<span class="type">int</span> c, <span class="type">int</span> s)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> c &lt; s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ctlå’ŒçŠ¶æ€å¸¸é‡æ¯”è¾ƒï¼Œåˆ¤æ–­æ˜¯å¦å°äºæˆ–ç­‰äº</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">runStateAtLeast</span><span class="params">(<span class="type">int</span> c, <span class="type">int</span> s)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> c &gt;= s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ctlå’ŒçŠ¶æ€å¸¸é‡SHUTDOWNæ¯”è¾ƒï¼Œåˆ¤æ–­æ˜¯å¦å¤„äºRUNNINGçŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isRunning</span><span class="params">(<span class="type">int</span> c)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> c &lt; SHUTDOWN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çº¿ç¨‹çŠ¶æ€æµè½¬å…³ç³»å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://qtspace.cn/contentimg/43.jpg"></p><h4 id="executeæ–¹æ³•æºç åˆ†æ"><a href="#executeæ–¹æ³•æºç åˆ†æ" class="headerlink" title="executeæ–¹æ³•æºç åˆ†æ"></a>executeæ–¹æ³•æºç åˆ†æ</h4><p>çº¿ç¨‹å¼‚æ­¥æ‰§è¡Œä»»åŠ¡çš„æ–¹æ³•å®ç°æ˜¯<code>ThreadPoolExecutor#execute()</code>æ–¹æ³•ï¼Œæˆ‘ä»¬ä»æºç çš„å®ç°æ¥å­¦ä¹ ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­ä»»åŠ¡å¯¹è±¡éç©º</span></span><br><span class="line">    <span class="keyword">if</span> (command == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerExcetion</span>();</span><br><span class="line">    <span class="comment">// è·å–ctlå€¼, ç”¨äºè·å–çº¿ç¨‹æ± çŠ¶æ€ã€çº¿ç¨‹æ± çº¿ç¨‹æ•°é‡</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹æ•°å°äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œåˆ™åˆ›å»ºæ–°çš„æ ¸å¿ƒçº¿ç¨‹æ•°å¹¶ä¸”æ‰§è¡Œä¼ å…¥çš„ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</span><br><span class="line">        <span class="keyword">if</span> (addWoker(command, <span class="literal">true</span>))</span><br><span class="line">            <span class="comment">// å¦‚æœåˆ›å»ºæ–°çš„æ ¸å¿ƒçº¿ç¨‹æˆåŠŸåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">// è¿™é‡Œè¯´æ˜åˆ›å»ºæ–°çš„æ ¸å¿ƒçº¿ç¨‹å¤±è´¥ï¼Œåˆ™æ›´æ–°ctlçš„ä¸´æ—¶å˜é‡c</span></span><br><span class="line">        c = ctl.get();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// èµ°åˆ°è¿™é‡Œè¯´æ˜åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹å¤±è´¥ï¼Œä¹Ÿå°±æ˜¯å½“å‰å·¥ä½œçš„çº¿ç¨‹æ•°å¤§äºç­‰äºæ ¸å¿ƒçº¿ç¨‹æ•°</span></span><br><span class="line">    <span class="comment">// åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å¤„äºè¿è¡Œä¸­çŠ¶æ€ï¼Œå¦‚æœæ˜¯è¿è¡ŒçŠ¶æ€å°è¯•ä½¿ç”¨éé˜»å¡æ–¹æ³•å‘ä»»åŠ¡é˜Ÿåˆ—æ”¾å…¥ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">recheck</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">        <span class="comment">// è¿™é‡Œå‘ä»»åŠ¡é˜Ÿåˆ—æŠ•æ”¾æˆåŠŸï¼Œå¯¹çº¿ç¨‹æ± çš„è¿è¡Œä¸­çŠ¶æ€åšäºŒæ¬¡æ£€æŸ¥</span></span><br><span class="line">        <span class="comment">// å¦‚æœçº¿ç¨‹æ± äºŒæ¬¡æ£€æŸ¥çŠ¶æ€æ˜¯éè¿è¡Œä¸­çŠ¶æ€ï¼Œåˆ™ä»ä»»åŠ¡é˜Ÿåˆ—ç§»é™¤å½“å‰çš„ä»»åŠ¡ï¼Œè°ƒç”¨æ‹’ç»ç­–ç•¥å¤„ç†</span></span><br><span class="line">        <span class="keyword">if</span> (!isRunning() &amp;&amp; remove(command))</span><br><span class="line">            <span class="comment">// è°ƒç”¨æ‹’ç»ç­–ç•¥å¤„ç†ä»»åŠ¡</span></span><br><span class="line">            reject(command);</span><br><span class="line">        <span class="comment">// èµ°åˆ°è¿™é‡Œè¯´æ˜æœ‰ä»¥ä¸‹çš„å‰æï¼š</span></span><br><span class="line">        <span class="comment">// 1ã€å¾…æ‰§è¡Œçš„ä»»åŠ¡å·²ç»æˆåŠŸåŠ å…¥ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">        <span class="comment">// 2ã€çº¿ç¨‹æ± çŠ¶æ€å¯èƒ½æ˜¯RUNNING</span></span><br><span class="line">        <span class="comment">// 3ã€ä¼ å…¥çš„ä»»åŠ¡å¯èƒ½ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­ç§»é™¤å¤±è´¥(ç§»é™¤å¤±è´¥çš„å”¯ä¸€å¯èƒ½å°±æ˜¯ä»»åŠ¡å·²ç»è¢«æ‰§è¡Œäº†)</span></span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰å·¥ä½œçº¿ç¨‹æ•°é‡ä¸º0ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªéæ ¸å¿ƒçº¿ç¨‹å¹¶ä¸”ä¼ å…¥çš„å¯¹è±¡ä¸ºnull</span></span><br><span class="line">        <span class="comment">// ä¹Ÿå°±æ˜¯åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹ä¸ä¼šé©¬ä¸Šè¿è¡Œï¼Œè€Œæ˜¯ç­‰å¾…è·å–ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡å†æ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// åˆ›å»ºä¸€ä¸ªéæ ¸å¿ƒçº¿ç¨‹å¹¶ä¸”ä¼ å…¥çš„ä»»åŠ¡å¯¹è±¡ä¸ºnull</span></span><br><span class="line">            addWorker(<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// èµ°åˆ°è¿™é‡Œè¯´æ˜ä»¥ä¸‹ï¼š</span></span><br><span class="line">    <span class="comment">// 1ã€çº¿ç¨‹æ± çš„å·¥ä½œçº¿ç¨‹æ€»æ•°å·²ç»å¤§äºç­‰äºæ ¸å¿ƒçº¿ç¨‹æ•°</span></span><br><span class="line">    <span class="comment">// 2ã€çº¿ç¨‹æ± å¯èƒ½ä¸æ˜¯RUNNINGçŠ¶æ€</span></span><br><span class="line">    <span class="comment">// 3ã€çº¿ç¨‹æ± å¯èƒ½æ˜¯RUNNINGçŠ¶æ€åŒæ—¶ä»»åŠ¡é˜Ÿåˆ—å·²ç»æ»¡äº†</span></span><br><span class="line">    <span class="comment">// å¦‚æœä»»åŠ¡é˜Ÿåˆ—æŠ•æ”¾ä»»åŠ¡å¤±è´¥ï¼Œåˆ™ä¼šå°è¯•åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="literal">false</span>))</span><br><span class="line">        <span class="comment">// å¦‚æœåˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹å¤±è´¥ï¼Œæ‰§è¡Œæ‹’ç»ç­–ç•¥</span></span><br><span class="line">        reject(command);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç çš„æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>å¦‚æœå½“å‰å·¥ä½œçº¿ç¨‹æ€»æ•°å°äºæ ¸å¿ƒçº¿ç¨‹æ•°<code>corePoolSize</code>ï¼Œåˆ™ç›´æ¥åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡ï¼ˆä»»åŠ¡å®ä¾‹ä¼šä¼ å…¥ç›´æ¥ç”¨äºæ„é€ å·¥ä½œçº¿ç¨‹å®ä¾‹ï¼‰ã€‚</li><li>å¦‚æœå½“å‰å·¥ä½œçº¿ç¨‹æ€»æ˜¯å¤§äºç­‰äºæ ¸å¿ƒçº¿ç¨‹æ•°<code>corePoolSize</code>ï¼Œåˆ¤æ–­çº¿ç¨‹çŠ¶æ€æ˜¯å¦æ˜¯è¿è¡Œä¸­çŠ¶æ€ï¼Œå¦‚æœæ˜¯è¿è¡Œä¸­çŠ¶æ€åˆ™ä¼šå°è¯•ç”¨éé˜»å¡æ–¹æ³•ï¼ˆ<code>offer()</code>ï¼‰å‘ä»»åŠ¡é˜Ÿåˆ—æŠ•æ”¾ä»»åŠ¡ï¼Œå¦‚æœæŠ•æ”¾æˆåŠŸä¼šäºŒæ¬¡æ£€æŸ¥çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ï¼Œå¦‚æœçº¿ç¨‹æ± æ˜¯éè¿è¡Œä¸­çŠ¶æ€æˆ–è€…ä»ä»»åŠ¡é˜Ÿåˆ—ç§»é™¤å½“å‰çš„ä»»åŠ¡å¤±è´¥ï¼Œåˆ™ä¼šè°ƒç”¨æ‹’ç»ç­–ç•¥ï¼Œå¦‚æœå½“å‰å·¥ä½œçº¿ç¨‹æ•°é‡ä¸º0ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªéæ ¸å¿ƒçº¿ç¨‹å¹¶ä¸”ä¼ å…¥çš„ä»»åŠ¡å¯¹è±¡ä¸º<code>null</code>ã€‚</li><li>å¦‚æœä»»åŠ¡é˜Ÿåˆ—æŠ•æ”¾ä»»åŠ¡å¤±è´¥äº†ï¼ˆä»»åŠ¡é˜Ÿåˆ—æ»¡äº†ï¼‰ï¼Œåˆ™ä¼šåˆ›å»ºåˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹ä¼ å…¥ä»»åŠ¡å®ä¾‹æ‰§è¡Œã€‚</li><li>å¦‚æœéæ ¸å¿ƒçº¿ç¨‹åˆ›å»ºå¤±è´¥ï¼Œåˆ™ä¼šè°ƒç”¨æ‹’ç»ç­–ç•¥ã€‚</li></ol><p><strong>è¿™é‡Œæœ‰ä¸€ä¸ªç–‘æƒ‘ç‚¹</strong>ï¼šä¸ºä»€ä¹ˆè¦äºŒæ¬¡æ£€æŸ¥çº¿ç¨‹æ± çš„çŠ¶æ€ï¼Œå½“å‰å·¥ä½œçº¿ç¨‹æ•°é‡ä¸º0ï¼Œå°è¯•åˆ›å»ºä¸€ä¸ªéæ ¸å¿ƒçº¿ç¨‹å¹¶ä¸”ä¼ å…¥çš„ä»»åŠ¡å¯¹è±¡ä¸º<code>null</code>ï¼Ÿè¿™ä¸ªå¯ä»¥çœ‹<code>API</code>çš„è§£é‡Šï¼š</p><blockquote><p>å¦‚æœä¸€ä¸ªä»»åŠ¡æˆåŠŸåŠ å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œæˆ‘ä»¬ä¾ç„¶éœ€è¦äºŒæ¬¡æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œå› ä¸ºæ‰€æœ‰å­˜æ´»çš„å·¥ä½œçº¿ç¨‹æœ‰å¯èƒ½åœ¨æœ€åä¸€æ¬¡æ£€æŸ¥ä¹‹åå°±ç»ˆç»“äº†æˆ–è€…æ‰§è¡Œå½“å‰ä»»åŠ¡çš„æ—¶å€™çº¿ç¨‹æ± æ˜¯å¦å·²ç»<code>shutdown</code>äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦äºŒæ¬¡æ£€è½¦çº¿ç¨‹æ± çš„çŠ¶æ€ï¼Œå¿…é¡»æ—¶è¦æŠŠä»»åŠ¡ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­ç§»é™¤æˆ–è€…åœ¨æ²¡æœ‰å¯ç”¨çš„å·¥ä½œçº¿ç¨‹çš„å‰æçš„ä¸‹åˆ›å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹ã€‚</p></blockquote><p><code>execute()</code>æ–¹æ³•æ‰§è¡Œæµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://qtspace.cn/contentimg/44.jpg"></p><h4 id="addWorkeræ–¹æ³•æºç åˆ†æ"><a href="#addWorkeræ–¹æ³•æºç åˆ†æ" class="headerlink" title="addWorkeræ–¹æ³•æºç åˆ†æ"></a>addWorkeræ–¹æ³•æºç åˆ†æ</h4><p><code>addWorker()</code>æ–¹æ³•ç”¨äºæ·»åŠ å·¥ä½œçº¿ç¨‹ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">pirvate <span class="type">boolean</span> <span class="title function_">addWorker</span><span class="params">(Runnable firstTask, <span class="type">boolean</span> core)</span> &#123;</span><br><span class="line">    retry;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">        <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> runStateOf(c);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ¤æ–­è¾¹ç•Œæƒ…å†µè¡¨ï¼Œå½“çº¿ç¨‹æ± çš„çŠ¶æ€æ˜¯shutdownçŠ¶æ€ä¸‹ï¼Œä¸ä¼šå†æ¥å—æ–°çš„ä»»åŠ¡ï¼Œ</span></span><br><span class="line">        <span class="comment">// åœ¨æ­¤å‰æä¸‹å¦‚æœçŠ¶æ€å·²ç»åˆ°stopçŠ¶æ€ã€æˆ–è€…ä¼ å…¥ä»»åŠ¡ä¸ä¸ºç©ºã€æˆ–è€…ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©º</span></span><br><span class="line">        <span class="comment">// éƒ½ä¸éœ€è¦æ·»åŠ æ–°çš„ä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp;</span><br><span class="line">           !(rs == SHUTDOWN &amp;&amp;</span><br><span class="line">             firstTask == <span class="literal">null</span> &amp;&amp;</span><br><span class="line">             ! workQueue.isEmpty()))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// è·å–å·¥ä½œçº¿ç¨‹æ€»æ•°</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">wc</span> <span class="operator">=</span> workCountOf(c);</span><br><span class="line">            <span class="comment">// å¦‚æœå·¥ä½œçº¿ç¨‹æ€»æ•°å¤§äºç­‰äºå®¹é‡æˆ–è€…å¤§äºç­‰äºæ ¸å¿ƒçº¿ç¨‹æ•°/æœ€å¤§çº¿ç¨‹æ•°,</span></span><br><span class="line">            <span class="comment">// åˆ™ä¸éœ€è¦æ·»åŠ æ–°çš„ä»»åŠ¡</span></span><br><span class="line">            <span class="keyword">if</span> (wc &gt;= CAPACITY ||</span><br><span class="line">                wc &gt;= (core ? corePoolSize : maximumPoolSize))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">// æˆåŠŸé€šè¿‡casæ·»åŠ æ–°çš„çº¿ç¨‹æ•°wcï¼Œåˆ™breakåˆ°æœ€å¤–å±‚çš„å¾ªç¯</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndOIncreamentWorkerCount(c))</span><br><span class="line">                breack retry;</span><br><span class="line">            <span class="comment">// èµ°åˆ°è¿™é‡Œè¯´æ˜é€šè¿‡casæ·»åŠ æ–°çš„çº¿ç¨‹æ•°wcå¤±è´¥ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦é‡æ–°åˆ¤æ–­çº¿ç¨‹æ± çš„çŠ¶æ€</span></span><br><span class="line">            <span class="comment">// æ˜¯å¦ç”±RUNNABLEå·²ç»å˜æˆSHUTDOWN</span></span><br><span class="line">            c = ctl.get();</span><br><span class="line">            <span class="comment">// å¦‚æœçº¿ç¨‹æ± çŠ¶æ€å·²ç»ç”±RUNNINGå·²ç»å˜ä¸ºSHUTDOWNï¼Œåˆ™é‡æ–°è·³å‡ºåˆ°å¤–å±‚å¾ªç¯ç»§ç»­æ‰§è¡Œ</span></span><br><span class="line">            <span class="keyword">if</span> (runStateOf(c) != rs)</span><br><span class="line">                <span class="keyword">continue</span> retry;</span><br><span class="line">            <span class="comment">// å¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¾ç„¶æ˜¯RUNNING, CASæ›´æ–°å·¥ä½œçº¿ç¨‹æ•°wcå¤±è´¥è¯´æ˜æœ‰å¯èƒ½æ˜¯å¹¶å‘æ›´æ–°å¯¼è‡´çš„å¤±è´¥</span></span><br><span class="line">            <span class="comment">// åˆ™åœ¨å†…å±‚å¾ªç¯å³å¯</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ‡è®°å·¥ä½œçº¿ç¨‹æ˜¯å¦æˆåŠŸå¯åŠ¨</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">workerStarted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// æ ‡è®°å·¥ä½œçº¿ç¨‹æ˜¯å¦åˆ›å»ºæˆåŠŸ</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">workerAdded</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">Worker</span> <span class="variable">w</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ä¼ å…¥ä»»åŠ¡å®ä¾‹firstTaskåˆ›å»ºworkerå®ä¾‹ï¼ŒWorkeræ„é€ é‡Œé¢ä¼šé€šè¿‡çº¿ç¨‹å·¥å‚åˆ›å»ºæ–°çš„Threadå¯¹è±¡</span></span><br><span class="line">        w = <span class="keyword">new</span> <span class="title class_">Worker</span>(firstTask);</span><br><span class="line">        <span class="comment">// è·å–workerçš„çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> w.thread;</span><br><span class="line">        <span class="keyword">if</span> (t != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// è·å–å…¨å±€é”</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">            <span class="comment">// å…¨å±€é”åŠ é”ï¼Œå› ä¸ºä¼šæ”¹å˜ä¸€äº›æŒ‡æ ‡å€¼å’Œéçº¿ç¨‹å®‰å…¨çš„é›†åˆ</span></span><br><span class="line">            mainLock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// è·å–çº¿ç¨‹æ± çŠ¶æ€</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> runStateOf(ctl.get());</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// å¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¸æ˜¯RUNNINGæˆ–è€…æ˜¯SHUTDOWNåŒæ—¶ä¼ å…¥çš„ä»»åŠ¡å®ä¾‹firstTaskä¸ºnullï¼Œ</span></span><br><span class="line">                <span class="comment">// åˆ™åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å­˜æ´»ï¼Œä¸å­˜æ´»æŠ›å¼‚å¸¸</span></span><br><span class="line">                <span class="keyword">if</span> (rs &lt; SHUTDOWN ||</span><br><span class="line">                    (rs == SHUTDOWN &amp;&amp; firstTask == <span class="literal">null</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (t.isAlive())</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalThreadStateException</span>();</span><br><span class="line">                    <span class="comment">// æŠŠåˆ›å»ºçš„å·¥ä½œçº¿ç¨‹å®ä¾‹æ·»åŠ åˆ°å·¥ä½œçº¿ç¨‹é›†åˆ</span></span><br><span class="line">                    workers.add(w);</span><br><span class="line">                    <span class="comment">// è·å–å·¥ä½œçº¿ç¨‹æ•°é‡</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> workers.size();</span><br><span class="line">                    <span class="comment">//  å°è¯•æ›´æ–°çº¿ç¨‹æ± å³°å€¼å®¹é‡</span></span><br><span class="line">                    <span class="keyword">if</span> (s &gt; largestPoolSize)</span><br><span class="line">                        largestPoolSize = s;</span><br><span class="line">                    <span class="comment">// æ ‡è®°å·¥ä½œçº¿ç¨‹æ·»åŠ æˆåŠŸï¼Œåé¢æ‰ä¼šè°ƒç”¨Thread#start()æ–¹æ³•å¯åŠ¨çœŸå®çš„çº¿ç¨‹å®ä¾‹</span></span><br><span class="line">                    workerAdded = <span class="literal">true</span>;</span><br><span class="line">                &#125; </span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                mainLock.unLock();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœæˆåŠŸæ·»åŠ å·¥ä½œçº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">if</span> (workerAdded) &#123;</span><br><span class="line">                <span class="comment">// è°ƒç”¨Workerå†…éƒ¨çš„çº¿ç¨‹å®ä¾‹tçš„Thread#start()æ–¹æ³•å¯åŠ¨çœŸå®çš„çº¿ç¨‹å®ä¾‹</span></span><br><span class="line">                t.start();</span><br><span class="line">                <span class="comment">// æ ‡è®°çº¿ç¨‹å¯åŠ¨æˆåŠŸ</span></span><br><span class="line">                workerStarted = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">         <span class="comment">// çº¿ç¨‹å¯åŠ¨å¤±è´¥ï¼Œåˆ™éœ€è¦ä»å·¥ä½œçº¿ç¨‹é›†åˆç§»é™¤å¯¹åº”çš„Worker</span></span><br><span class="line">         <span class="keyword">if</span> (! workerStarted)</span><br><span class="line">          addWorkerFailed(w);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> workerStarted;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ Workerå¤±è´¥</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addWorkerFailed</span><span class="params">(Worker w)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock();</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (w != <span class="literal">null</span>)</span><br><span class="line">            <span class="comment">// ä»å·¥ä½œçº¿ç¨‹ç§»é™¤</span></span><br><span class="line">            workers.remove();</span><br><span class="line">        <span class="comment">// å·¥ä½œçº¿ç¨‹æ•°-1</span></span><br><span class="line">        decrementWorkerCount();</span><br><span class="line">        <span class="comment">// åŸºäºçŠ¶æ€å°è¯•ç»ˆæ­¢çº¿ç¨‹æ± </span></span><br><span class="line">        tryTerminate();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unLock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>addWorker()</code>æ–¹æ³•æ˜¯ç”¨æ¥æ·»åŠ æ‰§è¡Œä»»åŠ¡ï¼Œè¿™ä¸ªæµç¨‹å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†æ¥çœ‹ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯ç”¨äºè®°å½•çº¿ç¨‹æ•°é‡ï¼Œç¬¬äºŒéƒ¨åˆ†æ˜¯åœ¨ç‹¬å é”é‡Œåˆ›å»ºæ‰§è¡Œçº¿ç¨‹å¹¶å¯åŠ¨ã€‚æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>é¦–å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æ± çš„çŠ¶æ€æ˜¯å¦æ˜¯<code>SHUTDOWN</code>ã€<code>STOP</code>ã€<code>TIDYING</code>ã€<code>TERMINATED</code>ä¸­çš„ä¸€ä¸ªã€‚å¹¶ä¸”å½“å‰çŠ¶æ€ä¸º<code>SHUTDOWN</code>ã€ä¸”ä¼ å…¥çš„ä»»åŠ¡ä¸º<code>NULL</code>ã€åŒæ—¶ä»»åŠ¡é˜Ÿåˆ—ä¸ä¸ºç©ºã€‚é‚£ä¹ˆå°±è¿”å›<code>false</code>ã€‚</li><li>ä¸æ»¡è¶³ä¸Šä¸€ç‚¹ç„¶ååˆ¤æ–­çº¿ç¨‹æ•°æ˜¯å¦è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°æˆ–è€…æœ€å¤§çº¿ç¨‹æ•°ï¼ˆæ ¹æ®ä¼ å…¥çš„<code>core</code>åˆ¤æ–­ï¼‰ï¼Œå¦‚æœè¶…è¿‡åˆ™è¿”å›<code>false</code>ã€‚</li><li>ç„¶åé€šè¿‡<code>CAS</code>æ“ä½œå¢åŠ çº¿ç¨‹æ± æ•°é‡ï¼ŒæˆåŠŸè·³å‡ºå¾ªç¯ä½“ã€‚</li><li>çº¿ç¨‹æ± æ•°é‡è®°å½•æˆåŠŸä¹‹åï¼Œåˆ›å»ºå·¥ä½œå®ä¾‹ï¼Œä½¿ç”¨ç‹¬å é”åˆ›å»ºå·¥ä½œçº¿ç¨‹å¹¶åŠ å…¥åˆ°å·¥ä½œçº¿ç¨‹é›†åˆï¼Œå¹¶è®°å½•æ·»åŠ çŠ¶æ€ï¼Œæ·»åŠ æˆåŠŸåˆ™å¯åŠ¨å·¥ä½œçº¿ç¨‹ï¼Œè®°å½•å¯åŠ¨çŠ¶æ€ï¼Œå¦‚æœæœ€åå¯åŠ¨å¤±è´¥åˆ™è°ƒç”¨<code>addWorkerFailed()</code>æ–¹æ³•ç§»é™¤çº¿ç¨‹ç­‰æ“ä½œã€‚</li></ul><p>æµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://qtspace.cn/contentimg/45.jpg"></p><h4 id="å†…éƒ¨ç±»Workeræºç åˆ†æ"><a href="#å†…éƒ¨ç±»Workeræºç åˆ†æ" class="headerlink" title="å†…éƒ¨ç±»Workeræºç åˆ†æ"></a>å†…éƒ¨ç±»Workeræºç åˆ†æ</h4><p>çº¿ç¨‹æ± ä¸­çš„æ¯ä¸€ä¸ªå…·ä½“çš„å·¥ä½œçº¿ç¨‹è¢«åŒ…è£…ä¸ºå†…éƒ¨ç±»<code>Worker</code>å®ä¾‹ï¼Œ<code>Worker</code>ç»§æ‰¿ä¸<code>AQS</code>ï¼Œå®ç°äº†<code>Runnable</code>æ¥å£ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Worker</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronized</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">6138294804551838833L</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¿å­˜ThreadFactoryåˆ›å»ºçš„çº¿ç¨‹å®ä¾‹ï¼Œå¦‚æœåˆ›å»ºå¤±è´¥ä¸ºnull</span></span><br><span class="line">    <span class="keyword">final</span> Thread thread;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¿å­˜ä¼ å…¥çš„Runnableå®ä¾‹</span></span><br><span class="line">    Runnable firstTask;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®°å½•çº¿ç¨‹å®Œæˆçš„ä»»åŠ¡æ€»æ•°</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">long</span> completedTasks;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å”¯ä¸€æ„é€ æ–¹æ³•ï¼Œä¼ å…¥ä»»åŠ¡å®ä¾‹firstTask, å¯ä»¥ä¸ºnull</span></span><br><span class="line">    Worker(Runnable firstTask) &#123;</span><br><span class="line">        <span class="comment">// ç¦æ­¢çº¿ç¨‹ä¸­æ–­ï¼Œç›´åˆ°runWorkeræ–¹æ³•æ‰§è¡Œ</span></span><br><span class="line">        setState(-<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">this</span>.firstTask = firseTask;</span><br><span class="line">        <span class="built_in">this</span>.thread = getThreadFactory().newThread(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨å¤–éƒ¨çš„runWorkeræ–¹æ³•æ‰§è¡ŒçœŸæ­£çš„ä»»åŠ¡</span></span><br><span class="line">        runWorker(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ˜¯å¦æŒæœ‰ç‹¬å é”ï¼Œstate = 0è¡¨ç¤ºæ²¡æœ‰è·å–é”ï¼Œstate &gt; 0è¡¨ç¤ºè·å–é”</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isHeldExclusively</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getState() != <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°è¯•è·å–ç‹¬å é”</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> unused)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">            setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°è¯•é‡Šæ”¾ç‹¬å é”</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> unused)</span> &#123;</span><br><span class="line">        setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">        setState(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span>        &#123; acquire(<span class="number">1</span>); &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span>  &#123; <span class="keyword">return</span> tryAcquire(<span class="number">1</span>); &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span>      &#123; release(<span class="number">1</span>); &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isLocked</span><span class="params">()</span> &#123; <span class="keyword">return</span> isHeldExclusively(); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯åŠ¨åè¿›è¡Œçº¿ç¨‹ä¸­æ–­</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">interruptIfStarted</span><span class="params">()</span> &#123;</span><br><span class="line">        Thread t;</span><br><span class="line">        <span class="keyword">if</span> (getState() &gt;= <span class="number">0</span> &amp;&amp; (t = thread) != <span class="literal">null</span> &amp;&amp; !t.isInterrupted()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                t.interrupt();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SecurityException ignore) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Worker</code>çš„æ„é€ å‡½æ•°é‡Œé¢çš„é€»è¾‘ååˆ†é‡è¦ï¼Œé€šè¿‡<code>ThreadFactory</code>åˆ›å»º<code>Thread</code>å®ä¾‹åŒæ—¶å¼•å…¥<code>Worker</code>å®ä¾‹ï¼Œå› ä¸º<code>Worker</code>æœ¬èº«å®ç°äº†<code>Runnable</code>ï¼Œæ‰€ä»¥å¯ä»¥ä½œä¸ºä»»åŠ¡æäº¤åˆ°çº¿ç¨‹ä¸­æ‰§è¡Œã€‚åªè¦<code>Worker</code>æŒæœ‰çš„çº¿ç¨‹å®ä¾‹<code>w</code>è°ƒç”¨<code>Thread#start()</code>æ–¹æ³•å°±èƒ½æ‰§è¡Œ<code>Worker#run()</code>ã€‚ç®€åŒ–ä¸€ä¸‹é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// addWorker()æ–¹æ³•ä¸­æ„é€ </span></span><br><span class="line"><span class="type">Worker</span> <span class="variable">worker</span> <span class="operator">=</span> createWorker();</span><br><span class="line"><span class="comment">// é€šè¿‡çº¿ç¨‹æ± æ„é€ æ—¶å€™ä¼ å…¥</span></span><br><span class="line"><span class="type">ThreadFactory</span> <span class="variable">threadFactory</span> <span class="operator">=</span> getThreadFactory();</span><br><span class="line"><span class="comment">// Workeræ„é€ å‡½æ•°ä¸­</span></span><br><span class="line"><span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> threadFactory.newThread(worker);</span><br><span class="line"><span class="comment">// addWorker()æ–¹æ³•ä¸­å¯åŠ¨</span></span><br><span class="line">thread.start();</span><br></pre></td></tr></table></figure><p><code>Worker</code>ç»§æ‰¿<code>AQS</code>ï¼Œè¿™é‡Œä½¿ç”¨äº†<code>AQS</code>çš„ç‹¬å é”æ¨¡å¼ï¼Œè¿™é‡Œæœ‰ä¸ªæŠ€å·§æ˜¯æ„é€ <code>Worker</code>çš„æ—¶å€™ï¼ŒæŠŠ<code>AQS</code>èµ„æºçŠ¶æ€é€šè¿‡<code>setState(-1)</code>è®¾ç½®æˆ-1ï¼Œè¿™æ˜¯å› ä¸º<code>Wokrer</code>å®ä¾‹åˆšåˆ›å»ºæ—¶<code>AQS</code>ä¸­<code>state</code>çš„é»˜è®¤å€¼æ˜¯0ï¼Œæ­¤æ—¶çº¿ç¨‹å°šæœªå¯åŠ¨ï¼Œä¸èƒ½åœ¨è¿™ä¸ªæ—¶å€™è¿›è¡Œçº¿ç¨‹ä¸­æ–­ï¼Œè§<code>Worker#interruptIfStarted()</code>æ–¹æ³•ã€‚</p><h4 id="runWorkeræ–¹æ³•æºç åˆ†æ"><a href="#runWorkeræ–¹æ³•æºç åˆ†æ" class="headerlink" title="runWorkeræ–¹æ³•æºç åˆ†æ"></a>runWorkeræ–¹æ³•æºç åˆ†æ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">runWorker</span><span class="params">(Worker w)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰çº¿ç¨‹ï¼Œå®é™…ä¸Šå’ŒWokreræŒæœ‰çš„çº¿ç¨‹å®ä¾‹æ˜¯ç›¸åŒçš„</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">wt</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="comment">// è·å–workerä¸­æŒæœ‰çš„åˆå§‹åŒ–æ—¶ä¼ å…¥çš„ä»»åŠ¡å¯¹è±¡ï¼Œè¿™é‡Œå­˜æ”¾ä¸´æ—¶å˜é‡task</span></span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> w.firstTask;</span><br><span class="line">    <span class="comment">// è®¾ç½®Workerä¸­æŒæœ‰çš„åˆå§‹åŒ–æ—¶ä¼ å…¥çš„ä»»åŠ¡å¯¹è±¡ä¸ºnull</span></span><br><span class="line">    w.firstTask = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// æ„é€ æ–¹å¼çš„æ˜¯stateè®¾ç½®æˆ-1ï¼Œè¿™é‡Œè§£é”stateè®¾æˆä¸º0ï¼Œå…è®¸çº¿ç¨‹ä¸­æ–­</span></span><br><span class="line">    w.unlock(); <span class="comment">// allow interrupts</span></span><br><span class="line">    <span class="comment">// è®°å½•çº¿ç¨‹æ˜¯å¦å› ä¸ºç”¨æˆ·å¼‚å¸¸ç»ˆç»“</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">completedAbruptly</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–ä»»åŠ¡å¯¹è±¡ä¸ä¸ºç©ºæˆ–è€…ä»ä»»åŠ¡é˜Ÿåˆ—è·å–åˆ°çš„ä»»åŠ¡å¯¹è±¡ä¸ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">while</span> (task != <span class="literal">null</span> || (task = getTask()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// åŠ é”</span></span><br><span class="line">            w.lock();</span><br><span class="line">            <span class="comment">// å¦‚æœçº¿ç¨‹æ± æ­£åœ¨åœæ­¢çŠ¶æ€ï¼Œçº¿ç¨‹éœ€è¦ç»ˆæ­¢</span></span><br><span class="line">            <span class="keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</span><br><span class="line">                 (Thread.interrupted() &amp;&amp;</span><br><span class="line">                  runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</span><br><span class="line">                !wt.isInterrupted())</span><br><span class="line">                wt.interrupt();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// ä»»åŠ¡æ‰§è¡Œä¹‹å‰</span></span><br><span class="line">                beforeExecute(wt, task);</span><br><span class="line">                <span class="type">Throwable</span> <span class="variable">thrown</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">                    task.run();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RuntimeException x) &#123;</span><br><span class="line">                    thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Error x) &#123;</span><br><span class="line">                    thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">                    thrown = x; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(x);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// ä»»åŠ¡æ‰§è¡Œä¹‹å</span></span><br><span class="line">                    afterExecute(task, thrown);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// ä»»åŠ¡å¯¹è±¡è®¾ä¸ºnull</span></span><br><span class="line">                task = <span class="literal">null</span>;</span><br><span class="line">                <span class="comment">// å®Œæˆå·¥ä½œæ•°é‡+1</span></span><br><span class="line">                w.completedTasks++;</span><br><span class="line">                <span class="comment">// è§£é”</span></span><br><span class="line">                w.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ­£å¸¸å®Œæˆä»»åŠ¡</span></span><br><span class="line">        completedAbruptly = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// å¤„ç†çº¿ç¨‹é€€å‡ºï¼ŒcompletedAbruptlyä¸ºtrueè¯´æ˜ç”±äºç”¨æˆ·å¼‚å¸¸å¯¼è‡´çº¿ç¨‹éæ­£å¸¸é€€å‡º</span></span><br><span class="line">        processWorkerExit(w, completedAbruptly);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>runWorker</code>æ–¹æ³•çš„æ ¸å¿ƒæµç¨‹å¦‚ä¸‹ï¼š</p><ol><li><code>Worker</code>å…ˆæ‰§è¡Œè§£é”æ“ä½œï¼Œå…è®¸çº¿ç¨‹ä¸­æ–­ã€‚</li><li>é€šè¿‡<code>while</code>å¾ªç¯è°ƒç”¨<code>getTask()</code>æ–¹æ³•è·å–ä»»åŠ¡å¯¹è±¡ï¼Œé¦–è½®å¾ªç¯å¯èƒ½æ˜¯å¤–éƒ¨ä¼ å…¥çš„æ”¶ä¸ªä»»åŠ¡å¯¹è±¡ã€‚</li><li>å¦‚æœçº¿ç¨‹æ± çŠ¶æ€å˜ä¸º<code>STOP</code>çŠ¶æ€ï¼Œåˆ™éœ€è¦ç¡®ä¿å·¥ä½œçº¿ç¨‹æ˜¯ä¸­æ–­çŠ¶æ€å¹¶ä¸”è¿›è¡Œä¸­æ–­å¤„ç†ï¼Œå¦åˆ™è¦ä¿è¯å·¥ä½œçº¿ç¨‹ä¸æ˜¯ä¸­æ–­çŠ¶æ€ã€‚</li><li>æ‰§è¡Œä»»åŠ¡å®ä¾‹<code>Runnable#run()</code>æ–¹æ³•ï¼Œä»»åŠ¡æ‰§è¡Œä¹‹å‰å’Œä¹‹ååˆ†åˆ«ä¼šè°ƒç”¨<code>beforeExecute()</code>å’Œ<code>afterExecute()</code>ã€‚</li><li><code>while</code>å¾ªç¯è·³å‡ºè¯´æ˜ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ï¼Œç„¶åä¼šè°ƒç”¨<code>processWorkerExit()</code>æ–¹æ³•å¤„ç†å·¥ä½œçº¿ç¨‹é€€å‡ºåçš„å·¥ä½œã€‚</li></ol><p>åƒè¨€ä¸‡è¯­ä¸å¦‚ä¸€å›¾ï¼Œæµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://qtspace.cn/contentimg/46.jpg"></p><h4 id="getTaskæ–¹æ³•æºç è§£æ"><a href="#getTaskæ–¹æ³•æºç è§£æ" class="headerlink" title="getTaskæ–¹æ³•æºç è§£æ"></a>getTaskæ–¹æ³•æºç è§£æ</h4><p><code>getTask()</code>æ–¹æ³•æ˜¯å·¥ä½œçº¿ç¨‹åœ¨<code>while</code>æ­»å¾ªç¯ä¸­è·å–ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡å¯¹è±¡çš„æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Runnable <span class="title function_">getTask</span><span class="params">()</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®°å½•ä¸Šä¸€æ¬¡ä»é˜Ÿåˆ—ä¸­è·å–çš„æ—¶å€™æ˜¯å¦è¶…æ—¶</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">timeOut</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// å¾ªç¯</span></span><br><span class="line">    <span class="keyword">for</span>(;;) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">        <span class="comment">// è·å–çº¿ç¨‹æ± çŠ¶æ€</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> runStateOf(c);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¦‚æœçº¿ç¨‹æ± çŠ¶æ€è‡³å°‘ä¸ºSHUTDOWNï¼Œå¦‚æœçº¿ç¨‹æ± çŠ¶æ€STOPæˆ–è€…ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©º</span></span><br><span class="line">        <span class="comment">// åˆ™å·¥ä½œçº¿ç¨‹æ•°é‡wcå‡1ï¼Œç›´æ¥è¿”å›null</span></span><br><span class="line">        <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty()))&#123;</span><br><span class="line">            decrementWorkerCount();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è·å–å·¥ä½œçº¿ç¨‹æ•°</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">wc</span> <span class="operator">=</span> workerCountOf(c);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// timedä¸´æ—¶å˜é‡ç”¨äºçº¿ç¨‹è¶…æ—¶æ§åˆ¶ï¼Œå†³å®šæ˜¯å¦éœ€è¦é€šè¿‡poll()çš„éé˜»å¡æ–¹æ³•ä»ä»»åŠ¡é˜Ÿåˆ—è·å–ä»»åŠ¡</span></span><br><span class="line">        <span class="comment">// allowCoreThreadTimeOuté»˜è®¤ä¸ºfalseï¼Œå¦‚æœè®¾ç½®æˆtrue,åˆ™å…è®¸æ ¸å¿ƒçº¿ç¨‹ä¹Ÿèƒ½é€šè¿‡poll()æ–¹æ³•ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­æ‹‰å–ä»»åŠ¡</span></span><br><span class="line">        <span class="comment">// å·¥ä½œçº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°çš„æ—¶å€™ï¼Œè¯´æ˜çº¿ç¨‹æ± ä¸­åˆ›å»ºäº†é¢å¤–çš„éæ ¸å¿ƒçº¿ç¨‹ï¼Œè¿™äº›éæ ¸å¿ƒçº¿ç¨‹ä¸€å®šæ˜¯é€šè¿‡poll()æ–¹æ³•ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­æ‹‰å–ä»»åŠ¡</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">timed</span> <span class="operator">=</span> allowCoreThreadTimeOut || wc &gt; corePoolSize;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1.å·¥ä½œçº¿ç¨‹æ•°å¤§äºæœ€å¤§çº¿ç¨‹æ•°æˆ–è€…timed &amp;&amp; timedOut è¯´æ˜çº¿ç¨‹å‘½ä¸­äº†è¶…æ—¶æ§åˆ¶å¹¶ä¸”ä¸Šä¸€è½®å¾ªç¯é€šè¿‡poll()æ–¹æ³•ä»ä»»åŠ¡é˜Ÿåˆ—è·å–ä»»åŠ¡ä¸ºnull</span></span><br><span class="line">        <span class="comment">// å¹¶ä¸”å·¥ä½œçº¿ç¨‹æ€»æ•°å¤§äº1æˆ–è€…ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™é€šè¿‡CASæŠŠçº¿ç¨‹æ•°å‡å»1ï¼ŒåŒæ—¶è¿”å›null</span></span><br><span class="line">        <span class="keyword">if</span> ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))</span><br><span class="line">            &amp;&amp; (wc &gt; <span class="number">1</span> || workQueue.isEmpty())) &#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndDecrementWorkerCount(c))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœtimedä¸ºtrueï¼Œé€šè¿‡poll()æ–¹æ³•åšè¶…æ—¶æ‹‰å–ï¼ŒkeepAliveTimeæ—¶é—´å†…æ²¡æœ‰ç­‰å¾…åˆ°æœ‰æ•ˆçš„ä»»åŠ¡ï¼Œåˆ™è¿”å›null</span></span><br><span class="line">            <span class="comment">// å¦‚æœtimedä¸ºfalseï¼Œé€šè¿‡take()åšé˜»å¡æ‹‰å–ï¼Œä¼šé˜»å¡åˆ°æœ‰ä¸‹ä¸€ä¸ªæœ‰æ•ˆçš„ä»»åŠ¡æ—¶å€™å†è¿”å›ï¼ˆä¸€èˆ¬ä¸ä¼šæ˜¯nullï¼‰</span></span><br><span class="line">            <span class="type">Runnable</span> <span class="variable">r</span> <span class="operator">=</span> timed ? </span><br><span class="line">                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :</span><br><span class="line">            workQueue.take();</span><br><span class="line">            <span class="keyword">if</span> (r != <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> r;</span><br><span class="line">            timedCount  = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException retry) &#123;</span><br><span class="line">                timedOut = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œæœ‰ä¸¤å¤„ååˆ†å¤æ‚çš„<code>if</code>é€»è¾‘ï¼Œå…ˆæ¥çœ‹ç¬¬ä¸€å¤„ï¼Œå¯¹äºç¬¬ä¸€å¤„<code>if</code>å¯èƒ½å¯¼è‡´å·¥ä½œçº¿ç¨‹æ•°é‡å‡å»1ç›´æ¥è¿”å›<code>null</code>çš„åœºæ™¯æœ‰ï¼š</p><ul><li>çº¿ç¨‹æ± çŠ¶æ€ä¸º<code>SHUTDOWN</code>ï¼Œä¸€èˆ¬æ˜¯è°ƒç”¨äº†<code>shutdown()</code>æ–¹æ³•ï¼Œå¹¶ä¸”ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºã€‚</li><li>çº¿ç¨‹æ± çŠ¶æ€ä¸º<code>STOP</code>ã€‚</li></ul><p>å¯¹äºç¬¬äºŒå¤„<code>if</code>é€»è¾‘æœ‰ç‚¹å¤æ‚ï¼Œå…ˆæ‹†è§£ä¸€ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å·¥ä½œçº¿ç¨‹æ€»æ•°å¤§äºæœ€å¤§çº¿ç¨‹æ•°</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">b1</span> <span class="operator">=</span> wc &gt; maximumPoolSize;</span><br><span class="line"><span class="comment">// å…è®¸çº¿ç¨‹è¶…æ—¶åŒæ—¶ä¸Šä¸€è½®é€šè¿‡poll()æ–¹æ³•ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡ä¸ºnull</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">b2</span> <span class="operator">=</span> timed &amp;&amp; timedOut;</span><br><span class="line"><span class="comment">// ä½œçº¿ç¨‹æ€»æ•°å¤§äº1</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">b3</span> <span class="operator">=</span> wc &gt; <span class="number">1</span>;</span><br><span class="line"><span class="comment">// ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©º</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">b4</span> <span class="operator">=</span> workQueue.isEmpty();</span><br><span class="line"><span class="keyword">if</span> (r) &#123;</span><br><span class="line">    <span class="keyword">if</span> (compareAndDecrementWorkerCount(c))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µé€»è¾‘å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯é’ˆå¯¹éæ ¸å¿ƒçº¿ç¨‹çš„ã€‚åœ¨<code>execute()</code>æ–¹æ³•ä¸­ï¼Œçº¿ç¨‹æ€»æ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹å¹¶ä¸”å°äºæœ€å¤§çº¿ç¨‹æ•°æ—¶ï¼Œä¼šè°ƒç”¨<code>addWorker(task, false)</code>æ–¹æ³•æ·»åŠ éæ ¸å¿ƒçº¿ç¨‹ï¼Œè€Œè¿™é‡Œçš„é€»è¾‘æ°å¥½æ˜¯æƒ³æ³•çš„æ“ä½œï¼Œç”¨äºå‡å°‘éæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä½¿å¾—å·¥ä½œå¿åŸæ€»æ•°æ€»æ˜¯æ¥è¿‘äºæ ¸å¿ƒçº¿ç¨‹æ•°ã€‚å¦‚æœå¯¹äºæ ¸å¿ƒçº¿ç¨‹ï¼Œä¸Šä¸€è½®å¾ªç¯è·å–å¯¹è±¡ä¸º<code>null</code>ï¼Œè¿™ä¸€è½®å¾ªç¯å¾ˆå®¹æ˜“æ»¡è¶³<code>timed &amp;&amp; timedOut</code>ä¸º<code>true</code>ï¼Œè¿™ä¸ªæ—¶å€™<code>getTask()</code>è¿”å›<code>null</code>å¯¼è‡´<code>runWorker()</code>æ–¹æ³•è·³å‡ºå¾ªç¯ï¼Œæœ€åæ‰§è¡Œ<code>processWorkerExit()</code>æ–¹æ³•å¤„ç†å·¥ä½œï¼Œè€Œè¯¥éæ ¸å¿ƒçº¿ç¨‹å¯¹åº”çš„<code>Worker</code>åˆ™å˜æˆâ€œæ¸¸ç¦»å¯¹è±¡â€ï¼Œç­‰å¾…è¢«JVMå›æ”¶ã€‚å½“<code>allowCoreThreadTimeOut</code>è®¾ç½®ä¸º<code>true</code>çš„æ—¶å€™ï¼Œè¿™é‡Œåˆ†æçš„éæ ¸å¿ƒçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸç»ˆç»“é€»è¾‘åŒæ—¶ä¼šé€‚ç”¨äºæ ¸å¿ƒçº¿ç¨‹ï¼Œé‚£ä¹ˆå¯ä»¥æ€»ç»“å‡º<code>keepAliveTime</code>çš„æ„ä¹‰ï¼š</p><ul><li>å½“å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶ï¼Œä¹Ÿå°±æ˜¯<code>allowCoreThreadTimeOut</code>è®¾ç½®ä¸ºtrueçš„æ—¶å€™ï¼Œæ­¤æ—¶<code>keepAliveTime</code>è¡¨ç¤ºç©ºé—²çš„å·¥ä½œçº¿ç¨‹å­˜æ´»å‘¨æœŸã€‚</li><li>é»˜è®¤æƒ…å†µä¸‹ä¸å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶ï¼Œæ­¤æ—¶<code>keepAliveTime</code>è¡¨ç¤ºç©ºé—²çš„éæ ¸å¿ƒçº¿ç¨‹å­˜æ´»å‘¨æœŸã€‚</li></ul><h3 id="ä¸‰ã€æ‰‹å†™ä¸€ä¸ªçº¿ç¨‹æ± "><a href="#ä¸‰ã€æ‰‹å†™ä¸€ä¸ªçº¿ç¨‹æ± " class="headerlink" title="ä¸‰ã€æ‰‹å†™ä¸€ä¸ªçº¿ç¨‹æ± "></a>ä¸‰ã€æ‰‹å†™ä¸€ä¸ªçº¿ç¨‹æ± </h3><p>é€šè¿‡ä¸Šé¢å¯¹<code>ThreadPoolExecutor</code>çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹å†™ä¸€ä¸ªç®€å•çš„çº¿ç¨‹æ± ï¼ŒåŒ…å«äº†çº¿ç¨‹çš„æ ¸å¿ƒé€»è¾‘ï¼ŒåŒ…å«äº†æäº¤ä»»åŠ¡ï¼Œæ·»åŠ ä»»åŠ¡ï¼Œè·å–ä»»åŠ¡ï¼Œæ‰§è¡Œä»»åŠ¡æ ¸å¿ƒé€»è¾‘ã€‚</p><p>è¿™ä¸ªæ‰‹å†™çº¿ç¨‹æ± çš„é€»è¾‘ä¹Ÿéå¸¸ç®€å•ï¼Œåªä½“ç°æ ¸å¿ƒæµç¨‹ï¼ŒåŒ…æ‹¬ï¼š</p><ol><li>æœ‰nä¸ªä¸€ç›´æ‰§è¡Œçš„çº¿ç¨‹ã€‚</li><li>æŠŠçº¿ç¨‹æäº¤ç»™çº¿ç¨‹æ± è¿è¡Œã€‚</li><li>å¦‚æœçº¿ç¨‹æ± å·²æ»¡ï¼Œåˆ™æŠŠçº¿ç¨‹æ”¾å…¥é˜Ÿåˆ—ä¸­ã€‚</li><li>æœ€åå½“æœ‰ç©ºé—²æ—¶ï¼Œåˆ™è·å–é˜Ÿåˆ—ä¸­çº¿ç¨‹è¿›è¡Œè¿è¡Œã€‚</li></ol><p>ä»£ç å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolTrader</span> <span class="keyword">implements</span> <span class="title class_">Executor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">ctl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> corePoolSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> maximumPoolSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; workQueue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ThreadPoolTrader</span><span class="params">(<span class="type">int</span> corePoolSize, <span class="type">int</span> maximumPoolSize,</span></span><br><span class="line"><span class="params">                            BlockingQueue&lt;Runnable&gt; workQueue)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.corePoolSize = corePoolSize;</span><br><span class="line">        <span class="built_in">this</span>.maximumPoolSize = maximumPoolSize;</span><br><span class="line">        <span class="built_in">this</span>.workQueue = workQueue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">        <span class="keyword">if</span> (c &lt; corePoolSize) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!addWorker(command)) &#123;</span><br><span class="line">                reject();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!workQueue.offer(command)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!addWorker(command)) &#123;</span><br><span class="line">                reject();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">addWorker</span><span class="params">(Runnable firstTask)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ctl.get() &gt;= maximumPoolSize) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">Worker</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Worker</span>(firstTask);</span><br><span class="line">        worker.thread.start();</span><br><span class="line">        ctl.incrementAndGet();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Worker</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Thread thread;</span><br><span class="line">        Runnable firstTask;</span><br><span class="line"></span><br><span class="line">        Worker(Runnable firstTask) &#123;</span><br><span class="line">            <span class="built_in">this</span>.thread = <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="built_in">this</span>);</span><br><span class="line">            <span class="built_in">this</span>.firstTask = firstTask;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> firstTask;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (task != <span class="literal">null</span> || (task = getTask()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;å½“å‰æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ï¼š&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">                    task.run();</span><br><span class="line">                    <span class="keyword">if</span> (ctl.get() &gt; maximumPoolSize) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    task = <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                ctl.decrementAndGet();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Runnable <span class="title function_">getTask</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;workQueue.sizeï¼š&quot;</span> + workQueue.size());</span><br><span class="line">                <span class="keyword">return</span> workQueue.take();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">reject</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Errorï¼ctl.countï¼š&quot;</span> + ctl.get() + <span class="string">&quot; workQueue.sizeï¼š&quot;</span> + workQueue.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTrader</span> <span class="variable">threadPoolTrader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTrader</span>(<span class="number">2</span>, <span class="number">2</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;Runnable&gt;(<span class="number">10</span>));</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">finalI</span> <span class="operator">=</span> i;</span><br><span class="line">            threadPoolTrader.execute(() -&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">&quot;ä»»åŠ¡ç¼–å·ï¼š&quot;</span> + finalI);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç æµ‹è¯•å¦‚ä¸‹ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">å½“å‰æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ï¼šThread-1</span><br><span class="line">å½“å‰æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ï¼šThread-0</span><br><span class="line">ä»»åŠ¡ç¼–å·ï¼š1</span><br><span class="line">ä»»åŠ¡ç¼–å·ï¼š0</span><br><span class="line">workQueue.sizeï¼š8</span><br><span class="line">workQueue.sizeï¼š8</span><br><span class="line">å½“å‰æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ï¼šThread-0</span><br><span class="line">å½“å‰æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ï¼šThread-1</span><br><span class="line">ä»»åŠ¡ç¼–å·ï¼š3</span><br><span class="line">ä»»åŠ¡ç¼–å·ï¼š2</span><br><span class="line">workQueue.sizeï¼š6</span><br><span class="line">å½“å‰æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ï¼šThread-1</span><br><span class="line">workQueue.sizeï¼š6</span><br><span class="line">å½“å‰æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ï¼šThread-0</span><br><span class="line">ä»»åŠ¡ç¼–å·ï¼š5</span><br><span class="line">workQueue.sizeï¼š4</span><br><span class="line">å½“å‰æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ï¼šThread-0</span><br><span class="line">ä»»åŠ¡ç¼–å·ï¼š4</span><br><span class="line">workQueue.sizeï¼š3</span><br><span class="line">å½“å‰æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ï¼šThread-1</span><br><span class="line">ä»»åŠ¡ç¼–å·ï¼š6</span><br><span class="line">workQueue.sizeï¼š2</span><br><span class="line">å½“å‰æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ï¼šThread-0</span><br><span class="line">ä»»åŠ¡ç¼–å·ï¼š7</span><br><span class="line">workQueue.sizeï¼š1</span><br><span class="line">å½“å‰æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ï¼šThread-1</span><br><span class="line">ä»»åŠ¡ç¼–å·ï¼š8</span><br><span class="line">ä»»åŠ¡ç¼–å·ï¼š9</span><br><span class="line">workQueue.sizeï¼š0</span><br><span class="line">workQueue.sizeï¼š0</span><br></pre></td></tr></table></figure><h3 id="å››ã€åˆ›å»ºçº¿ç¨‹æ± çš„å››ç§æ–¹å¼"><a href="#å››ã€åˆ›å»ºçº¿ç¨‹æ± çš„å››ç§æ–¹å¼" class="headerlink" title="å››ã€åˆ›å»ºçº¿ç¨‹æ± çš„å››ç§æ–¹å¼"></a>å››ã€åˆ›å»ºçº¿ç¨‹æ± çš„å››ç§æ–¹å¼</h3><p><a href="https://qtspace.cn/2022/03/02/java-create-threadpool/" target="_blank">Java åˆ›å»ºçº¿ç¨‹æ± çš„å››ç§æ–¹å¼</a></p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> çº¿ç¨‹æ±  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ThreadçŠ¶æ€æµè½¬ã€æ–¹æ³•ä½¿ç”¨ã€åŸç†åˆ†æ</title>
      <link href="/2022/04/04/thread-state-use-principle/"/>
      <url>/2022/04/04/thread-state-use-principle/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h3 id="ä¸€ã€ThreadçŠ¶æ€"><a href="#ä¸€ã€ThreadçŠ¶æ€" class="headerlink" title="ä¸€ã€ThreadçŠ¶æ€"></a>ä¸€ã€ThreadçŠ¶æ€</h3><p><code>Java</code>çš„çº¿ç¨‹çŠ¶æ€æè¿°åœ¨<code>Thread</code>ç±»é‡Œé¢çš„æšä¸¾ç±»<code>State</code>ä¸­ï¼ŒåŒ…è·¯å¾„ä¸º<code>java.lang.Thread.State</code>ï¼Œæ€»å…±åŒ…å«ä»¥ä¸‹å…­ç§çŠ¶æ€ï¼š<code>NEW</code>ã€<code>RUNNABLE</code>ã€<code>BLOCKED</code>ã€<code>WAITING</code>ã€<code>TIMED_WAITING</code>ã€<code>TERMINATED</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">State</span> &#123;</span><br><span class="line">    <span class="comment">// å°šæœªå¯åŠ¨çš„çº¿ç¨‹çš„çº¿ç¨‹çŠ¶æ€</span></span><br><span class="line">    NEW,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¯è¿è¡Œçº¿ç¨‹çš„çº¿ç¨‹çŠ¶æ€ï¼Œæ˜¯å¯è¿è¡Œçš„çº¿ç¨‹</span></span><br><span class="line">    <span class="comment">// è¿™ä¸ªçŠ¶æ€åœ¨Javaè™šæ‹Ÿæœºä¸­è¿›è¡Œï¼Œä½†å®ƒå¯èƒ½ç­‰å¾…æ¥è‡ªæ“ä½œç³»ç»Ÿçš„å…¶ä»–èµ„æºï¼Œæ¯”å¦‚å¤„ç†å™¨</span></span><br><span class="line">    RUNNABLE,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// çº¿ç¨‹é˜»å¡ç­‰å¾…ç›‘è§†å™¨é”çš„çº¿ç¨‹çŠ¶æ€</span></span><br><span class="line">    <span class="comment">// å¤„äºé˜»å¡çŠ¶æ€çš„çº¿ç¨‹æ­£åœ¨ç­‰å¾…ç›‘è§†å™¨é”</span></span><br><span class="line">    <span class="comment">// ä¾‹å¦‚synchronizedé”</span></span><br><span class="line">    BLOCKED,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç­‰å¾…çº¿ç¨‹çš„çº¿ç¨‹çŠ¶æ€</span></span><br><span class="line">    <span class="comment">// çº¿ç¨‹è°ƒç”¨ä»¥ä¸‹æ–¹æ³•ä¼šå¤„äºç­‰å¾…çŠ¶æ€ï¼šObject.wait()ä¸è¶…æ—¶ã€Thread.join()ä¸è¶…æ—¶ã€LockSupport.park()</span></span><br><span class="line">    <span class="comment">// ä¸€ä¸ªå¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹æ­£åœ¨ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç‰¹å®šåŠ¨ä½œï¼Œä¾‹å¦‚ï¼š</span></span><br><span class="line">    <span class="comment">// ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº†Object.wait()æ–¹æ³•åœ¨ä¸€ä¸ªå¯¹è±¡ä¸Šæ­£åœ¨ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨Object.nofify()æˆ–è€…</span></span><br><span class="line">    <span class="comment">// Object.nofifyAll()æ–¹æ³•å¼€å¯é‚£ä¸ªå¯¹è±¡</span></span><br><span class="line">    <span class="comment">// ä¸€ä¸ªè°ƒç”¨äº†Thread.join()æ–¹æ³•çš„çº¿ç¨‹æ­£åœ¨ç­‰å¾…æŒ‡å®šçº¿ç¨‹ç»ˆæ­¢</span></span><br><span class="line">    WAITING,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å…·æœ‰æŒ‡å®šç­‰å¾…æ—¶é—´çš„ç­‰å¾…çº¿ç¨‹çš„çº¿ç¨‹çŠ¶æ€ï¼Œè°ƒç”¨ä¸€ä¸‹æ–¹æ³•ä¼šå¤„äºè¿™ä¸ªçŠ¶æ€ï¼š</span></span><br><span class="line">    <span class="comment">// Object.wait() è¶…æ—¶ã€Thread.join()è¶…æ—¶</span></span><br><span class="line">    <span class="comment">// LockSupport.parkNanos()ã€LockSupport.parkUntil()</span></span><br><span class="line">    TIMED_WAITING,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å·²ç»ˆæ­¢çº¿ç¨‹çš„çº¿ç¨‹çŠ¶æ€</span></span><br><span class="line">    <span class="comment">// çº¿ç¨‹å·²æ‰§è¡Œå®Œæ¯•æˆ–è€…å‘ç”Ÿå¼‚å¸¸ç»ˆæ­¢</span></span><br><span class="line">    TERMINATED</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„å…­ç§çŠ¶æ€ç›¸å½“äºæè¿°äº†ä¸€ä¸ªçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼Œè¿™äº›çŠ¶æ€ä¹‹é—´æ˜¯å¯ä»¥æµè½¬çš„ï¼Œé‚£ä¹ˆçº¿ç¨‹çš„çŠ¶æ€æ˜¯å¦‚ä½•æµè½¬çš„å‘¢ï¼Œæˆ‘ä»¬çœ‹ä¸‹å›¾ï¼š</p><p><img src="https://qtspace.cn/contentimg/41.jpg"></p><ul><li><p><code>NEW</code>ï¼šæœªå¯åŠ¨çŠ¶æ€ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// è¿™ä¸ªæ—¶å€™åªæ˜¯newäº†ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶æ²¡æœ‰è°ƒç”¨start()æ–¹æ³•</span></span><br><span class="line">    <span class="comment">// è¾“å‡º NEW</span></span><br><span class="line">    System.out.println(t.getState().name());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>RUNNABLE</code>ï¼šå¯è¿è¡ŒçŠ¶æ€ï¼Œå¤„äºå¯è¿è¡ŒçŠ¶æ€çš„çº¿ç¨‹æ­£åœ¨<code>Java</code>è™šæ‹Ÿæœºä¸­è¿è¡Œï¼Œä½†ä¹Ÿå¯èƒ½æ˜¯æ­£åœ¨ç­‰å¾…æ¥è‡ªæ“ä½œç³»ç»Ÿèµ„æºï¼Œæ¯”å¦‚CPUã€‚åœ¨<code>RUNNABLE</code>çŠ¶æ€ä¸­åŒ…å«äº†<code>RUNNING</code>ã€<code>READY</code>ä¸¤ä¸ªçŠ¶æ€ï¼Œè¿™ä¸¤ä¸ªçŠ¶æ€æ˜¯å¯ä»¥äº’ç›¸æµè½¬çš„ã€‚å½“çº¿ç¨‹è°ƒç”¨<code>start()</code>æ–¹æ³•åï¼Œçº¿ç¨‹å°±å¤„äº<code>READY</code>çŠ¶æ€ï¼Œç­‰å¾…æ“ä½œç³»ç»Ÿåˆ†é…<code>CPU</code>æ—¶é—´ç‰‡ï¼Œåˆ†é…åè¿›å…¥<code>RUNNING</code>çŠ¶æ€ã€‚å½“è°ƒç”¨<code>yield()</code>æ–¹æ³•åï¼Œåªæ˜¯è°¦è®©çš„å…è®¸å½“å‰çº¿ç¨‹è®©å‡º<code>CPU</code>ï¼Œä½†æ˜¯ä¸ä¸€å®šè®©ï¼Œç”±æ“ä½œç³»ç»Ÿå†³å®šï¼Œå¦‚æœè®©äº†å½“å‰çº¿ç¨‹å°±ä¼šè¿›å…¥<code>READY</code>çŠ¶æ€ï¼Œç­‰å¾…ç³»ç»Ÿåˆ†é…<code>CPU</code>æ—¶é—´ç‰‡å†æ¬¡è¿›å…¥<code>RUNNING</code>çŠ¶æ€ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    t.start();</span><br><span class="line">    <span class="comment">// è°ƒç”¨start()æ–¹æ³•</span></span><br><span class="line">    <span class="comment">// è¾“å‡ºRUNNABLE</span></span><br><span class="line">    System.out.println(t.getState().name());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>BLOCKED</code>ï¼šé˜»å¡çŠ¶æ€ã€‚å½“å‘ç”Ÿçº¿ç¨‹é”ç«äº‰çŠ¶æ€ä¸‹ï¼Œæ²¡æœ‰è·å–åˆ°é”çš„çº¿ç¨‹ä¼šè¢«æŒ‚èµ·è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œæ¯”å¦‚<code>synchronized</code>é”ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock)&#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="comment">// mainçº¿ç¨‹å…ˆè·å–é”ï¼Œ tçº¿ç¨‹startçš„æ—¶å€™è¿›å…¥é˜»å¡çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">        t.start();</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="comment">// è¾“å‡ºBLOCKED</span></span><br><span class="line">        System.out.println(t.getState().name());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>WIITING</code>ï¼šç­‰å¾…çŠ¶æ€ï¼Œå¯è¢«å”¤é†’çš„ç­‰å¾…çŠ¶æ€ï¼Œæ­¤æ—¶çº¿ç¨‹ä¸ä¼šæ‰§è¡Œä¹Ÿä¸ä¼šè¢«è°ƒåº¦ï¼Œï¼šå¯è¢«å”¤é†’çš„ç­‰å¾…çŠ¶æ€ï¼Œæ­¤æ—¶çº¿ç¨‹ä¸ä¼šè¢«æ‰§è¡Œä¹Ÿä¸ä¼šè¢«ç³»ç»Ÿè°ƒåº¦ï¼Œæ­¤çŠ¶æ€å¯ä»¥é€šè¿‡ synchronized è·å¾—é”ï¼Œè°ƒç”¨ wait æ–¹æ³•è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œæœ€åé€šè¿‡<code>Object.notify()</code>ã€<code>Object.nofifyAll()</code>å”¤é†’ã€‚ä¸‹åˆ—æ–¹æ³•å¯ä»¥è®©çº¿ç¨‹è¿›å…¥<code>WAITING</code>çŠ¶æ€ï¼š<code>Object.wait()</code>ã€<code>Thread.join()</code>ã€<code>LockSupport.park()</code>ï¼Œè°ƒç”¨ä»¥ä¸‹æ–¹æ³•å¯ä»¥å”¤é†’ç™»å°çš„çº¿ç¨‹è¿›å…¥<code>RUNNABLE</code>çŠ¶æ€ï¼š<code>Object.notify()</code>ã€<code>Object.nofifyAll()</code>ã€<code>LockSupport.unpark(Thread)</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                    lock.wait();</span><br><span class="line">                    System.out.println(Thread.currentThread().getName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    t.start();</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">        <span class="comment">// è¾“å‡ºWAITING</span></span><br><span class="line">        System.out.println(t.getState().name());</span><br><span class="line">        lock.notify();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>TIMED_WAITING</code>ï¼šå…·æœ‰ç­‰å¾…æ—¶é—´çš„ç­‰å¾…çŠ¶æ€ï¼Œæ­¤æ—¶çº¿ç¨‹ä¸ä¼šæ‰§è¡Œä¹Ÿä¸ä¼šè¢«è°ƒåº¦ï¼Œç›´åˆ°ç­‰å¾…æ—¶é—´åˆ°æœŸåæ‰ä¼šè¢«æ‰§è¡Œã€‚ä¸‹åˆ—æ–¹æ³•å¯ä»¥è®©çº¿ç¨‹è¿›å…¥<code>TIMED_WAITING</code>çŠ¶æ€ï¼š<code>Thread.sleep(long)</code>ã€<code>Object.wait(long)</code>ã€<code>Thread.join(long)</code>ã€<code>LockSupport.parkNanos()</code>ã€<code>LockSupport.parkUntil()</code>ã€‚é™¤äº†ç­‰å¾…æ—¶é—´åˆ°æœŸä¼šè¢«æ‰§è¡Œå¤–ï¼Œè¿˜å¯ä»¥è°ƒç”¨ä»¥ä¸‹æ–¹æ³•ï¼š<code>Object.notify()</code>ã€<code>Object.nofifyAll()</code>ã€<code>LockSupport.unpark(Thread)</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt;&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    t.start();</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    <span class="comment">// è¾“å‡ºTIMED_WAITING</span></span><br><span class="line">    System.out.println(t.getState().name());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>TERMINATED</code>ï¼šå·²ç»ˆæ­¢çŠ¶æ€ï¼Œçº¿ç¨‹å·²å®Œæˆæ‰§è¡Œæˆ–è€…å‘ç”Ÿäº†å¼‚å¸¸ç»ˆæ­¢ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    t.start();</span><br><span class="line">    <span class="comment">// è¾“å‡º TERMINATED</span></span><br><span class="line">    System.out.println(t.getState().name());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="äºŒã€åˆ›å»ºThreadæ–¹å¼"><a href="#äºŒã€åˆ›å»ºThreadæ–¹å¼" class="headerlink" title="äºŒã€åˆ›å»ºThreadæ–¹å¼"></a>äºŒã€åˆ›å»ºThreadæ–¹å¼</h3><p>åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼æœ‰ä¸‰ç§ï¼Œåˆ†åˆ«æ˜¯ï¼šç»§æ‰¿<code>Thread</code>ç±»ã€å®ç°<code>Runnable</code>æ¥å£ã€å®ç°<code>Callable</code>æ¥å£å’Œä½¿ç”¨<code>Future</code>ã€‚</p><h4 id="ç»§æ‰¿Thread"><a href="#ç»§æ‰¿Thread" class="headerlink" title="ç»§æ‰¿Thread"></a>ç»§æ‰¿Thread</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å®ç°Runnable"><a href="#å®ç°Runnable" class="headerlink" title="å®ç°Runnable"></a>å®ç°Runnable</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å®ç°Callableæ¥å£å’Œä½¿ç”¨Future"><a href="#å®ç°Callableæ¥å£å’Œä½¿ç”¨Future" class="headerlink" title="å®ç°Callableæ¥å£å’Œä½¿ç”¨Future"></a>å®ç°Callableæ¥å£å’Œä½¿ç”¨Future</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadDemo</span> <span class="keyword">implements</span> <span class="title class_">Callable</span> &#123;</span><br><span class="line">    </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">call</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;str&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ThreadDemo</span> <span class="variable">threadDemo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadDemo</span>();</span><br><span class="line">        FutureTask&lt;String&gt; future = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;String&gt;(threadDemo);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(future);</span><br><span class="line">        thread.start();</span><br><span class="line">        System.out.println(future.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¸‰ã€Threadæ–¹æ³•ä½¿ç”¨"><a href="#ä¸‰ã€Threadæ–¹æ³•ä½¿ç”¨" class="headerlink" title="ä¸‰ã€Threadæ–¹æ³•ä½¿ç”¨"></a>ä¸‰ã€Threadæ–¹æ³•ä½¿ç”¨</h3><p><code>Thread</code>ç±»å¸¸ç”¨çš„æ–¹æ³•æœ‰ä»¥ä¸‹ï¼š</p><ul><li><code>start()</code>ï¼šå¯åŠ¨å½“å‰çº¿ç¨‹ã€‚</li><li><code>run()</code>ï¼šçº¿ç¨‹å¯åŠ¨çš„æ—¶å€™æ‰§è¡Œçš„æ–¹æ³•ã€‚</li><li><code>currentThread()</code>ï¼šé™æ€æ–¹æ³•ï¼Œè¿”å›æ‰§è¡Œå½“å‰ä»£ç çš„çº¿ç¨‹ã€‚</li><li><code>getName()</code>ï¼šè·å–å½“å‰çº¿ç¨‹çš„åå­—ã€‚</li><li><code>setName(String name)</code>ï¼šè®¾ç½®å½“å‰çº¿ç¨‹çš„åå­—</li><li><code>yield()</code>ï¼šé‡Šæ”¾å½“å‰CPUçš„æ‰§è¡Œæƒï¼ˆä½†ä¹Ÿæœ‰å¯èƒ½ä¸‹ä¸€åˆ»çš„æ‰§è¡Œæƒåˆå›åˆ°äº†å½“å‰çº¿ç¨‹ï¼Œä¸»æ§æƒè¿˜æ˜¯åœ¨CPUæ‰‹ä¸Šï¼‰ã€‚</li><li><code>join()</code>ï¼šå½“çº¿ç¨‹aè°ƒç”¨çº¿ç¨‹bçš„<code>join()</code>æ–¹æ³•ï¼Œæ­¤æ—¶çº¿ç¨‹aè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç›´åˆ°çº¿ç¨‹bå®Œå…¨æ‰§è¡Œå®Œä¹‹åï¼Œçº¿ç¨‹aç»“æŸé˜»å¡çŠ¶æ€ã€‚</li><li><code>stop</code>ï¼šå½“æ‰§è¡Œæ­¤æ–¹æ³•æ—¶ï¼Œå¼ºåˆ¶ç»“æŸå½“å‰çº¿ç¨‹ï¼ˆ<strong>å·²åœç”¨</strong>ï¼‰ã€‚</li><li><code>sleep()</code>ï¼šè®©å½“å‰çº¿ç¨‹â€œç¡çœ â€æŒ‡å®šçš„millitime<strong>æ¯«ç§’</strong>ã€‚åœ¨æŒ‡å®šçš„millitimeæ¯«ç§’æ—¶é—´å†…ï¼Œå½“å‰è¿›ç¨‹æ˜¯é˜»å¡çŠ¶æ€ã€‚</li><li><code>getPriority()</code>ï¼šè·å–çº¿ç¨‹ä¼˜å…ˆçº§ã€‚</li><li><code>isAlive()</code>ï¼šåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦å­˜æ´»ï¼ˆçº¿ç¨‹æ‰§è¡Œå®Œä¹‹å‰éƒ½æ˜¯å­˜æ´»çš„ï¼‰ã€‚</li><li><code>setDeamon()</code>ï¼šè®¾ç½®å®ˆæŠ¤çº¿ç¨‹ã€‚</li><li><code>isDaemon()</code>ï¼šæ˜¯å¦æ˜¯å®ˆæŠ¤çº¿ç¨‹ã€‚</li><li><code>isInterrupted()</code>ï¼šçº¿ç¨‹æ˜¯å¦ä¸­æ–­ã€‚</li></ul><h4 id="å®ˆæŠ¤çº¿ç¨‹"><a href="#å®ˆæŠ¤çº¿ç¨‹" class="headerlink" title="å®ˆæŠ¤çº¿ç¨‹"></a>å®ˆæŠ¤çº¿ç¨‹</h4><p>å®ˆæŠ¤çº¿ç¨‹åˆç§°åå°çº¿ç¨‹ï¼Œé»˜è®¤åˆ›å»ºå‡ºæ¥çš„çº¿ç¨‹éƒ½æ˜¯å‰å°çº¿ç¨‹ï¼Œå¯ä»¥é€šè¿‡<code>setDeamon(true)</code>è®¾å®šä¸ºåå°çº¿ç¨‹ã€‚</p><p>åå°çº¿ç¨‹å’Œå‰å°çº¿ç¨‹ä¸»è¦åŒºåˆ†åœ¨ç»“æŸæ—¶æœºï¼šå½“ä¸€ä¸ªè¿›ç¨‹ä¸­çš„æ‰€æœ‰å‰å°çº¿ç¨‹éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œæ— è®ºè¿›ç¨‹ä¸­çš„åå°çº¿ç¨‹æ˜¯å¦æ‰§è¡Œå®Œæ¯•ï¼Œéƒ½è¦å¼ºåˆ¶ä¸­æ–­ã€‚</p><p>çœ‹ä»¥ä¸‹ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">rose</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt;&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;Rose:å•Šå•Šå•Šå•Šå•ŠAAAAAaaaaa......&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;æ•ˆæœï¼šå™—é€š......&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">jack</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt;&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;Jack:You jump,I jump&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// jackçº¿ç¨‹è®¾ç½®ä¸ºåå°çº¿ç¨‹, ä¸€å®šè¦åœ¨start()æ–¹æ³•ä¹‹å‰è°ƒç”¨</span></span><br><span class="line">    jack.setDaemon(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    rose.start();;</span><br><span class="line">    jack.start();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//while(true);//æœ‰è¿›ç¨‹æ²¡ç»“æŸï¼Œåå°çº¿ç¨‹ä¸ä¼šç»“æŸã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Jack:You jump,I jump</span><br><span class="line">Rose:Let me go die!</span><br><span class="line">Rose:Let me go die!</span><br><span class="line">Jack:You jump,I jump</span><br><span class="line">Jack:You jump,I jump</span><br><span class="line">Rose:Let me go die!</span><br><span class="line">Jack:You jump,I jump</span><br><span class="line">Rose:Let me go die!</span><br><span class="line">Rose:Let me go die!</span><br><span class="line">Jack:You jump,I jump</span><br><span class="line">Jack:You jump,I jump</span><br><span class="line">Rose:Let me go die!</span><br><span class="line">Jack:You jump,I jump</span><br><span class="line">Rose:Let me go die!</span><br><span class="line">Jack:You jump,I jump</span><br><span class="line">Rose:Let me go die!</span><br><span class="line">Rose:Let me go die!</span><br><span class="line">Jack:You jump,I jump</span><br><span class="line">Jack:You jump,I jump</span><br><span class="line">Rose:Let me go die!</span><br><span class="line">Rose:å•Šå•Šå•Šå•Šå•ŠAAAAAaaaaa......</span><br><span class="line">æ•ˆæœï¼šå™—é€š......</span><br></pre></td></tr></table></figure><p>ä»è¾“å‡ºå¯ä»¥çœ‹å‡ºå‰å°çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œåå°çº¿ç¨‹å°±ç«‹å³åœæ­¢äº†ï¼Œå¦‚æœæŠŠ<code>while(true)</code>å»æ‰æ³¨é‡Šï¼Œé‚£ä¹ˆåå°çº¿ç¨‹ä¼šä¸€ç›´æ‰§è¡Œã€‚</p><h4 id="sleep"><a href="#sleep" class="headerlink" title="sleep"></a>sleep</h4><p><code>sleep()</code>æ–¹æ³•å¯ä»¥ä½¿å½“å‰æ–¹æ³•çš„çº¿ç¨‹é˜»å¡æŒ‡å®šæ¯«ç§’ï¼Œè¶…æ—¶åï¼Œè¯¥çº¿ç¨‹æ–¹æ³•ä¼šè‡ªåŠ¨å›åˆ°<code>RUNNABLE</code>çŠ¶æ€ç­‰å¾…å†æ¬¡åˆ†é…æ—¶é—´ç‰‡æ‰§è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;ç¨‹åºå¼€å§‹äº†&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment"> * è¿™é‡Œä¼šä½¿mainçº¿ç¨‹é˜»å¡5ç§’ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­</span></span><br><span class="line"><span class="comment"> * è‹¥å…¶ä»–çº¿ç¨‹è°ƒç”¨äº†mainçº¿ç¨‹çš„interruptæ–¹æ³•</span></span><br><span class="line"><span class="comment"> * è¯•å›¾ä¸­æ–­mainçº¿ç¨‹æ—¶ï¼Œsleepæ–¹æ³•ä¼šæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">    &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;ç¨‹åºç»“æŸäº†&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="join"><a href="#join" class="headerlink" title="join"></a>join</h4><p><code>join()</code>æ–¹æ³•ä¼šé˜»å¡è°ƒç”¨å½“å‰æ–¹æ³•çš„çº¿ç¨‹ï¼Œå¹¶åœ¨<code>join()</code>æ–¹æ³•æ‰€å±å¯¹è±¡çº¿ç¨‹ä¸Šç­‰å¾…ï¼Œç›´åˆ°è¯¥çº¿ç¨‹æ‰§è¡Œå®Œæ¯•æ‰ä¼šè§£é™¤é˜»å¡ç»§ç»­æ‰§è¡Œã€‚</p><p>ä¸¾ä¸ªæ —å­ï¼šaçº¿ç¨‹è°ƒç”¨bçº¿ç¨‹çš„<code>join()</code>æ–¹æ³•ï¼Œé‚£ä¹ˆaçº¿ç¨‹å°±ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç›´åˆ°bçº¿ç¨‹æ‰§è¡Œå®Œæ¯•æ‰ä¼šè§£é™¤é˜»å¡ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¸‹è½½å›¾ç‰‡çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">download</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt;&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;downloadï¼šå¼€å§‹ä¸‹è½½ç…§ç‰‡&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">100</span>; i++) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;ä¸‹è½½è¿›åº¦:&quot;</span>+i+<span class="string">&quot;%&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">500</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;downloadï¼šå›¾ç‰‡ä¸‹è½½å®Œæ¯•&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ˜¾ç¤ºå›¾ç‰‡çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">show</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt;&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;showï¼šå¼€å§‹æ˜¾ç¤ºå›¾ç‰‡&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// åªæœ‰å›¾ç‰‡ä¸‹è½½å®Œæ¯•ä¹‹åæ‰èƒ½æ˜¾ç¤ºå›¾ç‰‡</span></span><br><span class="line">                <span class="comment">// è°ƒç”¨ä¸‹è½½å›¾ç‰‡çº¿ç¨‹çš„join()æ–¹æ³•é˜»å¡æ˜¾ç¤ºå›¾ç‰‡çº¿ç¨‹ç›´åˆ°å›¾ç‰‡ä¸‹è½½å®Œæ¯•</span></span><br><span class="line">                download.join();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;showï¼šå›¾ç‰‡æ˜¾ç¤ºå®Œæ¯•&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        download.start();</span><br><span class="line">        show.start();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">showï¼šå¼€å§‹æ˜¾ç¤ºå›¾ç‰‡</span><br><span class="line">downloadï¼šå¼€å§‹ä¸‹è½½ç…§ç‰‡</span><br><span class="line">ä¸‹è½½è¿›åº¦:1<span class="comment">%</span></span><br><span class="line">ä¸‹è½½è¿›åº¦ï¼š...</span><br><span class="line">ä¸‹è½½è¿›åº¦:100<span class="comment">%</span></span><br><span class="line">downloadï¼šå›¾ç‰‡ä¸‹è½½å®Œæ¯•</span><br><span class="line">showï¼šå›¾ç‰‡æ˜¾ç¤ºå®Œæ¯•</span><br></pre></td></tr></table></figure><h4 id="wait-amp-nofify"><a href="#wait-amp-nofify" class="headerlink" title="wait &amp; nofify"></a>wait &amp; nofify</h4><p><code>wait()</code>å’Œ<code>notify()</code>æ–¹æ³•æ˜¯åœ¨<code>Object</code>ç±»å®šä¹‰çš„ï¼Œç”¨æ¥åè°ƒçº¿ç¨‹åŒæ­¥ä½¿ç”¨ï¼Œç›¸æ¯”<code>join()</code>åŒæ­¥çš„åŠæ—¶æ€§æ›´å¼ºï¼Œå› ä¸º<code>join()</code>æ–¹æ³•å¿…é¡»ç­‰å¾…å¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„æ‰€æœ‰å·¥ä½œéƒ½ç»“æŸã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> isFinish;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"><span class="comment">// ä¸‹è½½å›¾ç‰‡çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">download</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt;&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;downloadï¼šå¼€å§‹ä¸‹è½½ç…§ç‰‡&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">100</span>; i++) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;downå›¾ç‰‡è¿›åº¦:&quot;</span>+i+<span class="string">&quot;%&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;downloadï¼šå›¾ç‰‡ä¸‹è½½å®Œæ¯•&quot;</span>);</span><br><span class="line">        isFinish = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// å›¾ç‰‡ä¸‹è½½å®Œæ¯•å°±å¯ä»¥é€šçŸ¥æ˜¾ç¤ºå›¾ç‰‡çº¿ç¨‹æ˜¾ç¤ºå›¾ç‰‡, æ²¡å¿…è¦ç­‰ä¸‹è½½é™„ä»¶æ‰§è¡Œå®Œæ¯•</span></span><br><span class="line">        <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">            obj.notify();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¼€å§‹ä¸‹è½½é™„ä»¶</span></span><br><span class="line">        System.out.println(<span class="string">&quot;downï¼šå¼€å§‹ä¸‹è½½é™„ä»¶...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">100</span>; i++) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;downé™„ä»¶è¿›åº¦ï¼š&quot;</span> + i + <span class="string">&quot;%&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">50</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;downï¼šé™„ä»¶ä¸‹è½½å®Œæ¯•!&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¾ç¤ºå›¾ç‰‡çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">show</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt;&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;showï¼šå¼€å§‹æ˜¾ç¤ºå›¾ç‰‡&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// obj.wait()æ–¹æ³•ä¼šå¯¼è‡´showçº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ç›´åˆ°objè°ƒç”¨notify()æ–¹æ³•</span></span><br><span class="line">            <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">                obj.wait();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!isFinish) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;å›¾ç‰‡ä¸å­˜åœ¨!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;showï¼šå›¾ç‰‡æ˜¾ç¤ºå®Œæ¯•&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    download.start();</span><br><span class="line">    show.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">showï¼šå¼€å§‹æ˜¾ç¤ºå›¾ç‰‡</span><br><span class="line">downloadï¼šå¼€å§‹ä¸‹è½½ç…§ç‰‡</span><br><span class="line">downå›¾ç‰‡è¿›åº¦:1<span class="comment">%</span></span><br><span class="line">downå›¾ç‰‡è¿›åº¦:...</span><br><span class="line">downå›¾ç‰‡è¿›åº¦:100<span class="comment">%</span></span><br><span class="line">downloadï¼šå›¾ç‰‡ä¸‹è½½å®Œæ¯•</span><br><span class="line">downï¼šå¼€å§‹ä¸‹è½½é™„ä»¶...</span><br><span class="line">showï¼šå›¾ç‰‡æ˜¾ç¤ºå®Œæ¯•</span><br><span class="line">downé™„ä»¶è¿›åº¦ï¼š1<span class="comment">%</span></span><br><span class="line">downé™„ä»¶è¿›åº¦ï¼š...</span><br><span class="line">downé™„ä»¶è¿›åº¦ï¼š100<span class="comment">%</span></span><br><span class="line">downï¼šé™„ä»¶ä¸‹è½½å®Œæ¯•!</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢è¾“å‡ºæˆ‘ä»¬çœ‹å‡ºå½“ä¸‹è½½çº¿ç¨‹å›¾ç‰‡ä¸‹è½½å®Œæ¯•ä¹‹åï¼Œæ˜¾ç¤ºå›¾ç‰‡çº¿ç¨‹å°±æ‰§è¡Œäº†ï¼Œä¸éœ€è¦ç­‰å¾…é™„ä»¶ä¸‹è½½å®Œæ¯•å†æ‰§è¡Œã€‚</p><p><code>Oject</code>è¿˜æœ‰ä¸€ä¸ª<code>notifyAll()</code>æ–¹æ³•ï¼Œå½“è¯¥æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œç­‰å¾…é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å¯¹è±¡éƒ½è¢«ä¼šå”¤é†’ã€‚</p><h4 id="yield"><a href="#yield" class="headerlink" title="yield"></a>yield</h4><p><code>yield()</code>æ–¹æ³•ä¼šä½¿çº¿ç¨‹è®©å‡º<code>CPU</code>ï¼Œä½†ä¸æ˜¯æš‚åœæ‰§è¡Œï¼Œçº¿ç¨‹è¿˜ä¼šç»§ç»­è¿›è¡Œ<code>CPU</code>çš„äº‰å¤ºï¼Œä½†æ˜¯ä¹Ÿä¸æ˜¯ä¸€å®šå°±ä¼šè®©å‡ºï¼Œè¿™ä¸ªç”±æ“ä½œç³»ç»Ÿå†³å®šã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹ä¸é‚£ä¹ˆé‡è¦ï¼Œæˆ–è€…å¯¹åº”ä»»åŠ¡çš„ä¼˜å…ˆçº§éå¸¸ä½ï¼Œæˆ–è€…ä¸å¸Œæœ›å®ƒå ç”¨è¿‡å¤šçš„èµ„æºï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨<code>yield()</code>æ–¹æ³•ç»™äºˆå…¶å®ƒçº¿ç¨‹æ›´å¤šçš„æ‰§è¡Œæœºä¼šã€‚</p><h4 id="sleepå’Œwaitçš„åŒºåˆ«"><a href="#sleepå’Œwaitçš„åŒºåˆ«" class="headerlink" title="sleepå’Œwaitçš„åŒºåˆ«"></a>sleepå’Œwaitçš„åŒºåˆ«</h4><ul><li>è¢«<code>wait()</code>æ–¹æ³•é˜»å¡çš„çº¿ç¨‹å¯ä»¥é€šè¿‡<code>notify()</code>æˆ–è€…<code>notifyAll()</code>æ–¹æ³•å”¤é†’ï¼Œè€Œæ‰§è¡Œ<code>sleep(0</code>æ–¹æ³•çš„çº¿ç¨‹åªèƒ½ä¸€ç›´ä¼‘çœ åˆ°æŒ‡å®šæ—¶é—´ï¼Œä¸å¯è¢«å”¤é†’ã€‚</li><li>å½“è¢«<code>wait()</code>æ–¹æ³•é˜»å¡çš„çº¿ç¨‹è¢«å”¤é†’çš„æ—¶å€™ï¼Œä¼šé‡Šæ”¾ç›®æ ‡å¯¹è±¡çš„é”ï¼Œè€Œ<code>sleep()</code>æ–¹æ³•æŒ‡å®šçš„ç¡çœ æ—¶å€™åˆ°çš„æ—¶å€™ä¸ä¼šé‡Šæ”¾ä»»ä½•èµ„æºã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> çº¿ç¨‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Thread </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mybatisæ‰‹æ’¸ï¼ˆä¸€ï¼‰Mybatisç®€ä»‹å’Œæ•´ä½“æ¶æ„</title>
      <link href="/2022/04/02/hand-mybatis-1/"/>
      <url>/2022/04/02/hand-mybatis-1/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h3 id="ä¸€ã€Mybatisç®€ä»‹"><a href="#ä¸€ã€Mybatisç®€ä»‹" class="headerlink" title="ä¸€ã€Mybatisç®€ä»‹"></a>ä¸€ã€Mybatisç®€ä»‹</h3><p><a href="http://www.mybatis.org/mybatis-3/zh/index.html">MyBatis å®˜æ–¹æ–‡æ¡£</a></p><p><code>Mybatis</code>æ˜¯ä¸€æ¬¾æ—¨åœ¨å¸®åŠ©å¼€å‘äººå‘˜å±è”½åº•å±‚é‡å¤æ€§çš„<code>JDBC</code>ä»£ç çš„æŒä¹…å±‚æ¡†æ¶ï¼Œæ”¯æŒé€šè¿‡é…ç½®æ–‡ä»¶æˆ–è€…æ³¨è§£å°†<code>ResultSet</code>æ˜ å°„æˆ<code>Java</code>å¯¹è±¡ã€‚ç›¸å¯¹äºå…¶å®ƒ<code>ORM</code>æ¡†æ¶ï¼Œ<code>Mybatis</code>æ›´ä¸ºè½»é‡çº§ï¼Œæ”¯æŒå®šåˆ¶åŒ–<code>SQL</code>å’ŒåŠ¨æ€<code>SQL</code>ï¼Œæ–¹ä¾¿ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼ŒåŒæ—¶åŒ…å«äº†è‰¯å¥½çš„ç¼“å­˜æœºåˆ¶ã€‚</p><h3 id="äºŒã€Mybatisæ•´ä½“æ¶æ„"><a href="#äºŒã€Mybatisæ•´ä½“æ¶æ„" class="headerlink" title="äºŒã€Mybatisæ•´ä½“æ¶æ„"></a>äºŒã€Mybatisæ•´ä½“æ¶æ„</h3><p><code>Mybatis</code>æ•´ä½“æ¶æ„å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://qtspace.cn/contentimg/39.jpg"></p><h4 id="æ¥å£å±‚"><a href="#æ¥å£å±‚" class="headerlink" title="æ¥å£å±‚"></a>æ¥å£å±‚</h4><ul><li><code>SqlSession</code>æ¥å£å±‚å®šä¹‰äº†æš´éœ²ç»™åº”ç”¨ç¨‹åºè°ƒç”¨çš„<code>API</code>ï¼Œæ¥å£å±‚åœ¨æ”¶åˆ°è¯·æ±‚æ—¶ä¼šè°ƒç”¨<strong>æ ¸å¿ƒå¤„ç†å±‚</strong>çš„ç›¸å…³æ¨¡å—å®Œæˆå…·ä½“çš„æ•°æ®åº“æ“ä½œã€‚</li></ul><h4 id="æ ¸å¿ƒå¤„ç†å±‚"><a href="#æ ¸å¿ƒå¤„ç†å±‚" class="headerlink" title="æ ¸å¿ƒå¤„ç†å±‚"></a>æ ¸å¿ƒå¤„ç†å±‚</h4><ul><li>é…ç½®è§£æï¼š<code>Mybatis</code>åˆå§‹åŒ–æ—¶ä¼šåŠ è½½é…ç½®æ–‡ä»¶ã€æ˜ å°„æ–‡ä»¶å’Œ<code>Mapper</code>æ¥å£çš„æ³¨è§£ä¿¡æ¯ï¼Œè§£æå®Œæ¯•åä¼šå·²å¯¹è±¡çš„å½¢å¼ä¿å­˜åˆ°<code>Configuration</code>å¯¹è±¡ä¸­ã€‚</li><li><code>SQL</code>è§£æä¸<code>scripting</code> æ¨¡å—ï¼š<code>Mybatis</code>æ”¯æŒé€šè¿‡é…ç½®å®ç°åŠ¨æ€çš„<code>SQL</code>ï¼Œå³æ ¹æ®ä¸åŒå‚æ•°ç”Ÿæˆ<code>SQL</code>ã€‚</li><li><code>SQL</code>æ‰§è¡Œä¸ç»“æœé›†æ˜ å°„ï¼š<code>Executor</code>è´Ÿè´£ç»´æŠ¤ç¼“å­˜å’Œäº‹åŠ¡ç®¡ç†ï¼Œå¹¶å°†æ•°æ®åº“æ“ä½œå§”æ‰˜ç»™<code>StatementHandler</code>,<code>ParmaterHandler</code>è´Ÿè´£å®Œæˆ<code>SQL</code>è¯­å¥çš„å®å‚ç»‘å®šå¹¶é€šè¿‡<code>Statement</code>å¯¹è±¡æ‰§è¡Œ<code>SQL</code>ï¼Œæœ€åé€šè¿‡<code>ResultSet</code>è¿”å›ç»“æœï¼Œäº¤ç”±<code>ResultSetHandler</code>å¤„ç†æ˜ å°„æˆ<code>Java</code>å¯¹è±¡ã€‚</li><li>æ’ä»¶ï¼šæ”¯æŒå¼€å‘è€…é€šè¿‡æ’ä»¶æ¥å£å¯¹<code>Mybatis</code>è¿›è¡Œæ‰©å±•ã€‚</li></ul><h4 id="åŸºç¡€æ”¯æŒå±‚"><a href="#åŸºç¡€æ”¯æŒå±‚" class="headerlink" title="åŸºç¡€æ”¯æŒå±‚"></a>åŸºç¡€æ”¯æŒå±‚</h4><ul><li>æ•°æ®æºæ¨¡å—ï¼šæä¾›æ•°æ®æºå®ç°å¹¶èƒ½é›†æˆç¬¬ä¸‰æ–¹æ•°æ®æºæ¨¡å—ã€‚</li><li>äº‹åŠ¡ç®¡ç†æ¨¡å—ï¼šå¯ä»¥å’Œ<code>Spring</code>é›†æˆå¼€å‘ï¼Œå¯¹äº‹ç‰©è¿›è¡Œç®¡ç†ã€‚</li><li>ç¼“å­˜æ¨¡å—ï¼šæä¾›ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜ï¼Œå°†éƒ¨åˆ†è¯·æ±‚æ‹¦æˆªåœ¨ç¼“å­˜å±‚ï¼Œåˆ†æ‹…æ•°æ®åº“å‹åŠ›ï¼Œæé«˜æ€§èƒ½ã€‚</li><li><code>Binding</code>æ¨¡å—ï¼šåœ¨è°ƒç”¨<code>SqlSession</code>ç›¸åº”æ–¹æ³•æ‰§è¡Œæ•°æ®åº“æ“ä½œæ—¶ï¼Œéœ€è¦æŒ‡å®šæ˜ å°„æ–‡ä»¶ä¸­çš„<code>SQL</code>èŠ‚ç‚¹ï¼Œ<code>Mybatis</code>é€šè¿‡<code>Binding</code>æ¨¡å—å°†è‡ªå®šä¹‰<code>Mapper</code>æ¥å£å’Œæ˜ å°„æ–‡ä»¶å…³è”ï¼Œé¿å…æ‹¼å†™ç­‰é”™è¯¯å¯¼è‡´åœ¨è¿è¡Œæ—¶æ‰è¢«å‘ç°ã€‚</li><li>åå°„æ¨¡å—ï¼šæä¾›å°è£…çš„åå°„<code>API</code>ï¼Œæ–¹ä¾¿ä¸Šå±‚è°ƒç”¨ã€‚</li><li>ç±»å‹è½¬æ¢ï¼šä¸ºç®€åŒ–é…ç½®æ–‡ä»¶æä¾›åˆ«åæœºåˆ¶ï¼Œå¹¶ä¸”å®ç°äº†<code>Java</code>ç±»å‹å’Œ<code>JDBC</code>ç±»å‹çš„è½¬æ¢ã€‚</li><li>æ—¥å¿—æ¨¡å—ï¼šèƒ½å¤Ÿé›†æˆå¤šç§ç¬¬ä¸‰æ–¹æ—¥å¿—æ¡†æ¶ã€‚</li><li>èµ„æºåŠ è½½æ¨¡å—ï¼šå¯¹ç±»åŠ è½½å™¨è¿›è¡Œå°è£…ï¼Œæä¾›ç±»åŠ è½½æ–‡ä»¶å’Œå…¶ä»–èµ„æºæ–‡ä»¶çš„åŠŸèƒ½ã€‚</li><li>è§£æå™¨æ¨¡å—ï¼šå¯¹<code>Xpath</code>è¿›è¡Œå°è£…ï¼Œä¸º<code>Mabatis</code>åˆå§‹åŒ–æ—¶è§£æé…ç½®æ–‡ä»¶ä»¥åŠæ˜ å°„æ–‡ä»¶æä¾›æ”¯æŒï¼Œå¯¹å¤„ç†åŠ¨æ€<code>SQL</code>è¯­å¥ä¸­çš„å ä½ç¬¦æä¾›æ”¯æŒã€‚</li></ul><h3 id="ä¸‰ã€Mybatisæ‰§è¡Œæµç¨‹"><a href="#ä¸‰ã€Mybatisæ‰§è¡Œæµç¨‹" class="headerlink" title="ä¸‰ã€Mybatisæ‰§è¡Œæµç¨‹"></a>ä¸‰ã€Mybatisæ‰§è¡Œæµç¨‹</h3><p>Mybatisæ‰§è¡Œæµç¨‹å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://qtspace.cn/contentimg/40.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> Mybatis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mybatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ThreadLocalåº•å±‚å®ç°åŸç†è¯¦è§£</title>
      <link href="/2022/04/01/threadlocal-principle/"/>
      <url>/2022/04/01/threadlocal-principle/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h3 id="ä¸€ã€ThreadLocalç®€ä»‹"><a href="#ä¸€ã€ThreadLocalç®€ä»‹" class="headerlink" title="ä¸€ã€ThreadLocalç®€ä»‹"></a>ä¸€ã€ThreadLocalç®€ä»‹</h3><p><code>ThreadLocal</code>é¡¾åæ€ä¹‰å¯ä»¥æ ¹æ®å­—é¢æ„æ€ç†è§£æˆçº¿ç¨‹æœ¬åœ°å˜é‡ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœå®šä¹‰äº†ä¸€ä¸ª<code>ThreadLocal</code>ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥åœ¨è¿™ä¸ª<code>ThreadLocal</code>ä¸­è¯»å†™ï¼Œè¿™ä¸ªè¯»å†™æ˜¯çº¿ç¨‹éš”ç¦»çš„ï¼Œçº¿ç¨‹ä¹‹å‰ä¸ä¼šæœ‰å½±å“ã€‚</p><p>æ¯ä¸ª<code>Thread</code>éƒ½ç»´æŠ¤è‡ªå·±çš„ä¸€ä¸ª<code>ThreadLocalMap </code>ï¼Œæ‰€ä»¥æ˜¯çº¿ç¨‹éš”ç¦»çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ThreadLocal values pertaining to this thread. This map is maintained</span></span><br><span class="line"><span class="comment"> * by the ThreadLocal class. */</span></span><br><span class="line">ThreadLocal.<span class="type">ThreadLocalMap</span> <span class="variable">threadLocals</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿™ä¸ª<code>ThreadLocalMap</code>å®ç°æ•°æ®çš„è¯»å†™ï¼Œæ—¢ç„¶æ˜¯<code>Map</code>è‚¯å®šæœ‰<code>key</code>å’Œ<code>value</code>ï¼Œä½†æ˜¯è¿™ä¸ª<code>ThreadLocalMap</code>çš„<code>key</code>å¯ä»¥ç®€å•çš„çœ‹æˆæ˜¯<code>ThreadLocal</code>ï¼Œå®é™…æ˜¯å¹¶ä¸æ˜¯<code>ThreadLocal</code>çš„æœ¬èº«ï¼Œè€Œæ˜¯å®ƒçš„ä¸€ä¸ª<strong>å¼±å¼•ç”¨</strong>ã€‚</p><h3 id="äºŒã€ThreadLocalå­¦ä¹ å¤§çº²"><a href="#äºŒã€ThreadLocalå­¦ä¹ å¤§çº²" class="headerlink" title="äºŒã€ThreadLocalå­¦ä¹ å¤§çº²"></a>äºŒã€ThreadLocalå­¦ä¹ å¤§çº²</h3><p>å­¦ä¹ å¤§çº²æ€ç»´å¯¼å›¾å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://qtspace.cn/contentimg/23.jpg"></p><h3 id="ä¸‰ã€ThreadLocalæ–¹æ³•å’Œæˆå‘˜å˜é‡"><a href="#ä¸‰ã€ThreadLocalæ–¹æ³•å’Œæˆå‘˜å˜é‡" class="headerlink" title="ä¸‰ã€ThreadLocalæ–¹æ³•å’Œæˆå‘˜å˜é‡"></a>ä¸‰ã€ThreadLocalæ–¹æ³•å’Œæˆå‘˜å˜é‡</h3><h4 id="API"><a href="#API" class="headerlink" title="API"></a>API</h4><p><code>ThreadLocal</code>çš„<code>API</code>å¾ˆå°‘å°±åŒ…å«äº†4ä¸ªï¼Œåˆ†åˆ«æ˜¯<code>get()</code>ã€<code>set()</code>ã€<code>remove()</code>ã€<code>withInitial()</code>ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(T value)</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;S&gt; ThreadLocal&lt;S&gt; <span class="title function_">withInitial</span><span class="params">(Supplier&lt;? extends S&gt; supplier)</span> &#123;</span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>get()</code>ï¼šè·å–å½“å‰çº¿ç¨‹å¯¹åº”çš„<code>ThreadLocalMap</code>å­˜å‚¨çš„å€¼ï¼Œ<code>key</code>ä¸ºå½“å‰<code>TheadLocal</code>ï¼ˆå®é™…ä¸º<code>TheadLocal</code>çš„å¼±å¼•ç”¨ï¼‰ï¼Œä¹Ÿå°±æ˜¯è·å–å½“å‰çº¿ç¨‹æœ¬åœ°å˜é‡çš„å€¼ã€‚</li><li><code>set(T value)</code>ï¼šç»™å½“å‰çº¿ç¨‹å¯¹åº”çš„<code>ThreadLocalMap</code>çš„è®¾ç½®å€¼ï¼Œä¹Ÿå°±æ˜¯ç»™å½“å‰çº¿ç¨‹æœ¬åœ°å˜é‡è®¾ç½®å€¼ã€‚</li><li><code>remove()</code>ï¼šæ¸…é™¤å‰çº¿ç¨‹å¯¹åº”çš„<code>ThreadLocalMap</code>å­˜å‚¨çš„<code>TheadLocal</code>ï¼Œä¹Ÿå°±æ˜¯æ¸…é™¤å½“å‰çº¿ç¨‹æœ¬åœ°å˜é‡çš„å€¼ã€‚</li><li><code>withInitial()</code>ï¼šç”¨äºåˆ›å»ºä¸€ä¸ªçº¿ç¨‹å±€éƒ¨å˜é‡ï¼Œå˜é‡çš„åˆå§‹åŒ–å€¼é€šè¿‡è°ƒç”¨Supplierçš„getæ–¹æ³•æ¥ç¡®å®š</li></ul><h4 id="æˆå‘˜å˜é‡"><a href="#æˆå‘˜å˜é‡" class="headerlink" title="æˆå‘˜å˜é‡"></a>æˆå‘˜å˜é‡</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è°ƒç”¨nextHashCode()æ–¹æ³•è·å–ä¸‹ä¸€ä¸ªhashCodeå€¼ï¼Œç”¨äºè®¡ç®—ThreadLocalMap.tablesæ•°ç»„ä¸‹æ ‡</span></span><br><span class="line"><span class="comment">// key.threadLocalHashCode &amp; (len - 1)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">threadLocalHashCode</span> <span class="operator">=</span> nextHashCode();</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŸå­ç±»ï¼Œç”¨äºè®¡ç®—hashCodeå€¼</span></span><br><span class="line"><span class="keyword">private</span> staitc <span class="type">AmoicInteger</span> <span class="variable">nextHashCode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AmoicInteger</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// hashå¢é‡å€¼ï¼Œæ–æ³¢é‚£å¥‘æ•°ä¹Ÿå«é»„é‡‘åˆ†å‰²æ•°ï¼Œå¯ä»¥è®©hashå€¼åˆ†å¸ƒéå¸¸å‡åŒ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">HASH_INCREMENT</span> <span class="operator">=</span> <span class="number">0x61c88647</span>ï¼›</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–ä¸‹ä¸€ä¸ªhashCodeå€¼æ–¹æ³•ï¼Œåªç”¨åŸå­ç±»æ“ä½œ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">nextHashCode</span> <span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> nextHashCode.getAndAdd(HASH_INCREMENT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å››ã€ThreadLocalMap"><a href="#å››ã€ThreadLocalMap" class="headerlink" title="å››ã€ThreadLocalMap"></a>å››ã€ThreadLocalMap</h3><p><code>ThreadLocalMap</code>æ˜¯<code>ThreadLocal</code>ç±»çš„ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼Œåœ¨ä¸Šé¢æœ‰è¯´åˆ°æ¯ä¸ªçº¿ç¨‹éƒ½ç»´æŠ¤ç€ä¸€ä¸ª<code>ThreadLocalMap</code>ï¼Œè¿™ä¸ª&#96;&#96;ThreadLocalMap&#96; å°±æ˜¯ç”¨æ¥å‚¨å­˜æ•°æ®çš„ã€‚</p><p><code>ThreadLocalMap</code>å†…éƒ¨ç»´æŠ¤ç€ä¸€ä¸ª<code>Entry</code>èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹ç»§æ‰¿äº†<code>WeakReference</code>ç±»ï¼Œæ³›å‹ä¸º<code>ThreadLocal</code>è¡¨ç¤ºæ˜¯å¼±å¼•ç”¨ï¼ŒèŠ‚ç‚¹å†…éƒ¨å®šä¹‰äº†ä¸€ä¸ªä¸º<code>Object</code>çš„<code>value</code>ï¼Œè¿™ä¸ª<code>value</code>å°±æ˜¯æˆ‘ä»¬å­˜æ”¾çš„å€¼ï¼Œ<code>Entry</code>ç±»çš„æ„é€ æ–¹æ³•åªæœ‰ä¸€ä¸ªï¼Œä¼ å…¥<code>key</code>å’Œ<code>value</code>ï¼Œè¿™ä¸ª<code>key</code>å°±æ˜¯<code>ThreadLocal</code>ï¼Œå®é™…ä¸º<code>ThreadLocal</code>çš„å¼±å¼•ç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Entry</span> <span class="keyword">extends</span> <span class="title class_">WeakReference</span>&lt;ThreacLocal&lt;?&gt;&gt; &#123;</span><br><span class="line">    Object value;</span><br><span class="line">    </span><br><span class="line">    Entry(ThreadLocal&lt;?&gt; k, Object v)&#123;</span><br><span class="line">        <span class="built_in">super</span>(k);</span><br><span class="line">        value = v;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Threadã€ThreadLocalMapã€ThreadLocalç»“æ„å…³ç³»"><a href="#Threadã€ThreadLocalMapã€ThreadLocalç»“æ„å…³ç³»" class="headerlink" title="Threadã€ThreadLocalMapã€ThreadLocalç»“æ„å…³ç³»"></a>Threadã€ThreadLocalMapã€ThreadLocalç»“æ„å…³ç³»</h4><p>æ¯ä¸ª<code>Thread</code>éƒ½æœ‰ä¸€ä¸ª<code>ThreadLocalMap</code>å˜é‡ï¼Œ<code>ThreadLocalMap</code>å†…éƒ¨å®šä¹‰äº†<code>Entry</code>èŠ‚ç‚¹ç±»ï¼Œè¿™ä¸ªèŠ‚ç‚¹ç»§æ‰¿äº†<code>WeakReference</code>ç±»æ³›å‹ä¸º<code>ThreacLocal</code>ç±»ï¼ŒèŠ‚ç‚¹ç±»çš„æ„é€ æ–¹æ³•<code>ThreadLocal&lt;?&gt; k, Object v</code>ï¼Œæ‰€ä»¥å¯ä»¥å¾—åˆ°ä¸‹é¢çš„ç»“æ„å…³ç³»å›¾ï¼š</p><p><img src="https://qtspace.cn/contentimg/24.jpg"></p><h4 id="GCä¹‹åkeyæ˜¯å¦ä¸ºnullï¼Ÿ"><a href="#GCä¹‹åkeyæ˜¯å¦ä¸ºnullï¼Ÿ" class="headerlink" title="GCä¹‹åkeyæ˜¯å¦ä¸ºnullï¼Ÿ"></a>GCä¹‹åkeyæ˜¯å¦ä¸ºnullï¼Ÿ</h4><p>æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œæ—¢ç„¶<code>ThreadLocalMap</code>çš„<code>key</code>æ˜¯å¼±å¼•ç”¨ï¼Œ<code>GC</code>ä¹‹å<code>key</code>æ˜¯å¦ä¸º<code>null</code>ï¼Ÿåœ¨ææ¸…æ¥šè¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆææ¸…æ¥š<code>Java</code>çš„å››ç§<strong>å¼•ç”¨ç±»å‹</strong>ï¼š</p><ul><li>å¼ºå¼•ç”¨ï¼š<code>new</code>å‡ºæ¥çš„å¯¹è±¡å°±æ˜¯å¼ºå¼•ç”¨ï¼Œåªè¦å¼ºå¼•ç”¨å­˜åœ¨ï¼Œåƒåœ¾å›æ”¶å™¨å°±æ°¸è¿œä¸ä¼šå›æ”¶è¢«å¼•ç”¨çš„å¯¹è±¡ï¼Œå“ªæ€•å†…å­˜ä¸è¶³çš„æ—¶å€™ã€‚</li><li>è½¯å¼•ç”¨ï¼šä½¿ç”¨<code>SoftReference</code>ä¿®é¥°çš„å¯¹è±¡è¢«ç§°ä¸ºè½¯å¼•ç”¨ï¼Œåœ¨å†…å­˜è¦æº¢å‡ºçš„æ—¶å€™è½¯å¼•ç”¨æŒ‡å‘çš„å¯¹è±¡ä¼šè¢«å›æ”¶ã€‚</li><li>å¼±å¼•ç”¨ï¼šä½¿ç”¨<code>WeakReference</code>ä¿®é¥°çš„å¯¹è±¡è¢«ç§°ä¸ºå¼±å¼•ç”¨ï¼Œåªè¦å‘ç”Ÿåƒåœ¾å›æ”¶ï¼Œè¢«å¼±å¼•ç”¨æŒ‡å‘çš„å¯¹è±¡å°±ä¼šè¢«å›æ”¶ã€‚</li><li>è™šå¼•ç”¨ï¼šè™šå¼•ç”¨æ˜¯æœ€å¼±çš„å¼•ç”¨ï¼Œç”¨<code>PhantomReference</code>è¿›è¡Œå®šã€‚å”¯ä¸€çš„ä½œç”¨å°±æ˜¯ç”¨æ¥é˜Ÿåˆ—æ¥å—å¯¹è±¡å³å°†æ­»äº¡çš„é€šçŸ¥ã€‚</li></ul><p>è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆæ˜¯ä¸ä¸ºnullï¼Œå¯ä»¥çœ‹ä¸‹é¢çš„å›¾ï¼š</p><p><img src="https://qtspace.cn/contentimg/25.jpg"></p><p>é€šè¿‡ä¸Šå›¾æˆ‘ä»¬çŸ¥é“<code>ThreadLocal</code>çš„å¼ºå¼•ç”¨æ˜¯ä»ç„¶å­˜åœ¨çš„ï¼Œæ‰€ä»¥ä¸ä¼šè¢«å›æ”¶ï¼Œä¸ä¸º<code>null</code></p><h4 id="ThreadLocalMapæˆå‘˜å˜é‡"><a href="#ThreadLocalMapæˆå‘˜å˜é‡" class="headerlink" title="ThreadLocalMapæˆå‘˜å˜é‡"></a>ThreadLocalMapæˆå‘˜å˜é‡</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ–å®¹é‡ å¿…é¡»ä¸º2çš„å¹‚ï¼Œä½è¿ç®—å–ä»£æ¨¡è¿ç®—æå‡è®¡ç®—æ•ˆç‡ï¼Œå¯ä»¥è¯•hashå€¼å‘ç”Ÿç¢°æ’çš„æ¦‚ç‡æ›´å°ï¼Œå°½å¯èƒ½çš„ä½¿</span></span><br><span class="line"><span class="comment">// å…ƒç´ åœ¨å“ˆå¸Œè¡¨ä¸­å‡åŒ€çš„æ•£åˆ—</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">INITTAL_CAPACIRY</span> <span class="operator">=</span> <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Entryè¡¨</span></span><br><span class="line"><span class="keyword">private</span> Entry[] table;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Entryè¡¨å­˜æ”¾çš„å…ƒç´ æ•°é‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰©å®¹é˜™å€¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> threshold;</span><br></pre></td></tr></table></figure><h3 id="äº”ã€ThreadLocal-set-æ–¹æ³•æºç è¯¦è§£"><a href="#äº”ã€ThreadLocal-set-æ–¹æ³•æºç è¯¦è§£" class="headerlink" title="äº”ã€ThreadLocal.set()æ–¹æ³•æºç è¯¦è§£"></a>äº”ã€ThreadLocal.set()æ–¹æ³•æºç è¯¦è§£</h3><p><code>set()</code>æ–¹æ³•ç”¨äºç»™æœ¬åœ°çº¿ç¨‹å˜é‡è®¾å€¼ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹<code>set()</code>æ–¹æ³•çš„æºç ï¼Œä»æºç æ¥ä¸€æ­¥ä¸€æ­¥è§£æå®ç°åŸç†ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">pubic <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(T value)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Threac.currentThread();</span><br><span class="line">    <span class="comment">// è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMap</span></span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">    <span class="comment">// å¦‚æœmapä¸ä¸ºnullï¼Œ è°ƒç”¨ThreadLocalMap.set()æ–¹æ³•è®¾ç½®å€¼</span></span><br><span class="line">    <span class="keyword">if</span> (map != <span class="literal">null</span>)</span><br><span class="line">        map.set(<span class="built_in">this</span>, value);</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">        <span class="comment">// mapä¸ºnullï¼Œè°ƒç”¨createMap()æ–¹æ³•åˆå§‹åŒ–åˆ›å»ºmap</span></span><br><span class="line">        createMap(t, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›çº¿ç¨‹çš„ThreadLocalMap.threadLocals</span></span><br><span class="line">ThreadLocalMap <span class="title function_">getMap</span><span class="params">(Thread t)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> t.threadLocals;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨ThreadLocalMapæ„é€ æ–¹æ³•åˆ›å»ºThreadLocalMap</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">createMap</span><span class="params">(Thread t, T firstValue)</span> &#123;</span><br><span class="line">    t.threadLocals = <span class="keyword">new</span> <span class="title class_">ThreadLocalMap</span>(<span class="built_in">this</span>, firstValue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ThreadLocalMapæ„é€ æ–¹æ³•ï¼Œä¼ å…¥firstKey, firstValue</span></span><br><span class="line">ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) &#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–Entryè¡¨çš„å®¹é‡ = 16</span></span><br><span class="line">    table = <span class="keyword">new</span> <span class="title class_">Entry</span>[INITIAL_CAPACITY];</span><br><span class="line">    <span class="comment">// è·å–ThreadLocalçš„hashCodeå€¼ä¸è¿ç®—å¾—åˆ°æ•°ç»„ä¸‹æ ‡</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> firsetKey.threadLocalHashCode &amp; (INITAL_CAPACITY - <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// é€šè¿‡ä¸‹æ ‡Entryè¡¨èµ‹å€¼</span></span><br><span class="line">    table[i] = <span class="keyword">new</span> <span class="title class_">Entry</span>(firstKey, firstValue);</span><br><span class="line">    <span class="comment">// Entryè¡¨å­˜å‚¨å…ƒç´ æ•°é‡åˆå§‹åŒ–ä¸º1</span></span><br><span class="line">    size = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// è®¾ç½®Entryè¡¨æ‰©å®¹é˜™å€¼ é»˜è®¤ä¸º len * 2 / 3</span></span><br><span class="line">    setThreshold(INITIAL_CAPACITY);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setThreshold</span><span class="params">(<span class="type">int</span> len)</span> &#123;</span><br><span class="line">    threshold = len * <span class="number">2</span> / <span class="number">3</span></span><br><span class="line">&#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure><p><code>ThreadLocal.set()</code>æ–¹æ³•è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œæ ¸å¿ƒæ–¹æ³•åœ¨<code>ThreadLocalMap.set()</code>æ–¹æ³•ï¼Œ<code>ThreadLocal.set()</code>æ–¹æ³•æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>è·å–å½“å‰çº¿ç¨‹çš„<code>ThreadLocalMap map</code> ã€‚</li><li>å¦‚æœ<code>map</code>ä¸ä¸º<code>null</code>åˆ™è°ƒç”¨<code>map.set()</code>æ–¹æ³•è®¾ç½®å€¼ã€‚</li><li>å¦‚æœ<code>map</code>ä¸º<code>null</code>åˆ™è°ƒç”¨<code>createMap</code>æ–¹æ³•åˆ›å»ºã€‚</li><li><code>createMap()</code>æ–¹æ³•é€šè¿‡<code>ThreadLocalMap</code>çš„æ„é€ æ–¹æ³•åˆ›å»ºï¼Œæ„é€ æ–¹æ³•ä¸»è¦åšäº†åˆå§‹åŒ–<code>Entry[] table</code>å®¹é‡16ï¼Œé€šè¿‡<code>ThreadLocal</code>çš„<code>threadLocalHashCode</code>è°ƒç”¨<code>nextHashCode()</code>æ–¹æ³•è·å–<code>hashCode</code>å€¼è®¡ç®—å‡ºä¸‹æ ‡ï¼Œ<code>table</code>æ•°ç»„é€šè¿‡ä¸‹æ ‡èµ‹å€¼ï¼Œåˆå§‹åŒ–å­˜å‚¨çš„å…ƒç´ æ•°é‡ï¼Œåˆå§‹åŒ–æ•°ç»„æ‰©å®¹é˜™å€¼ã€‚</li></ol><p><img src="https://qtspace.cn/contentimg/26.jpg"></p><p><code>ThreadLocalMap</code>åœ¨æ„é€ æ–¹æ³•é‡Œå¤„ç†çš„æ—¶å€™ç”¨åˆ°äº†æˆ‘ä»¬å­¦ä¹ å¤§çº²é‡Œè¯´åˆ°çš„<code>hash</code>ç®—æ³•ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">threadLocalHashCode</span> <span class="operator">=</span> nextHashCode();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">HASH_INCREMENT</span> <span class="operator">=</span> <span class="number">0x61c88647</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">nextHashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> nextHashCode.getAndAdd(HASH_INCREMENT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ€å…³é”®çš„å°±æ˜¯<code>threadLocalHashCode</code>å€¼çš„è®¡ç®—ï¼Œ<code>ThreadLocal</code>ä¸­æœ‰ä¸€ä¸ªå±æ€§ä¸º<code>HASH_INCREMENT = 0x61c88647</code>ï¼Œæ²¡åˆ›å»ºä¸€ä¸ª<code>ThreadLocal</code>å°±ä¼šè°ƒç”¨ä¸€æ¬¡<code>nextHashCode()</code>æ–¹æ³•ï¼Œè¿™ä¸ª<code>HASH_INCREMENT</code>å€¼å°±ä¼šå¢é•¿<code>0x61c88647</code>ï¼Œè¿™ä¸ªå€¼å¾ˆç‰¹æ®Šï¼Œæ˜¯æ–æ³¢é‚£å¥‘æ•°ä¹Ÿå«é»„é‡‘åˆ†å‰²æ•°ï¼Œè¿™ä¸ªå€¼å¯ä»¥è®©<code>hash</code>åˆ†å¸ƒéå¸¸å‡åŒ€ã€‚</p><p>å¯ä»¥ä¸‹ä¸€ä¸ªå°demoæµ‹è¯•ä¸€ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">hashCode</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">HASH_INCREMENT</span> <span class="operator">=</span> <span class="number">0x61c88647</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) &#123;</span><br><span class="line">        hashCode = i * HASH_INCREMENT + HASH_INCREMENT;</span><br><span class="line">        <span class="type">int</span> <span class="variable">bucket</span> <span class="operator">=</span> hashCode &amp; (<span class="number">16</span> - <span class="number">1</span>);</span><br><span class="line">        System.out.println(i + <span class="string">&quot;åœ¨æ¡¶ä¸­çš„ä½ç½®ï¼š&quot;</span> + bucket);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æµ‹è¯•è¾“å‡ºå¦‚ä¸‹ï¼šå¯ä»¥çœ‹å‡ºæ•°æ®åœ¨ç®—åˆ—æ•°ç»„ä¸­åˆ†å¸ƒçš„å¾ˆå‡åŒ€ã€‚</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">0åœ¨æ¡¶ä¸­çš„ä½ç½®ï¼š7</span><br><span class="line">1åœ¨æ¡¶ä¸­çš„ä½ç½®ï¼š14</span><br><span class="line">2åœ¨æ¡¶ä¸­çš„ä½ç½®ï¼š5</span><br><span class="line">3åœ¨æ¡¶ä¸­çš„ä½ç½®ï¼š12</span><br><span class="line">4åœ¨æ¡¶ä¸­çš„ä½ç½®ï¼š3</span><br><span class="line">5åœ¨æ¡¶ä¸­çš„ä½ç½®ï¼š10</span><br><span class="line">6åœ¨æ¡¶ä¸­çš„ä½ç½®ï¼š1</span><br><span class="line">7åœ¨æ¡¶ä¸­çš„ä½ç½®ï¼š8</span><br><span class="line">8åœ¨æ¡¶ä¸­çš„ä½ç½®ï¼š15</span><br><span class="line">9åœ¨æ¡¶ä¸­çš„ä½ç½®ï¼š6</span><br><span class="line">10åœ¨æ¡¶ä¸­çš„ä½ç½®ï¼š13</span><br><span class="line">11åœ¨æ¡¶ä¸­çš„ä½ç½®ï¼š4</span><br><span class="line">12åœ¨æ¡¶ä¸­çš„ä½ç½®ï¼š11</span><br><span class="line">13åœ¨æ¡¶ä¸­çš„ä½ç½®ï¼š2</span><br><span class="line">14åœ¨æ¡¶ä¸­çš„ä½ç½®ï¼š9</span><br><span class="line">15åœ¨æ¡¶ä¸­çš„ä½ç½®ï¼š0</span><br></pre></td></tr></table></figure><h4 id="ThreadLocalMap-set-æ–¹æ³•æºç è¯¦è§£"><a href="#ThreadLocalMap-set-æ–¹æ³•æºç è¯¦è§£" class="headerlink" title="ThreadLocalMap.set()æ–¹æ³•æºç è¯¦è§£"></a>ThreadLocalMap.set()æ–¹æ³•æºç è¯¦è§£</h4><p><code>ThreadLocalMap.set()</code>æ–¹æ³•åˆ†ä¸ºå¥½å‡ ç§æƒ…å†µï¼Œä¸»è¦æœ‰ä»¥ä¸‹å››ç§æƒ…å†µï¼Œé’ˆå¯¹ä¸åŒçš„æƒ…å†µæˆ‘ä»¬é€šè¿‡ç”»å›¾æ¥è¯´æ˜ã€‚</p><blockquote><p>è¯´æ˜ï¼š ä¸‹é¢æ‰€æœ‰å›¾ä¸­ï¼Œç»¿è‰²å—<code>Entry</code>ä»£è¡¨æ­£å¸¸æ•°æ®ï¼Œç°è‰²ä»£è¡¨<code>Entry</code>çš„<code>key</code>å€¼ä¸º<code>null</code>ï¼Œå·²è¢«<code>GC</code>å›æ”¶ï¼Œç™½è‰²ä»£è¡¨<code>Entry</code>ä¸º<code>null</code>ã€‚</p></blockquote><p><strong>ç¬¬ä¸€ç§æƒ…å†µï¼š</strong>é€šè¿‡<code>hash</code>è®¡ç®—å¾—åˆ°çš„ä¸‹æ ‡ï¼Œè¯¥ä¸‹æ ‡å¯¹åº”çš„<code>Entry</code>ä¸º<code>null</code>ï¼š</p><p><img src="https://qtspace.cn/contentimg/27.jpg"></p><p>è¿™ç§æƒ…å†µç›´æ¥å°†è¯¥æ•°æ®æ”¾å…¥è¯¥æ§½ä½å³å¯ã€‚</p><p><strong>ç¬¬äºŒç§æƒ…å†µï¼š</strong>é€šè¿‡<code>hash</code>è®¡ç®—å¾—åˆ°çš„ä¸‹æ ‡ï¼Œè¯¥ä¸‹æ ‡å¯¹åº”çš„<code>Entry</code>ä¸ä¸º<code>null</code>ï¼Œä½†æ˜¯<code>key</code>ç›¸åŒï¼š</p><p><img src="https://qtspace.cn/contentimg/28.jpg"></p><p>è¿™ç§æƒ…å†µç›´æ¥è¯¥æ§½ä½çš„<code>value</code>å€¼ã€‚</p><p><strong>ç¬¬ä¸‰ç§æƒ…å†µï¼š</strong>é€šè¿‡<code>hash</code>è®¡ç®—å¾—åˆ°çš„ä¸‹æ ‡ï¼Œè¯¥ä¸‹æ ‡å¯¹åº”çš„<code>Entry</code>ä¸ä¸º<code>null</code>ï¼Œä¸”<code>key</code>ä¸ç›¸åŒï¼Œè¿™ç§æ—¶å€™ä¼šéå†æ•°ç»„ï¼Œçº¿æ€§å¾€åæŸ¥æ‰¾ï¼ŒæŸ¥æ‰¾<code>Entry</code>ä¸º<code>null</code>çš„æ§½ä½ï¼Œä¸”åœ¨æ‰¾åˆ°<code>Entry</code>ä¸º<code>null</code>ä¹‹å‰æ²¡æœ‰é‡åˆ°<code>key</code>è¿‡æœŸçš„<code>Entry</code>ï¼Œå°±è¯¥æ•°æ®æ”¾å…¥è¯¥æ§½ä½ä¸­ï¼Œå¦‚æœéå†è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°äº†<code>key</code>ç›¸ç­‰çš„æ§½ä½ï¼Œç›´æ¥æ›´æ–°<code>value</code>å³å¯ï¼š</p><p><img src="https://qtspace.cn/contentimg/29.jpg"></p><p>æ³¨æ„ï¼šæ¯æ¬¡å¾ªç¯æŸ¥æ‰¾éƒ½ä¼šåˆ¤æ–­<code>key</code>æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰åˆ™æ›´æ–°<code>value</code>ç›´æ¥è¿”å›ã€‚</p><p><strong>ç¬¬å››ç§æƒ…å†µï¼š</strong>åŸºäºç¬¬ä¸‰ç§æƒ…å†µï¼Œå¦‚æœåœ¨æ‰¾åˆ°<code>Entry</code>ä¸º<code>null</code>ä¹‹å‰é‡åˆ°äº†<code>key</code>è¿‡æœŸçš„<code>Entry</code>ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://qtspace.cn/contentimg/30.jpg"></p><p>å¦‚ä¸Šå›¾æ•£åˆ—æ•°ç»„ä¸‹æ ‡ä¸º7ä½ç½®å¯¹åº”çš„<code>Entry</code>æ•°æ®<code>key</code>ä¸º<code>null</code>ï¼Œè¯´æ˜æ­¤æ•°æ®<code>key</code>å€¼å·²ç»è¢«åƒåœ¾å›æ”¶æ‰äº†ï¼Œæ­¤æ—¶ä¼šæ‰§è¡Œ<code>replaceStaleEntry()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å«ä¹‰æ˜¯<strong>æ›¿æ¢è¿‡æœŸæ•°æ®çš„é€»è¾‘</strong>ï¼Œä»¥<code>index=7</code>ä¸ºèµ·ç‚¹å¼€å§‹å‘å‰éå†ï¼Œè¿›è¡Œæ¢æµ‹å¼æ•°æ®æ¸…ç†å·¥ä½œã€‚</p><p>åˆå§‹åŒ–æ¢æµ‹å¼æ¸…ç†è¿‡æœŸæ•°æ®æ‰«æçš„å¼€å§‹ä½ç½®ï¼š<code>slotToExpunge = stateSlot = 7</code>ã€‚</p><p>ä»¥å½“å‰<code>stateSlot </code>å¼€å§‹å‘å‰è¿­ä»£æ‰¾åˆ°ï¼Œæ‰¾åˆ°å…¶ä»–è¿‡æœŸçš„æ•°æ®ï¼Œç„¶åæ›´æ–°è¿‡æœŸæ•°æ®èµ·å§‹æ‰«æä¸‹æ ‡çš„<code>slotToExpunge </code>ï¼Œç›´åˆ°æ‰¾åˆ°äº†<code>Entry</code>ä¸º<code>null</code>çš„æ§½ä½åˆ™ç»“æŸã€‚</p><p>å¦‚æœæ‰¾åˆ°è¿‡æœŸæ•°æ®ï¼Œç»§ç»­å‘å‰è¿­ä»£ï¼Œç›´åˆ°é‡åˆ°<code>Entry=null</code>çš„æ§½ä½åˆ™åœæ­¢è¿­ä»£ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ<code>slotToExpunge</code>è¢«æ›´æ–°ä¸º0ï¼š</p><p><img src="https://qtspace.cn/contentimg/31.jpg"></p><p>ä¸Šå›¾ä»¥å½“å‰èŠ‚ç‚¹<code>index = 7</code>å‘å‰è¿­ä»£ï¼Œæ£€æµ‹æ˜¯å¦æœ‰è¿‡æœŸçš„<code>Entry</code>æ•°æ®ï¼Œå¦‚æœæœ‰åˆ™æ›´æ–°<code>slotToExpunge</code>çš„å€¼ï¼Œé‡åˆ°<code>Entry</code>ä¸º<code>null</code>åˆ™ç»“æŸæ¢æµ‹ï¼Œä»¥ä¸Šå›¾ä¸ºä¾‹<code>slotToExpunge</code>è¢«æ›´æ–°ä¸º0ã€‚</p><p>ä¸Šé¢å‘å‰è¿­ä»£çš„æ“ä½œæ˜¯ä¸ºäº†æ›´æ–°æ¢æµ‹æ¸…ç†è¿‡æœŸæ•°æ®çš„èµ·å§‹ä½ç½®<code>soltToExpunge</code>çš„å€¼ï¼Œè¿™ä¸ªå€¼æ˜¯ç”¨æ¥åˆ¤æ–­å½“å‰è¿‡æœŸæ§½ä½<code>staleSlot</code>ä¹‹å‰æ˜¯å¦è¿˜æœ‰è¿‡æœŸå…ƒç´ ã€‚</p><p>æ¥ç€å¼€å§‹<code>staleSolt</code>ä½ç½®<code>index = 7</code>å‘åè¿­ä»£ï¼Œ<strong>å¦‚æœæ‰¾åˆ°äº†ç›¸ç­‰<code>key</code>çš„<code>Entry</code>çš„æ•°æ®</strong>åˆ™æ›´æ–°<code>value</code>å€¼ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://qtspace.cn/contentimg/32.jpg"></p><p>ä»å½“å‰èŠ‚ç‚¹<code>staleSolt</code>ä½ç½®å¼€å§‹å‘åå¯»æ‰¾<code>key</code>ç›¸ç­‰çš„<code>Entry</code>ä½ç½®ï¼Œå¦‚æœæ‰¾åˆ°äº†<code>key</code>ç›¸ç­‰çš„<code>Entry</code>ï¼Œåˆ™ä¼šäº¤æ¢<code>staleSlot</code>å…ƒç´ çš„ä½ç½®ï¼Œä¸”æ›´æ–°<code>value</code>å€¼ï¼Œç„¶åè¿›è¡Œè¿‡æœŸ<code>Entry</code>çš„æ¸…ç†å·¥ä½œï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://qtspace.cn/contentimg/33.jpg"></p><p>å¦‚æœæ²¡æœ‰æ‰¾åˆ°<strong>ç›¸ç­‰<code>key</code>çš„<code>Entry</code>çš„æ•°æ®</strong>ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://qtspace.cn/contentimg/34.jpg"></p><p>ä»å½“å‰èŠ‚ç‚¹<code>staleSlot</code>å‘åæŸ¥æ‰¾<code>key</code>å€¼ç›¸ç­‰çš„<code>Entry</code>ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ä¼šç»§ç»­å¾€åæŸ¥æ‰¾ç›´åˆ°æ‰¾åˆ°<code>Entry</code>ä¸º<code>null</code>åœæ­¢ï¼Œç„¶ååˆ›å»ºæ–°çš„<code>Entry</code>ï¼Œæ›¿æ¢<code>stableSlot</code>çš„ä½ç½®ã€‚</p><p>æ›¿æ¢å®Œæˆä¹‹åä¹Ÿæ˜¯è¿›è¡Œè¿‡æœŸå…ƒç´ çš„æ¸…ç†å·¥ä½œï¼Œæ¸…ç†å·¥ä½œçš„æ–¹æ³•ä¸»è¦æœ‰ä¸¤ä¸ª<code>expungeStaleEntry</code>å’Œ<code>cleanSomeSlots</code>ï¼Œå…·ä½“è¯¦æƒ…åé¢ä¼šè®²åˆ°ã€‚</p><p>ä¸Šé¢å·²ç»å›¾è§£äº†<code>set()</code>æ–¹æ³•å®ç°çš„åŸç†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç»“åˆæºç å†æ¥çœ‹çœ‹ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(ThreadLocal&lt;?&gt; key, Object value)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–Entryè¡¨</span></span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="comment">// è·å–è¡¨é•¿åº¦</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰è¦æ”¾å…¥å…ƒç´ çš„ä¸‹æ ‡</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> key.threadLocalHashCode &amp; (len - <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¾ªç¯æŸ¥æ‰¾</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> tab[i]; </span><br><span class="line">         e != <span class="literal">null</span>;</span><br><span class="line">         e = tab[i = nextIndex(i, len)])&#123;</span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¦‚æœæŸ¥æ‰¾åˆ°keyç›¸ç­‰çš„entryï¼Œåˆ™æ›´æ–°value</span></span><br><span class="line">        <span class="keyword">if</span> (k == key) &#123;</span><br><span class="line">            v.value = value;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¦‚æœæŸ¥æ‰¾åˆ°ä¸ºkeyä¸ºnullçš„entryï¼Œè¯´æ˜keyè¿‡æœŸï¼Œè¢«GCå›æ”¶</span></span><br><span class="line">        <span class="comment">// è¿™ä¸ªæ—¶å€™è¦åˆå§‹åŒ–æ¢æµ‹å¼æ¸…ç†çš„èµ·å§‹ä½ç½®</span></span><br><span class="line">        <span class="comment">// æ›¿æ¢è¿‡æœŸå…ƒç´ </span></span><br><span class="line">        <span class="keyword">if</span> (k == <span class="literal">null</span>) &#123;</span><br><span class="line">            replaceStateEntry(key, value, i);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¾ªç¯æŸ¥æ‰¾è¿‡ç¨‹ä¸­ï¼Œæ²¡æœ‰æ‰¾åˆ°keyç›¸ç­‰çš„entryï¼Œä¸”æ²¡æœ‰keyè¿‡æœŸçš„entry</span></span><br><span class="line">    <span class="comment">// åˆ™æ–°å»ºä¸€ä¸ªentryæ”¾å…¥entryè¡¨ä¸­</span></span><br><span class="line">    table[i] = <span class="keyword">new</span> <span class="title class_">Entry</span>(key, value);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å­˜æ”¾å…ƒç´ æ•°é‡+1</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">sz</span> <span class="operator">=</span> ++size;</span><br><span class="line">    <span class="comment">// è°ƒç”¨å¯å‘å¼æ¸…ç†ï¼Œ ä¸”å…ƒç´ æ•°é‡å¤§äºæ‰©å®¹é˜™å€¼</span></span><br><span class="line">    <span class="comment">// åˆ™è°ƒç”¨rehashæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè¿›è¡Œkeyè¿‡æœŸçš„entryæ¸…ç†å·¥ä½œï¼Œæ¸…ç†å®Œæˆä¹‹åå†åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)</span><br><span class="line">    rehash();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç æµç¨‹ä¸»è¦å¦‚ä¸‹ï¼š</p><ol><li>é¦–å…ˆè·å–<code>Entry</code>è¡¨ï¼Œ<code>Entry</code>è¡¨é•¿åº¦ï¼Œé€šè¿‡<code>hashCode</code>è®¡ç®—ä¸‹æ ‡ï¼Œç„¶å<code>for</code>å¾ªç¯<code>Entry</code>è¡¨ã€‚</li><li>å¦‚æœå¾ªç¯æŸ¥æ‰¾è¿‡ç¨‹ä¸­æ‰¾åˆ°äº†<code>key</code>ç›¸ç­‰çš„<code>Entry</code>åˆ™æ›´æ–°<code>value</code>å¯¹åº”æˆ‘ä»¬ä¸Šé¢è¯´çš„<strong>ç¬¬äºŒç§æƒ…å†µ</strong>ã€‚</li><li>å¦‚æœå¾ªç¯æŸ¥æ‰¾è¿‡ç¨‹æ‰¾åˆ°äº†<code>key</code>ä¸º<code>null</code>çš„<code>Entry</code>ï¼Œè¯´æ˜<code>key</code>è¿‡æœŸäº†ï¼Œæ›¿æ¢è¿‡æœŸå…ƒç´ ï¼Œéœ€è¦åˆå§‹åŒ–æ¢æµ‹å¼æ¸…ç†çš„å…¶å®ä½ç½®ï¼Œè°ƒç”¨<code>replaceStaleEntry()</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æˆ‘ä»¬ä¸‹é¢å†è¯´ï¼Œè¿™ä¸ªå¯¹åº”æˆ‘ä»¬ä¸Šé¢è¯´çš„<strong>ç¬¬å››ç§æƒ…å†µã€‚</strong></li><li><code>for</code>å¾ªç¯æŸ¥æ‰¾å®Œæ¯•ï¼Œè¯´æ˜åœ¨æŸ¥æ‰¾è¿‡ç¨‹ä¸­è¯¥ä¸‹æ ‡å¯¹åº”çš„<code>Entry</code>ä¸º<code>null</code>ï¼Œåˆ™åœ¨æ–°å»ºä¸€ä¸ª<code>Entry</code>æ”¾å…¥è¯¥æ§½ä½ï¼Œç„¶åè°ƒç”¨<strong>å¯å‘å¼æ¸…ç†</strong>å·¥ä½œã€‚</li><li>å¦‚æœ<strong>å¯å‘å¼æ¸…ç†</strong>æœªæ¸…ç†ä»»åŠ¡æ•°æ®ï¼Œä¸”<code>size</code>è¶…è¿‡æ‰©å®¹é˜™å€¼(2&#x2F;3)ï¼Œåˆ™è°ƒç”¨<code>rehash()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå…ˆè¿›è¡Œä¸€æ¬¡æ¢æµ‹å¼æ¸…ç†ï¼Œæ¸…ç†è¿‡æœŸå…ƒç´ ï¼Œæ¸…ç†å®Œæ¯•ä¹‹åå¦‚æœ<code>size &gt;= threshold - threshold / 4 </code>ï¼Œåˆ™ä¼šè¿›è¡Œæ‰©å®¹æ“ä½œã€‚</li></ol><p>æ¥ä¸‹æ¥çœ‹æ ¸å¿ƒæ–¹æ³•<code>replaceStaleEntry()</code>ï¼Œè¯¥æ–¹æ³•åœ¨æŸ¥æ‰¾è¿‡ç¨‹ä¸­é‡åˆ°<code>key = null</code>æ•°æ®çš„æ—¶å€™ä¼šæ‰§è¡Œï¼Œè¯¥æ–¹æ³•æä¾›äº†æ›¿æ¢è¿‡æœŸæ•°æ®çš„åŠŸèƒ½ï¼Œå¯ä»¥å¯¹åº”ä¸Šé¢è¯´<strong>ç¬¬å››ç§æƒ…å†µ</strong>æ¥çœ‹ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">replaceStaleEntry</span><span class="params">(ThreadLocal&lt;?&gt; key, Object value,</span></span><br><span class="line"><span class="params">                                       <span class="type">int</span> staleSlot)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–Entryè¡¨</span></span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="comment">// è·å–Entryè¡¨é•¿åº¦</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line">    Entry e;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šä¹‰æ¢æµ‹å¼æ¸…ç†èµ·å§‹ä½ç½® slotToExpunge = staleSlot</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">slotToExpunge</span> <span class="operator">=</span> staleSlot;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä»staleSlotå¼€å§‹å‘å‰è¿­ä»£æŸ¥æ‰¾æ˜¯å¦æœ‰key=nullçš„entry</span></span><br><span class="line">    <span class="comment">// å¦‚æœæœ‰åˆ™æ›´æ–°slotToExpunge</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> prevIndex(staleSlot, len);</span><br><span class="line">         (e = tab[i]) != <span class="literal">null</span>;</span><br><span class="line">         i = prevIndex(i, len))</span><br><span class="line">        <span class="keyword">if</span> (e.get() == <span class="literal">null</span>)</span><br><span class="line">            slotToExpunge = i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// staleSlotå¼€å§‹å‘åå¾ªç¯</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> nextIndex(staleSlot, len);</span><br><span class="line">         (e = tab[i]) != <span class="literal">null</span>;</span><br><span class="line">         i = nextIndex(i, len)) &#123;</span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœæŸ¥æ‰¾åˆ°äº†keyç›¸ç­‰entry</span></span><br><span class="line">        <span class="comment">// åˆ™æ›¿æ¢staleSlotå’Œiçš„ä½ç½®ï¼Œä¸”æ›´æ–°valueçš„å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (k == key) &#123;</span><br><span class="line">            e.value = value;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// æ›¿æ¢staleSlotå’Œiçš„ä½ç½®</span></span><br><span class="line">            tab[i] = tab[staleSlot];</span><br><span class="line">            <span class="comment">// æ›´æ–°valueå€¼</span></span><br><span class="line">            tab[staleSlot] = e;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¦‚æœslotToExpunge == staleSlotï¼Œè¯´æ˜å‘å‰å¾ªç¯çš„æ²¡æœ‰æŸ¥æ‰¾åˆ°keyè¿‡æœŸçš„entry</span></span><br><span class="line">            <span class="comment">// æ›´æ–°slotToExpungeå€¼</span></span><br><span class="line">            <span class="comment">// åˆ™ä¼šè°ƒç”¨å¯åŠ¨å¼è¿‡æœŸæ¸…ç†ï¼Œå…ˆä¼šè¿›è¡Œä¸€éè¿‡æœŸå…ƒç´ æ¢æµ‹æ“ä½œ</span></span><br><span class="line">            <span class="keyword">if</span> (slotToExpunge == staleSlot)</span><br><span class="line">                slotToExpunge = i;</span><br><span class="line">            cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœæ‰¾åˆ°äº†keyä¸ºnull ä¸”å‘å‰å¾ªç¯çš„æ²¡æœ‰æŸ¥æ‰¾åˆ°keyè¿‡æœŸçš„entry</span></span><br><span class="line">        <span class="comment">// åˆ™æ›´æ–°slotToExpunge</span></span><br><span class="line">        <span class="keyword">if</span> (k == <span class="literal">null</span> &amp;&amp; slotToExpunge == staleSlot)</span><br><span class="line">            slotToExpunge = i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯´æ˜æ²¡æœ‰æ‰¾åˆ°k == keyçš„æ•°æ®ï¼Œä¸”ç¢°åˆ°Entryä¸ºnullçš„æ•°æ®</span></span><br><span class="line">    <span class="comment">// åˆ™å°†æ•°æ®æ”¾å…¥è¯¥æ§½ä½</span></span><br><span class="line">    tab[staleSlot].value = <span class="literal">null</span>;</span><br><span class="line">    tab[staleSlot] = <span class="keyword">new</span> <span class="title class_">Entry</span>(key, value);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// slotToExpunge != staleSlot è¯´æ˜ä»staleSlotå¼€å§‹å‘å‰è¿­ä»£æŸ¥æ‰¾æœ‰key=nullçš„entry</span></span><br><span class="line">    <span class="keyword">if</span> (slotToExpunge != staleSlot)</span><br><span class="line">        <span class="comment">// å¯åŠ¨å¼æ¸…ç†ä¹‹å‰ï¼Œå…ˆä¼šè¿›è¡Œä¸€æ¬¡è¿‡æœŸå…ƒç´ æ¢æµ‹ï¼Œå¦‚æœå‘ç°äº†æœ‰è¿‡æœŸçš„æ•°æ®å°±ä¼šå…ˆè¿›è¡Œæ¢æµ‹å¼æ¸…ç†</span></span><br><span class="line">        cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>é¦–å…ˆè·å–<code>Entry</code>è¡¨ï¼Œ<code>Entry</code>è¡¨é•¿åº¦ï¼Œå®šä¹‰æ¢æµ‹å¼æ¸…ç†èµ·å§‹ä½ç½® <code>slotToExpunge = staleSlot</code>ã€‚</li><li>ä»staleSlotå¼€å§‹å‘å‰è¿­ä»£æŸ¥æ‰¾æ˜¯å¦æœ‰<code>key=null</code>çš„<code>entry</code>ï¼Œå¦‚æœæœ‰åˆ™æ›´æ–°<code>slotToExpunge</code>ã€‚</li><li><code>staleSlot</code>å¼€å§‹å‘åå¾ªç¯ï¼Œå¦‚æœæŸ¥æ‰¾åˆ°äº†<code>key</code>ç›¸ç­‰<code>entry</code>ï¼Œåˆ™æ›¿æ¢<code>staleSlot</code>å’Œ<code>i</code>çš„ä½ç½®ï¼Œä¸”æ›´æ–°<code>value</code>çš„å€¼ï¼Œç„¶ååˆ¤æ–­<code>slotToExpunge == staleSlot</code>ï¼Œè¯´æ˜å‘å‰å¾ªç¯çš„æ²¡æœ‰æŸ¥æ‰¾åˆ°<code>key</code>è¿‡æœŸçš„<code>entry</code>ï¼Œ ç„¶åæ›´æ–°<code>slotToExpunge</code>å€¼ï¼Œåˆ™ä¼šè°ƒç”¨å¯åŠ¨å¼è¿‡æœŸæ¸…ç†ï¼Œå…ˆä¼šè¿›è¡Œä¸€éè¿‡æœŸå…ƒç´ æ¢æµ‹æ“ä½œï¼Œå¦‚æœå‘ç°äº†æœ‰è¿‡æœŸçš„æ•°æ®å°±ä¼šå…ˆè¿›è¡Œæ¢æµ‹å¼æ¸…ç†ã€‚</li><li>å¦‚æœæ‰¾åˆ°äº†<code>key</code>ä¸º<code>null </code>ä¸”å‘å‰å¾ªç¯çš„æ²¡æœ‰æŸ¥æ‰¾åˆ°<code>key</code>è¿‡æœŸçš„<code>entry</code>ï¼Œåˆ™æ›´æ–°<code>slotToExpunge</code>ã€‚</li><li>å¾ªç¯ç»“æŸï¼Œæ–¹æ³•æ²¡æœ‰é€€å‡ºï¼Œè¯´æ˜æ²¡æœ‰æ‰¾åˆ°<code>k == key</code>çš„æ•°æ®ï¼Œä¸”ç¢°åˆ°<code>Entry=null</code>çš„æ•°æ®ï¼Œåˆ™å°†æ•°æ®æ”¾å…¥è¯¥æ§½ä½ã€‚</li><li>æœ€ååˆ¤æ–­<code>slotToExpunge != staleSlot</code>ï¼Œè¯´æ˜ä»<code>staleSlot</code>å¼€å§‹å‘å‰è¿­ä»£æŸ¥æ‰¾æœ‰<code>key=null</code>çš„<code>entry</code>ï¼Œåˆ™è°ƒç”¨å¯åŠ¨å¼æ¸…ç†ï¼Œåœ¨å¯åŠ¨å¼æ¸…ç†ä¹‹å‰ï¼Œå…ˆä¼šè¿›è¡Œä¸€æ¬¡è¿‡æœŸå…ƒç´ æ¢æµ‹ï¼Œå¦‚æœå‘ç°äº†æœ‰è¿‡æœŸçš„æ•°æ®å°±ä¼šå…ˆè¿›è¡Œæ¢æµ‹å¼æ¸…ç†ã€‚</li></ol><p><code>ThreadLocalMap.set()</code>æ–¹æ³•åˆ°è¿™é‡Œå·²ç»è§£æå®Œæ¯•ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥çœ‹çœ‹<code>ThreadLocalMap</code>è¿‡æœŸ key çš„å¯å‘å¼æ¸…ç†æµç¨‹ã€‚</p><h4 id="ThreadLocalMapè¿‡æœŸ-key-çš„å¯å‘å¼æ¸…ç†æµç¨‹"><a href="#ThreadLocalMapè¿‡æœŸ-key-çš„å¯å‘å¼æ¸…ç†æµç¨‹" class="headerlink" title="ThreadLocalMapè¿‡æœŸ key çš„å¯å‘å¼æ¸…ç†æµç¨‹"></a>ThreadLocalMapè¿‡æœŸ key çš„å¯å‘å¼æ¸…ç†æµç¨‹</h4><p>ä¸Šé¢æˆ‘ä»¬æåˆ°çš„<code>ThreadLocalMap</code>ä¸¤ç§è¿‡æœŸ<code>key</code>æ•°æ®æ¸…ç†æ–¹å¼ï¼š<strong>æ¢æµ‹å¼æ¸…ç†</strong>å’Œ<strong>å¯å‘å¼æ¸…ç†</strong>ã€‚</p><h5 id="æ¢æµ‹å¼æ¸…ç†"><a href="#æ¢æµ‹å¼æ¸…ç†" class="headerlink" title="æ¢æµ‹å¼æ¸…ç†"></a>æ¢æµ‹å¼æ¸…ç†</h5><p>æ¢æµ‹å¼æ¸…ç†æ–¹æ³•<code>expungeStaleEntry</code>ï¼Œéå†æ•£åˆ—æ•°ç»„ï¼Œä»å¼€å§‹ä½ç½®å‘åæ¢æµ‹æ¸…ç†è¿‡æœŸæ•°æ®ï¼Œå°†è¿‡æœŸæ•°æ®çš„<code>Entry</code>è®¾ç½®ä¸º<code>null</code>ï¼Œéå†è¿‡ç¨‹å¦‚æœé‡åˆ°æœªè¿‡æœŸçš„æ•°æ®åˆ™ä¼šå°†æ­¤æ•°æ®<code>rehash</code>åé‡æ–°åœ¨<code>table</code>æ•°ç»„ä¸­å®šä½ï¼Œå¦‚æœå®šä½çš„ä½ç½®å·²ç»æœ‰äº†å…ƒç´ ï¼Œåˆ™ä¼šå°†æœªè¿‡æœŸçš„æ•°æ®æ”¾åœ¨æœ€é è¿‘æ­¤ä½ç½®çš„<code>Entry = null</code>çš„æ¡¶ä¸­ï¼Œä½¿<code>rehash</code>åçš„<code>Entry</code>æ•°æ®è·ç¦»æ­£ç¡®çš„æ¡¶ä½ç½®æ›´è¿‘ä¸€ç‚¹ã€‚è¿™ç§ä¼˜åŒ–ä¼šæé«˜æ•´ä¸ªæ•£åˆ—è¡¨æŸ¥è¯¢æ€§èƒ½ã€‚</p><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://qtspace.cn/contentimg/35.jpg"></p><p>æ¢æµ‹å¼æ¸…ç†è¿­ä»£çš„è¿‡ç¨‹ä¸­é‡åˆ°äº†ç©ºçš„æ§½ä½ï¼Œåˆ™ç»ˆæ­¢æ¢æµ‹ï¼Œè¿™æ ·å­ä¸€è½®æ¢æµ‹å¼æ¸…ç†å°±å·¥ä½œå®Œæˆï¼Œæˆ‘ä»¬çœ‹çœ‹å…·ä½“çš„æºç å®ç°ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// staleSlotæ¢æµ‹å¼æ¸…ç†èµ·å§‹ä½ç½®</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">expungeStaleEntry</span><span class="params">(<span class="type">int</span> staleSlot)</span> &#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†èµ·å§‹ä½ç½®ç½®ç©º</span></span><br><span class="line">    tab[staleSlot].value = <span class="literal">null</span>;</span><br><span class="line">    tab[staleSlot] = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// å…ƒç´ æ•°é‡å‡1</span></span><br><span class="line">    size--;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡æ–°è¿­ä»£æ•£åˆ—ï¼Œç›´åˆ°å‘ç°ç©ºæ§½</span></span><br><span class="line">    Entry e;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = nextIndex(staleSlot, len);</span><br><span class="line">         (e = tab[i]) != <span class="literal">null</span>;</span><br><span class="line">         i = nextIndex(i, len)) &#123;</span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line"><span class="comment">// å¦‚æœkeyè¿‡æœŸï¼Œåˆ™æ¸…ç©ºå…ƒç´ ï¼Œæ•°é‡å‡1</span></span><br><span class="line">        <span class="keyword">if</span> (k == <span class="literal">null</span>) &#123;</span><br><span class="line">            e.value = <span class="literal">null</span>;</span><br><span class="line">            tab[i] = <span class="literal">null</span>;</span><br><span class="line">            size--;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœkeyæ²¡æœ‰è¿‡æœŸï¼Œåˆ™é‡æ–°è®¡ç®—hashï¼Œé‡æ–°è·å–ä¸‹æ ‡</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> k.threadLocalHashCode &amp; (len - <span class="number">1</span>);</span><br><span class="line">            <span class="comment">// å¦‚æœå½“å‰ä¸‹æ ‡å­˜åœ¨å€¼ï¼Œåˆ™å¯»æ‰¾ç¦»å†²çªkeyæ‰€åœ¨entryæœ€è¿‘çš„ç©ºæ§½</span></span><br><span class="line">            <span class="keyword">if</span> (h != i) &#123;</span><br><span class="line">                <span class="comment">// iä½ç½®æ§½ç½®ç©º</span></span><br><span class="line">                tab[i] = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å¯»æ‰¾ç¦»å†²çªkeyæ‰€åœ¨entryæœ€è¿‘çš„ç©ºæ§½ï¼Œæ”¾å…¥è¯¥æ§½</span></span><br><span class="line">                <span class="keyword">while</span> (tab[h] != <span class="literal">null</span>)</span><br><span class="line">                    h = nextIndex(h, len);</span><br><span class="line">                tab[h] = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="å¯å‘å¼æ¸…ç†"><a href="#å¯å‘å¼æ¸…ç†" class="headerlink" title="å¯å‘å¼æ¸…ç†"></a>å¯å‘å¼æ¸…ç†</h5><p>å¯å‘å¼æ¸…ç†è¢«ä½œè€…å®šä¹‰ä¸ºï¼š<strong>Heuristically scan some cells looking for stale entries</strong></p><p>æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">cleanSomeSlots</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">removed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        i = nextIndex(i, len); <span class="comment">// ä»ä¸‹ä¸€ä¸ªä½ç½®å¼€å§‹</span></span><br><span class="line">        <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> tab[i];</span><br><span class="line">        <span class="comment">// éå†åˆ°key==nullçš„Entry</span></span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span> &amp;&amp; e.get() == <span class="literal">null</span>) &#123;</span><br><span class="line">            n = len; <span class="comment">// é‡ç½®n</span></span><br><span class="line">            removed = <span class="literal">true</span>; <span class="comment">// æ ‡å¿—æœ‰æ¸…ç†å…ƒç´ </span></span><br><span class="line">            i = expungeStaleEntry(i); <span class="comment">// æ¸…ç†</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> ( (n &gt;&gt;&gt;= <span class="number">1</span>) != <span class="number">0</span>); <span class="comment">// log(n) é™åˆ¶--å¯¹æ•°æ¬¡</span></span><br><span class="line">    <span class="keyword">return</span> removed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»<code>i</code>çš„ä¸‹ä¸€ä¸ªä½ç½®åˆ¤æ–­å…ƒç´ æ˜¯å¦éœ€è¦æ¸…é™¤ï¼Œå¦‚æœé‡åˆ°<code>key==null</code>çš„å…ƒç´ åˆ™ä¼šé‡ç½®<code>n</code>ï¼Œéœ€è¦æ¸…é™¤ä¸”æ›´æ–°<code>i</code>çš„å€¼ï¼Œåˆ¤æ–­ä¸”æ¸…é™¤å®Œæ¯•ä¹‹åï¼Œ<code>n = n &gt;&gt;&gt; 1</code>ç›´åˆ°<code>n = 0</code>åˆ™é€€å‡ºæ¸…ç†ã€‚</p><h4 id="ThreadLocalMap-get-æ–¹æ³•è¯¦è§£"><a href="#ThreadLocalMap-get-æ–¹æ³•è¯¦è§£" class="headerlink" title="ThreadLocalMap.get()æ–¹æ³•è¯¦è§£"></a>ThreadLocalMap.get()æ–¹æ³•è¯¦è§£</h4><p>ä¸Šé¢å·²ç»è¯´å®Œäº†<code>set()</code>æ–¹æ³•çš„æºç ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹<code>get()</code>æ–¹æ³•çš„æ“ä½œåŸç†ï¼Œä¸»è¦åŒ…å«ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯<code>hash</code>è®¡ç®—å‡ºä¸‹æ ‡ï¼Œè¯¥ä¸‹æ ‡å¯¹åº”çš„<code>Entry.key</code>å’Œæˆ‘ä»¬ä¼ å…¥çš„<code>key</code>ç›¸ç­‰çš„æƒ…å†µï¼Œå¦å¤–ä¸€ç§å°±æ˜¯ä¸ç›¸ç­‰çš„æƒ…å†µã€‚</p><p><strong>ç›¸ç­‰æƒ…å†µï¼š</strong>ç›¸ç­‰æƒ…å†µå¤„ç†å¾ˆç®€å•ï¼Œç›´æ¥è¿”å›<code>value</code>ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://qtspace.cn/contentimg/36.jpg"></p><p>ä¸Šå›¾ä¸­æ¯”å¦‚<code>get(ThreadLocal1)</code>è®¡ç®—ä¸‹æ ‡ä¸º4ï¼Œä¸”4å­˜åœ¨<code>Entry</code>ï¼Œä¸”<code>key</code>ç›¸ç­‰ï¼Œåˆ™ç›´æ¥è¿”å›<code>value = 11</code>ã€‚</p><p><strong>ä¸ç›¸ç­‰æƒ…å†µ</strong>ï¼šä¸ç›¸ç­‰æƒ…å†µï¼Œå…ˆçœ‹å›¾ï¼š</p><p>ä»¥<code>get(ThreadLocal2)</code>ä¸ºä¾‹è®¡ç®—ä¸‹æ ‡ä¸º4ï¼Œä¸”4å­˜åœ¨<code>Entry</code>ï¼Œä½†<code>key</code>ç›¸ç­‰ï¼Œè¿™ä¸ªæ—¶å€™åˆ™ä¸ºå¾€åè¿­ä»£å¯»æ‰¾<code>key</code>ç›¸ç­‰çš„å…ƒç´ ï¼Œå¦‚æœå¯»æ‰¾è¿‡ç¨‹ä¸­å‘ç°äº†æœ‰<code>key = null</code>çš„å…ƒç´ åˆ™å›è¿›è¡Œæ¢æµ‹å¼æ¸…ç†æ“ä½œã€‚å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://qtspace.cn/contentimg/37.jpg"></p><p>è¿­ä»£åˆ°<code>index=5</code>çš„æ•°æ®æ—¶ï¼Œæ­¤æ—¶<code>Entry.key=null</code>ï¼Œè§¦å‘ä¸€æ¬¡æ¢æµ‹å¼æ•°æ®å›æ”¶æ“ä½œï¼Œæ‰§è¡Œ<code>expungeStaleEntry()</code>æ–¹æ³•ï¼Œæ‰§è¡Œå®Œåï¼Œ<code>index 5,8</code>çš„æ•°æ®éƒ½ä¼šè¢«å›æ”¶ï¼Œè€Œ<code>index 6,7</code>çš„æ•°æ®éƒ½ä¼šå‰ç§»ï¼Œæ­¤æ—¶ç»§ç»­å¾€åè¿­ä»£ï¼Œåˆ°<code>index = 6</code>çš„æ—¶å€™å³æ‰¾åˆ°äº†<code>key</code>å€¼ç›¸ç­‰çš„<code>Entry</code>æ•°æ®ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://qtspace.cn/contentimg/38.jpg"></p><p><code>ThreadLocalMap.get()</code>æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">    <span class="keyword">if</span> (map != <span class="literal">null</span>) &#123;</span><br><span class="line">        ThreadLocalMap.<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> map.getEntry(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            <span class="type">T</span> <span class="variable">result</span> <span class="operator">=</span> (T)e.value;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æœªæ‰¾åˆ°çš„è¯ï¼Œåˆ™è°ƒç”¨setInitialValue()æ–¹æ³•è®¾ç½®null</span></span><br><span class="line">    <span class="keyword">return</span> setInitialValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Entry <span class="title function_">getEntry</span><span class="params">(ThreadLocal&lt;?&gt; key)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> key.threadLocalHashCode &amp; (table.length - <span class="number">1</span>);</span><br><span class="line">    <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> table[i];</span><br><span class="line">    <span class="comment">// keyç›¸ç­‰ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (e != <span class="literal">null</span> &amp;&amp; e.get() == key)</span><br><span class="line">        <span class="keyword">return</span> e;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// keyä¸ç›¸ç­‰è°ƒç”¨getEntryAfterMiss()æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">return</span> getEntryAfterMiss(key, i, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Entry <span class="title function_">getEntryAfterMiss</span><span class="params">(ThreadLocal&lt;?&gt; key, <span class="type">int</span> i, Entry e)</span> &#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿­ä»£å¾€åæŸ¥æ‰¾keyç›¸ç­‰çš„entry</span></span><br><span class="line">    <span class="keyword">while</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">        <span class="keyword">if</span> (k == key)</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">        <span class="comment">// é‡åˆ°key=nullçš„entryï¼Œå…ˆè¿›è¡Œæ¢æµ‹å¼æ¸…ç†å·¥ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (k == <span class="literal">null</span>)</span><br><span class="line">            expungeStaleEntry(i);</span><br><span class="line">        <span class="type">else</span></span><br><span class="line">            <span class="variable">i</span> <span class="operator">=</span> nextIndex(i, len);</span><br><span class="line">        e = tab[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ThreadLocalMapçš„æ‰©å®¹æœºåˆ¶"><a href="#ThreadLocalMapçš„æ‰©å®¹æœºåˆ¶" class="headerlink" title="ThreadLocalMapçš„æ‰©å®¹æœºåˆ¶"></a>ThreadLocalMapçš„æ‰©å®¹æœºåˆ¶</h4><p>åœ¨<code>ThreadLocalMap.set()</code>æ–¹æ³•æœ€åï¼Œå¦‚æœæ‰§è¡Œå®Œå¯å‘å¼æ¸…ç†å·¥ä½œä¹‹åï¼Œæœªæ¸…ç†ä»»ä½•æ•°æ®ï¼Œä¸”å½“å‰æ•£åˆ—æ•°ç»„ä¸­å…ƒç´ å·²ç»è¶…è¿‡æ‰©å®¹é˜™å€¼<code>len*2/3</code>ï¼Œåˆ™æ‰§è¡Œ<code>rehash()</code>é€»è¾‘ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)</span><br><span class="line">    rehash();</span><br></pre></td></tr></table></figure><p><code>rehash()</code>æ–¹æ³•æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">rehash</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//å…ˆè¿›è¡Œæ¢æµ‹å¼æ¸…ç†å·¥ä½œ</span></span><br><span class="line">    expungeStaleEntries();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ¢æµ‹å¼æ¸…ç†å®Œæ¯•ä¹‹å å¦‚æœsize &gt;= threshold - threshold / 4</span></span><br><span class="line">    <span class="comment">// ä¹Ÿå°±æ˜¯size &gt;= threshold * 3/4ï¼Œä¹Ÿå°±æ˜¯ size &gt;= len * 1/2ï¼Œåˆ™æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (size &gt;= threshold - threshold / <span class="number">4</span>)</span><br><span class="line">        resize();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">expungeStaleEntries</span><span class="params">()</span> &#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; len; j++) &#123;</span><br><span class="line">        <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> tab[j];</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span> &amp;&amp; e.get() == <span class="literal">null</span>)</span><br><span class="line">            expungeStaleEntry(j);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>rehash()</code>æ–¹æ³•æºç æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>é¦–å…ˆè¿›è¡Œæ¢æµ‹å¼æ¸…ç†å·¥ä½œ</li><li>å¦‚æœæ¢æµ‹å¼æ¸…ç†å·¥ä½œå®Œæ¯•ä¹‹åï¼Œå¦‚æœ<code>size &gt;= threshold - threshold / 4</code>ï¼Œ ä¹Ÿå°±æ˜¯<code>size &gt;= threshold * 3/4</code>ï¼Œä¹Ÿå°±æ˜¯ <code>size &gt;= len * 1/2</code>ï¼Œåˆ™è°ƒç”¨<code>resize()</code>æ‰©å®¹ã€‚</li></ol><p>æ‰©å®¹æ–¹æ³•<code>resize()</code>æ–¹æ³•æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">resize</span><span class="params">()</span> &#123;</span><br><span class="line">    Entry[] oldTab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">oldLen</span> <span class="operator">=</span> oldTab.length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">newLen</span> <span class="operator">=</span> oldLen * <span class="number">2</span>;</span><br><span class="line">    Entry[] newTab = <span class="keyword">new</span> <span class="title class_">Entry</span>[newLen];</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; oldLen; ++j) &#123;</span><br><span class="line">        <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> oldTab[j];</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">            <span class="keyword">if</span> (k == <span class="literal">null</span>) &#123;</span><br><span class="line">                e.value = <span class="literal">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> k.threadLocalHashCode &amp; (newLen - <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">while</span> (newTab[h] != <span class="literal">null</span>)</span><br><span class="line">                    h = nextIndex(h, newLen);</span><br><span class="line">                newTab[h] = e;</span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setThreshold(newLen);</span><br><span class="line">    size = count;</span><br><span class="line">    table = newTab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰©å®¹æ–¹æ³•æ‰§è¡Œä¹‹å<code>tab</code>çš„å¤§å°ä¸ºåŸå…ˆçš„ä¸¤å€<code>oldLen * 2</code>ï¼Œç„¶åå˜é‡è€çš„æ•£åˆ—è¡¨ï¼Œé‡æ–°è®¡ç®—<code>hash</code>ä½ç½®ï¼Œç„¶åæ”¾åˆ°æ–°çš„æ•£åˆ—è¡¨ä¸­ï¼Œå¦‚æœå‡ºç°<code>hash</code>å†²çªåˆ™å¾€åå¯»æ‰¾æœ€è¿‘çš„<code>entry</code>ä¸º<code>null</code>çš„æ§½ä½æ”¾å…¥ï¼Œæ‰©å®¹å®Œæˆä¹‹åï¼Œé‡æ–°è®¡ç®—æ‰©å®¹é˜™å€¼ã€‚</p><h3 id="å…­ã€ThreadLocal-get-æ–¹æ³•æºç è¯¦è§£"><a href="#å…­ã€ThreadLocal-get-æ–¹æ³•æºç è¯¦è§£" class="headerlink" title="å…­ã€ThreadLocal.get()æ–¹æ³•æºç è¯¦è§£"></a>å…­ã€ThreadLocal.get()æ–¹æ³•æºç è¯¦è§£</h3><p><code>ThreadLcoal.get()</code>æ–¹æ³•æºç è¯¦è§£å·²ç»åœ¨<code>ThreadLocalMap.get()</code>æ–¹æ³•æºç è§£æä¸­å®Œæˆã€‚</p><h3 id="ä¸ƒã€ThreadLocal-remove-æ–¹æ³•æºç è¯¦è§£"><a href="#ä¸ƒã€ThreadLocal-remove-æ–¹æ³•æºç è¯¦è§£" class="headerlink" title="ä¸ƒã€ThreadLocal.remove()æ–¹æ³•æºç è¯¦è§£"></a>ä¸ƒã€ThreadLocal.remove()æ–¹æ³•æºç è¯¦è§£</h3><p><code>ThreadLocal.remove()</code>æ–¹æ³•æµç¨‹æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬ç»“åˆæºç æ¥è¯´æ˜ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">m</span> <span class="operator">=</span> getMap(Thread.currentThread());</span><br><span class="line">    <span class="keyword">if</span> (m != <span class="literal">null</span>)</span><br><span class="line">        m.remove(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(ThreadLocal&lt;?&gt; key)</span> &#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> key.threadLocalHashCode &amp; (len-<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä»hashè·å–çš„ä¸‹æ ‡å¼€å§‹ï¼Œå¯»æ‰¾keyç›¸ç­‰çš„entryå…ƒç´ æ¸…é™¤</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> tab[i];</span><br><span class="line">         e != <span class="literal">null</span>;</span><br><span class="line">         e = tab[i = nextIndex(i, len)]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e.get() == key) &#123;</span><br><span class="line">            e.clear();</span><br><span class="line">            expungeStaleEntry(i);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ThreadLocal.remove()</code>æ ¸å¿ƒæ˜¯è°ƒç”¨<code>ThreadLocalMap.remove()</code>æ–¹æ³•ï¼Œæµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>é€šè¿‡<code>hash</code>è®¡ç®—ä¸‹æ ‡ã€‚</li><li>ä»æ•£åˆ—è¡¨è¯¥ä¸‹æ ‡å¼€å§‹å¾€åæŸ¥<code>key</code>ç›¸ç­‰çš„å…ƒç´ ï¼Œå¦‚æœæ‰¾åˆ°åˆ™åšæ¸…é™¤æ“ä½œï¼Œå¼•ç”¨ç½®ä¸º<code>null</code>ï¼Œ<code>GC</code>çš„æ—¶å€™<code>key</code>å°±ä¼šç½®ä¸º<code>null</code>ï¼Œç„¶åæ‰§è¡Œæ¢æµ‹å¼æ¸…ç†å¤„ç†ã€‚</li></ol><h3 id="å…«ã€InheritableThreadLocal"><a href="#å…«ã€InheritableThreadLocal" class="headerlink" title="å…«ã€InheritableThreadLocal"></a>å…«ã€InheritableThreadLocal</h3><p>æˆ‘ä»¬åœ¨ä½¿ç”¨<code>ThreadLocal</code>çš„æ—¶å€™ï¼Œåœ¨å¼‚æ­¥åœºæ™¯ä¸‹æ˜¯æ— æ³•ç»™å­çº¿ç¨‹å…±äº«çˆ¶çº¿ç¨‹ä¸­åˆ›å»ºçš„çº¿ç¨‹å‰¯æœ¬æ•°æ®çš„ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ<code>JDK</code>ä¸­è¿˜æœ‰ä¸€ä¸ª<code>InheritableThreadLocal</code>ç±»ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    ThreadLocal&lt;String&gt; ThreadLocal = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line">    ThreadLocal&lt;String&gt; inheritableThreadLocal = <span class="keyword">new</span> <span class="title class_">InheritableThreadLocal</span>&lt;&gt;();</span><br><span class="line">    ThreadLocal.set(<span class="string">&quot;çˆ¶ç±»æ•°æ®:threadLocal&quot;</span>);</span><br><span class="line">    inheritableThreadLocal.set(<span class="string">&quot;çˆ¶ç±»æ•°æ®:inheritableThreadLocal&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å­çº¿ç¨‹è·å–çˆ¶ç±»ThreadLocalæ•°æ®ï¼š&quot;</span> + ThreadLocal.get());</span><br><span class="line">            System.out.println(<span class="string">&quot;å­çº¿ç¨‹è·å–çˆ¶ç±»inheritableThreadLocalæ•°æ®ï¼š&quot;</span> + inheritableThreadLocal.get());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç è¾“å‡ºç»“æœä¸ºï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å­çº¿ç¨‹è·å–çˆ¶ç±»ThreadLocalæ•°æ®ï¼šnull</span><br><span class="line">å­çº¿ç¨‹è·å–çˆ¶ç±»inheritableThreadLocalæ•°æ®ï¼šçˆ¶ç±»æ•°æ®:inheritableThreadLocal</span><br></pre></td></tr></table></figure><p>å®ç°åŸç†æ˜¯å­çº¿ç¨‹é€šè¿‡çˆ¶çº¿ç¨‹ä¸­è°ƒç”¨<code>new Thread()</code>æ–¹æ³•åˆ›å»ºå­çº¿ç¨‹ï¼Œ<code>Thread#init</code>æ–¹æ³•åœ¨<code>Thread</code>çš„æ„é€ æ–¹æ³•ä¸­è¢«è°ƒç”¨ï¼Œ<code>init()</code>æ–¹æ³•ä¸­æ‹·è´çˆ¶çº¿ç¨‹æ•°æ®æºåˆ°å­çº¿ç¨‹ä¸­ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ThreadGroup g, Runnable target, String name,</span></span><br><span class="line"><span class="params">                      <span class="type">long</span> stackSize, AccessControlContext acc,</span></span><br><span class="line"><span class="params">                      <span class="type">boolean</span> inheritThreadLocals)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;name cannot be null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inheritThreadLocals &amp;&amp; parent.inheritableThreadLocals != <span class="literal">null</span>)</span><br><span class="line">        <span class="built_in">this</span>.inheritableThreadLocals =</span><br><span class="line">            ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);</span><br><span class="line">    <span class="built_in">this</span>.stackSize = stackSize;</span><br><span class="line">    tid = nextThreadID();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†<code>InheritableThreadLocal</code>ä»ç„¶æœ‰ç¼ºé™·ï¼Œä¸€èˆ¬æˆ‘ä»¬åšå¼‚æ­¥åŒ–å¤„ç†éƒ½æ˜¯ä½¿ç”¨çš„çº¿ç¨‹æ± ï¼Œè€Œ<code>InheritableThreadLocal</code>æ˜¯åœ¨<code>new Thread</code>ä¸­çš„<code>init()</code>æ–¹æ³•ç»™èµ‹å€¼çš„ï¼Œè€Œçº¿ç¨‹æ± æ˜¯çº¿ç¨‹å¤ç”¨çš„é€»è¾‘ï¼Œæ‰€ä»¥è¿™é‡Œä¼šå­˜åœ¨é—®é¢˜ã€‚</p><p>å½“ç„¶ï¼Œæœ‰é—®é¢˜å‡ºç°å°±ä¼šæœ‰è§£å†³é—®é¢˜çš„æ–¹æ¡ˆï¼Œé˜¿é‡Œå·´å·´å¼€æºäº†ä¸€ä¸ª<code>TransmittableThreadLocal</code>ç»„ä»¶å°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¿™é‡Œå°±ä¸å†å»¶ä¼¸ï¼Œæ„Ÿå…´è¶£çš„å¯è‡ªè¡ŒæŸ¥é˜…èµ„æ–™ã€‚</p><blockquote><p>å‚è€ƒï¼š<a href="https://javaguide.cn/java/concurrent/threadlocal.html">https://javaguide.cn/java/concurrent/threadlocal.html</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ThreadLocal </tag>
            
            <tag> ThreadLocalMap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaé”(ä¸‰)ï¼šSemaphoreå…±äº«é”è¯¦è§£</title>
      <link href="/2022/03/29/java-lock-semaphore/"/>
      <url>/2022/03/29/java-lock-semaphore/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h3 id="ä¸€ã€åŸºäºAQSå®ç°çš„é”"><a href="#ä¸€ã€åŸºäºAQSå®ç°çš„é”" class="headerlink" title="ä¸€ã€åŸºäºAQSå®ç°çš„é”"></a>ä¸€ã€åŸºäºAQSå®ç°çš„é”</h3><p>AQSï¼ˆAbstractQueuedSynchronizerï¼‰ æ˜¯Javaå¹¶å‘åŒ…JUCä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªç±»ï¼Œå¤§éƒ¨åˆ†é”éƒ½æ˜¯åŸºäºAQSå®ç°çš„ï¼Œä¸»è¦å®ç°çš„ç±»å¦‚ä¸‹ï¼š</p><ul><li><p><code>ReentrantLock</code>ï¼šå¯é‡å…¥é”ï¼Œç‹¬å é”ï¼Œå®ç°äº†å…¬å¹³é”å’Œéå…¬å¹³é”ï¼Œè¿™ä¸ªæ˜¯ä¸Šç¯‡å†…å®¹ä»‹ç»çš„ç±»ï¼Œä¹Ÿæ˜¯æœ€å¸¸ç”¨ç±»ï¼Œé€šå¸¸ä¼šå’Œ<code>synchronized</code>ä½œæ¯”è¾ƒã€‚</p></li><li><p><code>ReentrantReadWriteLock</code>ï¼šè¯»å†™é”ï¼Œå¯å…±äº«ä¹Ÿå¯ç‹¬å é”ï¼Œè¯»æ˜¯å…±äº«é”ï¼Œå†™æ˜¯ç‹¬å é”ï¼Œä¹Ÿå®ç°äº†å…¬å¹³é”å’Œéå…¬å¹³é”ã€‚</p></li><li><p><code>Semaphore</code>ï¼šä¿¡å·é”ï¼Œå…±äº«é”ï¼Œä¹Ÿå®ç°äº†å…¬å¹³é”å’Œéå…¬å¹³é”ï¼Œä¸»è¦åŒäºæ§åˆ¶æµé‡ï¼Œæ¯”å¦‚ï¼šæ•°æ®åº“è¿æ¥æ± ç»™ä½ åˆ†é…10ä¸ªé“¾æ¥ï¼Œæ¥ä¸€ä¸ªåˆ†é…ä¸€ä¸ªï¼Œå¦‚æœ10ä¸ªéƒ½åˆ†é…å®Œäº†ä¸”æ²¡æœ‰é‡Šæ”¾é‚£å°±ç­‰å¾…é‡Šæ”¾ã€‚</p></li><li><p><code>CountDownLatch</code>ï¼šé—­é”ï¼Œå…±äº«é”ï¼Œä¹Ÿå®ç°äº†å…¬å¹³é”å’Œéå…¬å¹³é”ï¼ŒLatché—¨é—©çš„æ„æ€ï¼Œæ¯”å¦‚ï¼šè¯´å››ä¸ªäººä¸€ä¸ªæ¼‚æµè‰‡ï¼Œåæ»¡äº†å°±æ¨ä¸‹æ°´ã€‚</p></li><li></li></ul><h3 id="äºŒã€Semaphore"><a href="#äºŒã€Semaphore" class="headerlink" title="äºŒã€Semaphore"></a>äºŒã€Semaphore</h3><h4 id="Semaphoreæ˜¯ä»€ä¹ˆ"><a href="#Semaphoreæ˜¯ä»€ä¹ˆ" class="headerlink" title="Semaphoreæ˜¯ä»€ä¹ˆ"></a>Semaphoreæ˜¯ä»€ä¹ˆ</h4><p>ä¸Šé¢å·²ç»ä»‹ç»äº†<code>Semaphore</code>ï¼ŒåŸºäºAQSå®ç°çš„ä¿¡å·é”ï¼Œæ˜¯å…±äº«é”ï¼Œå®ç°äº†å…¬å¹³é”å’Œéå…¬å¹³é”ã€‚å¯ä»¥ç”¨æ¥æ§åˆ¶åŒæ—¶è®¿é—®ç‰¹å®šèµ„æºçš„çº¿ç¨‹æ•°ï¼Œé€šè¿‡åè°ƒå„ä¸ªçº¿ç¨‹ä»¥ä¿è¯åˆç†çš„ä½¿ç”¨èµ„æºã€‚</p><h4 id="Semaphoreä½¿ç”¨åœºæ™¯"><a href="#Semaphoreä½¿ç”¨åœºæ™¯" class="headerlink" title="Semaphoreä½¿ç”¨åœºæ™¯"></a>Semaphoreä½¿ç”¨åœºæ™¯</h4><p>é€šå¸¸ç”¨äºèµ„æºæœ‰æ˜ç¡®è®¿é—®æ•°é‡é™åˆ¶çš„åœºæ™¯ï¼Œå¸¸ç”¨äºé™æµã€‚</p><p>æ¯”å¦‚ï¼šæ•°æ®åº“è¿æ¥æ± ï¼ŒåŒæ—¶è¿›è¡Œè¿æ¥çš„çº¿ç¨‹æ•°é‡æœ‰é™åˆ¶ï¼Œè¿æ¥ä¸èƒ½è¶…è¿‡ä¸€å®šçš„æ•°é‡ï¼Œå½“è¿æ¥è¾¾åˆ°äº†é™åˆ¶çš„æ•°é‡åï¼Œåé¢çš„çº¿ç¨‹åªèƒ½æ’é˜Ÿç­‰å¾…å‰é¢çš„çº¿ç¨‹é‡Šæ”¾äº†æ•°æ®åº“é“¾æ¥æ‰èƒ½è·å–æ•°æ®åº“é“¾æ¥ã€‚</p><p>æ¯”å¦‚ï¼šåœè½¦åœºåœºæ™¯ï¼Œè½¦ä½æ•°é‡æœ‰é™ï¼ŒåŒæ—¶åªèƒ½å¬ä¸€å®šæ•°é‡çš„è½¦ï¼Œå½“åœæ»¡äº†ä¹‹åå¤–é¢çš„è½¦åªèƒ½ç­‰é‡Œé¢çš„è½¦å‡ºæ¥æ‰èƒ½è¿›å»åœè½¦ã€‚</p><h4 id="Semaphoreçš„å¸¸ç”¨æ–¹æ³•"><a href="#Semaphoreçš„å¸¸ç”¨æ–¹æ³•" class="headerlink" title="Semaphoreçš„å¸¸ç”¨æ–¹æ³•"></a>Semaphoreçš„å¸¸ç”¨æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»ä¿¡å·é”è·å–è·å–ä¸€ä¸ªé”ï¼Œåœ¨è·å–åˆ°é”ä¹‹å‰ä¸€ç›´å¤„ç†é˜»å¡çŠ¶æ€ï¼Œé™¤éçº¿ç¨‹è¢«ä¸­æ–­</span></span><br><span class="line">acquire();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»ä¿¡å·é”è·å–è·å–æŒ‡å®šæ•°é‡é”ï¼Œåœ¨è·å–åˆ°é”ä¹‹å‰ä¸€ç›´å¤„ç†é˜»å¡çŠ¶æ€ï¼Œé™¤éçº¿ç¨‹è¢«ä¸­æ–­</span></span><br><span class="line">acquire(<span class="type">int</span> permits);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»ä¿¡å·é”è·å–ä¸€ä¸ªé”ï¼Œåœ¨è·å–åˆ°é”ä¹‹å‰çº¿ç¨‹ä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ï¼ˆå¿½ç•¥ä¸­æ–­ï¼‰</span></span><br><span class="line">acquireUninterruptibly();</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°è¯•ä»ä¿¡å·é”è·å–é”ï¼Œè¿”å›è·å–æˆåŠŸæˆ–è€…å¤±è´¥ï¼Œä¸ä¼šé˜»å¡çº¿ç¨‹</span></span><br><span class="line">tryAcquire();</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°è¯•ä»ä¿¡å¥½é”è·å–é”ï¼ŒæŒ‡å®šè·å–æ—¶é—´ï¼Œåœ¨æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰è·å–åˆ°åˆ™è¶…æ—¶è¿”å›ï¼Œä¸ä¼šé˜»å¡çº¿ç¨‹</span></span><br><span class="line">tryAcquire(<span class="type">long</span> timeount, TimeUnit unit);</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">release();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–ç­‰å¾…é˜Ÿåˆ—ä¸­æ˜¯å¦è¿˜æœ‰ç­‰å¾…çº¿ç¨‹</span></span><br><span class="line">hadQueuedThreads();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–ç­‰å¾…é˜Ÿåˆ—é‡Œé˜»å¡çº¿ç¨‹çš„æ•°é‡</span></span><br><span class="line">getQueuedLength();</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸…ç©ºé”ï¼Œè¿”å›æ¸…ç©ºé”çš„æ•°é‡</span></span><br><span class="line">drainPermits();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›å¯ç”¨çš„é”çš„æ•°é‡</span></span><br><span class="line">availabelPermits();</span><br></pre></td></tr></table></figure><h4 id="Semaphoreå®ç°åŸç†"><a href="#Semaphoreå®ç°åŸç†" class="headerlink" title="Semaphoreå®ç°åŸç†"></a>Semaphoreå®ç°åŸç†</h4><h5 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h5><p>Semaphoreæä¾›äº†ä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼Œé»˜è®¤æ„é€ æ–¹æ³•åˆ›å»ºæŒ‡å®šé”æ•°é‡çš„éå…¬å¹³ä¿¡å·é”ï¼Œå¦å¤–ä¸€ä¸ªæ„é€ æ–¹æ³•å¤šäº†ä¸€ä¸ªæŒ‡å®šæ˜¯å…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é”çš„å‚æ•°ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ„å»ºæŒ‡å®šæ•°é‡é”çš„éå…¬å¹³ä¿¡å·é”</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Semaphore</span><span class="params">(<span class="type">int</span> permits)</span> &#123;</span><br><span class="line">    sync = <span class="keyword">new</span> <span class="title class_">NonfairSync</span>(permits);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ„å»ºæŒ‡å®šæ•°é‡é”çš„å…¬å¹³/éå…¬å¹³ä¿¡å·é”</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Semaphore</span><span class="params">(<span class="type">int</span> permits, <span class="type">boolean</span> fair)</span> &#123;</span><br><span class="line">    sync = fair ? <span class="keyword">new</span> <span class="title class_">FairSync</span>(permits) : <span class="keyword">new</span> <span class="title class_">NonfairSync</span>(permits);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="è·å–é”è¿‡ç¨‹"><a href="#è·å–é”è¿‡ç¨‹" class="headerlink" title="è·å–é”è¿‡ç¨‹"></a>è·å–é”è¿‡ç¨‹</h5><h6 id="acquire"><a href="#acquire" class="headerlink" title="acquire"></a>acquire</h6><p><code>acquire()</code>æ˜¯è·å–é”æ–¹æ³•ï¼Œè°ƒç”¨äº†å†…éƒ¨ç±»åŒæ­¥å™¨<code>Sync</code>ç»§æ‰¿äº†<code>AQS</code>å®é™…è°ƒç”¨<code>AQS</code>çš„<code>acquireSharedInterruptibly()</code>æ ¸å¿ƒï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedExcetion &#123;</span><br><span class="line">    sync.acquireSharedInterruptibly();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŠ JDKä¸­ï¼Œä¸é”ç›¸å…³çš„æ–¹æ³•ï¼Œ<code>Interruptibly</code>è¡¨ç¤ºå¯ä¸­æ–­ï¼Œä¹Ÿå°±æ˜¯å¯ä¸­æ–­é”ã€‚å¯ä¸­æ–­é”çš„æ„æ€æ˜¯<strong>çº¿ç¨‹åœ¨ç­‰å¾…è·å–é”çš„è¿‡ç¨‹ä¸­æ˜¯å¯ä»¥è¢«ä¸­æ–­çš„</strong>ï¼Œæ¢è¨€ä¹‹ï¼Œ<strong>çº¿ç¨‹åœ¨ç­‰å¾…é”çš„è¿‡ç¨‹ä¸­å¯ä»¥å“åº”ä¸­æ–­ã€‚</strong></p><h6 id="acquireSharedInterruptiby"><a href="#acquireSharedInterruptiby" class="headerlink" title="acquireSharedInterruptiby"></a>acquireSharedInterruptiby</h6><p><code>acquireSharedInterruptibly</code>æ–¹æ³•æ˜¯è·å–å¯ä¸­æ–­é”ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquireSharedInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span></span><br><span class="line">    <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="comment">// æ£€æµ‹çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ï¼Œå¦‚æœå·²ç»è¢«ä¸­æ–­äº†ï¼Œå°±å“åº”ä¸­æ–­ï¼Œè¯¥æ–¹æ³•ä¼šæ¸…é™¤çº¿ç¨‹ä¸­çš„ä¸­æ–­æ ‡è¯†</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">    <span class="comment">// å°è¯•è·å–é”ï¼Œargä¸ºé”çš„æ•°é‡</span></span><br><span class="line">    <span class="comment">// å½“é”è¢«è·å–å®Œäº†ä¹‹åï¼Œåˆ™ä¸ºå½“å‰çº¿ç¨‹åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹åŠ å…¥é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>)</span><br><span class="line">        doAcquireSharedInterruptibly(arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>acquireSharedInterruptibly</code>æ–¹æ³•é¦–å…ˆä¼šåˆ¤æ–­å½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€å¦‚æœæ˜¯ä¸­æ–­çŠ¶æ€åˆ™å“åº”ä¸­æ–­ï¼ŒæŠ›å¼‚å¸¸ï¼Œç„¶åè°ƒç”¨<code>tryAcquireShared()</code>æ–¹æ³•è·å–é”ï¼Œå¦‚æœé”è¢«è·å–å®Œäº†å°±ä¸ºå½“å‰çº¿ç¨‹åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ã€‚</p><h6 id="tryAcquireShared"><a href="#tryAcquireShared" class="headerlink" title="tryAcquireShared"></a>tryAcquireShared</h6><p><code>tryAcquireShared()</code>æ˜¯<code>AQS</code>å®šä¹‰çš„ä¸€ä¸ªæ¨¡ç‰ˆæ–¹æ³•ï¼Œå…·ä½“ç”±å­ç±»å®ç°ï¼Œ<code>Semaphore</code>ä¹Ÿå®ç°äº†å…¬å¹³é”å’Œéå…¬å¹³é”ï¼Œä¸¤ç§é”å¤§åŒå°å¼‚ï¼Œæˆ‘ä»¬å…·ä½“æ¥çœ‹ä¸€ä¸‹å…¬å¹³é”çš„å…·ä½“å®ç°ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">tryAcquireShared</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="comment">// è‡ªæ—‹</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦æœ‰æ’åœ¨è‡ªå·±å‰é¢çš„çº¿ç¨‹ï¼Œå¦‚æœæœ‰ç›´æ¥è¿”å›-1ï¼Œè¿›å…¥é˜»å¡çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> (hasQueuedPredecessors())</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="comment">// è·å–åŒæ­¥çŠ¶æ€çš„å€¼(å½“å‰å¯ç”¨é”æ•°é‡)</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">available</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="comment">// å‰©ä½™é”æ•°é‡ï¼Œ å¯ç”¨çš„-ç”³è¯·çš„</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">remaining</span> <span class="operator">=</span> available - acquires;</span><br><span class="line">        <span class="comment">// å¦‚æœå‰©ä½™çš„é”å°äº0, æˆ–è€…è®¾ç½®æˆåŠŸå°±è¿”å›ï¼Œå¦‚æœè®¾ç½®å¤±è´¥ç»§ç»­å¾ªç¯è®¾ç½®</span></span><br><span class="line">        <span class="comment">// å¦‚æœå‰©ä½™é”æ•°é‡å°äº0ï¼Œè¿”å›è´Ÿæ•°ï¼Œè¡¨ç¤ºè·å–é”å¤±è´¥</span></span><br><span class="line">        <span class="comment">// å¦‚æœå‰©ä½™é”æ•°é‡å¤§äº0ï¼Œä¸”è®¾ç½®çŠ¶æ€æˆåŠŸï¼Œè¡¨ç¤ºè·å–é”æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span> (remaining &lt; <span class="number">0</span> ||</span><br><span class="line">            compareAndSetState(available, remaining))</span><br><span class="line">            <span class="keyword">return</span> remaining;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>tryAcquireShared()</code>é€šè¿‡<strong>è‡ªæ—‹+CAS</strong>çš„æ–¹å¼è·å–é”å’Œä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p><h6 id="doAcquireSharedInterruptibly"><a href="#doAcquireSharedInterruptibly" class="headerlink" title="doAcquireSharedInterruptibly"></a>doAcquireSharedInterruptibly</h6><p><code>doAcquireSharedInterruptibly()</code>æ–¹æ³•åœ¨å…¬å¹³é”çš„æ—¶å€™å¦‚æœå½“å‰çº¿ç¨‹å‰é¢æœ‰ç­‰å¾…çº¿ç¨‹æˆ–è€…é”è¢«è·å–å®Œäº†ä¹‹åï¼Œå½“å‰çº¿ç¨‹éœ€è¦è¿›å…¥ç­‰å¾…çŠ¶æ€æ—¶ä¼šè¢«è°ƒç”¨ï¼Œç”¨äºä¸ºå½“å‰çº¿ç¨‹åˆ›å»ºèŠ‚ç‚¹å¹¶åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doAcquireSharedInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span></span><br><span class="line">        <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// ä¸ºå½“å‰çº¿ç¨‹åˆ›å»ºå…±äº«æ¨¡å¼èŠ‚ç‚¹åŠ å…¥é˜Ÿåˆ—ç»“å°¾</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addWaiter(Node.SHARED);</span><br><span class="line">    <span class="comment">// æ“ä½œå¤±è´¥æ ‡è®°</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//è‡ªæ—‹</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// è·å–å½“å‰èŠ‚ç‚¹çš„å‰ä¸€èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">            <span class="keyword">if</span> (p == head) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœå‰ä¸€èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹, åˆ™å°è¯•è·å–é”</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> tryAcquireShared(arg);</span><br><span class="line">                <span class="keyword">if</span> (r &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//å¦‚æœè·å–æˆåŠŸï¼Œè®¾ç½®å¤´èŠ‚ç‚¹å’Œå…±äº«æ¨¡å¼ä¼ æ’­</span></span><br><span class="line">                    setHeadAndPropagate(node, r);</span><br><span class="line">                    p.next = <span class="literal">null</span>;</span><br><span class="line">                    failed = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœå‰ä¸€èŠ‚ç‚¹ä¸æ˜¯å¤´èŠ‚ç‚¹æˆ–è€…æ²¡æœ‰è·å–åˆ°é”</span></span><br><span class="line">            <span class="comment">// shouldParkAfterFailedAcquireæ–¹æ³•åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦éœ€è¦è¢«é˜»å¡</span></span><br><span class="line">            <span class="comment">// parkAndCheckInterruptæ–¹æ³•ç”¨äºé˜»å¡çº¿ç¨‹å¹¶æ£€æµ‹çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼Œå¦‚æœè¢«ä¸­æ–­æŠ›é”™</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                    parkAndCheckInterrupt())</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            <span class="comment">// è‡ªæ—‹å¼‚å¸¸é€€å‡º å–æ¶ˆçº¿ç¨‹è·å–é”</span></span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="è·å–é”è¿‡ç¨‹æ€»ç»“"><a href="#è·å–é”è¿‡ç¨‹æ€»ç»“" class="headerlink" title="è·å–é”è¿‡ç¨‹æ€»ç»“"></a>è·å–é”è¿‡ç¨‹æ€»ç»“</h6><ol><li>é¦–å…ˆè°ƒç”¨<code>Semaphore.acquire()</code>æ–¹æ³•è·å–ä»¤ç‰Œï¼Œè¯¥æ–¹æ³•è°ƒç”¨å†…ç½®åŒæ­¥å™¨<code>Sync.acquireSharedInterruptibly()</code>æ–¹æ³•ï¼Œè¯¥åŒæ­¥å™¨ç»§æ‰¿<code>AQS</code>å®é™…è°ƒç”¨çš„æ˜¯<code>AQS</code>çš„<code>acquireSharedInterruptibly()</code>æ–¹æ³•ã€‚</li><li><code>acquireSharedInterruptibly()</code>æ–¹æ³•é¦–å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼Œå¦‚æœä¸­æ–­äº†å°±æŠ›<code>InterruptedException</code>å¼‚å¸¸ï¼Œå¦‚æœæ²¡æœ‰è¢«ä¸­å•ï¼Œå°±è°ƒç”¨<code>tryAcquireShared()</code>æ–¹æ³•å°è¯•è·å–é”ã€‚</li><li><code>tryAcquireShared()</code>æ–¹æ³•<code>AQS</code>åªæ˜¯å®šäº†ä¸€ä¸ªæ¨¡ç‰ˆæ–¹æ³•ç”±å­ç±»å®ç°ï¼Œ<code>Semaphore.Sync</code>åŒæ­¥å™¨æä¾›äº†ä¸¤ç§å®ç°ï¼Œåˆ†åˆ«æ˜¯<code>FairSync</code>ï¼ˆå…¬å¹³é”ï¼‰å’Œ<code>NonfairSync</code>ï¼ˆéå…¬å¹³é”ï¼‰ï¼Œè¿™ä¸¤ç§é”å®ç°å·®ä¸å¤šï¼Œå…¬å¹³é”å°±æ˜¯å¤šä¸€ä¸ª<code>hasQueuedPredecessor()</code>æ–¹æ³•åˆ¤æ–­æ˜¯å¦æœ‰æ’åœ¨è‡ªå·±å‰é¢çš„çº¿ç¨‹ï¼Œå¦‚æœæœ‰åˆ™è¿”å›-1ã€‚</li><li><code>tryAcquireShared()</code>æ–¹æ³•é€šè¿‡è‡ªæ—‹æˆ–è®¸é”ï¼Œå…ˆè·å–å½“å‰å¯ç”¨é”ï¼Œå‡å»éœ€è¦è·å–çš„é”è·å–åˆ°å‰©ä½™é”ï¼Œå¦‚æœå‰©ä½™é”å°äº0ç›´æ¥è¿”å›ï¼Œè¡¨ç¤ºè·å–å¤±è´¥ï¼Œå¦åˆ™é€šè¿‡CASå»è·å–é”ï¼ŒæˆåŠŸè·å–è¿”å›æˆåŠŸï¼Œå¤±è´¥è·å–è¿”å›å¤±è´¥ã€‚</li><li><code>tryAcquireShared()</code>å¦‚æœè·å–é”å¤±è´¥ï¼Œå°±è¦è°ƒç”¨<code>doAcquireSharedInterruptibly()</code>æ–¹æ³•ç”¨äºä¸ºå½“å‰çº¿ç¨‹åˆ›å»ºèŠ‚ç‚¹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œè¯¥æ–¹æ³•é¦–å…ˆåˆ›å»ºå…±äº«æ¨¡å¼çš„èŠ‚ç‚¹åŠ å…¥é˜Ÿåˆ—ï¼Œç„¶åè‡ªæ—‹ï¼Œåˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯ä¸æ˜¯å¤´èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯å¤´èŠ‚ç‚¹ä¹Ÿå°è¯•è·å–é”ï¼Œè·å–æˆåŠŸçš„è¯è®¾ç½®å¤´èŠ‚ç‚¹å¹¶æˆåŠŸè¿”å›ï¼Œå¦‚æœè·å–å¤±è´¥åˆ™ä¼šè°ƒç”¨<code>shouldParkAfterFailedAcquire()</code>åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦éœ€è¦ç­‰å¾…ï¼Œå¦‚æœéœ€è¦ç­‰å¾…ç„¶åè°ƒç”¨<code>parkAndCheckInterrupt()</code>æ–¹æ³•é˜»å¡çº¿ç¨‹å¹¶åˆ¤æ–­çº¿ç¨‹æ˜¯å¦ä¸­æ–­ï¼Œå¦‚æœä¸­æ–­åˆ™æŠ›é”™ï¼Œå¦‚æœæ²¡æœ‰ä¸­æ–­å°±é˜»å¡å†é€šè¿‡è‡ªæ—‹è·å–é”ã€‚å¦‚æœè‡ªæ—‹å¼‚å¸¸é€€å‡ºï¼Œåˆ™è°ƒç”¨<code>cancelAcquire()</code>æ–¹æ³•å–æ¶ˆçº¿ç¨‹è·å–é”ã€‚</li></ol><h5 id="é‡Šæ”¾é”è¿‡ç¨‹"><a href="#é‡Šæ”¾é”è¿‡ç¨‹" class="headerlink" title="é‡Šæ”¾é”è¿‡ç¨‹"></a>é‡Šæ”¾é”è¿‡ç¨‹</h5><h6 id="release"><a href="#release" class="headerlink" title="release"></a>release</h6><p><code>Semaphore.relese()</code>æ–¹æ³•ç”¨äºé‡Šæ”¾é”ï¼Œé‡Šæ”¾ä¸€ä¸ªé”ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">release</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// é‡Šæ”¾ä¸€ä¸ªå…±äº«é”</span></span><br><span class="line">    sync.releaseShared(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>release()</code>æ–¹æ³•è°ƒç”¨<code>Semaphore.Sync</code>åŒæ­¥å™¨çš„<code>releaseShared()</code>æ–¹æ³•ï¼Œè¯¥åŒæ­¥å™¨ç»§æ‰¿ä¸<code>AQS</code>å®é™…è°ƒç”¨çš„æ˜¯<code>AQS.releaseShared()</code>æ–¹æ³•ã€‚</p><h6 id="releaseShared"><a href="#releaseShared" class="headerlink" title="releaseShared"></a>releaseShared</h6><p><code>releaseShared()</code>æ–¹æ³•é‡Šæ”¾æŒ‡å®šæ•°é‡çš„å…±äº«é”ï¼Œé‡Šæ”¾æˆåŠŸä¹‹åä¼šå”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">releaseShared</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// å°è¯•é‡Šæ”¾é”</span></span><br><span class="line">    <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾æˆåŠŸï¼Œå”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹</span></span><br><span class="line">        doReleaseShared();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="tryReleaseShared"><a href="#tryReleaseShared" class="headerlink" title="tryReleaseShared"></a>tryReleaseShared</h6><p><code>tryReleaseShared()</code>æ–¹æ³•æ˜¯<code>AQS</code>å®šä¹‰çš„æ¨¡ç‰ˆæ–¹æ³•ç”±å­ç±»å®ç°ï¼Œè°ƒç”¨äº†<code>Semaphore.tryReleaseShared()</code>ï¼Œè¯¥æ–¹æ³•é€šè¿‡è‡ªæ—‹+CASé‡Šæ”¾é”ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryReleaseShared</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">    <span class="comment">// è‡ªæ—‹</span></span><br><span class="line">    <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰å¯ç”¨çš„é”æ•°é‡</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">current</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="comment">// å¯ç”¨çš„+é‡Šæ”¾çš„</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> current + releases;</span><br><span class="line">        <span class="keyword">if</span> (next &lt; current) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum permit count exceeded&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é€šè¿‡CASä¿®æ”¹çŠ¶æ€å€¼é‡Šæ”¾é”</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(current, next))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="doReleaseShared"><a href="#doReleaseShared" class="headerlink" title="doReleaseShared"></a>doReleaseShared</h6><p><code>doReleaseShared()</code>æ–¹æ³•ç”¨äºé‡Šæ”¾é”æˆåŠŸä¹‹åå”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doReleaseShared</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è‡ªæ—‹</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// å°†é˜Ÿåˆ—å¤´èŠ‚ç‚¹èµ‹å€¼ä¸èŠ‚ç‚¹h</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="comment">// å¦‚æœèŠ‚ç‚¹ä¸ä¸ºnullï¼Œä¸”ä¸ç­‰äºå°¾èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h != tail) &#123;</span><br><span class="line">            <span class="comment">// å¾—åˆ°hèŠ‚ç‚¹çš„çŠ¶æ€</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> h.waitStatus;</span><br><span class="line">            <span class="comment">// å¦‚æœèŠ‚ç‚¹çŠ¶æ€æ˜¯Node.SIGNALï¼Œå°±è¦å”¤é†’èŠ‚ç‚¹hä¸‹ä¸€èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (ws == Node.SIGNAL) &#123;</span><br><span class="line">                <span class="comment">// è®¾ç½®èŠ‚ç‚¹hçš„çŠ¶æ€ä¸ºå–æ¶ˆçŠ¶æ€ï¼Œå¦‚æœå¤±è´¥å°±å¾ªç¯å†è¯•ä¸€æ¬¡</span></span><br><span class="line">                <span class="keyword">if</span> (!compareAndSetWaitStatus(h, Node.SIGNAL, <span class="number">0</span>))</span><br><span class="line">                    <span class="keyword">continue</span>;    </span><br><span class="line">                <span class="comment">// å”¤é†’èŠ‚ç‚¹hä¸‹ä¸€èŠ‚ç‚¹çº¿ç¨‹</span></span><br><span class="line">                unparkSuccessor(h);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœèŠ‚ç‚¹hçŠ¶æ€ä¸º0ï¼Œå°±è®¾ç½®wsçš„çŠ¶æ€ä¸ºPROPAGATEï¼Œè¯´æ˜ä¸‹æ¬¡å¾ªç¯çš„æ—¶å€™èŠ‚ç‚¹håº”è¯¥æ— æ¡ä»¶è¢«ä¼ æ’­</span></span><br><span class="line">            <span class="comment">// åœ¨shouldParkAfterFailedAcquireæ–¹æ³•ä¸­ä½¿ç”¨</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ws == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                     !compareAndSetWaitStatus(h, <span class="number">0</span>, Node.PROPAGATE))</span><br><span class="line">                <span class="keyword">continue</span>;                </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœé˜Ÿåˆ—ä¸­å¤´èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–å°±ç»§ç»­å¾ªç¯</span></span><br><span class="line">        <span class="comment">// å¦‚æœæ²¡æœ‰å‘ç”Ÿå˜åŒ–å°±è·³å‡ºå¾ªç¯</span></span><br><span class="line">        <span class="keyword">if</span> (h == head)                   </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="é‡Šæ”¾é”è¿‡ç¨‹æ€»ç»“"><a href="#é‡Šæ”¾é”è¿‡ç¨‹æ€»ç»“" class="headerlink" title="é‡Šæ”¾é”è¿‡ç¨‹æ€»ç»“"></a>é‡Šæ”¾é”è¿‡ç¨‹æ€»ç»“</h6><ol><li>é¦–å…ˆè°ƒç”¨<code>Semaphore.release()</code>æ–¹æ³•é‡Šæ”¾é”ï¼Œè¯¥æ–¹æ³•è°ƒç”¨åŒæ­¥å™¨<code>Sync</code>çš„<code>releasShared()</code>æ–¹æ³•ï¼Œå› ä¸ºåŒæ­¥å™¨ç»§æ‰¿ä¸<code>AQS</code>æ‰€ä»¥å®é™…è°ƒç”¨çš„æ˜¯<code>AQS.releaseShared()</code>æ–¹æ³•ã€‚</li><li><code>AQS.releaseShared()</code>æ–¹æ³•é¦–å…ˆè°ƒç”¨<code>tryReleaseShared()</code>æ–¹æ³•å°è¯•é‡Šæ”¾é”ï¼Œè¯¥æ–¹æ³•æ˜¯<code>AQS</code>å®šä¹‰çš„æ¨¡ç‰ˆæ–¹æ³•ï¼Œé€šè¿‡å­ç±»å®ç°ï¼Œè°ƒç”¨çš„æ˜¯<code>Semaphore.tryReleaseShared()</code>æ–¹æ³•ã€‚</li><li><code>Semaphore.tryReleaseShared()</code>æ–¹æ³•é€šè¿‡è‡ªæ—‹+CASé‡Šæ”¾é”ï¼Œå…ˆè·å–å½“å‰çš„é”æ•°é‡åŠ ä¸Šé‡Šæ”¾çš„é”æ•°é‡ï¼Œä¼šåˆ¤æ–­è¶…è¿‡åˆ¤æ–­ï¼Œç„¶åé€šè¿‡CASä¿®æ”¹é”çš„æ•°é‡è¾¾åˆ°é‡Šæ”¾é”çš„ç›®çš„ã€‚<code>tryReleaseShared()</code>é‡Šæ”¾é”æˆåŠŸä¹‹åï¼Œä¼šè°ƒç”¨<code>AQS.doReleaseShared()</code>å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹ã€‚</li><li><code>AQS.doReleaseShared()</code>ç”¨äºé‡Šæ”¾é”æˆåŠŸä¹‹åå”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹ï¼Œä¹Ÿæ˜¯é€šè¿‡è‡ªæ—‹+CASå®ç°ï¼Œé¦–å…ˆè·å–å¤´èŠ‚ç‚¹hï¼Œå…ˆåˆ¤æ–­èŠ‚ç‚¹hä¸ä¸ºnullä¸”ä¸æ˜¯å°¾èŠ‚ç‚¹ï¼Œå¾—åˆ°èŠ‚ç‚¹hçš„çŠ¶æ€ï¼Œå¦‚æœçŠ¶æ€æ˜¯<code>Node.SIGNAL</code>è¯´æ˜è¿™ä¸ªèŠ‚ç‚¹å·²ç»è¦è¢«å”¤é†’åº”è¯¥å”¤é†’ä¸‹ä¸€èŠ‚ç‚¹ï¼Œé€šè¿‡CASæ“ä½œè®¾ç½®èŠ‚ç‚¹hçŠ¶æ€ä¸ºå–æ¶ˆï¼Œç„¶åè°ƒç”¨<code>unparkSuccessor()</code>æ–¹æ³•å”¤é†’ä¸‹ä¸€èŠ‚ç‚¹ã€‚å¦‚æœèŠ‚ç‚¹hçš„çŠ¶æ€ä¸º0ï¼Œå°±è®¾ç½®çŠ¶æ€ä¸º<code>PROPAGATE</code>è¯´æ˜ä¸‹ä¸€æ¬¡åº”è¯¥è¢«æ— æ¡ä»¶ä¼ æ’­ã€‚å¦‚æœé˜Ÿåˆ—ä¸­å¤´èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–å°±ç»§ç»­å¾ªç¯ï¼Œæ²¡æœ‰å‘ç”Ÿå˜åŒ–å°±ç»ˆæ­¢å¾ªç¯ã€‚</li></ol><h3 id="ä¸‰ã€ä½¿ç”¨Semaphorå®ç°åœè½¦åœºæç¤ºç‰ŒåŠŸèƒ½"><a href="#ä¸‰ã€ä½¿ç”¨Semaphorå®ç°åœè½¦åœºæç¤ºç‰ŒåŠŸèƒ½" class="headerlink" title="ä¸‰ã€ä½¿ç”¨Semaphorå®ç°åœè½¦åœºæç¤ºç‰ŒåŠŸèƒ½"></a>ä¸‰ã€ä½¿ç”¨Semaphorå®ç°åœè½¦åœºæç¤ºç‰ŒåŠŸèƒ½</h3><p>æ¯ä¸ªåœè½¦åœºå…¥å£éƒ½æœ‰ä¸€ä¸ªæç¤ºç‰Œï¼Œä¸Šé¢æ˜¾ç¤ºç€åœè½¦åœºå‰©ä½™çš„è½¦ä½æ˜¯å¤šå°‘ï¼Œå½“å‰©ä½™è½¦ä½ä¸º0æ—¶ï¼Œåˆ™ä¸å…è®¸è½¦è¾†è¿›å…¥åœè½¦åœºï¼Œç›´åˆ°åœè½¦åœºæœ‰è½¦ç¦»å¼€åœè½¦åœºï¼Œè¿™æ˜¯æç¤ºç‰Œæ˜¾ç¤ºæ–°çš„å‰©ä½™è½¦ä½æ•°ã€‚</p><h4 id="ä¸šåŠ¡åœºæ™¯"><a href="#ä¸šåŠ¡åœºæ™¯" class="headerlink" title="ä¸šåŠ¡åœºæ™¯"></a>ä¸šåŠ¡åœºæ™¯</h4><ol><li>åœè½¦åœºå®¹çº³é‡ä¸º10ã€‚</li><li>å½“ä¸€è¾†è½¦è¿›å…¥åœè½¦åœºåï¼Œæ˜¾ç¤ºç‰Œçš„å‰©ä½™è½¦ä½æ•°å“åº”çš„å‡1.</li><li>æ¯æœ‰ä¸€è¾†è½¦é©¶å‡ºåœè½¦åœºåï¼Œæ˜¾ç¤ºç‰Œçš„å‰©ä½™è½¦ä½æ•°å“åº”çš„åŠ 1ã€‚</li><li>åœè½¦åœºå‰©ä½™è½¦ä½ä¸è¶³æ—¶ï¼Œè½¦è¾†åªèƒ½åœ¨å¤–é¢ç­‰å¾…ã€‚</li></ol><h4 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SemaphoreDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åœè½¦åœºåŒæ—¶å®¹çº³10è¾†è½¦</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Semaphore</span> <span class="variable">semaphore</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿ15è¾†è½¦åŒæ—¶åœè½¦</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">15</span>; i++) &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;=====&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;è½¦è¾†æ¥åˆ°åœè½¦åœº&quot;</span>);</span><br><span class="line">                        <span class="keyword">if</span> (semaphore.availablePermits() == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">// æ²¡æœ‰è½¦ä½äº†</span></span><br><span class="line">                            System.out.println(<span class="string">&quot;è½¦ä½ä¸è¶³ï¼Œè¯·è€å¿ƒç­‰å¾…ï¼Œ&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;è½¦è¾†æ­£åœ¨ç­‰å¾…&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// è·å–è½¦ä½åœè½¦</span></span><br><span class="line">                        semaphore.acquire();</span><br><span class="line">                        System.out.println(Thread.currentThread().getName()+<span class="string">&quot;æˆåŠŸè¿›å…¥åœè½¦åœº&quot;</span>);</span><br><span class="line">                        <span class="comment">//æ¨¡æ‹Ÿè½¦è¾†åœ¨åœè½¦åœºåœç•™çš„æ—¶é—´</span></span><br><span class="line">                        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                        <span class="comment">//é©¶å‡ºåœè½¦åœº</span></span><br><span class="line">                        semaphore.release();</span><br><span class="line">                        System.out.println(Thread.currentThread().getName()+<span class="string">&quot;é©¶å‡ºåœè½¦åœº&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">=====Thread-0è½¦è¾†æ¥åˆ°åœè½¦åœº</span><br><span class="line">=====Thread-3è½¦è¾†æ¥åˆ°åœè½¦åœº</span><br><span class="line">Thread-3æˆåŠŸè¿›å…¥åœè½¦åœº</span><br><span class="line">=====Thread-1è½¦è¾†æ¥åˆ°åœè½¦åœº</span><br><span class="line">=====Thread-2è½¦è¾†æ¥åˆ°åœè½¦åœº</span><br><span class="line">Thread-1æˆåŠŸè¿›å…¥åœè½¦åœº</span><br><span class="line">=====Thread-5è½¦è¾†æ¥åˆ°åœè½¦åœº</span><br><span class="line">=====Thread-4è½¦è¾†æ¥åˆ°åœè½¦åœº</span><br><span class="line">Thread-0æˆåŠŸè¿›å…¥åœè½¦åœº</span><br><span class="line">=====Thread-7è½¦è¾†æ¥åˆ°åœè½¦åœº</span><br><span class="line">Thread-4æˆåŠŸè¿›å…¥åœè½¦åœº</span><br><span class="line">Thread-7æˆåŠŸè¿›å…¥åœè½¦åœº</span><br><span class="line">Thread-5æˆåŠŸè¿›å…¥åœè½¦åœº</span><br><span class="line">=====Thread-6è½¦è¾†æ¥åˆ°åœè½¦åœº</span><br><span class="line">Thread-2æˆåŠŸè¿›å…¥åœè½¦åœº</span><br><span class="line">Thread-6æˆåŠŸè¿›å…¥åœè½¦åœº</span><br><span class="line">=====Thread-8è½¦è¾†æ¥åˆ°åœè½¦åœº</span><br><span class="line">Thread-8æˆåŠŸè¿›å…¥åœè½¦åœº</span><br><span class="line">=====Thread-10è½¦è¾†æ¥åˆ°åœè½¦åœº</span><br><span class="line">Thread-10æˆåŠŸè¿›å…¥åœè½¦åœº</span><br><span class="line">=====Thread-9è½¦è¾†æ¥åˆ°åœè½¦åœº</span><br><span class="line">=====Thread-14è½¦è¾†æ¥åˆ°åœè½¦åœº</span><br><span class="line">è½¦ä½ä¸è¶³ï¼Œè¯·è€å¿ƒç­‰å¾…ï¼ŒThread-14è½¦è¾†æ­£åœ¨ç­‰å¾…</span><br><span class="line">=====Thread-12è½¦è¾†æ¥åˆ°åœè½¦åœº</span><br><span class="line">è½¦ä½ä¸è¶³ï¼Œè¯·è€å¿ƒç­‰å¾…ï¼ŒThread-12è½¦è¾†æ­£åœ¨ç­‰å¾…</span><br><span class="line">=====Thread-11è½¦è¾†æ¥åˆ°åœè½¦åœº</span><br><span class="line">è½¦ä½ä¸è¶³ï¼Œè¯·è€å¿ƒç­‰å¾…ï¼ŒThread-11è½¦è¾†æ­£åœ¨ç­‰å¾…</span><br><span class="line">=====Thread-13è½¦è¾†æ¥åˆ°åœè½¦åœº</span><br><span class="line">è½¦ä½ä¸è¶³ï¼Œè¯·è€å¿ƒç­‰å¾…ï¼ŒThread-9è½¦è¾†æ­£åœ¨ç­‰å¾…</span><br><span class="line">è½¦ä½ä¸è¶³ï¼Œè¯·è€å¿ƒç­‰å¾…ï¼ŒThread-13è½¦è¾†æ­£åœ¨ç­‰å¾…</span><br><span class="line">Thread-14æˆåŠŸè¿›å…¥åœè½¦åœº</span><br><span class="line">Thread-10é©¶å‡ºåœè½¦åœº</span><br><span class="line">Thread-2é©¶å‡ºåœè½¦åœº</span><br><span class="line">Thread-6é©¶å‡ºåœè½¦åœº</span><br><span class="line">Thread-11æˆåŠŸè¿›å…¥åœè½¦åœº</span><br><span class="line">Thread-7é©¶å‡ºåœè½¦åœº</span><br><span class="line">Thread-3é©¶å‡ºåœè½¦åœº</span><br><span class="line">Thread-9æˆåŠŸè¿›å…¥åœè½¦åœº</span><br><span class="line">Thread-13æˆåŠŸè¿›å…¥åœè½¦åœº</span><br><span class="line">Thread-1é©¶å‡ºåœè½¦åœº</span><br><span class="line">Thread-0é©¶å‡ºåœè½¦åœº</span><br><span class="line">Thread-4é©¶å‡ºåœè½¦åœº</span><br><span class="line">Thread-5é©¶å‡ºåœè½¦åœº</span><br><span class="line">Thread-8é©¶å‡ºåœè½¦åœº</span><br><span class="line">Thread-12æˆåŠŸè¿›å…¥åœè½¦åœº</span><br><span class="line">Thread-13é©¶å‡ºåœè½¦åœº</span><br><span class="line">Thread-9é©¶å‡ºåœè½¦åœº</span><br><span class="line">Thread-12é©¶å‡ºåœè½¦åœº</span><br><span class="line">Thread-14é©¶å‡ºåœè½¦åœº</span><br><span class="line">Thread-11é©¶å‡ºåœè½¦åœº</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢è¾“å‡ºå¯ä»¥çœ‹å‡ºï¼Œå½“10ä¸ªè½¦ä½è¢«åœæ»¡äº†ä¹‹åï¼Œå†è¿›æ¥çš„5è¾†è½¦è¿›å…¥ç­‰å¾…çŠ¶æ€ç›´åˆ°æœ‰è½¦é©¶å‡ºåœè½¦åœºï¼Œç„¶åå†åœè½¦ï¼Œè¾¾åˆ°äº†æˆ‘ä»¬é¢„æœŸçš„æ•ˆæœã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> JUC </category>
          
          <category> AQS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AbstractQueuedSynchronizer </tag>
            
            <tag> Semaphore </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaé”(äºŒ)ï¼šAbstractQueuedSynchronizerã€ReentrantLockè¯¦è§£</title>
      <link href="/2022/03/27/java-lock-aqs-reentrantlock/"/>
      <url>/2022/03/27/java-lock-aqs-reentrantlock/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h3 id="ä¸€ã€AbstractQueuedSynchronizerç®€ä»‹"><a href="#ä¸€ã€AbstractQueuedSynchronizerç®€ä»‹" class="headerlink" title="ä¸€ã€AbstractQueuedSynchronizerç®€ä»‹"></a>ä¸€ã€AbstractQueuedSynchronizerç®€ä»‹</h3><p>AQSï¼ˆAbstractQueuedSynchronizerï¼‰æ˜¯å¹¶å‘å®¹å™¨JUCï¼ˆjava.util.concurrentï¼‰ä¸‹locksåŒ…å†…çš„ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæ˜¯ä¸€ä¸ªåŒæ­¥å™¨ï¼Œæ˜¯ç”¨æ¥æ„å»ºé”æˆ–è€…å…¶ä»–åŒæ­¥ç»„ä»¶çš„åŸºç¡€æ¡†æ¶ï¼Œå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªæˆå‘˜å˜é‡<code>state</code>è¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼Œ<code>state=0</code>è¡¨ç¤ºçº¿ç¨‹æœªè·å–åˆ°é”ï¼Œ<code>state &gt; 0</code>è¡¨ç¤ºè·å–åˆ°é”ï¼Œ<code>state &gt; 1</code>è¡¨ç¤ºé‡å…¥é”çš„æ•°é‡ï¼Œè¢« <code>volatile</code>ä¿®é¥°ä¿è¯äº†å¯è§æ€§ï¼Œé€šè¿‡CASæ“ä½œå¯¹å…¶ä¿®æ”¹ï¼Œå†…ç½®ç»´æŠ¤äº†<code>FIFO</code>é˜Ÿåˆ—å®ç°å¯¹æœªè·å–åˆ°é”çš„çº¿ç¨‹è¿›è¡Œæ’é˜Ÿå·¥ä½œã€‚</p><p><img src="https://qtspace.cn/contentimg/20.jpg"></p><h3 id="äºŒã€AbstractQueuedSynchronizeræºç è§£æ"><a href="#äºŒã€AbstractQueuedSynchronizeræºç è§£æ" class="headerlink" title="äºŒã€AbstractQueuedSynchronizeræºç è§£æ"></a>äºŒã€AbstractQueuedSynchronizeræºç è§£æ</h3><h4 id="æ ¸å¿ƒæˆå‘˜å˜é‡"><a href="#æ ¸å¿ƒæˆå‘˜å˜é‡" class="headerlink" title="æ ¸å¿ƒæˆå‘˜å˜é‡"></a>æ ¸å¿ƒæˆå‘˜å˜é‡</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractQueuedSynchronizer</span> <span class="keyword">extends</span> <span class="title class_">AbstractOwnableSynchronizer</span></span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç­‰å¾…è·å–é”é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹, åªèƒ½é€šè¿‡setHeadæ–¹æ³•ä¿®æ”¹</span></span><br><span class="line"><span class="comment">     * å¦‚æœheadå­˜åœ¨ä¿è¯waitStatusçŠ¶æ€ä¸ä¸ºCANCELLED</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node head;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç­‰å¾…è·å–é”é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹, åªèƒ½é€šè¿‡enqæ–¹æ³•æ·»åŠ æ–°çš„ç­‰å¾…èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node tail;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¡¨ç¤ºé”çš„çŠ¶æ€</span></span><br><span class="line"><span class="comment">     * state = 0 è¡¨ç¤ºæœªé”å®š</span></span><br><span class="line"><span class="comment">     * state &gt; 0 è¡¨ç¤ºå·²é”å®š</span></span><br><span class="line"><span class="comment">     * state &gt; 1 è¡¨ç¤ºå¯é‡å…¥é”, è·å–é”çš„æ¬¡æ•°</span></span><br><span class="line"><span class="comment">     * volatileä¿®é¥°ä¿è¯äº†å¯è§æ€§</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> state;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AbstractQueuedSynchronizerä¸»è¦æœ‰ä¸‰ä¸ªæ ¸å¿ƒæˆå‘˜å˜é‡<code>state</code>ã€<code>head</code>ã€<code>tail</code></p><ul><li><code>state</code>ï¼šè¡¨ç¤ºé”çš„çŠ¶æ€ï¼Œ ç­‰äº0è¡¨ç¤ºæœªé”å®šï¼Œå¤§äº0è¡¨ç¤ºå·²é”å®šï¼Œå¤§äº1è¡¨ç¤ºå¯é‡å…¥é”ï¼Œé‡å…¥é”çš„æ¬¡æ•°ã€‚è¢«<code>volatile</code>ä¿®é¥°ä¿è¯äº†å¯è§æ€§ã€‚</li><li><code>head</code>ï¼šç­‰å¾…é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹ï¼Œé™¤äº†åˆå§‹åŒ–åªèƒ½é€šè¿‡<code>setHead()</code>æ–¹æ³•è®¾ç½®å€¼ï¼Œå¦‚æœ<code>head</code>å­˜ç€èƒ½ä¿è¯<code>waitStatus</code>çŠ¶æ€ä¸ä¸º<code>CANELLED</code>ã€‚</li><li><code>tail</code>ï¼šç­‰å¾…é˜Ÿåˆ—å°¾èŠ‚ç‚¹ï¼Œåªèƒ½é€šè¿‡<code>equ</code>æ·»åŠ æ–°çš„ç­‰å¾…èŠ‚ç‚¹ã€‚</li></ul><h4 id="NodeèŠ‚ç‚¹"><a href="#NodeèŠ‚ç‚¹" class="headerlink" title="NodeèŠ‚ç‚¹"></a>NodeèŠ‚ç‚¹</h4><p><code>AbstractQueuedSynchronizer</code>å†…éƒ¨ç»´æŠ¤ç€<code>FIFO</code>é˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯<code>CLH</code>é˜Ÿåˆ—ï¼Œè¿™ä¸ªé˜Ÿåˆ—çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ª<code>Node</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ä¸‹æ¥è¦äº†è§£å…¶ä»–å…¶å†…éƒ¨ç±»<code>Node</code>ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * èŠ‚ç‚¹æ­£åœ¨å…±äº«æ¨¡å¼ä¸‹ç­‰å¾…çš„æ ‡è®°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">SHARED</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * èŠ‚ç‚¹æ­£åœ¨ç‹¬å æ¨¡å¼ä¸‹ç­‰å¾…çš„æ ‡è®°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">EXCLUSIVE</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * waitStatuså˜é‡çš„å¯é€‰å€¼, å–æ¶ˆçŠ¶æ€, è¢«å–æ¶ˆçš„èŠ‚ç‚¹ä¸å‚ä¸é”ç«äº‰, çŠ¶æ€ä¹Ÿä¸ä¼šè¢«æ”¹å˜</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CANCELLED</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * waitStatuså˜é‡çš„å¯é€‰å€¼, ä¸‹ä¸€èŠ‚ç‚¹å¤„äºç­‰å¾…çŠ¶æ€, å¦‚æœå½“å‰èŠ‚ç‚¹é‡Šæ”¾é”æˆ–è€…è¢«å–æ¶ˆ, ä¼šé€šçŸ¥ä¸‹ä¸€èŠ‚ç‚¹å»è¿è¡Œ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SIGNAL</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * waitStatuså˜é‡çš„å¯é€‰å€¼, è¡¨ç¤ºèŠ‚ç‚¹å¤„äºconditioné˜Ÿåˆ—ä¸­, æ­£åœ¨ç­‰å¾…è¢«å”¤é†’</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CONDITION</span> <span class="operator">=</span> -<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * waitStatuså˜é‡çš„å¯é€‰å€¼, ä¸‹ä¸€æ¬¡acquireSharedåº”è¯¥æ— æ¡ä»¶ä¼ æ’­</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PROPAGATE</span> <span class="operator">=</span> -<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * èŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">int</span> waitStatus;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸Šä¸€èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">volatile</span> Node prev;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸‹ä¸€èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">volatile</span> Node next;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–åŒæ­¥çŠ¶æ€(é”)çš„çº¿ç¨‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">volatile</span> Thread thread;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸‹ä¸€ä¸ªconditioné˜Ÿåˆ—çš„ç­‰å¾…èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Node nextWaiter;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ˜¯å¦æ˜¯å…±äº«æ¨¡å¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">isShared</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">return</span> <span class="variable">nextWaiter</span> <span class="operator">=</span>= SHARED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–å‰ä¸€èŠ‚ç‚¹, å‰ä¸€èŠ‚ç‚¹ä¸ºnullä¼šæŠ›å¼‚å¸¸</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> Node <span class="title function_">predecessor</span><span class="params">()</span> <span class="keyword">throws</span> NullPointerException &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> prev;</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ— å‚æ„é€ æ–¹æ³•ç”¨äºåˆå§‹åŒ–å¤´éƒ¨æˆ–è€…å…±äº«æ¨¡å¼æ ‡è®°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Node () &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨äºaddWaiteræ–¹æ³•, è®¾ç½®ä¸‹ä¸€ä¸ªconditioné˜Ÿåˆ—çš„ç­‰å¾…èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Node(Thread thread, Node mode) &#123;</span><br><span class="line">        <span class="built_in">this</span>.nextWaiter = mode;</span><br><span class="line">        <span class="built_in">this</span>.thread = thread;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨äºaddConditionWaiteræ–¹æ³•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Node (Thread thread, <span class="type">int</span> waitStatus) &#123;</span><br><span class="line">        <span class="built_in">this</span>.thread = thread;</span><br><span class="line">        <span class="built_in">this</span>.waitStatus = waitStatus;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ ¸å¿ƒæ–¹æ³•"><a href="#æ ¸å¿ƒæ–¹æ³•" class="headerlink" title="æ ¸å¿ƒæ–¹æ³•"></a>æ ¸å¿ƒæ–¹æ³•</h4><p>JUCé‡Œé¢çš„å·¥å…·ç±»åŸºæœ¬éƒ½æ˜¯åŸºç¡€AQSå®ç°çš„ï¼Œæ¯”<code>ReentrantLock</code> ã€<code>CountDownLatch</code>ã€<code>CyclicBarrier</code>ã€<code>Semaphore</code>ç­‰ï¼Œæœ‰çš„åªæ”¯æŒç‹¬å é”ï¼Œå¦‚<code>ReentrantLock#lock()</code>ï¼Œæœ‰çš„æ”¯æŒå…±äº«é”ï¼Œå¦‚<code>Semaphore</code>ï¼Œä»å‰æ–‡çš„Nodeç±»çš„å®šä¹‰ä¹Ÿèƒ½çœ‹åˆ°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * èŠ‚ç‚¹æ­£åœ¨å…±äº«æ¨¡å¼ä¸‹ç­‰å¾…çš„æ ‡è®°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">SHARED</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * èŠ‚ç‚¹æ­£åœ¨ç‹¬å æ¨¡å¼ä¸‹ç­‰å¾…çš„æ ‡è®°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">EXCLUSIVE</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><p>AQSå®ç°äº†ä¸¤å¥—åŠ é”è§£é”çš„æ–¹å¼ï¼Œé‚£å°±æ˜¯<strong>ç‹¬å é”</strong>å’Œ<strong>å…±äº«é”</strong>ã€‚æˆ‘ä»¬å°±ä»AQSæœ€å¸¸ç”¨çš„ç±»<code>ReentrantLock</code>æ¥å­¦ä¹ AQSçš„æ ¸å¿ƒæ–¹æ³•ã€‚</p><h3 id="ä¸‰ã€ReentrantLock"><a href="#ä¸‰ã€ReentrantLock" class="headerlink" title="ä¸‰ã€ReentrantLock"></a>ä¸‰ã€ReentrantLock</h3><h4 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h4><p><code>ReentrantLock</code>æ˜¯åŸºç¡€AQSå®ç°çš„ä¸€ä¸ªå¯é‡å…¥ä¸”ç‹¬å å¼é”ã€‚å†…ç½®äº†ä¸€ä¸ª<code>Sync</code>åŒæ­¥å™¨ç±»å®ç°äº†AQSï¼Œä¸”æ”¯æŒå…¬å¹³é”å’Œéå…¬å¹³é”ï¼Œå…¶å®ç°ç±»åˆ†åˆ«æ˜¯<code>FairSync</code>å’Œ<code>NonfairSync</code>ã€‚</p><p><code>ReentrantLock</code>æ‰€æœ‰æ“ä½œéƒ½æ˜¯é€šè¿‡æ ¸å¿ƒå†…éƒ¨ç±»<code>Sync</code>æ“ä½œï¼Œç”±å­ç±»<code>FairSync</code>å’Œ<code>NonfairSync</code>å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Sync sync;</span><br></pre></td></tr></table></figure><h4 id="ReentrantLockåŠ é”è¿‡ç¨‹"><a href="#ReentrantLockåŠ é”è¿‡ç¨‹" class="headerlink" title="ReentrantLockåŠ é”è¿‡ç¨‹"></a>ReentrantLockåŠ é”è¿‡ç¨‹</h4><h5 id="lock"><a href="#lock" class="headerlink" title="lock"></a>lock</h5><p><code>lock()</code>å°±æ˜¯åŠ é”ï¼Œè¯¥æ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">    sync.lock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>FairSync</code>å’Œ<code>NonfairSync</code>å…·ä½“å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FairSyncå®ç°</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NofairSyncå®ç° setExclusiveOwnerThreadæ˜¯çˆ¶ç±»AQS</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">        setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setExclusiveOwnerThread</span><span class="params">(Thread thread)</span> &#123;</span><br><span class="line">    exclusiveOwnerThread = thread;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°éå…¬å¹³é”å¤šäº†ä¸€ä¸ª<code>compareAndSetState()</code>æ“ä½œï¼Œé€šè¿‡CASå°è¯•ä¿®æ”¹é”çŠ¶æ€<code>state</code>çš„å€¼ï¼Œå¦‚æœä¿®æ”¹æˆåŠŸè®¾ç½®å½“å‰çº¿ç¨‹ä»¥ç‹¬å çš„æ–¹å¼è·å–äº†é”ï¼Œä¿®æ”¹å¤±è´¥æ‰§è¡Œçš„é€»è¾‘å’Œå…¬å¹³é”ä¸€æ ·ã€‚</p><p>å…¬å¹³é”å’Œéå…¬å¹³é”è·å–ç‹¬å é”çš„æ ¸å¿ƒé€»è¾‘éƒ½æ˜¯<code>acquire()</code>æ–¹æ³•ï¼Œæ¥ä¸‹æ¥å°±çœ‹çœ‹è¿™ä¸ªæ–¹æ³•ã€‚</p><h5 id="acquire"><a href="#acquire" class="headerlink" title="acquire"></a>acquire</h5><p><code>acquire</code>è¯¥æ–¹æ³•æ˜¯çˆ¶ç±»<code>AbstractQueuedSynchronizer</code>å®šä¹‰çš„æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•ä¸»è¦è°ƒç”¨<code>tryAcquire</code>æ–¹æ³•å°è¯•è·å–é”ï¼ŒæˆåŠŸè¿”å›trueè¡¨ç¤ºè·å–åˆ°äº†é”ï¼Œå¦‚æœå¤±è´¥å°±å°†çº¿ç¨‹å°è£…æˆèŠ‚ç‚¹æ’å…¥é˜Ÿå°¾ã€‚</p><h5 id="tryAcquire"><a href="#tryAcquire" class="headerlink" title="tryAcquire"></a>tryAcquire</h5><p><code>tryAcquire</code>æ–¹æ³•åœ¨ç±»<code>AbstractQueuedSynchronizer</code>æ²¡æœ‰ç›´æ¥å®ç°ï¼Œé‡‡ç”¨<strong>æ¨¡ç‰ˆæ–¹æ³•</strong>çš„è®¾è®¡æ¨¡å¼äº¤ç»™å­ç±»å®ç°ï¼Œå…ˆçœ‹å…¬å¹³é”<code>FairSync</code>çš„å®ç°ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="comment">// è·å–å½“å‰é”çŠ¶æ€ state=0è¡¨ç¤ºæœªé”å®š, state&gt;0è¡¨ç¤ºå·²é”å®š</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// çº¿ç¨‹æ²¡æœ‰è·å–åˆ°é”</span></span><br><span class="line">        <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">            compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">            <span class="comment">// æ²¡æœ‰æ¯”å½“å‰çº¿ç¨‹ç­‰å¾…æ›´ä¹…çš„çº¿ç¨‹äº†, é€šè¿‡CASçš„æ–¹å¼ä¿®æ”¹state</span></span><br><span class="line">            <span class="comment">// å¦‚æœæˆåŠŸåˆ™è®¾ç½®å½“å‰çº¿ç¨‹è·å–ç‹¬å å¼é”</span></span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        <span class="comment">// è·å–ç‹¬å é”çš„çº¿ç¨‹å°±æ˜¯å½“å‰çº¿ç¨‹, è¡¨ç¤ºé‡å…¥</span></span><br><span class="line">        <span class="comment">// é‡å…¥é”çš„å®ç°</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        <span class="comment">// ä¿®æ”¹stateè®°å½•è·å–é”çš„æ¬¡æ•°</span></span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢æºç å¯ä»¥çœ‹å‡ºè¯¥æ–¹æ³•å°±æ˜¯ç‹¬å çš„æ–¹å¼è·å–é”ï¼Œè·å–æˆåŠŸåè¿”å›trueï¼Œé‡å…¥é”çš„é€»è¾‘ä¹Ÿæ˜¯åœ¨è¿™é‡Œå®ç°ï¼Œä¸»è¦é€šè¿‡ä¿®æ”¹stateçš„å€¼æ¥è®°å½•è·å–é”çš„æ¬¡æ•°ã€‚</p><p>éå…¬å¹³é”çš„å®ç°å¤§åŒå°å¼‚å°±æ˜¯å°‘äº†<code>!hasQueuedPredecessors()</code>çš„åˆ¤æ–­ï¼Œå› ä¸ºæ˜¯éå…¬å¹³é”å˜›ï¼Œæ‰€ä»¥ä¸éœ€è¦åˆ¤æ–­é˜»å¡æ—¶é—´äº†ã€‚</p><p><code>acquire()</code>æ–¹æ³•é™¤äº†è°ƒç”¨<code>tryAcquire()</code>æ–¹æ³•å¤–è¿˜è°ƒç”¨äº†<code>acquireQueued(addWaiter(Node.EXCLUSIVE), arg)</code>ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆçœ‹<code>addWaiter()</code>æ–¹æ³•ã€‚</p><h5 id="addWaiter"><a href="#addWaiter" class="headerlink" title="addWaiter"></a>addWaiter</h5><p>è¯¥æ–¹æ³•ç›¸å½“äºæŠŠå½“å‰çº¿ç¨‹å°è£…æˆä¸€ä¸ªèŠ‚ç‚¹Nodeï¼Œå¹¶åŠ å…¥é˜Ÿåˆ—ï¼Œè¿™ä¸ªæ–¹æ³•æˆ‘ä»¬åœ¨ä¸Šé¢æœ‰å†™è¿‡ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates and enqueues node for current thread and given mode.</span></span><br><span class="line"><span class="comment"> * ä¸ºå½“å‰çº¿ç¨‹å’Œç»™å®šæ¨¡å¼åˆ›å»ºå¹¶è®¾ç½®å°¾èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> * Node.EXCLUSIVE: ç‹¬å æ¨¡å¼</span></span><br><span class="line"><span class="comment"> * Node.SHARED: å…±äº«æ¨¡å¼</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Node <span class="title function_">addWaiter</span><span class="params">(Node mode)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸ºå½“å‰çº¿ç¨‹åˆ›å»ºèŠ‚ç‚¹</span></span><br><span class="line">    <span class="type">Npde</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(Thread.currentThread(), mode);</span><br><span class="line">    <span class="comment">// è·å–å°¾èŠ‚ç‚¹</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">pred</span> <span class="operator">=</span> tail;</span><br><span class="line">    <span class="comment">// Try the fast path of enq; backup to full enq on failure</span></span><br><span class="line">    <span class="comment">// å¦‚æœé˜Ÿåˆ—å·²ç»åˆ›å»º, å°è¯•å¿«é€Ÿæ·»åŠ å°¾ç»“ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (pred == <span class="literal">null</span>) &#123;</span><br><span class="line">        node.prev = pred;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">            pred.next = node;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¿«é€Ÿæ·»åŠ å¤±è´¥, åˆ™è°ƒç”¨enq</span></span><br><span class="line">    enq(node);</span><br><span class="line">    retur node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="enq"><a href="#enq" class="headerlink" title="enq"></a>enq</h5><p>enqæ–¹æ³•æ˜¯å°†èŠ‚ç‚¹åŠ å…¥é˜Ÿåˆ—é˜Ÿå°¾ï¼Œå¿…è¦æ—¶è¦è¿›è¡Œåˆå§‹åŒ–ï¼Œé€šè¿‡è‡ªæ—‹+CASçš„æ–¹å¼ä¿è¯çº¿ç¨‹å®‰å…¨å’Œæ’å…¥æˆåŠŸã€‚æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Inserts node into queue, initializing if necessary. See picture above</span></span><br><span class="line"><span class="comment">* å°†èŠ‚ç‚¹æ’å…¥é˜Ÿåˆ—ï¼Œå¿…è¦æ—¶è¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> Node <span class="title function_">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// è‡ªæ—‹</span></span><br><span class="line">    <span class="keyword">for</span>(;;) &#123;</span><br><span class="line">        <span class="comment">// è·å–å°¾èŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail;</span><br><span class="line">        <span class="comment">// å°¾èŠ‚ç‚¹ä¸ºnullè¡¨ç¤ºé˜Ÿåˆ—æ²¡æœ‰åˆå§‹åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> (t == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// è®¾ç½®å¤´èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> <span class="title class_">Node</span>())) &#123;</span><br><span class="line">                tail = head;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// é˜Ÿåˆ—å·²ç»åˆå§‹åŒ–, è®¾ç½®æ–°æ·»åŠ èŠ‚ç‚¹çš„å‰ä¸€èŠ‚ç‚¹æ˜¯é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹</span></span><br><span class="line">            node.prev = t;</span><br><span class="line">            <span class="comment">// è®¾ç½®å°¾èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                <span class="comment">// è®¾ç½®é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹çš„ä¸‹ä¸€èŠ‚ç‚¹æ˜¯æ–°æ·»åŠ çš„èŠ‚ç‚¹, æ–°æ·»åŠ çš„èŠ‚ç‚¹å°±æ’å…¥å°¾èŠ‚ç‚¹äº†</span></span><br><span class="line">                t.next = node;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºè¯¥æ–¹æ³•å°±æ˜¯å¾€é˜Ÿåˆ—æ’å…¥å°¾èŠ‚ç‚¹ï¼Œé€šè¿‡è‡ªæ—‹+CASçš„æ–¹å¼ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¯¥æ–¹æ³•è¿”å›çš„NodeèŠ‚ç‚¹ä¸æ˜¯æ–°æ’å…¥çš„èŠ‚ç‚¹ï¼Œè€Œæ˜¯æ–°æ’å…¥èŠ‚ç‚¹çš„å‰ä¸€èŠ‚ç‚¹ã€‚</p><p><code>enq()</code>æ–¹æ³•ä¸­è°ƒç”¨çš„<code>compareAndSetHead()</code>ã€<code>compareAndSetTail()</code>æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€šè¿‡CASè®¾ç½®headå€¼, åªåœ¨enqæ–¹æ³•è°ƒç”¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">compareAndSetHead</span><span class="params">(Node update)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> unsafe.companreAndSwapObject(<span class="built_in">this</span>, headOffset, <span class="literal">null</span>, update);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€šè¿‡CASå‡½æ•°è®¾ç½®tailå€¼ï¼Œä»…ä»…åœ¨enqæ–¹æ³•ä¸­è°ƒç”¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">compareAndSetTail</span><span class="params">(Node expect, Node update)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> unsafe.compareAndSwapObject(<span class="built_in">this</span>, tailOffset, expect, update);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="acquireQueued"><a href="#acquireQueued" class="headerlink" title="acquireQueued"></a>acquireQueued</h5><p><code>acquireQueued()</code>æ–¹æ³•ä½œç”¨å°±æ˜¯è·å–é”ï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°é”å°±è®©å½“å‰çº¿ç¨‹é˜»å¡ç­‰å¾…ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æƒ³è¦è·å–é”çš„acquireæ–¹æ³•ï¼Œéƒ½ä¼šé€šè¿‡è¿™ä¸ªæ–¹æ³•è·å–é”</span></span><br><span class="line"><span class="comment"> * å¾ªç¯é€šè¿‡tryAcquireæ–¹æ³•ä¸æ–­å»è·å–é”ï¼Œå¦‚æœæ²¡æœ‰è·å–æˆåŠŸ</span></span><br><span class="line"><span class="comment"> * å°±æœ‰å¯èƒ½è°ƒç”¨parkAndCheckInterruptæ–¹æ³•ï¼Œè®©å½“å‰çº¿ç¨‹é˜»å¡</span></span><br><span class="line"><span class="comment"> * ç»“æœè¿”å›trueï¼Œè¡¨ç¤ºåœ¨çº¿ç¨‹ç­‰å¾…çš„è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹è¢«ä¸­æ–­äº†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// æ“ä½œæ˜¯å¦æˆåŠŸ</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è¡¨ç¤ºçº¿ç¨‹åœ¨ç­‰å¾…è¿‡ç¨‹ä¸­æ˜¯å¦è¢«ä¸­æ–­äº†</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// è‡ªæ—‹</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// è·å–å½“å‰èŠ‚ç‚¹çš„å‰ä¸€èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">            <span class="comment">// è·å–å‰ä¸€èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹, å¹¶ä¸”å°è¯•è·å–é”æˆåŠŸ</span></span><br><span class="line">            <span class="comment">// é‚£ä¹ˆå½“å‰çº¿ç¨‹ä¸å°±éœ€è¦é˜»å¡çŠ¶æ€, ç»§ç»­æ‰§è¡Œ</span></span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                <span class="comment">// å°†å½“å‰èŠ‚ç‚¹è®¾ç½®æˆå¤´èŠ‚ç‚¹</span></span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="literal">null</span>;</span><br><span class="line">                <span class="comment">// ä¸éœ€è¦è°ƒç”¨cancelAcquireæ–¹æ³•</span></span><br><span class="line">                failed = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å½“å‰èŠ‚ç‚¹ä¸æ˜¯å¤´èŠ‚ç‚¹æˆ–è€…æ²¡æœ‰è·å–åˆ°é”</span></span><br><span class="line">            <span class="comment">// shouldParkAfterFailedAcquireæ–¹æ³•ç”¨äºåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦éœ€è¦è¢«é˜»å¡</span></span><br><span class="line">            <span class="comment">// å½“pèŠ‚ç‚¹çš„çŠ¶æ€æ˜¯Node.SIGNALæ—¶å°±ä¼šè°ƒç”¨parkAndCheckInterruptæ–¹æ³•é˜»å¡çº¿ç¨‹</span></span><br><span class="line">            <span class="comment">// parkAndCheckInterruptæ–¹æ³•ç”¨äºé˜»å¡çº¿ç¨‹å¹¶ä¸”æ£€æµ‹çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­</span></span><br><span class="line">            <span class="comment">// è¢«é˜»å¡çš„çº¿ç¨‹æœ‰ä¸¤ç§è¢«å”¤é†’çš„æ–¹æ³•ï¼š</span></span><br><span class="line">            <span class="comment">// 1. åœ¨unparkSuccessor(Node node)æ–¹æ³•ï¼Œä¼šå”¤é†’è¢«é˜»å¡çš„nodeçº¿ç¨‹ï¼Œè¿”å›false</span></span><br><span class="line">            <span class="comment">// 2. å½“å‰çº¿ç¨‹è¢«è°ƒç”¨äº†interruptæ–¹æ³•ï¼Œçº¿ç¨‹è¢«å”¤é†’ï¼Œè¿”å›true</span></span><br><span class="line">            <span class="comment">// åœ¨è¿™é‡Œåªæ˜¯ç®€å•åœ°å°†interrupted = trueï¼Œæ²¡æœ‰è·³å‡ºforçš„æ­»å¾ªç¯ï¼Œç»§ç»­å°è¯•è·å–é”</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">               parkAndCheckInterrupt()) &#123;</span><br><span class="line">               interrupted = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// failedä¸ºtrueï¼Œè¡¨ç¤ºå‘ç”Ÿå¼‚å¸¸éæ­£å¸¸é€€å‡º</span></span><br><span class="line">        <span class="keyword">if</span> (failed) </span><br><span class="line">            <span class="comment">// å°†å½“å‰èŠ‚ç‚¹çŠ¶æ€è®¾ç½®æˆCANCELLED, è¡¨ç¤ºå½“å‰èŠ‚ç‚¹å·²ç»è¢«å–æ¶ˆ, ä¸éœ€è¦å”¤é†’äº†</span></span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>acquireQueued</code>æ–¹æ³•ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>é€šè¿‡<code>for(;;)</code>æ­»å¾ªç¯è‡ªæ—‹ï¼Œç›´åˆ°nodeï¼ˆå½“å‰ï¼‰èŠ‚ç‚¹è·å–åˆ°é”ã€‚</li><li>è·å–å½“å‰èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹pã€‚</li><li>å¦‚æœèŠ‚ç‚¹pæ˜¯å¤´èŠ‚ç‚¹ï¼Œç„¶åè°ƒç”¨<code>tryAcquire()</code>å°è¯•è·å–é”ï¼Œå¦‚æœè·å–æˆåŠŸå°±å°†nodeèŠ‚ç‚¹è®¾ç½®æˆå¤´èŠ‚ç‚¹ç„¶åè¿”å›ã€‚</li><li>å¦‚æœèŠ‚ç‚¹pä¸æ˜¯æŠ•èŠ‚ç‚¹æˆ–è€…è·å–é”å¤±è´¥ï¼Œè°ƒç”¨<code>shouldParkAfterFaildAcquired()</code>æ–¹æ³•æ¥å†³å®šæ˜¯å¦è¦é˜»å¡å½“å‰çº¿ç¨‹ã€‚</li><li>å¦‚æœè¦é˜»å¡å½“å‰çº¿ç¨‹ï¼Œè°ƒç”¨<code>parkAndCheckInterrupt()</code>æ–¹æ³•é˜»å¡å½“å‰çº¿ç¨‹ã€‚</li><li>å¦‚æœå½“å‰çº¿ç¨‹å‘ç”Ÿå¼‚å¸¸ï¼Œéæ­£å¸¸é€€å‡ºï¼Œè°ƒç”¨<code>cancelAcquire()</code>æ–¹æ³•å°†å½“å‰èŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®æˆå–æ¶ˆã€‚</li></ol><h5 id="shouldParkAfterFailedAcquire"><a href="#shouldParkAfterFailedAcquire" class="headerlink" title="shouldParkAfterFailedAcquire"></a>shouldParkAfterFailedAcquire</h5><p><code>shouldParkAfterFailedAcquire()</code>ç”¨äºåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦éœ€è¦é˜»å¡ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹ç»å‰ä¸€ä¸ªèŠ‚ç‚¹predçš„çŠ¶æ€æ¥åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦éœ€è¦è¢«é˜»å¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">shouldParkAfterFailedAcquire</span><span class="params">(Node pred, Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å‰ä¸€èŠ‚ç‚¹çš„çŠ¶æ€</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> pred.waitStatus;</span><br><span class="line">    <span class="keyword">if</span> (ws == Node.SINGAL) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå‰ä¸€èŠ‚ç‚¹predçš„çŠ¶æ€æ˜¯Node.SINGAL, è¯´æ˜å½“å‰çº¿ç¨‹éœ€è¦è¢«é˜»å¡</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå‰ä¸€èŠ‚ç‚¹çŠ¶æ€æ˜¯Node.CANCELLED(å¤§äº0å°±æ˜¯CANCELLED)</span></span><br><span class="line">        <span class="comment">// è¡¨ç¤ºå‰ä¸€èŠ‚ç‚¹æ‰€åœ¨çº¿ç¨‹å·²ç»è¢«å”¤é†’äº†, è¦ä»é˜Ÿåˆ—ä¸­ç§»é™¤CANCELLEDçš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥ä»predèŠ‚ç‚¹ä¸€ç›´å‘å‰æŸ¥æ‰¾ç›´åˆ°æ‰¾åˆ°ä¸æ˜¯CANCELLEDçŠ¶æ€çš„èŠ‚ç‚¹, å¹¶æŠŠè¯¥èŠ‚ç‚¹èµ‹å€¼ç»™nodeçš„prev</span></span><br><span class="line">        <span class="comment">// è¡¨ç¤ºnodeèŠ‚ç‚¹çš„å‰ä¸€èŠ‚ç‚¹å·²ç»æ”¹å˜</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            node.prev = pred = pred.prev;</span><br><span class="line">        &#125; <span class="keyword">while</span>(pred.waitStatus &gt; <span class="number">0</span>);</span><br><span class="line">        pred.next = node;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æ­¤æ—¶å‰ä¸€èŠ‚ç‚¹predçš„çŠ¶æ€åªèƒ½æ˜¯0æˆ–è€…PROPAGATE, ä¸å¯èƒ½æ˜¯CONDITIONçŠ¶æ€</span></span><br><span class="line">        <span class="comment">// CONDITION(è¿™ä¸ªæ˜¯ç‰¹æ®ŠçŠ¶æ€ï¼Œåªåœ¨conditionåˆ—è¡¨ä¸­èŠ‚ç‚¹ä¸­å­˜åœ¨ï¼ŒCLHé˜Ÿåˆ—ä¸­ä¸å­˜åœ¨è¿™ä¸ªçŠ¶æ€çš„èŠ‚ç‚¹)</span></span><br><span class="line">        <span class="comment">// å°†å‰ä¸€ä¸ªèŠ‚ç‚¹predçš„çŠ¶æ€è®¾ç½®æˆNode.SIGNAL, è¿™æ ·å­ä¸‹ä¸€æ¬¡å¾ªç¯æ—¶,å°±æ˜¯ç›´æ¥é˜»å¡å½“å‰çº¿ç¨‹</span></span><br><span class="line">        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•æ˜¯æ ¹ç»å‰ä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€æ¥åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦éœ€è¦è¢«é˜»å¡ï¼Œå‰ä¸€èŠ‚ç‚¹çš„çŠ¶æ€ä¹Ÿæ˜¯åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ä¿®æ”¹çš„ï¼Œé€šè¿‡<code>compareAndSetWaitStatus()</code>æ–¹æ³•ã€‚</p><p><code>shouldParkAfterFailedAcquire()</code>æ–¹æ³•ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>å¦‚æœå‰ä¸€èŠ‚ç‚¹çŠ¶æ€æ˜¯<code>Node.SIGNAL</code>ï¼Œåˆ™ç›´æ¥è¿”å›<code>true</code>å½“å‰çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ã€‚</li><li>å¦‚æœå‰ä¸€èŠ‚ç‚¹çŠ¶æ€æ˜¯<code>Node.CANCELLED</code>ï¼ˆå¤§äº0å°±æ˜¯CANCELLEDï¼‰ï¼Œè¡¨ç¤ºå‰ä¸€ä¸ªèŠ‚ç‚¹å·²ç»è¢«å”¤é†’äº†ï¼Œè¦ä»é˜Ÿåˆ—ä¸­ç§»åŠ¨CANCELLEDçŠ¶æ€çš„èŠ‚ç‚¹ï¼Œæ‰€ä»¥é€predèŠ‚ç‚¹ä¸€ç›´å‘å‰æŸ¥è¯¢ä¸æ˜¯CANCELLEDçŠ¶æ€çš„èŠ‚ç‚¹ï¼Œå¹¶å°†è¯¥èŠ‚ç‚¹èµ‹å€¼æˆå½“å‰èŠ‚ç‚¹çš„å‰ä¸€èŠ‚ç‚¹ï¼Œè¡¨ç¤ºå½“å‰èŠ‚ç‚¹çš„å‰ä¸€èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–ï¼Œåœ¨<code>acquireQueued()</code>æ–¹æ³•ä¸­è¿›è¡Œä¸‹ä¸€æ¬¡å¾ªç¯ã€‚</li><li>ä¸æ˜¯å‰é¢ä¸¤ç§çŠ¶æ€ï¼Œåªèƒ½æ˜¯<code>0æˆ–è€…PROPAGATE</code>çŠ¶æ€ï¼Œä¿®æ”¹å‰ä¸€èŠ‚ç‚¹çš„çŠ¶æ€ä¸º<code>Node.SIGNAL</code>ï¼Œä¸‹ä¸€æ¬¡å¾ªç¯æ—¶é˜»å¡å½“å‰çº¿ç¨‹ã€‚</li></ol><h5 id="parkAndCheckInterrupt"><a href="#parkAndCheckInterrupt" class="headerlink" title="parkAndCheckInterrupt"></a>parkAndCheckInterrupt</h5><p>è¯¥æ–¹æ³•ç”¨äºé˜»å¡å½“å‰çº¿ç¨‹å¹¶æ£€æµ‹çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é˜»å¡å½“å‰çº¿ç¨‹ï¼Œçº¿ç¨‹è¢«å”¤é†’åè¿”å›å½“å‰çº¿ç¨‹ä¸­æ–­çŠ¶æ€</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">parkAndCheckInterrupt</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="comment">// é˜»å¡å½“å‰çº¿ç¨‹</span></span><br><span class="line">    LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">// æ£€æµ‹å½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼ˆè¯¥æ–¹æ³•ä¼šæ¸…é™¤ä¸­æ–­æ ‡è¯†ä½ï¼‰</span></span><br><span class="line">    <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="cancelAcquire"><a href="#cancelAcquire" class="headerlink" title="cancelAcquire"></a>cancelAcquire</h5><p><code>cancelAcquire()</code>æ–¹æ³•åœ¨<code>acquireQueued()</code>æ–¹æ³•å¼‚å¸¸çš„æ—¶å€™è°ƒç”¨ï¼Œç”¨äºå°†å½“å‰èŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®æˆCANCELLEDï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°†nodeèŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®æˆCANCELLEDï¼Œè¡¨ç¤ºnodeèŠ‚ç‚¹æ‰€åœ¨çº¿ç¨‹å·²å–æ¶ˆï¼Œä¸éœ€è¦å”¤é†’äº†ã€‚</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">cancelAcquire</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœnodeä¸ºnullï¼Œå°±ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†è·å–é”èŠ‚ç‚¹çš„çº¿ç¨‹ç½®ç©º</span></span><br><span class="line">    node.thread = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·³è¿‡é‚£äº›å·²å–æ¶ˆçš„èŠ‚ç‚¹ï¼Œåœ¨é˜Ÿåˆ—ä¸­æ‰¾åˆ°åœ¨nodeèŠ‚ç‚¹å‰é¢çš„ç¬¬ä¸€æ¬¡çŠ¶æ€ä¸æ˜¯å·²å–æ¶ˆçš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">pred</span> <span class="operator">=</span> node.prev;</span><br><span class="line">    <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>)</span><br><span class="line">        node.prev = pred = pred.prev;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®°å½•predåŸæ¥çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç”¨äºCASå‡½æ•°æ›´æ–°æ—¶ä½¿ç”¨</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">predNext</span> <span class="operator">=</span> pred.next;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Can use unconditional write instead of CAS here.</span></span><br><span class="line">    <span class="comment">// After this atomic step, other Nodes can skip past us.</span></span><br><span class="line">    <span class="comment">// Before, we are free of interference from other threads.</span></span><br><span class="line">    <span class="comment">// å°†nodeèŠ‚ç‚¹çŠ¶æ€è®¾ç½®ä¸ºå·²å–æ¶ˆNode.CANCELLED;</span></span><br><span class="line">    node.waitStatus = Node.CANCELLED;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœnodeèŠ‚ç‚¹æ˜¯é˜Ÿåˆ—å°¾èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå°±å°†predèŠ‚ç‚¹è®¾ç½®ä¸ºæ–°çš„é˜Ÿåˆ—å°¾èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (node == tail &amp;&amp; compareAndSetTail(node, pred)) &#123;</span><br><span class="line">        <span class="comment">// å¹¶ä¸”è®¾ç½®predèŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹nextä¸ºnull</span></span><br><span class="line">        compareAndSetNext(pred, predNext, <span class="literal">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// If successor needs signal, try to set pred&#x27;s next-link</span></span><br><span class="line">        <span class="comment">// so it will get one. Otherwise wake it up to propagate.</span></span><br><span class="line">        <span class="type">int</span> ws;</span><br><span class="line">        <span class="keyword">if</span> (pred != head &amp;&amp;</span><br><span class="line">            ((ws = pred.waitStatus) == Node.SIGNAL ||</span><br><span class="line">             (ws &lt;= <span class="number">0</span> &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp;</span><br><span class="line">            pred.thread != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">next</span> <span class="operator">=</span> node.next;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="literal">null</span> &amp;&amp; next.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                compareAndSetNext(pred, predNext, next);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            unparkSuccessor(node);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        node.next = node; <span class="comment">// help GC</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="åŠ é”è¿‡ç¨‹æ€»ç»“"><a href="#åŠ é”è¿‡ç¨‹æ€»ç»“" class="headerlink" title="åŠ é”è¿‡ç¨‹æ€»ç»“"></a>åŠ é”è¿‡ç¨‹æ€»ç»“</h5><p><a href="https://qtspace.cn/contentimg/21.png"></a></p><ol><li>é¦–å…ˆè°ƒç”¨<code>lock()</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æœ‰ä¸¤ä¸ªå­ç±»<code>FairSync</code>å’Œ<code>NofairSync</code>å®ç°ï¼Œè¡¨ç¤ºå…¬å¹³é”å’Œéå…¬å¹³é”ï¼Œä¸¤ä¸ªç±»çš„ä¸åŒå°±æ˜¯<code>NofairSync</code>ä¼šç›´æ¥è°ƒç”¨<code>compareAndSetStaus()</code>æ–¹æ³•ä¿®æ”¹åŠ é”çŠ¶æ€ï¼Œå¦‚æœæˆåŠŸå½“å‰çº¿ç¨‹è·å–åˆ°é”ã€‚</li><li>ç„¶åè°ƒç”¨çˆ¶ç±»<code>AbstractQueuedSynchronized</code>çš„<code>acquire()</code>æ–¹æ³•è·å–é”ã€‚</li><li><code>acquire()</code>æ–¹æ³•è°ƒç”¨<code>tryAcquire()</code>æ–¹æ³•å°è¯•è·å–é”ï¼Œ<code>tryAcquire()</code>ç”±å­ç±»<code>FairSync</code>å’Œ<code>NofairSync</code>å®ç°åˆ†åˆ«è°ƒç”¨<code>fairTryAcquire()</code>å’Œ<code>nonfairTryAcquire()</code>æ–¹æ³•å°è¯•è·å–é”ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•é‡Œé¢å®ç°äº†é‡å…¥é”çš„é€»è¾‘ï¼Œå¦‚æœå½“å‰é”çŠ¶æ€æ˜¯æœªè·å–åˆ°é”ï¼Œåˆ™è°ƒç”¨CASè®¾ç½®é”çŠ¶æ€ï¼Œå¦‚æœæ˜¯è·å–åˆ°é”çŠ¶æ€åˆ™ä¼šåˆ¤æ–­è·å–é”çš„çº¿ç¨‹æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯åˆ™æ˜¯é‡å…¥é”çš„é€»è¾‘è®°å½•å½“å‰çº¿ç¨‹è·å–é”çš„æ¬¡æ•°ã€‚</li><li>å¦‚æœ<code>tryAcquire()</code>æ–¹æ³•è°ƒç”¨è·å–é”å¤±è´¥ï¼Œåˆ™ä¼šè°ƒç”¨<code>acquireQueued()</code>æ–¹æ³•å†è·å–é”æˆ–è€…è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œ<code>acquireQueued()</code>æ–¹æ³•é¦–å…ˆè°ƒç”¨äº†<code>addWaiter()</code>æ–¹æ³•ç”¨äºå°†å½“å‰çº¿ç¨‹å°è£…æˆä¸€ä¸ªèŠ‚ç‚¹åŠ å…¥é˜Ÿåˆ—é˜Ÿå°¾ï¼Œç„¶åå†è°ƒç”¨<code>acquireQueued()</code>æ–¹æ³•è·å–é”æˆ–è€…è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œ<code>acquireQueued()</code>æ–¹æ³•ä¼šé€šè¿‡è‡ªæ—‹çš„æ–¹å¼æ ¹ç»å½“å‰èŠ‚ç‚¹çŠ¶æ€åˆ¤æ–­æ˜¯å¦è¿›å…¥é˜»å¡çŠ¶æ€ã€‚å½“åˆ«çš„çº¿ç¨‹é‡Šæ”¾é”çš„æ—¶å€™ï¼Œå¯èƒ½å”¤é†’è¿™ä¸ªçº¿ç¨‹ï¼Œå†è°ƒç”¨<code>tryAcquire()</code>æ–¹æ³•è·å–é”ã€‚</li><li>å¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œå°†å½“å‰èŠ‚ç‚¹çŠ¶æ€è®¾ç½®æˆCANCELLEDã€‚</li></ol><h4 id="ReentrantLocké‡Šæ”¾é”è¿‡ç¨‹"><a href="#ReentrantLocké‡Šæ”¾é”è¿‡ç¨‹" class="headerlink" title="ReentrantLocké‡Šæ”¾é”è¿‡ç¨‹"></a>ReentrantLocké‡Šæ”¾é”è¿‡ç¨‹</h4><h5 id="unlock"><a href="#unlock" class="headerlink" title="unlock"></a>unlock</h5><p>è°ƒç”¨<code>unlock()</code>æ–¹æ³•é‡Šæ”¾é”ï¼Œç„¶åè°ƒç”¨<code>release()</code>æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    sync.release(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="release"><a href="#release" class="headerlink" title="release"></a>release</h5><p><code>release</code>æ˜¯<code>AbstactQueuedSynchronized</code>å®šä¹‰çš„æ–¹æ³•ç”¨äºé‡Šæ”¾é”ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åœ¨ç‹¬å é”æ¨¡å¼ä¸‹, é‡Šæ”¾é”</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">release</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨tryReleaseæ–¹æ³•å°è¯•é‡Šæ”¾é”, ç”±å­ç±»å®ç°</span></span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">        <span class="comment">//å°è¯•é‡Šæ”¾é”æˆåŠŸ è·å–å¤´èŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="comment">// å¦‚æœå¤´èŠ‚ç‚¹ä¸ä¸ºnullä¸”çŠ¶æ€ä¸ä¸ºå–æ¶ˆçŠ¶æ€, è°ƒç”¨unparkSuccessorå”¤é†’è¢«é˜»å¡çš„çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>release()</code>é‡Šæ”¾é”æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>è°ƒç”¨<code>tryRelease()</code>æ–¹æ³•å°è¯•é‡Šæ”¾é”ï¼Œè¿”å›trueè¡¨ç¤ºé‡Šæ”¾é”æˆåŠŸï¼Œè¿”å›falseè¡¨ç¤ºè¿˜æŒæœ‰é”èµ„æºã€‚</li><li>å¦‚æœé‡Šæ”¾é”æˆåŠŸäº†ï¼Œä¸”å¤´èŠ‚ç‚¹ä¸ä¸ºnullï¼Œå°±è¦å”¤é†’è¢«é˜»å¡çš„çº¿ç¨‹ï¼Œè°ƒç”¨<code>unparkSuccessor()</code>æ–¹æ³•å”¤é†’ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹ã€‚</li></ol><h5 id="tryRelease"><a href="#tryRelease" class="headerlink" title="tryRelease"></a>tryRelease</h5><p><code>tryRelease</code>å°è¯•é‡Šæ”¾é”æ–¹æ³•æ˜¯æœ‰å­ç±»å®ç°çš„ï¼Œä¸‹é¢æ˜¯<code>ReentrantLock</code>ä¸­<code>Sync</code>çš„<code>tryRelease()</code>æ–¹æ³•å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">    <span class="comment">// cè¡¨ç¤ºæ–°çš„é”çŠ¶æ€</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState() - releases;</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯è·å–ç‹¬å é”çš„çº¿ç¨‹æŠ›é”™</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">    <span class="comment">// æ˜¯å¦å¯ä»¥é‡Šæ”¾é”</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">free</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// å¦‚æœæ–°çš„é”çŠ¶æ€=0è¡¨ç¤ºå¯ä»¥é‡Šæ”¾é”</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        free = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// è·å–ç‹¬å é”çš„çº¿ç¨‹ç½®ä¸ºnull</span></span><br><span class="line">        setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é”çŠ¶æ€è®¾ç½®æˆæœªé”å®š</span></span><br><span class="line">    setState(c);</span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>tryRelease()</code>å°è¯•é‡Šæ”¾é”æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>é¦–å…ˆè·å–æ–°çš„é”çŠ¶æ€</li><li>åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯è·å–ç‹¬å é”çš„çº¿ç¨‹ï¼Œå¦‚æœä¸æ˜¯æŠ›å¼‚å¸¸ã€‚</li><li>å¦‚æœæ–°çš„é”çŠ¶æ€æ˜¯æœªé”å®šçŠ¶æ€ï¼Œè·å–ç‹¬å é”çš„çº¿ç¨‹ç½®ä¸ºnullï¼Œæ–°çš„é”çŠ¶æ€ç½®ä¸ºæœªé”å®šã€‚</li></ol><h5 id="unparkSuccessor"><a href="#unparkSuccessor" class="headerlink" title="unparkSuccessor"></a>unparkSuccessor</h5><p><code>unparkSuccessor()</code>æ–¹æ³•ç”¨äºå”¤é†’nodeèŠ‚ç‚¹ä¸‹ä¸€èŠ‚ç‚¹éå–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹æ‰€åœ¨çº¿ç¨‹ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å”¤é†’nodeèŠ‚ç‚¹ä¸‹ä¸€èŠ‚ç‚¹éå–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹æ‰€åœ¨çº¿ç¨‹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unparkSuccessor</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–nodeèŠ‚ç‚¹çš„çŠ¶æ€</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> node.waitStatus;</span><br><span class="line">    <span class="comment">// å¦‚æœçŠ¶æ€å°äº0, å°±å°†çŠ¶æ€ç½®ä¸º0, è¡¨ç¤ºè¿™ä¸ªnodeèŠ‚ç‚¹å·²ç»å®Œæˆäº†</span></span><br><span class="line">    <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">        compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// è·å–èŠ‚ç‚¹ä¸‹ä¸€èŠ‚ç‚¹</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">    <span class="comment">// å¦‚æœä¸‹ä¸€èŠ‚ç‚¹ä¸ºnull, æˆ–è€…ä¸‹ä¸€èŠ‚ç‚¹çŠ¶æ€ä¸ºå–æ¶ˆçŠ¶æ€, å°±è¦å¯»æ‰¾ä¸‹ä¸€ä¸ªéå–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// å…ˆå°†sè®¾ç½®æˆnull, sä¸æ˜¯éå–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹</span></span><br><span class="line">        s = <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// </span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail; t != <span class="literal">null</span> &amp;&amp; t!= node; t = t.prev)</span><br><span class="line">            <span class="comment">//å› ä¸ºæ˜¯ä»åå‘å‰éå†ï¼Œæ‰€ä»¥ä¸æ–­è¦†ç›–æ‰¾åˆ°çš„å€¼ï¼Œè¿™æ ·æ‰èƒ½å¾—åˆ°nodeèŠ‚ç‚¹åä¸‹ä¸€ä¸ªéå–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                s = t;</span><br><span class="line">        <span class="comment">// å¦‚æœsä¸ä¸ºnullï¼Œè¡¨ç¤ºå­˜åœ¨éå–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹,é‚£ä¹ˆè°ƒç”¨LockSupport.unparkæ–¹æ³•å”¤é†’è¿™ä¸ªèŠ‚ç‚¹çš„çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (s != <span class="literal">null</span>)</span><br><span class="line">            LockSupport.unpark(s.thread);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>unparkSuccessor()</code>æ–¹æ³•å”¤é†’nodeèŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªéå–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹æ‰€åœ¨çº¿ç¨‹æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>å…ˆå°†nodeèŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®ä¸º0ã€‚</li><li>å¯»æ‰¾ä¸‹ä¸€ä¸ªçŠ¶æ€ä¸ä¸ºå–æ¶ˆçš„èŠ‚ç‚¹sã€‚</li><li>å¦‚æœèŠ‚ç‚¹sä¸ä¸ºnullï¼Œè°ƒç”¨<code>LockSupport.unpark()</code>æ–¹æ³•å”¤é†’sæ‰€åœ¨çº¿ç¨‹ã€‚</li></ol><h5 id="é‡Šæ”¾é”è¿‡ç¨‹æ€»ç»“"><a href="#é‡Šæ”¾é”è¿‡ç¨‹æ€»ç»“" class="headerlink" title="é‡Šæ”¾é”è¿‡ç¨‹æ€»ç»“"></a>é‡Šæ”¾é”è¿‡ç¨‹æ€»ç»“</h5><ol><li>å…ˆè°ƒç”¨<code>tryRelease()</code>æ–¹æ³•å°è¯•é‡Šæ”¾å½“å‰æŒæœ‰çš„é”èµ„æºã€‚</li><li>å¦‚æœæˆåŠŸé‡Šæ”¾äº†é”èµ„æºï¼Œåˆ™è°ƒç”¨<code>unparkSuccessor()</code>æ–¹æ³•å»å”¤é†’ä¸€ä¸ªç­‰å¾…é”çš„çº¿ç¨‹ã€‚</li></ol><h4 id="å››ã€æ€»ç»“"><a href="#å››ã€æ€»ç»“" class="headerlink" title="å››ã€æ€»ç»“"></a>å››ã€æ€»ç»“</h4><p><a href="https://qtspace.cn/contentimg/22.png"></a></p><p>åˆ°è¿™é‡Œ<code>ReentrantLock</code>åŠ é”é‡Šæ”¾é”çš„è¿‡ç¨‹å·²ç»å­¦ä¹ å®Œæ¯•ï¼Œ<code>ReentrantLock</code>æ˜¯åŸºäºAQSå®ç°çš„<strong>ç‹¬å å¼é”</strong>ï¼Œå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª<code>FIFOé˜Ÿåˆ—</code>å®ç°æœªè·å–åˆ°é”çš„çº¿ç¨‹è¿›è¡Œæ’é˜Ÿå·¥ä½œï¼Œ <code>ReentrantLock</code>å†…éƒ¨æœ‰<code>FairSync</code>ï¼ˆå…¬å¹³é”ï¼‰å’Œ<code>NonfairSync</code>ï¼ˆéå…¬å¹³é”ï¼‰ä¸¤ç§å®ç°ï¼Œé€šè¿‡è°ƒç”¨<code>lock()</code>æ–¹æ³•åŠ é”ï¼Œè°ƒç”¨<code>unlock()</code>æ–¹æ³•è§£é”ã€‚</p><h4 id="äº”ã€è‡ªå·±å®ç°ä¸€ä¸ªå¯é‡å…¥çš„ç‹¬å é”"><a href="#äº”ã€è‡ªå·±å®ç°ä¸€ä¸ªå¯é‡å…¥çš„ç‹¬å é”" class="headerlink" title="äº”ã€è‡ªå·±å®ç°ä¸€ä¸ªå¯é‡å…¥çš„ç‹¬å é”"></a>äº”ã€è‡ªå·±å®ç°ä¸€ä¸ªå¯é‡å…¥çš„ç‹¬å é”</h4><p>é€šè¿‡ç»§æ‰¿<code>AbstractQueuedSynchronizer </code>ç±»é‡å†™<code>tryAcquire()</code>å’Œ<code>tryRelease()</code>æ–¹æ³•å®ç°è‡ªå®šä¹‰çš„å¯é‡å…¥ç‹¬å é”ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SyncLock</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="comment">// è·å–å½“å‰é”çŠ¶æ€</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="comment">// å¦‚æœé”çŠ¶æ€ä¸º0, è¡¨ç¤ºå½“å‰é”æ˜¯ç©ºé—²çš„</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// è°ƒç”¨CASåŸå­æ“ä½œè®¾ç½®é”çŠ¶æ€</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè®¾ç½®æˆåŠŸ, å°†å½“å‰çº¿ç¨‹è®¾ç½®ä¸ºè·å–ç‹¬å é”çš„çº¿ç¨‹</span></span><br><span class="line">                setExclusiveOwnerThread(current);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯ä¸æ˜¯è·å–ç‹¬å é”çš„çº¿ç¨‹, å› ä¸ºå¯èƒ½é‡å…¥é”</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">            <span class="keyword">if</span> (nextc &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// é‡å…¥é”å®ç°é€»è¾‘, è®°å½•è·å–é”çš„æ¬¡æ•°</span></span><br><span class="line">            setState(nextc);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState() - releases;</span><br><span class="line">        <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">free</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>)&#123;</span><br><span class="line">            free = <span class="literal">true</span>;</span><br><span class="line">            setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        setState(c);</span><br><span class="line">        <span class="keyword">return</span> free;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AQSTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">newThread</span><span class="params">(SyncLock syncLock, String name, <span class="type">int</span> time)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹&quot;</span> + Thread.currentThread().getName() +</span><br><span class="line">                        <span class="string">&quot;å¼€å§‹è¿è¡Œ, å‡†å¤‡è·å–é”ã€‚&quot;</span>);</span><br><span class="line">                syncLock.acquire(<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;çº¿ç¨‹&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;, åœ¨runæ–¹æ³•è·å–äº†é”ã€‚&quot;</span>);</span><br><span class="line">                    lockAgain();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(time);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;çº¿ç¨‹&quot;</span>+Thread.currentThread().getName()+<span class="string">&quot; åœ¨runæ–¹æ³•ä¸­é‡Šæ”¾äº†é”ã€‚&quot;</span>);</span><br><span class="line">                    syncLock.release(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">lockAgain</span><span class="params">()</span> &#123;</span><br><span class="line">                syncLock.acquire(<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;çº¿ç¨‹&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;, åœ¨lockAgainæ–¹æ³•è·å–äº†é”ã€‚&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">10</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;çº¿ç¨‹&quot;</span>+Thread.currentThread().getName()+<span class="string">&quot; åœ¨lockAgainæ–¹æ³•ä¸­é‡Šæ”¾äº†é”ã€‚&quot;</span>);</span><br><span class="line">                    syncLock.release(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, name).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">SyncLock</span> <span class="variable">syncLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SyncLock</span>();</span><br><span class="line">        newThread(syncLock, <span class="string">&quot;t1111&quot;</span>, <span class="number">1000</span>);</span><br><span class="line">        newThread(syncLock, <span class="string">&quot;t2222&quot;</span>, <span class="number">1000</span>);</span><br><span class="line">        newThread(syncLock, <span class="string">&quot;t3333&quot;</span>, <span class="number">1000</span>);</span><br><span class="line">        newThread(syncLock, <span class="string">&quot;t4444&quot;</span>, <span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">çº¿ç¨‹t1111å¼€å§‹è¿è¡Œ, å‡†å¤‡è·å–é”ã€‚</span><br><span class="line">çº¿ç¨‹t2222å¼€å§‹è¿è¡Œ, å‡†å¤‡è·å–é”ã€‚</span><br><span class="line">çº¿ç¨‹t1111, åœ¨runæ–¹æ³•è·å–äº†é”ã€‚</span><br><span class="line">çº¿ç¨‹t1111, åœ¨lockAgainæ–¹æ³•è·å–äº†é”ã€‚</span><br><span class="line">çº¿ç¨‹t4444å¼€å§‹è¿è¡Œ, å‡†å¤‡è·å–é”ã€‚</span><br><span class="line">çº¿ç¨‹t3333å¼€å§‹è¿è¡Œ, å‡†å¤‡è·å–é”ã€‚</span><br><span class="line">çº¿ç¨‹t1111 åœ¨lockAgainæ–¹æ³•ä¸­é‡Šæ”¾äº†é”ã€‚</span><br><span class="line">çº¿ç¨‹t1111 åœ¨runæ–¹æ³•ä¸­é‡Šæ”¾äº†é”ã€‚</span><br><span class="line">çº¿ç¨‹t2222, åœ¨runæ–¹æ³•è·å–äº†é”ã€‚</span><br><span class="line">çº¿ç¨‹t2222, åœ¨lockAgainæ–¹æ³•è·å–äº†é”ã€‚</span><br><span class="line">çº¿ç¨‹t2222 åœ¨lockAgainæ–¹æ³•ä¸­é‡Šæ”¾äº†é”ã€‚</span><br><span class="line">çº¿ç¨‹t2222 åœ¨runæ–¹æ³•ä¸­é‡Šæ”¾äº†é”ã€‚</span><br><span class="line">çº¿ç¨‹t4444, åœ¨runæ–¹æ³•è·å–äº†é”ã€‚</span><br><span class="line">çº¿ç¨‹t4444, åœ¨lockAgainæ–¹æ³•è·å–äº†é”ã€‚</span><br><span class="line">çº¿ç¨‹t4444 åœ¨lockAgainæ–¹æ³•ä¸­é‡Šæ”¾äº†é”ã€‚</span><br><span class="line">çº¿ç¨‹t4444 åœ¨runæ–¹æ³•ä¸­é‡Šæ”¾äº†é”ã€‚</span><br><span class="line">çº¿ç¨‹t3333, åœ¨runæ–¹æ³•è·å–äº†é”ã€‚</span><br><span class="line">çº¿ç¨‹t3333, åœ¨lockAgainæ–¹æ³•è·å–äº†é”ã€‚</span><br><span class="line">çº¿ç¨‹t3333 åœ¨lockAgainæ–¹æ³•ä¸­é‡Šæ”¾äº†é”ã€‚</span><br><span class="line">çº¿ç¨‹t3333 åœ¨runæ–¹æ³•ä¸­é‡Šæ”¾äº†é”ã€‚</span><br></pre></td></tr></table></figure><h4 id="å…­ã€ReentrentLockå’Œsynchronizedçš„æ¯”è¾ƒ"><a href="#å…­ã€ReentrentLockå’Œsynchronizedçš„æ¯”è¾ƒ" class="headerlink" title="å…­ã€ReentrentLockå’Œsynchronizedçš„æ¯”è¾ƒ"></a>å…­ã€ReentrentLockå’Œsynchronizedçš„æ¯”è¾ƒ</h4><h5 id="ç›¸åŒç‚¹ï¼š"><a href="#ç›¸åŒç‚¹ï¼š" class="headerlink" title="ç›¸åŒç‚¹ï¼š"></a>ç›¸åŒç‚¹ï¼š</h5><ul><li>éƒ½æ˜¯åŠ é”æ–¹å¼åŒæ­¥</li><li>éƒ½æ˜¯é‡å…¥é”ã€‚</li><li>éƒ½æ˜¯é€šè¿‡é˜»å¡çš„æ–¹å¼å®ç°åŒæ­¥ã€‚</li></ul><h5 id="ä¸åŒç‚¹"><a href="#ä¸åŒç‚¹" class="headerlink" title="ä¸åŒç‚¹"></a>ä¸åŒç‚¹</h5><ul><li>åŸå§‹æ„æˆï¼š<code>synchronized</code>æ˜¯javaè¯­è¨€çš„å…³é”®å­—ï¼Œæ˜¯åŸç”Ÿè¯­æ³•å±‚é¢çš„äº’æ–¥ï¼Œç”±JVMå®ç°ï¼Œè€Œ<code>ReentrentLock</code>æ˜¯JDK1.5ä¹‹åæä¾›çš„APIå±‚é¢çš„äº’æ–¥é”ã€‚</li><li>å®ç°ï¼š<code>synchronized</code>æ˜¯é€šè¿‡JVMå®ç°åŠ é”è§£é”ï¼Œè€Œ<code>ReentrentLock</code>æ˜¯APIå±‚é¢çš„åŠ é”è§£é”ï¼Œéœ€è¦æ‰‹åŠ¨è§£é”ã€‚</li><li>ä»£ç ç¼–å†™ï¼š<code>synchronized</code>ä¸éœ€è¦æ‰‹åŠ¨é‡Šæ”¾é”ï¼Œä¿®é¥°æ–¹æ³•æˆ–è€…ä»£ç å—ï¼Œè€Œ<code>ReentrentLock</code>å¿…é¡»æ‰‹åŠ¨é‡Šæ”¾é”ï¼Œå¦‚æœæ²¡æœ‰é‡Šæ”¾é”å¯èƒ½é€ æˆæ­»é”ç°è±¡ã€‚éœ€è¦<code>lock()</code>å’Œ<code>unlock()</code>æ–¹æ³•é…åˆ<code>try/finally</code>è¯­å¥å—å®Œæˆã€‚</li><li>çµæ´»æ€§ï¼š<code>synchronized</code>åªèƒ½ç”¨äºä¿®é¥°æ–¹æ³•æˆ–è€…ä»£ç å—ï¼Œçµæ´»æ€§ä½ï¼Œè€Œ<code>ReentrentLock</code>æ˜¯æ–¹æ³•è°ƒç”¨å¯ä»¥è·¨æ–¹æ³•ï¼Œçµæ´»æ€§é«˜ã€‚</li><li>æ˜¯å¦ç­‰å¾…å¯ä¸­æ–­ï¼š<code>synchronized</code>ä¸å¯ä¸­æ–­ï¼Œé™¤éæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œ<code>ReentrentLock</code>æ˜¯å¯ä»¥ä¸­æ–­çš„ï¼Œå¦‚æœæŒæœ‰é”çš„çº¿ç¨‹é•¿æœŸä¸é‡Šæ”¾é”ï¼Œæ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥é€‰æ‹©æ”¾å¼ƒç­‰å¾…ï¼Œé€šè¿‡è®¾ç½®è¶…æ—¶æ—¶é—´æ–¹æ³•ã€‚</li><li>æ˜¯å¦å…¬å¹³é”ï¼š<code>synchronized</code>æ˜¯ä¸å…¬å¹³é”ï¼Œè€Œ<code>ReentrentLock</code>æ˜¯å¯å…¬å¹³é”ä¹Ÿå¯ä¸å…¬å¹³é”ã€‚</li><li>å®ç°åŸç†ï¼š<code>synchronized</code>æ˜¯é€šè¿‡ç¼–è¯‘ï¼Œä¼šåœ¨åŒæ­¥ä»£ç å—å‰ååˆ†åˆ«ç”Ÿæˆ<code>monitorenter</code>å’Œ<code>monitorexit</code>ä¸¤ä¸ªæŒ‡ä»¤å®ç°åŒæ­¥ï¼Œåœ¨æ‰§è¡Œ<code>monitorenter</code>çš„æŒ‡ä»¤æ—¶ä¼šå°è¯•è·å–é”ï¼Œè·å–é”æˆåŠŸä¼šé€šè¿‡è®¡æ•°å™¨+1ï¼Œæ‰§è¡Œå®Œæ¯•ä¹‹åä¼šæ‰§è¡Œ<code>monitorexit</code>æ‰§è¡Œè®¡æ•°å™¨-1ï¼Œå½“è®¡æ•°å™¨ä¸º0æ—¶é‡Šæ”¾é”ï¼Œå¦‚æœè·å–é”å¤±è´¥å°±ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œè€Œ<code>ReentrentLock</code>æ˜¯é€šè¿‡<code>CAS + CLHé˜Ÿåˆ—</code>å®ç°ï¼Œé€šè¿‡<code>CAS</code>åŸå­æ€§æ“ä½œå®ç°å¯¹é”çŠ¶æ€<code>state</code>çš„ä¿®æ”¹ï¼Œé€šè¿‡<code>CLHé˜Ÿåˆ—</code>å®ç°å¯¹æœªè·å–åˆ°é”çš„çº¿ç¨‹è¿›è¡Œæ’é˜Ÿå·¥ä½œã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> JUC </category>
          
          <category> AQS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AbstractQueuedSynchronizer </tag>
            
            <tag> ReentrantLock </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaé”(ä¸€)ï¼švolatileã€synchronizedè¯¦è§£</title>
      <link href="/2022/03/26/java-lock-volatile-synchronized/"/>
      <url>/2022/03/26/java-lock-volatile-synchronized/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h3 id="ä¸€ã€é”çš„åŸºç¡€çŸ¥è¯†"><a href="#ä¸€ã€é”çš„åŸºç¡€çŸ¥è¯†" class="headerlink" title="ä¸€ã€é”çš„åŸºç¡€çŸ¥è¯†"></a>ä¸€ã€é”çš„åŸºç¡€çŸ¥è¯†</h3><h4 id="é”çš„ç±»å‹"><a href="#é”çš„ç±»å‹" class="headerlink" title="é”çš„ç±»å‹"></a>é”çš„ç±»å‹</h4><p>é”ä»å®¢è§‚ä¸Šåˆ†ä¸ºæ‚²è§‚é”å’Œä¹è§‚é”ã€‚</p><ul><li>ä¹è§‚é”ï¼šä¹è§‚é”æ˜¯ä¸€ç§ä¹è§‚æ€æƒ³ï¼Œè®¤ä¸ºå†™å°‘è¯»å¤šï¼Œé‡åˆ°å¹¶å‘å†™çš„å¯èƒ½æ€§æ¯”è¾ƒä½ï¼Œè¯»æ•°æ®çš„æ—¶å€™è®¤ä¸ºåˆ«äººä¸ä¼šä¿®æ”¹ï¼Œæ‰€ä»¥è¯»çš„æ—¶å€™ä¸ä¼šä¸Šé”ï¼Œä½†æ˜¯åœ¨å†™çš„æ—¶å€™ä¼šåˆ¤æ–­ä¸€ä¸‹åœ¨æ­¤æœŸé—´æœ‰æ²¡æœ‰åˆ«äººå»æ›´æ–°è¿™ä¸ªæ•°æ®ï¼Œé‡‡å–çš„æ˜¯å…ˆè¯»å–å½“å‰ç‰ˆæœ¬å·ï¼Œç„¶ååŠ é”æ“ä½œï¼Œå†™å®Œçš„æ—¶å€™è¯»å–æœ€æ–°ç‰ˆæœ¬å·åšè®°å½•çš„ç‰ˆæœ¬å·åšæ¯”è¾ƒä¸€æ ·åˆ™æˆåŠŸï¼Œå¦‚æœå¤±è´¥åˆ™é‡å¤è¯»-æ¯”è¾ƒ-å†™çš„æ“ä½œã€‚Javaä¸­çš„ä¹è§‚é”åŸºæœ¬éƒ½æ˜¯é€šè¿‡<code>CAS</code>æ“ä½œå®ç°çš„ï¼Œ<code>java.util.concurrent.atomic</code>åŒ…ä¸‹çš„åŸå­å˜é‡ã€‚<code>CAS(compare and swap)æ¯”è¾ƒäº¤æ¢</code>æ˜¯ä¸€ç§æ›´æ–°çš„åŸå­æ“ä½œï¼Œæ¯”è¾ƒå½“å‰å€¼å’Œä¼ å…¥å€¼æ˜¯å¦ä¸€æ ·ï¼Œä¸€æ ·åˆ™æ›´æ–°ï¼Œå¦åˆ™åˆ™å¤±è´¥ã€‚</li><li>æ‚²è§‚é”ï¼šæ‚²è§‚é”å°±æ˜¯æ‚²è§‚æ€æƒ³ï¼Œè®¤ä¸ºå†™å¤šä¸”é‡åˆ°å¹¶å‘æ€§çš„å¯èƒ½æ€§é«˜ï¼Œæ¯æ¬¡æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¸ºä¿®æ”¹ï¼Œæ‰€ä»¥æ¯æ¬¡è¯»å†™çš„æ—¶å€™éƒ½ä¼šä¸Šé”ï¼Œè¿™æ ·åˆ«äººæƒ³è¯»å†™æ•°æ®çš„æ—¶å€™éƒ½ä¼šblock(é˜»å¡)çŸ¥é“æ‹¿åˆ°é”ã€‚Javaä¸­æ‚²è§‚é”å°±æ˜¯<code>syschronized</code>ï¼Œ<code>AQS</code>æ¡†æ¶ä¸‹çš„é”åˆ™æ˜¯å…ˆå°è¯•<code>CAS</code>ä¹è§‚é”è·å–é”ï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œæ‰ä¼šè½¬ä¸ºæ‚²è§‚é”ï¼Œå¦‚<code>ReentrantLock</code>ã€‚</li></ul><h4 id="Javaä¸­çš„é”"><a href="#Javaä¸­çš„é”" class="headerlink" title="Javaä¸­çš„é”"></a>Javaä¸­çš„é”</h4><p>åœ¨Javaä¸­ä¸»è¦æœ‰ä¸¤ç§é”åŠ é”æœºåˆ¶ï¼š</p><ul><li><code>syschronized</code>å…³é”®å­—ä¿®é¥°</li><li><code>java.util.concurrent.Lock</code>ï¼ŒLockæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæœ‰å¾ˆå¤šå®ç°ç±»æ¯”å¦‚<code>ReentrantLock</code>ã€‚</li></ul><h3 id="äºŒã€volatile"><a href="#äºŒã€volatile" class="headerlink" title="äºŒã€volatile"></a>äºŒã€volatile</h3><h4 id="å¯è§æ€§"><a href="#å¯è§æ€§" class="headerlink" title="å¯è§æ€§"></a>å¯è§æ€§</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VolatileTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span>  <span class="type">VT</span> <span class="variable">vt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VT</span>();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread01</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(vt);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread02</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ignore) &#123; &#125;</span><br><span class="line">                vt.sign = <span class="literal">true</span>;</span><br><span class="line">                System.out.println(<span class="string">&quot;vt.sign = true é€šçŸ¥ while (!sign) ç»“æŸï¼&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        thread01.start();</span><br><span class="line">        thread02.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VT</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="variable">sign</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (!sign) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;ä½ å&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç æ˜¯ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œä¸€ä¸ªå˜é‡ï¼Œç¨‹åºå¸Œæœ›å½“<code>sign</code>åœ¨çº¿ç¨‹Thread01è¢«æ“ä½œ<code>vt.sign = true</code>æ—¶ï¼Œçº¿ç¨‹Thread02è¾“å‡º<code>ä½ å</code>ã€‚</p><p>å®é™…ä¸Šè¿™æ®µä»£ç æ°¸è¿œä¸ä¼šè¾“å‡º<code>ä½ å</code>ï¼Œè€Œæ˜¯ä¸€ç›´å¤„äºæ­»å¾ªç¯ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬ä¸€æ­¥æ­¥è®²è§£éªŒè¯ã€‚</p><p>æˆ‘ä»¬æŠŠ<code>sign</code>å…³é”®å­—åŠ ä¸Š<code>volatile</code>å…³é”®å­—ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">sign</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™ä¼šè¾“å‡º<code>ä½ å</code>ã€‚</p><p><code>volatile</code>å…³é”®å­—æ˜¯Javaè™šæ‹Ÿæœºæä¾›çš„æœ€è½»é‡çº§é”çš„åŒæ­¥æœºåˆ¶ï¼Œä½œä¸ºä¸€ä¸ªä¿®é¥°ç¬¦å‡ºç°ï¼ŒåŒæ¥ä¿®é¥°å˜é‡ï¼Œä¸å«æ‹¬å±€éƒ¨å˜é‡ï¼Œç”¨æ¥ä¿è¯å¯¹æ‰€æœ‰çº¿ç¨‹å¯è§æ€§ã€‚</p><p>æ— <code>volatile</code>å…³é”®å­—ä¿®é¥°æ—¶å†…å­˜å˜åŒ–</p><p><img src="https://qtspace.cn/contentimg/16.jpg"></p><p>å½“æ²¡æœ‰<code>volatile</code>å…³é”®å­—ä¿®é¥°çš„æ—¶å€™ï¼ŒThread01å¯¹å˜é‡è¿›è¡Œæ“ä½œï¼ŒThead02å¹¶ä¸ä¼šæ‹¿åˆ°æœ€æ–°å€¼ã€‚</p><p>æœ‰<code>volatile</code>å…³é”®å­—æ—¶å†…å­˜å˜åŒ–</p><p><img src="https://qtspace.cn/contentimg/17.jpg"></p><p>å½“æœ‰<code>volatile</code>å…³é”®å­—ä¿®é¥°çš„æ—¶å€™ï¼ŒThread01å¯¹å˜é‡è¿›è¡Œæ“ä½œæ—¶ï¼Œä¼šæŠŠå˜é‡çš„å˜åŒ–å¼ºåˆ¶åˆ·æ–°åˆ°ä¸»å†…å­˜ï¼ŒThread02è·å–å€¼æ—¶ï¼Œä¼šæŠŠè‡ªå·±å†…å­˜çš„signå€¼è¿‡æœŸæ‰ï¼Œä»ä¸»å†…å­˜è¯»å–æœ€æ–°çš„ã€‚</p><h4 id="æœ‰åºæ€§"><a href="#æœ‰åºæ€§" class="headerlink" title="æœ‰åºæ€§"></a>æœ‰åºæ€§</h4><p><code>volatile</code>å…³é”®å­—åº•å±‚æ˜¯é€šè¿‡<strong>lockæŒ‡ä»¤</strong>å®ç°å¯è§æ€§çš„ï¼ŒlockæŒ‡ä»¤ç›¸å½“äºä¸€ä¸ªå†…å­˜å±éšœï¼Œä¿è¯ä»¥ä¸‹ä¸‰ç‚¹ï¼š</p><ul><li>å°†æœ¬å¤„ç†å™¨çš„ç¼“å­˜å†™å…¥ä¸»å†…å­˜ã€‚</li><li>é‡æ’åºæ—¶ä¸ä¼šæŠŠåé¢çš„æŒ‡ä»¤é‡æ–°æ’åºåˆ°å†…å­˜å±éšœä¹‹å‰ã€‚</li><li>å¦‚æœæ˜¯å†™å…¥æ“ä½œä¼šå¯¼è‡´å…¶ä»–å†…å­˜å™¨ä¸­å¯¹åº”çš„å†…å­˜æ— æ•ˆã€‚</li></ul><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><ul><li><code>volatile</code>å…³é”®å­—ä¼šæ§åˆ¶è¢«ä¿®é¥°çš„å˜é‡åœ¨å†…å­˜æ“ä½œçš„æ—¶å€™ä¼šä¸»åŠ¨æŠŠå€¼åˆ·æ–°åˆ°ä¸»å†…å­˜ï¼ŒJMMä¼šå…ˆå°†çº¿ç¨‹å¯¹åº”çš„CPUå†…å­˜è®¾ç½®è¿‡æœŸï¼Œä»å†…å­˜è¯»å–æœ€æ–°å€¼ã€‚</li><li><code>volatile</code>å…³é”®å­—æ˜¯é€šè¿‡å†…å­˜å±éšœé˜²æ­¢æŒ‡ä»¤é‡æ’ï¼Œ<code>volatile</code>çš„å†…å­˜å±éšœåœ¨è¯»å†™çš„æ—¶å€™åœ¨å‰åå„æ·»åŠ ä¸€ä¸ª<code>Store</code>å±éšœæ¥ä¿è¯é‡æ–°æ’åºæ—¶ä¸ä¼šæŠŠå†…å­˜å±éšœåé¢çš„æ—¶å€™æŒ‡ä»¤æ’åºåˆ°å†…å­˜å±éšœä¹‹å‰ã€‚</li><li><code>volatile</code>ä¸èƒ½è§£å†³åŸå­æ€§ï¼Œå¦‚æœéœ€è¦è§£å†³åŸå­æ€§éœ€è¦<code>synchronized</code>æˆ–è€…<code>lock</code>ã€‚</li></ul><h3 id="ä¸‰ã€synchronized"><a href="#ä¸‰ã€synchronized" class="headerlink" title="ä¸‰ã€synchronized"></a>ä¸‰ã€synchronized</h3><h4 id="çŸ¥è¯†å¤§çº²"><a href="#çŸ¥è¯†å¤§çº²" class="headerlink" title="çŸ¥è¯†å¤§çº²"></a>çŸ¥è¯†å¤§çº²</h4><p><img src="https://qtspace.cn/contentimg/18.jpg"></p><h4 id="ä½¿ç”¨æ–¹æ³•"><a href="#ä½¿ç”¨æ–¹æ³•" class="headerlink" title="ä½¿ç”¨æ–¹æ³•"></a>ä½¿ç”¨æ–¹æ³•</h4><p><code>synchronized</code>å…³é”®å­—ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç§ä½¿ç”¨æ–¹å¼ï¼š</p><ul><li><p><strong>ä¿®é¥°å®ä¾‹æ–¹æ³•</strong>ï¼Œä½œç”¨äºå½“å‰å®ä¾‹åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å–<strong>å½“å‰å®ä¾‹</strong>çš„é”ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SynchronizedTest</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">getI</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">1000000</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            System.out.println(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">increase</span><span class="params">()</span> &#123;</span><br><span class="line">        i++;</span><br><span class="line">        getI();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">1000000</span>; j++) &#123;</span><br><span class="line">            increase();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">        <span class="type">SynchronizedTest</span> <span class="variable">synchronizedTest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SynchronizedTest</span>();</span><br><span class="line">        executorService.execute(synchronizedTest);</span><br><span class="line">        executorService.execute(synchronizedTest);</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åç»“æœè¾“å‡ºï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1000000</span><br><span class="line">1556623</span><br><span class="line">2000000</span><br><span class="line">2000000</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œåˆ›å»ºä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œåŒä¸€ä¸ªå…±äº«èµ„æº<code>i</code>ï¼Œä¸”<code>increase()</code>ã€<code>get()</code>æ–¹æ³•åŠ äº†<code>synchronized</code>å…³é”®å­—ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹çš„é”æ˜¯å®ä¾‹å¯¹è±¡ï¼Œå› ä¸ºä¼ å…¥çº¿ç¨‹éƒ½æ˜¯<code>synchronizedTest</code>å¯¹è±¡å®ä¾‹æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥æœ€ç»ˆç»“æœè‚¯å®šèƒ½è¾“å‡º<code>2000000</code>ï¼Œå¦‚æœæˆ‘ä»¬æ¢ç§æ–¹å¼ï¼Œä¼ å…¥ä¸åŒå¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">    <span class="type">SynchronizedTest</span> <span class="variable">synchronizedTest01</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SynchronizedTest</span>();</span><br><span class="line">    <span class="type">SynchronizedTest</span> <span class="variable">synchronizedTest02</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SynchronizedTest</span>();</span><br><span class="line">    executorService.execute(synchronizedTest01);</span><br><span class="line">    executorService.execute(synchronizedTest02);</span><br><span class="line">    executorService.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1002588</span><br><span class="line">1641267</span><br><span class="line">1848269</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆè‚¯å®šä¸æ˜¯æœŸæœ›çš„<code>200000</code>ï¼Œå› ä¸º<code>synchronized</code>ä¿®é¥°æ–¹æ³•é”çš„æ˜¯å½“å‰å®ä¾‹ï¼Œä¼ å…¥ä¸åŒå¯¹è±¡å®ä¾‹çº¿ç¨‹æ˜¯æ— æ³•ä¿è¯å®‰å…¨çš„ã€‚</p></li><li><p><strong>ä¿®é¥°é™æ€æ–¹æ³•</strong>ï¼Œä½œç”¨äºå½“å‰ç±»å¯¹è±¡åŠ é”ï¼Œè¿›å…¥åŒæ­¥æ–¹æ³•å‰è¦è·å–<strong>å½“å‰ç±»å¯¹è±¡</strong>çš„é”ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SynchronizedTest</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">getI</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">1000000</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            System.out.println(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">increase</span><span class="params">()</span> &#123;</span><br><span class="line">        i++;</span><br><span class="line">        getI();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">1000000</span>; j++) &#123;</span><br><span class="line">            increase();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">        <span class="type">SynchronizedTest</span> <span class="variable">synchronizedTest01</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SynchronizedTest</span>();</span><br><span class="line">        <span class="type">SynchronizedTest</span> <span class="variable">synchronizedTest02</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SynchronizedTest</span>();</span><br><span class="line">        executorService.execute(synchronizedTest01);</span><br><span class="line">        executorService.execute(synchronizedTest02);</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1000000</span></span><br><span class="line"><span class="number">1649530</span></span><br><span class="line"><span class="number">2000000</span></span><br><span class="line"><span class="number">2000000</span></span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç å’Œç¬¬ä¸€æ®µä»£ç å·®ä¸å¤šï¼Œåªä¸è¿‡<code>increase()</code>ã€<code>get()</code>æ–¹æ³•æ˜¯é™æ€æ–¹æ³•ï¼Œä¸”ä¹ŸåŠ ä¸Šäº†<code>synchronized</code>è¡¨ç¤ºé”çš„æ˜¯å½“å‰ç±»å¯¹è±¡ï¼Œè™½ç„¶æˆ‘ä»¬ä¼ å…¥ä¸åŒçš„å¯¹è±¡ï¼Œä½†æ˜¯æœ€ç»ˆç»“æœæ˜¯ä¼šè¾“å‡º<code>200000</code>çš„ã€‚</p></li><li><p>ä¿®é¥°<strong>è¯­ä»£ç å—</strong>ï¼ŒæŒ‡å®šåŠ é”å¯¹è±¡ï¼Œç»™å¯¹è±¡åŠ é”ï¼Œè¿›å…¥åŒæ­¥æ–¹æ³•å‰è¦è·å–<strong>ç»™å®šå¯¹è±¡</strong>çš„é”ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SynchronizedTest02</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">SynchronizedTest02</span> <span class="variable">synchronizedTest02</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SynchronizedTest02</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ä¼ å…¥å¯¹è±¡é”å½“å‰å®ä¾‹å¯¹è±¡</span></span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯ synchronized (SynchronizedTest02.class) é”å½“å‰ç±»å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">synchronized</span> (synchronizedTest02)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;<span class="number">1000000</span>;j++)&#123;</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread01</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(synchronizedTest02);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread02</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(synchronizedTest02);</span><br><span class="line">        thread01.start();</span><br><span class="line">        thread02.start();</span><br><span class="line">        Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        System.out.println(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ç”¨é”ä¿®é¥°ä»£ç å—ï¼Œä¼ å…¥çš„æ˜¯å¯¹è±¡è¡¨ç¤ºé”çš„æ˜¯å½“å‰å®ä¾‹å¯¹è±¡ï¼Œå¦‚æœä¼ å…¥æ˜¯ç±»è¡¨ç¤ºé”çš„æ˜¯ç±»å¯¹è±¡ã€‚</p></li></ul><h4 id="ç‰¹æ€§"><a href="#ç‰¹æ€§" class="headerlink" title="ç‰¹æ€§"></a>ç‰¹æ€§</h4><h5 id="åŸå­æ€§"><a href="#åŸå­æ€§" class="headerlink" title="åŸå­æ€§"></a>åŸå­æ€§</h5><p>åŸå­æ€§è¡¨ç¤ºä¸€ä¸ªæ“ä½œä¸å¯ä¸­æ–­ï¼Œè¦ä¹ˆæˆåŠŸè¦ä¹ˆå¤±è´¥ã€‚</p><p><code>synchroniezd</code>èƒ½å®ç°æ–¹æ³•åŒæ­¥ï¼ŒåŒä¸€æ—¶é—´æ®µå†…åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‹¿åˆ°é”ï¼Œè¿›å…¥åˆ°ä»£ç æ‰§è¡Œï¼Œä»è€Œè¾¾åˆ°åŸå­æ€§ã€‚</p><p>åº•å±‚é€šè¿‡æ‰§è¡Œ<code>mointorenter</code>æŒ‡ä»¤ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰<code>ACC_SYNCHRONIZED</code>åŒæ­¥æ ‡è¯†ï¼Œæœ‰è¡¨ç¤ºè·å–<code>monitor</code>é”ï¼Œæ­¤æ—¶è®¡æ•°å™¨+1ï¼Œæ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œæ‰§è¡Œ<code>mointorexit</code>æŒ‡å®šï¼Œæ­¤æ—¶è®¡æ•°å™¨-1ï¼Œå½’0é‡Šæ”¾é”ã€‚</p><h5 id="å¯è§æ€§-1"><a href="#å¯è§æ€§-1" class="headerlink" title="å¯è§æ€§"></a>å¯è§æ€§</h5><p>å¯è§æ€§è¡¨ç¤ºä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†ä¸€ä¸ªå…±äº«å˜é‡çš„å€¼ï¼Œå…¶å®ƒçº¿ç¨‹éƒ½èƒ½å¤ŸçŸ¥é“è¿™ä¸ªä¿®æ”¹ã€‚<code>CPUç¼“å­˜ä¼˜åŒ–</code>ã€<code>æŒ‡ä»¤é‡æ’</code>ç­‰éƒ½å¯èƒ½å¯¼è‡´å…±äº«å˜é‡ä¿®ä¸èƒ½ç«‹åˆ»è¢«å…¶ä»–çº¿ç¨‹å¯Ÿè§‰ã€‚</p><p><code>synchroniezd</code>é€šè¿‡æ“ä½œç³»ç»Ÿå†…æ ¸äº’æ–¥é”å®ç°å¯è§æ€§ï¼Œçº¿ç¨‹é‡Šæ”¾é”å‰å¿…é¡»æŠŠå…±äº«å˜é‡çš„æœ€æ–°å€¼åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ï¼Œçº¿ç¨‹è·å–é”ä¹‹å‰ä¼šå°†å·¥ä½œå†…å­˜ä¸­å…±äº«å€¼æ¸…ç©ºï¼Œä»ä¸»å†…å­˜ä¸­è·å–æœ€æ–°çš„å€¼ã€‚</p><h5 id="æœ‰åºæ€§-1"><a href="#æœ‰åºæ€§-1" class="headerlink" title="æœ‰åºæ€§"></a>æœ‰åºæ€§</h5><p>ç¨‹åºåœ¨æ‰§è¡Œæ—¶ï¼Œæœ‰å¯èƒ½ä¼šè¿›è¡ŒæŒ‡ä»¤é‡æ’ï¼ŒCPUæ‰§è¡ŒæŒ‡ä»¤é¡ºåºä¸ä¸€å®šå’Œç¨‹åºçš„é¡ºåºä¸€è‡´ã€‚æŒ‡å®šé‡æ’ä¿è¯<code>ä¸²è¡Œè¯­ä¹‰ä¸€è‡´</code>ï¼ˆå³é‡æ’åCPUæ‰§è¡Œçš„æ‰§è¡Œå’Œç¨‹åºçœŸæ­£æ‰§è¡Œé¡ºåºä¸€è‡´ï¼‰ã€‚<code>synchronized</code>èƒ½ä¿è¯CPUæ‰§è¡ŒæŒ‡ä»¤é¡ºåºå’Œç¨‹åºçš„é¡ºåºä¸€è‡´ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LazySingleton</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å•ä¾‹å¯¹è±¡</span></span><br><span class="line"><span class="comment">     * volatile + åŒé‡æ£€æµ‹æœºåˆ¶ -&gt; ç¦æ­¢é‡æ’åº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> <span class="type">LazySingleton</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *   instance = new LazySingleton();</span></span><br><span class="line"><span class="comment">     *   1. åˆ†é…å¯¹è±¡å†…å­˜ç©ºé—´</span></span><br><span class="line"><span class="comment">     *   2. åˆå§‹åŒ–å¯¹è±¡</span></span><br><span class="line"><span class="comment">     *   3. è®¾ç½®instanceæŒ‡å‘åˆšåˆ†é…çš„å†…å­˜</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *   JVMå’ŒCPUä¼˜åŒ–, å‘ç”Ÿäº†æŒ‡ä»¤é‡æ’, 1-3-2, çº¿ç¨‹Aæ‰§è¡Œå®Œ3, çº¿ç¨‹Bæ‰§è¡Œç¬¬ä¸€ä¸ªåˆ¤æ–­, ç›´æ¥è¿”å›, è¿™ä¸ªæ—¶å€™æ˜¯ * æœ‰é—®é¢˜çš„ã€‚</span></span><br><span class="line"><span class="comment">     *   é€šè¿‡volatileå…³é”®å­—ç¦æ­¢é‡æ’åº</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> LazySingleton <span class="title function_">getInstance</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == instance) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (LazySingleton.class)&#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == instance) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">LazySingleton</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>synchronized</code>çš„æœ‰åºæ€§æ˜¯ä¿è¯çº¿ç¨‹æœ‰åºçš„æ‰§è¡Œï¼Œä¸æ˜¯é˜²æ­¢æŒ‡ä»¤é‡æ’åºã€‚ä¸Šé¢ä»£ç å¦‚æœä¸åŠ <code>volatile</code>å…³é”®å­—å¯èƒ½å¯¼è‡´çš„ç»“æœï¼Œå°±æ˜¯ç¬¬ä¸€ä¸ªçº¿ç¨‹åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œè®¾ç½®instanceæ‰§è¡Œåˆ†é…çš„å†…å­˜æ—¶ï¼Œè¿™ä¸ªæ—¶å€™ç¬¬äºŒä¸ªçº¿ç¨‹è¿›æ¥äº†ï¼Œæœ‰æŒ‡ä»¤é‡æ’ï¼Œåœ¨ç¬¬ä¸€ä¸ªåˆ¤æ–­çš„æ—¶å€™ç›´æ¥è¿”å›ï¼Œå°±å‡ºé”™äº†è¿™ä¸ªæ—¶å€™instanceå¯èƒ½è¿˜æ²¡åˆå§‹åŒ–æˆåŠŸã€‚</p><h5 id="é‡å…¥æ€§"><a href="#é‡å…¥æ€§" class="headerlink" title="é‡å…¥æ€§"></a>é‡å…¥æ€§</h5><p><code>synchronized</code>æ˜¯å¯é‡å…¥é”ï¼Œå…è®¸ä¸€ä¸ªçº¿ç¨‹äºŒæ¬¡è¯·æ±‚è‡ªå·±æŒæœ‰å¯¹è±¡é”çš„ä¸´ç•Œèµ„æºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SynchronizedTest03</span> <span class="keyword">extends</span> <span class="title class_">A</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">SynchronizedTest03</span> <span class="variable">synchronizedTest03</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SynchronizedTest03</span>();</span><br><span class="line">        synchronizedTest03.doA();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">doA</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å­ç±»æ–¹æ³•ï¼šSynchronizedTest03.doA() ThreadId:&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">        doB();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">doB</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å­ç±»æ–¹æ³•ï¼šSynchronizedTest03.doB() ThreadId:&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">        <span class="built_in">super</span>.doA();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span>  <span class="keyword">void</span> <span class="title function_">doA</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;çˆ¶ç±»æ–¹æ³•ï¼šA.doA() ThreadId:&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç æ­£å¸¸è¾“å…¥å¦‚ä¸‹ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å­ç±»æ–¹æ³•ï¼šSynchronizedTest03.doA() ThreadId:1</span><br><span class="line">å­ç±»æ–¹æ³•ï¼šSynchronizedTest03.doB() ThreadId:1</span><br><span class="line">çˆ¶ç±»æ–¹æ³•ï¼šA.doA() ThreadId:1</span><br></pre></td></tr></table></figure><p>æœ€åæ­£å¸¸çš„è¾“å‡ºäº†ç»“æœï¼Œå¹¶æ²¡æœ‰å‘ç”Ÿæ­»é”ï¼Œè¯´æ˜<code>synchronized</code>æ˜¯å¯é‡å…¥é”ã€‚</p><p><code>synchronized</code>é”å¯¹è±¡çš„æ—¶å€™æœ‰ä¸ªè®¡æ•°å™¨ï¼Œè®°å½•çº¿ç¨‹è·å–é”çš„æ¬¡æ•°ï¼Œåœ¨æ‰§è¡Œå®Œå¯¹åº”çš„ä»£ç åè®¡æ•°å™¨å°±ä¼š-1ï¼ŒçŸ¥é“è®¡æ•°å™¨æ¸…0é‡Šæ”¾é”ã€‚</p><h4 id="ç±»å‹å’Œå‡çº§"><a href="#ç±»å‹å’Œå‡çº§" class="headerlink" title="ç±»å‹å’Œå‡çº§"></a>ç±»å‹å’Œå‡çº§</h4><p>åœ¨ä»‹ç»é”çš„ç±»å‹ä¹‹å‰å…ˆè¯´ä¸€ä¸‹ä»€ä¹ˆæ˜¯<code>markword</code>ï¼Œ<code>markword</code>æ˜¯javaå¯¹è±¡æ•°æ®ç»“æ„ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œ<code>markword</code>æ•°æ®åœ¨é•¿åº¦ä¸º32ä½å’Œ64ä½è™šæ‹Ÿæœºï¼ˆæœªå¼€å¯å‹ç¼©æŒ‡é’ˆï¼‰ä¸­åˆ†åˆ«æ˜¯32bitå’Œ64bitï¼Œå®ƒçš„æœ€åä¸¤ä½bitæ˜¯é”çŠ¶æ€æ ‡å¿—ä½ï¼Œç”¨æ¥æ ‡è®°å½“å‰å¯¹è±¡çš„çŠ¶æ€ï¼Œå¦‚ä¸‹è¡¨ç¤ºï¼š</p><table><thead><tr><th align="center">çŠ¶æ€</th><th align="center">æ ‡å¿—ä½</th><th align="center">å‚¨å­˜å†…å®¹</th></tr></thead><tbody><tr><td align="center">æ— é”ï¼ˆæœªå¼€å¯åå‘é”ï¼‰</td><td align="center">01</td><td align="center">å¯¹è±¡å“ˆå¸Œç ã€å¯¹è±¡åˆ†ä»£å¹´é¾„</td></tr><tr><td align="center">åå‘é”ï¼ˆå¼€å¯åå‘é”ï¼‰</td><td align="center">01</td><td align="center">åå‘çº¿ç¨‹idã€åå‘æ—¶é—´æˆ³ã€å¯¹è±¡åˆ†ä»£å¹´é¾„</td></tr><tr><td align="center">è½»é‡çº§é”</td><td align="center">00</td><td align="center">æŒ‡å‘è½»é‡çº§é”æŒ‡é’ˆ</td></tr><tr><td align="center">é‡é‡çº§é”</td><td align="center">10</td><td align="center">æŒ‡å‘é‡é‡çº§é”æŒ‡é’ˆ</td></tr><tr><td align="center">GCæ ‡è®°</td><td align="center">11</td><td align="center">ç©º</td></tr></tbody></table><h5 id="åå‘é”"><a href="#åå‘é”" class="headerlink" title="åå‘é”"></a>åå‘é”</h5><p>åå‘é”ä¼šåå‘äºç¬¬ä¸€ä¸ªè®¿é—®é”çš„çº¿ç¨‹ï¼Œå¦‚æœåœ¨è¿è¡Œè¿‡ç¨‹ä¸­åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®ä¸å­˜åœ¨å¤šä¸ªçº¿ç¨‹äº‰ç”¨çš„æƒ…å†µä¸‹ï¼Œåˆ™çº¿ç¨‹æ˜¯ä¸éœ€è¦è§¦å‘åŒæ­¥çš„ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šç»™çº¿ç¨‹åŠ ä¸€ä¸ªåå‘é”ã€‚å¦‚æœåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œé‡åˆ°äº†å…¶ä»–çº¿ç¨‹æŠ¢å é”ï¼Œåˆ™æŒæœ‰åå‘é”çš„çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼ŒJVMä¼šæ¶ˆé™¤å®ƒèº«ä¸Šçš„åå‘é”ï¼Œå°†é”å‡çº§è‡³è½»é‡çº§é”ã€‚</p><p><code>UseBiasedLocking</code> æ˜¯ä¸€ä¸ªåå‘é”æ£€æŸ¥ï¼Œ 1.6 ä¹‹åæ˜¯é»˜è®¤å¼€å¯çš„ï¼Œ 1.5 ä¸­æ˜¯å…³é—­çš„ï¼Œéœ€è¦æ‰‹åŠ¨å¼€å¯å‚æ•°æ˜¯ <code>XX: UseBiasedLocking=false</code>ã€‚</p><p>åå‘é”è·å–è¿‡ç¨‹ï¼š</p><ol><li>è®¿é—®markwordä¸­åå‘é”è¡¨ç¤ºæ˜¯å¦ä¸º1ï¼Œé”æ ‡å¿—ä½01ï¼Œç¡®è®¤ä¸ºåå‘é”çŠ¶æ€ã€‚</li><li>åˆ¤æ–­markwordä¸­çº¿ç¨‹idæ˜¯å¦æŒ‡å‘å½“å‰çº¿ç¨‹idï¼Œå¦‚æœæ˜¯åˆ™æ‰§è¡Œæ­¥éª¤5ï¼Œå¦‚æœä¸æ˜¯åˆ™æ‰§è¡Œæ­¥éª¤3</li><li>å¦‚æœmarkwordä¸­çº¿ç¨‹idæœªæŒ‡å‘å½“å‰çº¿ç¨‹idï¼Œåˆ™é€šè¿‡CASæ“ä½œç«äº‰é”ã€‚å¦‚æœç«äº‰æˆåŠŸï¼Œåˆ™æŒ‡å‘å½“å‰çº¿ç¨‹idï¼Œæ‰§è¡Œæ­¥éª¤5ï¼Œå¦‚æœç«äº‰å¤±è´¥ï¼Œåˆ™æ‰§è¡Œæ­¥éª¤4ã€‚</li><li>å¦‚æœCASç«äº‰é”å¤±è´¥è¡¨ç¤ºæœ‰ç«äº‰ï¼Œå½“åˆ°è¾¾å…¨å±€å®‰å…¨ç‚¹ï¼ˆsafepointï¼‰æ—¶è·å¾—åå‘é”çš„çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œåå‘é”å‡çº§ä¸ºè½»é‡çº§é”å¹¶æ’¤é”€åå‘é”ï¼ˆæ’¤é”€åå‘é”æ˜¯ä¼šå¯¼è‡´stop the wordï¼Œé™¤GCæ‰€éœ€çš„çº¿ç¨‹å¤–ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°GCä»»åŠ¡å®Œæˆï¼‰ï¼Œç„¶åè¢«é˜»å¡åœ¨å®‰å…¨ç‚¹çš„çº¿ç¨‹ä¼šç»§ç»­æ‰§è¡ŒåŒæ­¥ä»£ç ã€‚</li><li>æ‰§è¡ŒåŒæ­¥ä»£ç ã€‚</li></ol><h5 id="è½»é‡çº§é”"><a href="#è½»é‡çº§é”" class="headerlink" title="è½»é‡çº§é”"></a>è½»é‡çº§é”</h5><p>å½“é”æ˜¯åå‘é”çš„æ—¶å€™ï¼Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å‘ç°æœ‰å…¶ä»–çº¿ç¨‹æŠ¢å é”ï¼Œåå‘é”å°±ä¼šå‡çº§æˆè½»é‡çº§é”ï¼Œå…¶ä»–çº¿ç¨‹ä¼šé€šè¿‡è‡ªæ—‹çš„å½¢å¼è·å–é”ï¼Œä¸ä¼šé˜»å¡ï¼Œæé«˜æ€§èƒ½ï¼Œç¼ºç‚¹æ˜¯å¾ªç¯ä¼šæ¶ˆè€—CPUã€‚</p><p>è½»é‡çº§é”åŠ é”è¿‡ç¨‹ï¼š</p><ol><li>åœ¨ä»£ç è¿›å…¥åŒæ­¥å—çš„æ—¶å€™ï¼Œå¦‚æœåŒæ­¥å¯¹è±¡é”çŠ¶æ€ä¸ºæ— é”çŠ¶æ€ï¼ˆé”çŠ¶æ€æ ‡å¿—ä½ä¸º01çŠ¶æ€ï¼Œæ˜¯å¦ä¸ºåå‘é”ä¸º0ï¼‰ï¼Œè™šæ‹Ÿæœºé¦–å…ˆå°†åœ¨å½“å‰çº¿ç¨‹çš„å¸§æ ˆä¸­å»ºç«‹ä¸€ä¸ªåä¸ºç´¢è®°å½•ï¼ˆLock Recordï¼‰çš„ç©ºé—´ï¼Œç”¨äºå‚¨å­˜é”å¯¹è±¡ç›®å‰çš„markwordçš„æ‹·è´ï¼Œå®˜æ–¹ç§°ä¹‹ä¸º <code>Displaced Mark Word</code>ã€‚</li><li>æ‹·è´å¯¹è±¡çš„markwordåˆ°é”è®°å½•ä¸­ã€‚</li><li>æ‹·è´æˆåŠŸåï¼Œè™šæ‹Ÿæœºå°†ä½¿ç”¨CASæ“ä½œå°è¯•å°†å¯¹è±¡çš„markwordæ›´æ–°æŒ‡å‘é”è®°å½•çš„æŒ‡é’ˆï¼Œå¹¶å°†é”è®°å½•é‡Œçš„owneræŒ‡å‘å¯¹è±¡çš„markwordï¼Œå¦‚æœæ›´æ–°æˆåŠŸåˆ™æ‰§è¡Œæ­¥éª¤4ï¼Œå¦åˆ™æ‰§è¡Œæ­¥éª¤5ã€‚</li><li>æ›´æ–°æˆåŠŸè¡¨ç¤ºè¿™ä¸ªçº¿ç¨‹å°±è·å–åˆ°äº†é”çš„å¯¹è±¡ï¼Œå¹¶ä¸”å¯¹è±¡çš„markwordé”æ ‡å¿—ä½è®¾ç½®æˆ00ï¼Œè¡¨ç¤ºæ­¤å¯¹è±¡å¤„äºè½»é‡çº§é” çŠ¶æ€ã€‚</li><li>å¦‚æœæ›´æ–°å¤±è´¥äº†ï¼Œè¯´æ˜è™šæ‹Ÿæœºé¦–å…ˆä¼šæ£€æŸ¥å¯¹è±¡çš„markwordæ˜¯å¦æŒ‡å‘å½“å‰çº¿ç¨‹çš„æ ˆå¸§ï¼Œå¦‚æœæ˜¯è¯´æ˜å½“å‰çº¿ç¨‹å·²ç»è·å–åˆ°äº†è¿™ä¸ªå¯¹è±¡çš„é”ã€‚å¦‚æœä¸æ˜¯åˆ™è¯´æ˜å¤šä¸ªçº¿ç¨‹ç«äº‰é”ï¼Œè½»é‡çº§é”å°±ä¼šå‡çº§æˆé‡é‡çº§é”ï¼Œé”æ ‡å¿—çš„çŠ¶æ€å€¼å˜ä¸º10ï¼Œmarkwordä¸­å‚¨å­˜çš„å°±æ˜¯æŒ‡å‘é‡é‡çº§é”çš„æŒ‡é’ˆï¼Œåé¢ç­‰å¾…é”çš„çº¿ç¨‹ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ã€‚</li></ol><h5 id="é‡é‡çº§é”"><a href="#é‡é‡çº§é”" class="headerlink" title="é‡é‡çº§é”"></a>é‡é‡çº§é”</h5><p>å½“åå‘é”å‡çº§æˆè½»é‡çº§é”æ—¶ï¼Œå…¶ä»–çº¿ç¨‹ä¼šé€šè¿‡è‡ªæ—‹çš„æ–¹å¼è·å–é”ï¼Œä¸ä¼šé˜»å¡ï¼Œå¦‚æœè‡ªæ—‹næ¬¡éƒ½å¤±è´¥äº†ï¼Œè¿™ä¸ªæ—¶å€™è½»é‡çº§é”å°±ä¼šå‡çº§æˆé‡é‡çº§é”ã€‚</p><h5 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><p><img src="https://qtspace.cn/contentimg/19.jpg"></p><p>synchronizedçš„æ‰§è¡Œè¿‡ç¨‹ï¼š</p><ol><li>æ£€æŸ¥markwordé‡Œé¢å­˜å‚¨çš„æ˜¯ä¸æ˜¯å½“å‰çº¿ç¨‹çš„idï¼Œå¦‚æœæ˜¯åˆ™è¡¨ç¤ºå½“å‰çº¿ç¨‹å¤„äºåå‘é”ã€‚</li><li>å¦‚æœä¸æ˜¯ï¼Œåˆ™å°è¯•ä½¿ç”¨CASå°†å½“å‰çº¿ç¨‹çš„idæ›¿æ¢markwordï¼Œå¦‚æœæˆåŠŸåˆ™è¡¨ç¤ºå½“å‰çº¿ç¨‹è·å–é”ï¼Œåå‘æ ‡å¿—ä½ç½®ä¸º1ã€‚</li><li>å¦‚æœCASå¤±è´¥åˆ™è¯´æ˜å‘ç”Ÿç«äº‰ï¼Œæ’¤é”€åå‘é”ï¼Œè¿›è€Œå‡çº§æˆè½»é‡çº§é”ï¼Œé”æ ‡å¿—ç½®ä¸º00ã€‚</li><li>å½“å‰çº¿ç¨‹ä½¿ç”¨CASå°†å¯¹è±¡çš„markwordæ›¿æ¢æˆé”è®°å½•æŒ‡é’ˆï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™å½“å‰çº¿ç¨‹è·å–é”ã€‚</li><li>å¦‚æœæ›¿æ¢å¤±è´¥ï¼Œè¡¨ç¤ºå…¶ä»–çº¿ç¨‹ç«äº‰é”ï¼Œå½“å‰çº¿ç¨‹éå°è¯•ä½¿ç”¨è‡ªé€‰é”çš„æ–¹å¼æ¥è·å–é”ã€‚</li><li>å¦‚æœè‡ªæ—‹æˆåŠŸè·å–é”åˆ™ä¾å¤„äºè½»é‡çº§é”ã€‚</li><li>å¦‚æœè‡ªæ—‹å¤±è´¥ï¼Œåˆ™å‡çº§æˆé‡é‡çº§é”ï¼Œé”æ ‡å¿—ç½®ä¸º10ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> volatile </tag>
            
            <tag> synchronized </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JVM-GCåƒåœ¾å›æ”¶</title>
      <link href="/2022/03/22/jvm-gc/"/>
      <url>/2022/03/22/jvm-gc/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><p>å­¦ä¹ JVMåƒåœ¾å›æ”¶æœºåˆ¶ä¸»è¦å­¦ä¹ ä»¥ä¸‹å‡ ç‚¹ï¼š<strong>å“ªäº›å†…å­˜éœ€è¦å›æ”¶ï¼ˆåˆ¤æ–­å¯¹è±¡å¯ä»¥å›æ”¶ï¼‰ã€ä»€ä¹ˆæ—¶å€™å›æ”¶(GCä»€ä¹ˆæ—¶å€™æ‰§è¡Œ)ã€æ€ä¹ˆå›æ”¶ï¼ˆåƒåœ¾å›æ”¶ç®—æ³•ã€åƒåœ¾å›æ”¶å™¨ï¼‰ã€åƒåœ¾å›æ”¶è¿‡ç¨‹</strong>ã€‚</p><h3 id="JVM-GCå›æ”¶å“ªäº›åŒºåŸŸå†…çš„åƒåœ¾ï¼Ÿ"><a href="#JVM-GCå›æ”¶å“ªäº›åŒºåŸŸå†…çš„åƒåœ¾ï¼Ÿ" class="headerlink" title="JVM GCå›æ”¶å“ªäº›åŒºåŸŸå†…çš„åƒåœ¾ï¼Ÿ"></a>JVM GCå›æ”¶å“ªäº›åŒºåŸŸå†…çš„åƒåœ¾ï¼Ÿ</h3><p>JVM GCåªå›æ”¶<strong>å †åŒºå’Œæ–¹æ³•åŒº</strong>å†…çš„å¯¹è±¡ï¼Œä¸å›æ”¶è™šæ‹Ÿæœºæ ˆå†…çš„æ•°æ®ï¼Œæ ˆå†…æ•°æ®åœ¨è¶…å‡ºä½œç”¨åŸŸåä¼šè¢«JVMè‡ªåŠ¨é‡Šæ”¾æ‰ã€‚</p><p>å› ä¸ºJVM GCå›æ”¶å †åŒºçš„å¯¹è±¡ï¼Œæ‰€ä»¥å…ˆäº†è§£å­¦ä¹ ä¸€ä¸‹å †å†…å­˜çš„ç»“æ„å›¾ï¼š</p><p>å †å†…å­˜åˆ†ä¸º<strong>å¹´è½»ä»£ï¼ˆYoung Generationï¼‰</strong>ã€<strong>è€å¹´ä»£ï¼ˆOld Generationï¼‰</strong>ï¼Œå¹´è½»ä»£å’Œè€å¹´ä»£æ‰€å ç©ºé—´æ¯”ä¾‹é»˜è®¤æ˜¯<strong>1:2</strong>ã€‚å¹´è½»ä»£åˆåˆ†ä¸º<strong>Eden</strong>å’Œ<strong>Survivor</strong>åŒºï¼Œ<strong>Survivor</strong>åŒºç”±<strong>FormSpace</strong>å’Œ<strong>ToSpace</strong>ç»„æˆã€‚EdenåŒºå å¤§å®¹é‡ï¼ŒSurvivorä¸¤ä¸ªåŒºå å°å®¹é‡ï¼Œé»˜è®¤æ¯”ä¾‹æ˜¯<strong>8:1:1</strong>ã€‚Fromå’ŒToä¸»è¦æ˜¯ä¸ºäº†è§£å†³å†…å­˜ç¢ç‰‡åŒ–ã€‚</p><h3 id="JVM-GCæ€ä¹ˆåˆ¤æ–­å¯¹è±¡å¯ä»¥å›æ”¶ï¼Ÿ"><a href="#JVM-GCæ€ä¹ˆåˆ¤æ–­å¯¹è±¡å¯ä»¥å›æ”¶ï¼Ÿ" class="headerlink" title="JVM GCæ€ä¹ˆåˆ¤æ–­å¯¹è±¡å¯ä»¥å›æ”¶ï¼Ÿ"></a>JVM GCæ€ä¹ˆåˆ¤æ–­å¯¹è±¡å¯ä»¥å›æ”¶ï¼Ÿ</h3><ul><li>å¯¹è±¡æ²¡æœ‰å¼•ç”¨ã€‚</li><li>ä½œç”¨åŸŸå‘ç”Ÿæœªæ•è·å¼‚å¸¸ã€‚</li><li>ç¨‹åºåœ¨ä½œç”¨åŸŸæ­£å¸¸æ‰§è¡Œå®Œæ¯•ã€‚</li><li>ç¨‹åºæ‰§è¡Œäº†<code>System.exit()</code>ã€‚</li><li>ç¨‹åºå‘ç”Ÿæ„å¤–ç»ˆæ­¢ï¼ˆè¢«æ€è¿›ç¨‹ç­‰ï¼‰ã€‚</li></ul><p>åˆ¤æ–­å¯¹è±¡æ˜¯å¦å¯ä»¥å›æ”¶æ¶‰åŠåˆ°åƒåœ¾å›æ”¶ç®—æ³•ï¼Œåé¢æˆ‘ä»¬ä¼šè¯¦æƒ…è¯´æ˜ã€‚</p><p>æœ‰äº›æ—¶å€™æˆ‘ä»¬å¯ä»¥æŠŠç›¸å…³çš„å¯¹è±¡è®¾ç½®æˆnullæ¥è¯•å›¾æ˜¾ç¤ºçš„æ¸…é™¤ç¼“å­˜ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯è®¾ç½®nullå°±ä¸€å®šè¢«æ ‡è®°æˆå¯ä»¥å›æ”¶ï¼Œæ¯”å¦‚ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">testGC</span><span class="params">()</span> &#123; </span><br><span class="line">    <span class="type">ReferenceCountingGC</span> <span class="variable">objA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceCountingGC</span>(); </span><br><span class="line">    <span class="type">ReferenceCountingGC</span> <span class="variable">objB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceCountingGC</span>(); </span><br><span class="line">    objA.instance = objB; </span><br><span class="line">    objB.instance = objA; </span><br><span class="line">    objA = <span class="literal">null</span>; </span><br><span class="line">    objB = <span class="literal">null</span>; </span><br><span class="line">    <span class="comment">// å‡è®¾åœ¨è¿™è¡Œå‘ç”ŸGCï¼Œ objAå’ŒobjBæ˜¯å¦èƒ½è¢«å›æ”¶ï¼Ÿ </span></span><br><span class="line">    System.gc(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŠŠ<code>objA</code>å’Œ<code>objB</code>è®¾ç½®nullä¸ä¼šè¢«æ ‡è®°æˆå¯ä»¥å›æ”¶å› ä¸º<code>objA</code>å’Œ<code>objB</code>å¾ªç¯ä¾èµ–å¼•ç”¨å…³ç³»ï¼Œä½†æ˜¯<code>System.gc();</code>ä¼šæ‰§è¡Œ<code>Full GC</code>å›æ”¶ã€‚</p><p>å°†å¯¹è±¡è®¾ç½®nullè‡³å°‘æ²¡æœ‰ä»€ä¹ˆåå¤„ï¼Œä½†æ˜¯<code>System.gc();</code>ä¾¿ä¸å¯å–äº†ï¼Œå› ä¸ºä½¿ç”¨<code>System.gc();</code>çš„æ—¶å€™å¹¶ä¸æ˜¯é©¬ä¸Šæ‰§è¡ŒGCæ“ä½œï¼Œè€Œæ˜¯ä¼šç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œç”šè‡³ä¸ä¼šæ‰§è¡Œï¼Œå¦‚æœè¢«æ‰§è¡Œä¼šè§¦å‘<code>Full GC</code>æ˜¯éå¸¸å½±å“æ€§èƒ½çš„ã€‚</p><h3 id="JVM-GCä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Ÿ"><a href="#JVM-GCä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Ÿ" class="headerlink" title="JVM GCä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Ÿ"></a>JVM GCä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Ÿ</h3><p>EdenåŒºç©ºé—´ä¸å¤Ÿå‚¨å­˜å¯¹è±¡çš„æ—¶å€™ä¼šæ‰§è¡Œ<code>Minro GC</code>ã€‚å‡åˆ°è€å¹´ä»£çš„å¯¹è±¡å¤§äºè€å¹´ä»£å‰©ä½™çš„ç©ºé—´æ—¶æ‰§è¡Œ<code>Full GC</code>,æˆ–è€…å°äºçš„æ—¶å€™è¢«<code>HandlePromotionFailure</code>å‚æ•°å¼ºåˆ¶<code>Full GC</code>ã€‚JVM GCè°ƒä¼˜ä¸»è¦æ˜¯å‡å°‘<code>Full GC</code>çš„è§¦å‘æ¬¡æ•°ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®å‚æ•°<code>NewRatio</code>æ§åˆ¶å¹´è½»ä»£å’Œè€å¹´ä»£æ‰€å å†…å­˜æ¯”ä¾‹ï¼Œé€šè¿‡è®¾ç½®å‚æ•°<code>MaxTenuringThreshold</code>æ”¹å˜å¯¹è±¡è¿›å…¥è€å¹´ä»£çš„é˜™å€¼ã€‚<code>Full GC</code>éå¸¸æŸè€—æ€§èƒ½ï¼Œæ‰§è¡Œæ—¶é—´å¤§æ¦‚æ˜¯<code>Minro GC</code>çš„10å€ã€‚</p><h3 id="JVM-GCæŒ‰ä»£çš„åƒåœ¾å›æ”¶æœºåˆ¶"><a href="#JVM-GCæŒ‰ä»£çš„åƒåœ¾å›æ”¶æœºåˆ¶" class="headerlink" title="JVM GCæŒ‰ä»£çš„åƒåœ¾å›æ”¶æœºåˆ¶"></a>JVM GCæŒ‰ä»£çš„åƒåœ¾å›æ”¶æœºåˆ¶</h3><p><strong>å¹´è½»ä»£ï¼š</strong>ç»å¤§å¤šæ•°æ–°åˆ›å»ºçš„å¯¹è±¡éƒ½æ˜¯è¢«åˆ†é…åœ¨å¹´è½»ä»£ï¼ˆå¯¹è±¡å¾ˆå¤§çš„è¯å¯èƒ½è¢«åˆ†é…åœ¨è€å¹´ä»£ï¼‰ï¼Œå¹´è½»ä»£è§¦å‘GCå¯¹è±¡è¢«å›æ”¶çš„è¿‡ç¨‹ç§°ä¹‹ä¸º<code>Minor GC</code>ã€‚</p><p><strong>è€å¹´ä»£ï¼š</strong>å¯¹è±¡åœ¨å¹´è½»ä»£å‘¨æœŸå­˜æ´»äº†ä¸‹æ¥ï¼Œä¼šè¢«æ‹·è´åˆ°è€å¹´ä»£ï¼Œè€å¹´ä»£è§¦å‘GCå¯¹è±¡è¢«å›æ”¶çš„è¿‡ç¨‹ç§°ä¹‹ä¸º<code>Full GC</code>ã€‚</p><p><strong>æŒä¹…ä»£ï¼š</strong>ä¹Ÿè¢«å«åšæ–¹æ³•åŒºï¼Œç”¨äºä¿å­˜ç±»åŠ è½½ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ç­‰ï¼Œæ–¹æ³•åŒºä¸æ˜¯ç”¨äºå‚¨å­˜è€å¹´ä»£å­˜æ´»ä¸‹æ¥çš„å¯¹è±¡ï¼Œè¿™ä¸ªåŒºåŸŸä¹Ÿå¯èƒ½å‘ç”ŸGCï¼Œæ–¹æ³•å‘ç”ŸGCçš„è¿‡ç¨‹è¢«ç§°ä¸º<code>Major GC</code>ï¼Œæ–¹æ³•åŒºå‘ç”ŸGCçš„æ¡ä»¶éå¸¸è‹›åˆ»ï¼Œå¿…é¡»æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶æ‰ä¼šå›æ”¶ï¼š</p><ul><li>æ‰€æœ‰å®ä¾‹è¢«å›æ”¶ã€‚</li><li>åŠ è½½è¯¥ç±»çš„ClassLoaderè¢«å›æ”¶ã€‚</li><li>Classå¯¹è±¡æ— æ³•é€šè¿‡ä»»åŠ¡é€”å¾„è®¿é—®ï¼ˆåŒ…å«åå°„ï¼‰ã€‚</li></ul><h3 id="è€å¹´ä»£å¦‚ä½•è§£å†³å¼•ç”¨å¹´è½»ä»£å¯¹è±¡é—®é¢˜ï¼Ÿ"><a href="#è€å¹´ä»£å¦‚ä½•è§£å†³å¼•ç”¨å¹´è½»ä»£å¯¹è±¡é—®é¢˜ï¼Ÿ" class="headerlink" title="è€å¹´ä»£å¦‚ä½•è§£å†³å¼•ç”¨å¹´è½»ä»£å¯¹è±¡é—®é¢˜ï¼Ÿ"></a>è€å¹´ä»£å¦‚ä½•è§£å†³å¼•ç”¨å¹´è½»ä»£å¯¹è±¡é—®é¢˜ï¼Ÿ</h3><p>è€å¹´ä»£ä¸­å­˜åœ¨ä¸€ä¸ª<code>card table</code>ï¼Œå¤§å°ä¸º512å­—èŠ‚ï¼Œç”¨äºå­˜æ”¾æ‰€æœ‰è€å¹´ä»£å¯¹è±¡æ‰§è¡Œå¹´è½»ä»£å¯¹è±¡çš„å¼•ç”¨ï¼Œå½“é’ˆå¯¹å¹´è½»ä»£æ‰§è¡ŒGCçš„æ—¶å€™ï¼Œåªéœ€æŸ¥è¯¢ä¸€ä¸‹<code>card table</code>æ¥å†³å®šæ˜¯å¦å›æ”¶ï¼Œè€Œä¸åŒæŸ¥è¯¢æ•´ä¸ªè€å¹´ä»£ã€‚</p><h3 id="åƒåœ¾å›æ”¶è¿‡ç¨‹"><a href="#åƒåœ¾å›æ”¶è¿‡ç¨‹" class="headerlink" title="åƒåœ¾å›æ”¶è¿‡ç¨‹"></a>åƒåœ¾å›æ”¶è¿‡ç¨‹</h3><ol><li>ç»å¤§æ•°åˆšåˆšæ–°å»ºçš„å¯¹è±¡éƒ½ä¼šå‚¨å­˜åœ¨å¹´è½»ä»£çš„EdenåŒºã€‚</li><li>å½“EdenåŒºç©ºé—´ä¸è¶³æ—¶å°±ä¼šæ‰§è¡ŒGCï¼Œåœ¨æ‰§è¡Œç¬¬ä¸€æ¬¡GCä¹‹åå­˜æ´»çš„å¯¹è±¡å°±ä¼šç§»åŠ¨åˆ°Survivorçš„FromåŒºã€‚</li><li>æ­¤åæ¯æ¬¡EdenåŒºæ‰§è¡ŒGCï¼Œå­˜æ´»çš„å¯¹è±¡éƒ½ä¼šè¢«å­˜æ”¾åœ¨FromåŒºã€‚</li><li>å½“FromåŒºç©ºé—´é¥±å’Œæ—¶ï¼Œåœ¨å­˜æ´»çš„å¯¹è±¡å°±ä¼šè¢«ç§»åŠ¨åˆ°toåŒºï¼Œç„¶åæ¸…ç©ºfromåŒºã€‚</li><li>åœ¨ä»¥ä¸Šæ­¥éª¤é‡å¤Næ¬¡ï¼ˆN&#x3D;MaxTenuringThreshold å¹´é¾„é˜™å€¼é»˜è®¤15ï¼‰ä¾ç„¶å­˜æ´»çš„å¯¹è±¡å°±ä¼šç§»åˆ°è€å¹´ä»£ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™è€å¹´ä»£æ²¡æœ‰ç©ºé—´äº†å°±ä¼šè§¦å‘<code>Full GC</code>ï¼Œå¦‚æœè§¦å‘ Full GCä¹‹åç©ºé—´è¿˜æ˜¯ä¸è¶³å°±ä¼šæŠ›å‡ºOOMå¼‚å¸¸ã€‚</li></ol><h3 id="JVM-GCæ ¸å¿ƒå‚æ•°"><a href="#JVM-GCæ ¸å¿ƒå‚æ•°" class="headerlink" title="JVM GCæ ¸å¿ƒå‚æ•°"></a>JVM GCæ ¸å¿ƒå‚æ•°</h3><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-XX:NewRatio </span><br><span class="line">â€“XX:SurvivorRatio </span><br><span class="line">â€“XX:NewSize </span><br><span class="line">â€“XX:MaxNewSize</span><br></pre></td></tr></table></figure><p><code>-XX:NewRatio</code>è¡¨ç¤ºå¹´è½»ä»£å’Œè€å¹´ä»£ç›¸å¯¹çš„æ¯”ä¾‹ï¼Œæ¯”å¦‚<code>-XX:NewRatio=2</code>è¡¨ç¤ºè€å¹´ä»£æ˜¯å¹´è½»ä»£çš„2è¢«ï¼Œè€å¹´ä»£å å †çš„2&#x2F;3ï¼Œå¹´è½»ä»£å 1&#x2F;3ã€‚</p><p><code>-XX:SurvivorRatio</code>è¡¨ç¤ºå¹´è½»ä»£é‡Œé¢EdenåŒºå’ŒSurvivoråŒºç›¸æ¯”æ¯”ä¾‹ï¼Œæ¯”å¦‚<code>-XX:SurvivorRatio=8</code>è¡¨ç¤º<code>Eden:From:To = 8:1:1</code>ã€‚SurvivorRatioä¸èƒ½è®¾ç½®è¿‡å¤§ä¹Ÿä¸èƒ½è®¾ç½®è¿‡å°ï¼Œä¸€èˆ¬é»˜è®¤å€¼å³å¯ã€‚</p><p><code>-XX:NewSize</code>è¡¨ç¤ºå¹´è½»ä»£çš„åˆå§‹åŒ–å¤§å°ã€‚</p><p><code>-XX:MaxNewSize</code>è¡¨ç¤ºå¹´è½»ä»£æœ€å¤§å¤§å°ã€‚</p><h3 id="JVM-GCç®—æ³•"><a href="#JVM-GCç®—æ³•" class="headerlink" title="JVM GCç®—æ³•"></a>JVM GCç®—æ³•</h3><h4 id="æ ¹æœç´¢ç®—æ³•"><a href="#æ ¹æœç´¢ç®—æ³•" class="headerlink" title="æ ¹æœç´¢ç®—æ³•"></a>æ ¹æœç´¢ç®—æ³•</h4><p>ç¨‹åºæŠŠæ‰€æœ‰å¼•ç”¨å…³ç³»çœ‹ä½œä¸€æ£µæ ‘ï¼Œä»ä¸€ä¸ªæ ¹èŠ‚ç‚¹GC ROOTå¼€å§‹å¯»æ‰¾å¯¹åº”çš„å¼•ç”¨èŠ‚ç‚¹ï¼Œæ‰¾åˆ°è¿™ä¸ªèŠ‚ç‚¹åç»§ç»­å¯»æ‰¾è¿™ä¸ªèŠ‚ç‚¹çš„å¼•ç”¨èŠ‚ç‚¹ï¼Œå½“æ‰€æœ‰èŠ‚ç‚¹å¯»æ‰¾å®Œæ¯•ä¹‹åï¼Œæ²¡æœ‰è¢«å¼•ç”¨çš„èŠ‚ç‚¹å°±æ˜¯æ— ç”¨çš„èŠ‚ç‚¹ã€‚</p><p><img src="https://qtspace.cn/contentimg/12.jpg"></p><p>ä¸Šå›¾çº¢è‰²å°±æ˜¯æ— ç”¨çš„èŠ‚ç‚¹ï¼Œå¯ä»¥è¢«å›æ”¶ã€‚</p><p>ç›®å‰Javaä¸­å¯ä»¥ä½œä¸ºGC ROOTçš„å¯¹è±¡æœ‰ï¼š</p><ul><li>è™šæ‹Ÿæœºæ ˆã€æœ¬åœ°æ–¹æ³•æ ˆä¸­å¼•ç”¨çš„å¯¹è±¡ï¼Œå¯¹è±¡åˆ†åˆ«æ˜¯æœ¬åœ°å˜é‡è¡¨ã€Nativeå¯¹è±¡ã€‚</li><li>æ–¹æ³•åŒºä¸­é™æ€å˜é‡ã€å¸¸é‡å¼•ç”¨çš„å¯¹è±¡ã€‚</li></ul><h4 id="æ ‡è®°-æ¸…é™¤ç®—æ³•"><a href="#æ ‡è®°-æ¸…é™¤ç®—æ³•" class="headerlink" title="æ ‡è®°-æ¸…é™¤ç®—æ³•"></a>æ ‡è®°-æ¸…é™¤ç®—æ³•</h4><p><img src="https://qtspace.cn/contentimg/13.jpg"></p><p>æ ‡è®°-æ¸…é™¤ç®—æ³•é‡‡ç”¨ä»æ ¹é›†åˆè¿›è¡Œæ‰«æï¼Œå¯¹å­˜æ´»çš„å¯¹è±¡è¿›è¡Œæ ‡è®°ï¼Œæ ‡è®°å®Œæ¯•ä¹‹åå†æ‰«ææ•´ä¸ªç©ºé—´ä¸­æœªè¢«æ ‡è®°çš„å¯¹è±¡è¿›è¡Œå›æ”¶ã€‚</p><p>æ ‡è®°-æ¸…é™¤ç®—æ³•ä¸éœ€è¦è¿›è¡Œå¯¹è±¡çš„ç§»åŠ¨ï¼Œå¹¶ä¸”ä»…å¯¹ä¸å­˜æ´»çš„å¯¹è±¡è¿›è¡Œå›æ”¶ï¼Œåœ¨å­˜æ´»çš„å¯¹è±¡æ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹æä¸ºé«˜æ•ˆï¼Œä½†æ˜¯ç”±äºæ ‡è®°-æ¸…é™¤ç®—æ³•ç›´æ¥å›æ”¶ä¸å­˜æ´»çš„å¯¹è±¡ï¼Œæ²¡æœ‰å¯¹è¿˜å­˜æ´»çš„å¯¹è±¡è¿›è¡Œæ•´ç†ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´å†…å­˜ç¢ç‰‡åŒ–ã€‚</p><h4 id="å¤åˆ¶ç®—æ³•"><a href="#å¤åˆ¶ç®—æ³•" class="headerlink" title="å¤åˆ¶ç®—æ³•"></a>å¤åˆ¶ç®—æ³•</h4><p><img src="https://qtspace.cn/contentimg/14.jpg"></p><p>å¤åˆ¶ç®—æ³•å°†å†…å­˜ç©ºé—´åˆ’åˆ†ä¸ºä¸¤ä¸ªåŒºé—´ï¼Œæ‰€æœ‰å¯¹è±¡éƒ½åªä¼šåˆ†é…åœ¨å…¶ä¸­ä¸€ä¸ªæ´»åŠ¨åŒºé—´ï¼Œè€Œå¦å¤–ä¸€ä¸ªåŒºé—´åˆ™æ˜¯ç©ºé—²çš„ã€‚</p><p>å¤åˆ¶ç®—æ³•é‡‡ç”¨ä»æ ¹é›†åˆæ‰«æï¼Œå°†å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°ç©ºé—²åŒºé—´ï¼Œå½“æ‰«æå®Œæ¯•ä¹‹åï¼Œä¼šå°†æ´»åŠ¨åŒºé—´ä¸€æ¬¡æ€§å›æ”¶ï¼Œ<strong>æ­¤æ—¶åŸæœ¬çš„ç©ºé—²åŒºé—´å˜æˆäº†æ´»åŠ¨åŒºé—´</strong>ï¼Œä¸‹æ¬¡GCçš„æ—¶å€™åˆé‡å¤æ­¤æ“ä½œã€‚å¤åˆ¶ç®—æ³•åœ¨å­˜æ´»å¯¹è±¡æ¯”è¾ƒå°‘çš„æ—¶å€™æä¸ºé«˜æ•ˆã€‚</p><h4 id="æ ‡è®°-æ•´ç†ç®—æ³•"><a href="#æ ‡è®°-æ•´ç†ç®—æ³•" class="headerlink" title="æ ‡è®°-æ•´ç†ç®—æ³•"></a>æ ‡è®°-æ•´ç†ç®—æ³•</h4><p><img src="https://qtspace.cn/contentimg/15.jpg"></p><p>æ ‡è®°-æ•´ç†ç®—æ³•é‡‡ç”¨æ ‡è®°-æ¸…é™¤ç®—æ³•ä¸€æ ·çš„æ–¹å¼è¿›è¡Œå¯¹è±¡çš„æ ‡è®°ã€å›æ”¶ï¼Œä½†æ˜¯åœ¨å›æ”¶ä¸å­˜æ´»å¯¹è±¡å ç”¨çš„ç©ºé—´åï¼Œä¼šå°†æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡å¾€å·¦ç§»åŠ¨ï¼Œå¹¶æ›´æ–°å¯¹åº”çš„æŒ‡é’ˆï¼Œè§£å†³äº†å†…å­˜ç¢ç‰‡çš„é—®é¢˜ã€‚</p><p>JVMä¸ºäº†ä¼˜åŒ–å†…å­˜çš„å›æ”¶ï¼Œä½¿ç”¨åˆ†ä»£å›æ”¶çš„æ–¹å¼ï¼Œå¹´è½»ä»£å†…å­˜å›æ”¶é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£å›æ”¶å¤§å¤šé‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ã€‚</p><h3 id="åƒåœ¾å›æ”¶å™¨"><a href="#åƒåœ¾å›æ”¶å™¨" class="headerlink" title="åƒåœ¾å›æ”¶å™¨"></a>åƒåœ¾å›æ”¶å™¨</h3><h4 id="å¹´è½»ä»£å›æ”¶å™¨"><a href="#å¹´è½»ä»£å›æ”¶å™¨" class="headerlink" title="å¹´è½»ä»£å›æ”¶å™¨"></a>å¹´è½»ä»£å›æ”¶å™¨</h4><p><strong>Serialï¼š</strong></p><ul><li>ç®—æ³•ï¼šå¤åˆ¶ç®—æ³•</li><li>è¯´æ˜ï¼šç®€å•é«˜æ•ˆçš„å•æ ¸æœºå™¨ï¼ŒClientæ¨¡å¼ä¸‹é»˜è®¤çš„å¹´è½»ä»£æ”¶é›†å™¨ã€‚</li></ul><p><strong>ParNew</strong></p><ul><li>ç®—æ³•ï¼šå¤åˆ¶ç®—æ³•</li><li>è¯´æ˜ï¼šSerialçš„å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼Œè¿è¡Œåœ¨Serveræ¨¡å¼ä¸‹çš„JVMé¦–é€‰çš„æ–°ç”Ÿä»£æ”¶é›†å™¨ã€‚</li></ul><p><strong>Parallel Scavenge</strong></p><ul><li>ç®—æ³•ï¼šå¤åˆ¶ç®—æ³•</li><li>è¯´æ˜ï¼šåˆè¢«ç§°ä¸ºååé‡ä¼˜å…ˆæ”¶é›†å™¨ï¼Œå’ŒParNew æ”¶é›†å™¨ç±»ä¼¼ï¼Œç›®æ ‡åœ¨äºè¾¾åˆ°å¯æ§åˆ¶ååé‡ã€‚</li></ul><h4 id="è€å¹´ä»£å›æ”¶å™¨"><a href="#è€å¹´ä»£å›æ”¶å™¨" class="headerlink" title="è€å¹´ä»£å›æ”¶å™¨"></a>è€å¹´ä»£å›æ”¶å™¨</h4><p><strong>Serial Old</strong></p><ul><li>ç®—æ³•ï¼šæ ‡è®°-æ•´ç†ç®—æ³•</li><li>è¯´æ˜ï¼šæ€§èƒ½ä¸€èˆ¬ï¼Œå•çº¿ç¨‹ç‰ˆæœ¬ï¼Œåœ¨JDK1.5åŠä¹‹å‰çš„ç‰ˆæœ¬ä¸­ä¸Parallel Scavengeæ”¶é›†å™¨æ­é…ä½¿ç”¨ï¼Œä½œä¸ºCMSæ”¶é›†å™¨çš„åå¤‡é¢„æ¡ˆã€‚</li></ul><p><strong>Parallel Old</strong></p><ul><li>ç®—æ³•ï¼šæ ‡è®°-æ•´ç†ç®—æ³•</li><li>è¯´æ˜ï¼šGCå¤šçº¿ç¨‹å¹¶è¡Œï¼Œä¸ºäº†æ›¿ä»£ Serial Old ä¸ Parallel Scavenge é…åˆä½¿ç”¨ã€‚</li></ul><p><strong>CMS</strong></p><ul><li>ç®—æ³•ï¼šæ ‡è®°-æ¸…é™¤ç®—æ³•</li><li>è¯´æ˜ï¼šå¯¹CPUèµ„æºæ•æ„Ÿï¼Œåœé¡¿æ—¶é—´é•¿ã€‚ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼Œå¯ä»¥é€šè¿‡å‚æ•°å¼€å¯ç¢ç‰‡çš„åˆå¹¶æ•´ç†ã€‚ åŸºæœ¬å·²è¢« G1 å–ä»£ã€‚</li></ul><h4 id="å¹´è½»ä»£ã€è€å¹´ä»£å…±ç”¨å›æ”¶å™¨"><a href="#å¹´è½»ä»£ã€è€å¹´ä»£å…±ç”¨å›æ”¶å™¨" class="headerlink" title="å¹´è½»ä»£ã€è€å¹´ä»£å…±ç”¨å›æ”¶å™¨"></a>å¹´è½»ä»£ã€è€å¹´ä»£å…±ç”¨å›æ”¶å™¨</h4><p><strong>G1</strong></p><ul><li>ç®—æ³•ï¼šæ ‡è®°-æ•´ç†ç®—æ³•</li><li>è¯´æ˜ï¼šæ–°çš„åƒåœ¾å›æ”¶å™¨ï¼Œæ—¢å¯ä»¥å›æ”¶æ–°ç”Ÿä»£ä¹Ÿå¯ä»¥å›æ”¶è€å¹´ä»£ï¼Œé€‚ç”¨äºå¤šæ ¸å¤§å†…å­˜æœºå™¨ã€GCå¤šçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œï¼Œåœé¡¿ä½ã€é«˜å›æ”¶ç‡ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> JVM </category>
          
      </categories>
      
      
        <tags>
            
            <tag> GCåƒåœ¾å›æ”¶æœºåˆ¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…­å¤§è®¾è®¡æ¨¡å¼åŸåˆ™-ä¾èµ–å€’ç½®åŸåˆ™</title>
      <link href="/2022/03/20/design-mode-di/"/>
      <url>/2022/03/20/design-mode-di/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h3 id="ä¸€ã€ä¾èµ–å€’ç½®åŸåˆ™å®šä¹‰"><a href="#ä¸€ã€ä¾èµ–å€’ç½®åŸåˆ™å®šä¹‰" class="headerlink" title="ä¸€ã€ä¾èµ–å€’ç½®åŸåˆ™å®šä¹‰"></a>ä¸€ã€ä¾èµ–å€’ç½®åŸåˆ™å®šä¹‰</h3><p>ä¾èµ–å€’ç½®åŸåˆ™ï¼š<strong>æŠ½è±¡ä¸åº”è¯¥ä¾èµ–äºå®ç°ï¼Œå®ç°åº”è¯¥ä¾èµ–äºæŠ½è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åº”è¯¥é¢å¯¹æŠ½è±¡(æ¥å£)ç¼–ç¨‹ï¼Œè€Œä¸åº”è¯¥é¢å¯¹å®ç°ç¼–ç¨‹ã€‚</strong></p><h3 id="äºŒã€ä¾èµ–å€’ç½®åŸåˆ™æè¿°"><a href="#äºŒã€ä¾èµ–å€’ç½®åŸåˆ™æè¿°" class="headerlink" title="äºŒã€ä¾èµ–å€’ç½®åŸåˆ™æè¿°"></a>äºŒã€ä¾èµ–å€’ç½®åŸåˆ™æè¿°</h3><p>ä¾èµ–å€’ç½®åŸåˆ™è¦æ±‚æˆ‘ä»¬åœ¨ç¨‹åºä»£ç ä¸­ä¼ é€’å‚æ•°æˆ–åœ¨å…³è”å…³ç³»æ—¶ï¼Œå°½é‡å¼•ç”¨é«˜å±‚æ¬¡ç±»æŠ½è±¡ç±»(æ¥å£ç±»)ï¼Œè€Œä¸åº”è¯¥å¼•ç”¨å…·ä½“çš„å®ç°ç±»ï¼Œå³ä½¿ç”¨æŠ½è±¡ç±»æˆ–è€…æ¥å£è¿›è¡Œå˜é‡ç±»å‹å£°æ˜ã€å‚æ•°ç±»å‹å£°æ˜ã€æ–¹æ³•è¿”å›ç»“æœå£°æ˜ã€‚</p><p>åœ¨å¼•ç”¨æŠ½è±¡å±‚ä¹‹åï¼Œç³»ç»Ÿå°†å¾—åˆ°å¾ˆå¥½çš„çµæ´»æ€§ï¼ŒæŠ½è±¡ç±»æ— éœ€æ”¹å˜ï¼Œåªéœ€æ–°å¢æ–°çš„å®ç°ç±»å³å¯ï¼Œä¹Ÿæ»¡è¶³äº†å¼€é—­åŸåˆ™ã€‚</p><h3 id="ä¸‰ã€ä¾èµ–å€’ç½®åŸåˆ™ç¤ºä¾‹åœºæ™¯"><a href="#ä¸‰ã€ä¾èµ–å€’ç½®åŸåˆ™ç¤ºä¾‹åœºæ™¯" class="headerlink" title="ä¸‰ã€ä¾èµ–å€’ç½®åŸåˆ™ç¤ºä¾‹åœºæ™¯"></a>ä¸‰ã€ä¾èµ–å€’ç½®åŸåˆ™ç¤ºä¾‹åœºæ™¯</h3><p>ç°æœ‰ä¸€ä¸ªæŠ½å¥–ç­–ç•¥çš„è®¾è®¡ï¼Œåœ¨ä¸ä½¿ç”¨è®¾è®¡æ¨¡å¼æ—¶ï¼Œè®¾è®¡äº†ä¸€ä¸ª<code>DrawControl</code>æŠ½å¥–æ§åˆ¶ç±»ï¼Œè¿™ä¸ªç±»é‡Œé¢åŒ…å«äº†<code>doDrawRandom()</code>ã€<code>doDrawWeight()</code>ä¸¤ç§æŠ½å¥–ç­–ç•¥ï¼Œè¿™ç§è®¾è®¡åœ¨å®é™…å¼€å‘èµ·æ¥é€Ÿåº¦æ˜¯éå¸¸å¿«çš„ï¼Œä½†æ˜¯åç»­ä¸å¥½ç»´æŠ¤ï¼Œå¦‚æœåç»­è¦æ–°å¢å…¶ä»–çš„æŠ½å¥–ç­–ç•¥è¯¥ç±»å°±è¦æ–°å¢æ–¹æ³•ä¸åˆ©äºç»´æŠ¤ä¹Ÿä¸æ»¡è¶³å¼€é—­åŸåˆ™ã€‚</p><p><img src="https://qtspace.cn/contentimg/10.jpg"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DrawControl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;BetUser&gt; <span class="title function_">doDrawRandom</span> <span class="params">(List&lt;BetUset&gt; list, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">        <span class="comment">// éšæœºæŠ½å–æŒ‡å®šæ•°é‡çš„ç”¨æˆ·ï¼Œä½œä¸ºä¸­å¥–ç”¨æˆ·</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="keyword">public</span> List&lt;BetUser&gt; <span class="title function_">doDrawWeight</span> <span class="params">(List&lt;BetUset&gt; list, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">        <span class="comment">// æƒé‡æ’åè·å–æŒ‡å®šæ•°é‡çš„ç”¨æˆ·ï¼Œä½œä¸ºä¸­å¥–ç”¨æˆ·</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°è¿›è¡Œé‡æ„æ»¡è¶³ä¾èµ–å€’ç½®åŸåˆ™ï¼Œå®šä¹‰ä¸€ä¸ª<code>IDraw</code>æŠ½å¥–æ¥å£ï¼ŒåŒ…å«<code>prize()</code>æ–¹æ³•ï¼Œæ–°å¢ä¸¤ä¸ªæŠ½å¥–çš„å®ç°ç±»<code>DrawRandom</code>(éšæœºæŠ½å–æŒ‡å®šæ•°é‡çš„ç”¨æˆ·ï¼Œä½œä¸ºä¸­å¥–ç”¨æˆ·)ã€<code>DrawWeightRank</code>(æƒé‡æ’åè·å–æŒ‡å®šæ•°é‡çš„ç”¨æˆ·ï¼Œä½œä¸ºä¸­å¥–ç”¨æˆ·),<code>DrawControl</code>æŠ½å¥–æ§åˆ¶ç±»åªå®šä¹‰ä¸€ä¸ª<code>doDraw()</code>æ–¹æ³•ï¼Œå…·ä½“çš„æŠ½è±¡ç­–ç•¥ä½¿ç”¨å‚æ•°ä¼ å…¥ï¼Œè€Œä¸”å‚æ•°ä¼ å…¥é«˜å±‚çš„æ¥å£ç±»ï¼Œä¸å‚ä¸å…·ä½“çš„å®ç°ç±»ã€‚è¿™æ ·å­å°±æ»¡è¶³äº†çµæ´»æ€§ï¼Œåç»­ä¸šåŠ¡å¦‚æœè¦æ–°å¢æŠ½å¥–ç­–ç•¥æ–°å¢æ–°çš„å®ç°ç±»å³å¯ï¼Œ<code>DrawControl</code>ç±»å¯ä»¥ä¸ç”¨æ”¹å˜ï¼Œæ»¡è¶³äº†ä¾èµ–å€’ç½®åŸåˆ™ï¼ŒåŒæ—¶ä¹Ÿæ»¡è¶³äº†å¼€é—­åŸåˆ™ã€‚</p><p><img src="https://qtspace.cn/contentimg/11.jpg"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IDraw</span> &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;BetUser&gt; <span class="title function_">prize</span><span class="params">(List&lt;BetUser&gt; list, <span class="type">int</span> count)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DrawRandom</span> <span class="keyword">implements</span> <span class="title class_">IDraw</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;BetUser&gt; <span class="title function_">prize</span><span class="params">(List&lt;BetUser&gt; list, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">        <span class="comment">// éšæœºæŠ½å–æŒ‡å®šæ•°é‡çš„ç”¨æˆ·ï¼Œä½œä¸ºä¸­å¥–ç”¨æˆ·</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DrawWeightRank</span> <span class="keyword">implements</span> <span class="title class_">IDraw</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;BetUser&gt; <span class="title function_">prize</span><span class="params">(List&lt;BetUser&gt; list, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">        <span class="comment">// æƒé‡æ’åè·å–æŒ‡å®šæ•°é‡çš„ç”¨æˆ·ï¼Œä½œä¸ºä¸­å¥–ç”¨æˆ·</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DrawControl</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¹Ÿå¯ä»¥ç”¨æ³¨å…¥çš„æ–¹å¼</span></span><br><span class="line">    <span class="keyword">private</span> IDraw draw;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;BetUser&gt; <span class="title function_">doDraw</span><span class="params">(IDraw draw, List&lt;BetUser&gt; betUserList, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> draw.prize(betUserList, count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ä¾èµ–å€’ç½®åŸåˆ™ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JVM-ç±»åŠ è½½è¯¦è§£</title>
      <link href="/2022/03/19/jvm-class-loader/"/>
      <url>/2022/03/19/jvm-class-loader/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h3 id="ä¸€ã€JVMç±»åŠ è½½è¿‡ç¨‹"><a href="#ä¸€ã€JVMç±»åŠ è½½è¿‡ç¨‹" class="headerlink" title="ä¸€ã€JVMç±»åŠ è½½è¿‡ç¨‹"></a>ä¸€ã€JVMç±»åŠ è½½è¿‡ç¨‹</h3><p>JVMç±»åŠ è½½è¿‡ç¨‹å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://qtspace.cn/contentimg/8.jpg"></p><p><img src="https://qtspace.cn/contentimg/9.jpg"></p><p>JVMç±»åŠ è½½è¿‡ç¨‹åˆ†ä¸ºï¼š<mark class="hl-label blue">åŠ è½½</mark> ã€<mark class="hl-label blue">é“¾æ¥</mark> ã€<mark class="hl-label blue">åˆå§‹åŒ–</mark> ã€<mark class="hl-label blue">ä½¿ç”¨</mark> ã€<mark class="hl-label blue">å¸è½½</mark> è¿™äº”ä¸ªé˜¶æ®µï¼Œå…¶ä¸­é“¾æ¥é˜¶æ®µåˆåŒ…æ‹¬ï¼š<mark class="hl-label green">éªŒè¯</mark> ã€<mark class="hl-label green">å‡†å¤‡</mark> ã€<mark class="hl-label green">è§£æ</mark> ã€‚</p><ul><li><mark class="hl-label blue">åŠ è½½</mark> ï¼šé€šè¿‡ç±»çš„å®Œå…¨é™å®šåï¼ŒæŸ¥æ‰¾æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚ç æ–‡ä»¶ï¼Œé€šè¿‡è¯¥å­—èŠ‚ç æ–‡ä»¶åˆ›å»ºClasså¯¹è±¡ã€‚</li><li><mark class="hl-label blue">é“¾æ¥</mark> ï¼šåŒ…å«<mark class="hl-label green">éªŒè¯</mark> ã€<mark class="hl-label green">å‡†å¤‡</mark> ã€<mark class="hl-label green">è§£æ</mark> ä¸‰ä¸ªé˜¶æ®µï¼š<ul><li><mark class="hl-label green">éªŒè¯</mark> ï¼šç¡®ä¿Classæ–‡ä»¶å¤åˆè™šæ‹Ÿæœºè§„å®šçš„Classæ–‡ä»¶æ ¼å¼ï¼ŒåŒ…å«æ–‡ä»¶æ ¼å¼éªŒè¯ã€å…ƒæ•°æ®éªŒè¯ã€å­—èŠ‚ç éªŒè¯ã€å¼•ç”¨ç¬¦å·éªŒè¯ã€‚</li><li><mark class="hl-label green">å‡†å¤‡</mark> ï¼šä¸ºç±»çš„é™æ€å˜é‡åˆ†é…å†…å­˜å¹¶è®¾ç½®åˆå§‹åŒ–å€¼ï¼Œæ³¨ï¼šè¿™é‡Œä¸åŒ…å«`final`ä¿®é¥°çš„é™æ€å˜é‡ï¼Œå› ä¸º`final`ä¿®é¥°çš„é™æ€å˜é‡æ˜¯åœ¨ç¼–è¯‘æœŸåˆ†é…ã€‚</li><li><mark class="hl-label green">è§£æ</mark> ï¼šå°†å¸¸é‡æ± çš„é—´æ¥å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼Œè§£æåŒ…å«å­—æ®µè§£æã€æ¥å£è§£æã€æ–¹æ³•è§£æã€‚</li></ul></li><li><mark class="hl-label blue">åˆå§‹åŒ–</mark> ï¼šåˆå§‹åŒ–é™æ€å˜é‡å’Œé™æ€å—ï¼Œå…ˆåˆå§‹åŒ–çˆ¶ç±»ï¼Œå†åˆå§‹åŒ–å½“å‰ç±»ï¼Œåªæœ‰å¯¹ç±»ä¸»åŠ¨æ—¶æ‰ä¼šåˆå§‹åŒ–ã€‚</li><li><mark class="hl-label blue">ä½¿ç”¨</mark> ï¼šç¨‹åºä»£ç æ‰§è¡Œæ—¶ä½¿ç”¨ï¼Œnewå‡ºå¯¹è±¡ç¨‹åºä¸­ä½¿ç”¨ã€‚</li><li><mark class="hl-label blue">å¸è½½</mark> ï¼šç¨‹åºä»£ç é€€å‡ºã€å¼‚å¸¸ã€ç»“æŸç­‰ï¼Œæ‰§è¡Œåƒåœ¾å›æ”¶ã€‚</li></ul><h3 id="äºŒã€ç±»åŠ è½½æ—¶æœº"><a href="#äºŒã€ç±»åŠ è½½æ—¶æœº" class="headerlink" title="äºŒã€ç±»åŠ è½½æ—¶æœº"></a>äºŒã€ç±»åŠ è½½æ—¶æœº</h3><ul><li>åˆ›å»ºç±»çš„å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯<code>new</code>ä¸€ä¸ªå¯¹è±¡ã€‚</li><li>è®¿é—®ç±»çš„é™æ€æ–¹æ³•æˆ–è€…é™æ€å˜é‡ï¼ˆåŒ…å«é™æ€å˜é‡èµ‹å€¼ï¼‰ã€‚</li><li>ä½¿ç”¨<code>Class.forName()</code>åå°„ç±»ã€‚</li><li>å­ç±»åˆå§‹åŒ–çš„æ—¶å€™ã€‚</li><li>JVMå¯åŠ¨æ—¶æ ‡æ˜çš„å¯åŠ¨ç±»ã€‚</li></ul><h3 id="ä¸‰ã€ç±»åŠ è½½å™¨"><a href="#ä¸‰ã€ç±»åŠ è½½å™¨" class="headerlink" title="ä¸‰ã€ç±»åŠ è½½å™¨"></a>ä¸‰ã€ç±»åŠ è½½å™¨</h3><p>ç±»åŠ è½½å™¨åŒ…æ‹¬å¯åŠ¨ç±»åŠ è½½å™¨ã€æ‰©å±•ç±»åŠ è½½å™¨ã€ç³»ç»Ÿç±»åŠ è½½å™¨ã€è‡ªå®šä¹‰ç±»åŠ è½½å™¨å››ç§åŠ è½½å™¨ã€‚</p><ul><li><p>å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰ï¼šè´Ÿè´£åŠ è½½Javaç±»çš„æ ¸å¿ƒç±»ï¼Œæ˜¯ç”¨åŸç”Ÿä»£ç å®ç°ã€‚ä¸‹é¢ä»£ç å¯ä»¥è·å¾—å¯åŠ¨ç±»åŠ è½½å™¨æ‰€åŠ è½½çš„Javaæ ¸å¿ƒç±»åº“ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">URL[] urLs = Launcher.getBootstrapClassPath().getURLs();</span><br><span class="line"><span class="keyword">for</span>(URL url : urLs)&#123;</span><br><span class="line">    System.out.println(url.toExternalForm());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">file:/D:/Develop<span class="comment">%20Tools/Java/jdk-8u231/jre/lib/resources.jar</span></span><br><span class="line">file:/D:/Develop<span class="comment">%20Tools/Java/jdk-8u231/jre/lib/rt.jar</span></span><br><span class="line">file:/D:/Develop<span class="comment">%20Tools/Java/jdk-8u231/jre/lib/sunrsasign.jar</span></span><br><span class="line">file:/D:/Develop<span class="comment">%20Tools/Java/jdk-8u231/jre/lib/jsse.jar</span></span><br><span class="line">file:/D:/Develop<span class="comment">%20Tools/Java/jdk-8u231/jre/lib/jce.jar</span></span><br><span class="line">file:/D:/Develop<span class="comment">%20Tools/Java/jdk-8u231/jre/lib/charsets.jar</span></span><br><span class="line">file:/D:/Develop<span class="comment">%20Tools/Java/jdk-8u231/jre/lib/jfr.jar</span></span><br><span class="line">file:/D:/Develop<span class="comment">%20Tools/Java/jdk-8u231/jre/classes</span></span><br></pre></td></tr></table></figure></li><li><p>æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtensions ClassLoaderï¼‰ï¼šè´Ÿè´£åŠ è½½JREçš„æ‰©å±•ç›®å½•<code>lib/ext</code>æˆ–è€…ç”±<code>java.ext.dirs</code>ç³»ç»Ÿå±æ€§æŒ‡å®šçš„ç›®å½•ä¸­çš„JARåŒ…çš„ç±»ã€‚ç”±Javaè¯­è¨€å®ç°ï¼Œçˆ¶ç±»åŠ è½½å™¨ä¸ºNullã€‚</p></li><li><p>ç³»ç»Ÿç±»åŠ è½½å™¨ï¼ˆSystem Class Loaderï¼‰ï¼šè´Ÿè´£åœ¨JVMå¯åŠ¨æ—¶åŠ è½½æ¥è‡ªJavaå‘½ä»¤çš„<code>-classpath</code>é€‰é¡¹ã€<code>java.class.path</code>ç³»ç»Ÿå±æ€§ã€‚å¯ä»¥é€šè¿‡<code>ClassLoader.getSystemClassLoader()</code>æ–¹æ³•è·å–å½“å‰ç³»ç»Ÿç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬æƒ…å†µæ˜¯è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„çˆ¶åŠ è½½å™¨ã€‚ç”±Javaè¯­è¨€å®ç°ï¼Œçˆ¶ç±»åŠ è½½å™¨ä¸ºæ‰©å±•ç±»åŠ è½½å™¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(ClassLoader.getSystemClassLoader());</span><br><span class="line">System.out.println(ClassLoader.getSystemClassLoader().getParent());</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç è¾“å‡ºä¸ºï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sun.misc.Launcher<span class="built_in">$</span>AppClassLoader@18b4aac2</span><br><span class="line">sun.misc.Launcher<span class="built_in">$</span>ExtClassLoader@4eb7f003</span><br></pre></td></tr></table></figure></li><li><p>è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼ˆCustom ClassLoaderï¼‰ï¼šç”¨æˆ·å¯ä»¥é€šè¿‡ç»§æ‰¿<code>ClassLoader</code>ç±»å®ç°è‡ªå®šä¹‰ç±»åŠ è½½å™¨ã€‚ç”±Javaè¯­è¨€å®ç°ï¼Œè‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„çˆ¶ç±»æ˜¯ç³»ç»Ÿç±»åŠ è½½å™¨ã€‚</p></li></ul><h3 id="å››ã€ç±»åŠ è½½æœºåˆ¶"><a href="#å››ã€ç±»åŠ è½½æœºåˆ¶" class="headerlink" title="å››ã€ç±»åŠ è½½æœºåˆ¶"></a>å››ã€ç±»åŠ è½½æœºåˆ¶</h3><p>JVMçš„ç±»åŠ è½½æœºåˆ¶ä¸»è¦æœ‰å…¨ç›˜è´Ÿè´£ã€åŒäº²å§”æ´¾ã€ç¼“å­˜æœºåˆ¶ä¸‰ç§åŠ è½½æœºåˆ¶ã€‚</p><ul><li>å…¨ç›˜è´Ÿè´£ï¼šå½“ä¸€ä¸ªç±»åŠ è½½å™¨åŠ è½½æŸä¸ªClassæ—¶ï¼Œè¯¥Classæ‰€ä¾èµ–å’Œå¼•ç”¨å…¶ä»–Classä¹Ÿä¼šç”±è¯¥ç±»åŠ è½½å™¨è´Ÿè´£åŠ è½½ï¼Œé™¤éæŒ‡å®šäº†ä½¿ç”¨å…¶ä»–ç±»åŠ è½½å™¨åŠ è½½ã€‚</li><li>åŒäº²å§”æ´¾ï¼šå…ˆè®©çˆ¶ç±»åŠ è½½å™¨åŠ è½½è¯¥Classï¼Œåªæœ‰åœ¨çˆ¶ç±»åŠ è½½å™¨æ— æ³•åŠ è½½è¯¥ç±»æ—¶æ‰å°è¯•ä½¿ç”¨è‡ªå·±çš„ç±»åŠ è½½å™¨åŠ è½½ã€‚é€šä¿—çš„è®²å°±æ˜¯åœ¨æŸä¸ªç‰¹å®šçš„ç±»åŠ è½½å™¨æ¥åˆ°åŠ è½½ç±»è¯·æ±‚æ—¶ï¼Œå…ˆå¯„æ‰˜ç»™çˆ¶åŠ è½½å™¨åŠ è½½ï¼Œä¾æ¬¡é€’å½’ï¼Œå¦‚æœçˆ¶åŠ è½½å™¨å¯ä»¥åŠ è½½æ—¶åˆ™æˆåŠŸè¿”å›ï¼Œå¦‚æœä¸å¯ä»¥åŠ è½½å°±è‡ªå·±å»åŠ è½½ã€‚</li><li>ç¼“å­˜æœºåˆ¶ï¼šç¼“å­˜æœºåˆ¶ä¼šç¡®ä¿æ‰€æœ‰åŠ è½½è¿‡çš„Classéƒ½è¢«ä¼šç¼“å­˜ï¼Œå½“ç¨‹åºä¸­éœ€è¦æŸä¸ªClassæ—¶ï¼Œç±»åŠ è½½å™¨å…ˆä»ç¼“å­˜åŒºä¸­æœç´¢è¯¥Classï¼Œåªæœ‰ç¼“å­˜åŒºä¸­ä¸å­˜åœ¨è¯¥Classå¯¹è±¡æ—¶ï¼Œç³»ç»Ÿæ‰ä¼šè¯»å–è¯¥ç±»çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºClasså¯¹è±¡ï¼Œå­˜å…¥ç¼“å­˜åŒºã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¿®æ”¹Classæ–‡ä»¶ä¹‹åï¼Œå¿…é¡»é‡å¯JVMæ‰ä¼šç”Ÿæ•ˆçš„åŸå› ã€‚</li></ul><p>å…¶ä¸­åŒäº²å§”æ´¾æœºåˆ¶ä¼˜åŠ¿ï¼š</p><ul><li>çˆ¶ç±»åŠ è½½å™¨æˆåŠŸåŠ è½½åˆ™è¿”å›ï¼Œå­ç±»åŠ è½½å™¨ä¸ä¼šå†åŠ è½½ï¼Œé˜²æ­¢äº†é‡å¤åŠ è½½ã€‚</li><li>é˜²æ­¢æ ¸å¿ƒAPIåº“è¢«éšæ„ç¯¡æ”¹ã€‚æ¯”å¦‚æœ‰ä¸€ä¸ªè¦åŠ è½½<code>java.lang.Integer</code>ç±»çš„è¯·æ±‚ï¼Œé€šè¿‡åŒäº²å§”æ´¾è¿›åˆ¶åŠ è½½ä¼ é€’åˆ°å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œåœ¨åœ¨æ ¸å¿ƒJava APIå‘ç°è¿™ä¸ªåå­—çš„ç±»ï¼Œå‘ç°è¯¥ç±»å·²è¢«åŠ è½½ï¼Œå¹¶ä¸ä¼šé‡æ–°åŠ è½½ä¼ é€’çš„è¿‡æ¥çš„<code>java.lang.Integer</code>ï¼Œè€Œç›´æ¥è¿”å›å·²åŠ è½½è¿‡çš„<code>Integer.class</code>ï¼Œå¯ä»¥é˜²æ­¢æ ¸å¿ƒAPIè¢«éšæ„ç¯¡æ”¹ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> JVM </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç±»åŠ è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…­å¤§è®¾è®¡æ¨¡å¼åŸåˆ™-æ¥å£éš”ç¦»åŸåˆ™</title>
      <link href="/2022/03/17/deisgn-model-isp/"/>
      <url>/2022/03/17/deisgn-model-isp/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h3 id="ä¸€ã€æ¥å£éš”ç¦»åŸåˆ™å®šä¹‰"><a href="#ä¸€ã€æ¥å£éš”ç¦»åŸåˆ™å®šä¹‰" class="headerlink" title="ä¸€ã€æ¥å£éš”ç¦»åŸåˆ™å®šä¹‰"></a>ä¸€ã€æ¥å£éš”ç¦»åŸåˆ™å®šä¹‰</h3><p>æ¥å£éš”ç¦»åŸåˆ™å®šä¹‰å¦‚ä¸‹ï¼š</p><p><strong>æ¥å£éš”ç¦»åŸåˆ™(Interface Segregation Principle, ISP)ï¼šä½¿ç”¨å¤šä¸ªä¸“é—¨çš„æ¥å£ï¼Œè€Œä¸ä½¿ç”¨å•ä¸€çš„æ€»æ¥å£ï¼Œå³å®¢æˆ·ç«¯ä¸åº”è¯¥ä¾èµ–é‚£äº›å®ƒä¸éœ€è¦çš„æ¥å£</strong>ã€‚</p><h3 id="äºŒã€æ¥å£éš”ç¦»åŸåˆ™æè¿°"><a href="#äºŒã€æ¥å£éš”ç¦»åŸåˆ™æè¿°" class="headerlink" title="äºŒã€æ¥å£éš”ç¦»åŸåˆ™æè¿°"></a>äºŒã€æ¥å£éš”ç¦»åŸåˆ™æè¿°</h3><p>æ ¹ç»æ¥å£éš”ç¦»åŸåˆ™ï¼Œå½“ä¸€ä¸ªæ¥å£å¤ªå¤§æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°†å®ƒåˆ†å‰²æˆä¸€äº›ç»†å°çš„æ¥å£ï¼Œä½¿ç”¨è¯¥æ¥å£çš„å®¢æˆ·ç«¯åªéœ€çŸ¥é“ä¸ä¹‹ç›¸å…³çš„æ–¹æ³•å³å¯ã€‚<strong>æ¯ä¸€ä¸ªæ¥å£åº”è¯¥æ‰¿æ‹…ä¸€ç§ç›¸å¯¹ç‹¬ç«‹çš„è§’è‰²ï¼Œä¸å¹²ä¸è¯¥å¹²çš„äº‹æƒ…ï¼Œå¹²è¯¥å¹²çš„äº‹è¯·</strong>ã€‚è¿™é‡Œçš„â€æ¥å£â€å¾€å¾€æœ‰ä¸¤ç§ä¸åŒçš„å®šä¹‰ï¼šä¸€ç§æ˜¯æŒ‡ä¸€ä¸ªç±»å‹æ‰€å…·æœ‰çš„æ–¹æ³•ç‰¹å¾çš„é›†åˆï¼Œä»…ä»…æ˜¯ä¸€ç§é€»è¾‘ä¸Šçš„æŠ½è±¡ï¼›å¦å¤–ä¸€ç§æ˜¯æŸç§è¯­è¨€ä¸Šå…·ä½“çš„â€æ¥å£â€å®šä¹‰ï¼Œæ¯”å¦‚Javaè¯­è¨€çš„<code>interface</code>ã€‚å¯¹äºè¿™ä¸¤ç§ä¸åŒçš„å«ä¹‰ï¼Œæ¥å£éš”ç¦»åŸåˆ™è¡¨è¾¾ä»¥åŠå«ä¹‰æ‰€ä»¥ä¸åŒï¼š</p><ul><li>å½“æŠŠâ€æ¥å£â€œç†è§£æˆä¸€ä¸ªç±»å‹æ‰€å…·æœ‰çš„æ–¹æ³•ç‰¹æ€§çš„é›†åˆæ—¶ï¼Œå°±æ˜¯ä¸€ç§é€»è¾‘ä¸Šçš„æ¦‚å¿µï¼Œæ¥å£çš„åˆ’åˆ†å°†ç›´æ¥å¸¦æ¥ç±»çš„åˆ’åˆ†ã€‚å¯ä»¥æŠŠæ¥å£ç†è§£æˆè§’è‰²ï¼Œä¸€ä¸ªæ¥å£åªèƒ½ä»£è¡¨ä¸€ä¸ªè§’è‰²ï¼Œæ¯ä¸ªè§’è‰²éƒ½æœ‰å®ƒç‰¹å®šä¸€ä¸ªæ¥å£ï¼Œæ­¤æ—¶è¿™ä¸ªåŸåˆ™å¯ä»¥å«åš<strong>è§’è‰²éš”ç¦»åŸåˆ™</strong>ã€‚</li><li>å¦‚æœæŠŠâ€æ¥å£â€ç†è§£æˆç‹­ä¹‰çš„ç‰¹å®šè¯­è¨€æ¥å£ï¼Œé‚£ä¹ˆæ¥å£éš”ç¦»åŸåˆ™è¡¨è¾¾çš„æ„æ€å°±æ˜¯<strong>æ¥å£ä»…ä»…æä¾›å®¢æˆ·ç«¯éœ€è¦çš„è¡Œä¸ºï¼Œå®¢æˆ·ç«¯ä¸éœ€è¦çš„è¡Œä¸ºåˆ™éšè—èµ·æ¥ï¼Œåº”å½“ä¸ºå®¢æˆ·ç«¯æä¾›å°½å¯èƒ½å°çš„æ¥å£ï¼Œè€Œä¸è¦æä¾›å¤§çš„æ€»æ¥å£</strong>ã€‚åœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œå®ç°ä¸€ä¸ªæ¥å£ç±»å°±è¦å®ç°è¯¥æ¥å£å®šä¹‰çš„æ‰€æœ‰æ–¹æ³•ï¼Œå› æ­¤å¤§çš„æ€»æ¥å£ä½¿ç”¨èµ·æ¥ä¸ä¸€å®šå¾ˆæ–¹ä¾¿ï¼Œä¸ºäº†ä½¿æ¥å£çš„èŒè´£å•ä¸€ï¼Œéœ€è¦æŠŠå¤§æ¥å£ä¸­çš„æ–¹æ³•æ ¹æ®å…¶èŒè´£ä¸åŒæ”¾åˆ°ä¸åŒçš„å°æ¥å£ä¸­ï¼Œç¡®ä¿æ¯ä¸ªæ¥å£ä½¿ç”¨èµ·æ¥éƒ½å¾ˆæ–¹ä¾¿ï¼Œå¹¶éƒ½æ‰¿æ‹…æŸä¸€å•ä¸€è§’è‰²ã€‚æ¥å£åº”è¯¥å°½é‡ç»†åŒ–ï¼ŒåŒæ—¶æ¥å£ä¸­çš„æ–¹æ³•åº”è¯¥å°½é‡å°‘ï¼Œæ¯ä¸ªæ¥å£ä¸­åªåŒ…å«ä¸€ä¸ªå®¢æˆ·ç«¯ï¼ˆå¦‚å­æ¨¡å—æˆ–è€…ä¸šåŠ¡é€»è¾‘ç±»ï¼‰æ‰€éœ€çš„æ–¹æ³•å³å¯ï¼Œè¿™ç§æœºåˆ¶ä¹Ÿç§°ä¸ºâ€œ<strong>å®šåˆ¶æœåŠ¡</strong>â€ï¼Œå³ä¸ºä¸åŒçš„å®¢æˆ·ç«¯æä¾›å®½çª„ä¸åŒçš„æ¥å£ã€‚</li></ul><h3 id="ä¸‰ã€æ¥å£éš”ç¦»åŸåˆ™æ —å­"><a href="#ä¸‰ã€æ¥å£éš”ç¦»åŸåˆ™æ —å­" class="headerlink" title="ä¸‰ã€æ¥å£éš”ç¦»åŸåˆ™æ —å­"></a>ä¸‰ã€æ¥å£éš”ç¦»åŸåˆ™æ —å­</h3><h4 id="ä¸æ»¡è¶³æ¥å£éš”ç¦»åŸåˆ™"><a href="#ä¸æ»¡è¶³æ¥å£éš”ç¦»åŸåˆ™" class="headerlink" title="ä¸æ»¡è¶³æ¥å£éš”ç¦»åŸåˆ™"></a>ä¸æ»¡è¶³æ¥å£éš”ç¦»åŸåˆ™</h4><p>ç°æœ‰ä¸€ä¸ªæ¥å£<code>CustomerDataDisplay</code>ï¼ŒåŒ…å«äº†<code>dataRead()</code>ã€<code>transformToXml()</code>ã€<code>createChart()</code>ã€<code>displayChart()</code>ã€<code>createReport()</code>ã€<code>displayReport()</code>æ–¹æ³•ï¼Œæ–¹æ³•è¯´æ˜å¦‚ä¸‹ï¼š</p><ul><li><code>dataRead()</code>ï¼šæ•°æ®è¯»å–ã€‚</li><li><code>transformToXml()</code>ï¼šæ•°æ®è½¬æˆxmlæ ¼å¼ã€‚</li><li><code>createChart()</code>ï¼šåˆ›å»ºå›¾è¡¨ã€‚</li><li><code>displayChart()</code>ï¼šæ˜¾ç¤ºå›¾è¡¨ã€‚</li><li><code>createReport()</code>ï¼šåˆ›å»ºæŠ¥è¡¨ã€‚</li><li><code>displayReport()</code>ï¼šæ˜¾ç¤ºæŠ¥è¡¨ã€‚</li></ul><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CustomerDataDisplay</span> &#123;</span><br><span class="line">    List&lt;CustomerData&gt; <span class="title function_">dataRead</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">transformToXml</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createChart</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">displayChart</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createReport</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">displayReport</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆæœ‰ä¸€ä¸ªå›¾è¡¨ç±»<code>ChartClass</code>å®ç°äº†<code>CustomerDataDisplay</code>æ¥å£ï¼Œè¯¥ç±»å°±è¦å®ç°æ¥å£çš„å…¨éƒ¨æ–¹æ³•ï¼Œæ­£å¸¸æ¥è¯´<code>ChartClass</code>åªéœ€è¦<code>createChart()</code>ã€<code>displayChart()</code>æ–¹æ³•å³å¯ï¼Œå› ä¸º<code>CustomerDataDisplay</code>æ¥å£æ–¹æ³•å¤ªå¤šäº†ï¼Œæ‰¿æ‹…äº†å¤ªå¤šèŒè´£ï¼Œé¢—ç²’åº¦å¤ªå¤§äº†<code>ChartClass</code>ç±»ä¸å¾—ä¸ç©ºå®ç°å…¶ä»–æ–¹æ³•ï¼Œè¿èƒŒäº†æ¥å£éš”ç¦»åŸåˆ™ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChartClass</span> <span class="keyword">implements</span> <span class="title class_">CustomerDataDisplay</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;CustomerData&gt; <span class="title function_">dataRead</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// ç©ºå®ç°</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transformToXml</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// ç©ºå®ç°</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createChart</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºå›¾è¡¨</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">displayChart</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// æ˜¾ç¤ºå›¾è¡¨</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createReport</span><span class="params">()</span>&#123;</span><br><span class="line">         <span class="comment">// ç©ºå®ç°</span></span><br><span class="line">    &#125;</span><br><span class="line">    publicvoid <span class="title function_">displayReport</span><span class="params">()</span>&#123;</span><br><span class="line">         <span class="comment">// ç©ºå®ç°</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="é‡æ„æ»¡è¶³æ¥å£éš”ç¦»åŸåˆ™"><a href="#é‡æ„æ»¡è¶³æ¥å£éš”ç¦»åŸåˆ™" class="headerlink" title="é‡æ„æ»¡è¶³æ¥å£éš”ç¦»åŸåˆ™"></a>é‡æ„æ»¡è¶³æ¥å£éš”ç¦»åŸåˆ™</h4><p>æˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸šåŠ¡èŒä¸šå°†<code>CustomerDataDisplay</code>æ¥å£åˆ†ä¸º<code>DataHandler</code>ã€<code>XMLTransformer</code>ã€<code>ChartHandler</code>ã€<code>ReportHandler</code>å››ä¸ªæ¥å£ï¼Œè¿™å››ä¸ªæ¥å£èŒè´£åˆ†åˆ«æ˜¯ï¼š</p><ul><li><code>DataHandler</code>ï¼šæ•°æ®ä¸šåŠ¡å¤„ç†æ¥å£ã€‚</li><li><code>XMLTransformer</code>ï¼šXMLè½¬æ¢æ¥å£ã€‚</li><li><code>ChartHandler</code>ï¼šå›¾è¡¨ä¸šåŠ¡å¤„ç†æ¥å£ã€‚</li><li><code>ReportHandler</code>ï¼šæŠ¥è¡¨ä¸šåŠ¡å¤„ç†æ¥å£ã€‚</li></ul><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DataHandler</span> &#123;</span><br><span class="line">    List&lt;CustomerData&gt; <span class="title function_">dataRead</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">XMLTransformer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">transformToXml</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ChartHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createChart</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">displayChart</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ReportHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createReport</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">displayReport</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡æ„ä¹‹åæ¯ä¸ªæ¥å£éƒ½æ‰¿æ‹…è‡ªå·±çš„èŒè´£ï¼Œçµæ´»æ€§å¾ˆé«˜ï¼Œä½¿ç”¨èµ·æ¥å¾ˆæ–¹ä¾¿ï¼Œæ¯ä¸ªæ¥å£ä¸­éƒ½åªåŒ…å«å’Œè‡ªå·±ä¸šåŠ¡ç›¸å…³çš„æ–¹æ³•ï¼Œä¸ä¼šå­˜åœ¨å’Œè‡ªå·±æ— å…³çš„æ–¹æ³•ï¼Œè¾¾åˆ°äº†é«˜å†…èšã€æ¾è€¦åˆçš„æ•ˆæœã€‚</p><p><strong>åœ¨ä½¿ç”¨æ¥å£éš”ç¦»åŸåˆ™æ—¶æˆ‘ä»¬è¦æ§åˆ¶æ¥å£çš„é¢—ç²’åº¦ï¼Œé¢—ç²’åº¦ä¸èƒ½å¤ªå¤§ï¼Œä¹Ÿä¸èƒ½å¤ªå°ã€‚å¦‚æœå¤ªå°å°±ä¼šé€ æˆæ¥å£æ³›æ»¥ï¼Œä¸åˆ©äºç»´æŠ¤ï¼›æ¥å£å…¥å¦‚æœå¤ªå¤§å°±ä¼šè¿èƒŒæ¥å£éš”ç¦»åŸåˆ™ï¼Œçµæ´»æ€§è¾ƒå·®ï¼Œä½¿ç”¨èµ·æ¥ä¸æ–¹ä¾¿</strong>ã€‚ä¸€èˆ¬æ¥è¯´æ¥å£ä¸­ä»…åŒ…å«æŸä¸šåŠ¡æ¨¡å—çš„æ–¹æ³•å³å¯ï¼Œä¸åº”è¯¥æœ‰å…¶ä»–ä¸šåŠ¡æ¨¡å—çš„æ–¹æ³•ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¥å£éš”ç¦»åŸåˆ™ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…­å¤§è®¾è®¡æ¨¡å¼åŸåˆ™-è¿ªç±³ç‰¹æ³•åˆ™</title>
      <link href="/2022/03/16/deisgn-model-lod/"/>
      <url>/2022/03/16/deisgn-model-lod/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h3 id="ä¸€ã€è¿ªç±³ç‰¹æ³•åˆ™å®šä¹‰"><a href="#ä¸€ã€è¿ªç±³ç‰¹æ³•åˆ™å®šä¹‰" class="headerlink" title="ä¸€ã€è¿ªç±³ç‰¹æ³•åˆ™å®šä¹‰"></a>ä¸€ã€è¿ªç±³ç‰¹æ³•åˆ™å®šä¹‰</h3><p>è¿ªç±³ç‰¹æ³•åˆ™åˆæœ€å°‘çŸ¥è¯†åŸåˆ™ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><p><strong>è¿ªç±³ç‰¹æ³•åˆ™(Law of Demeter, LoD)ï¼šä¸€ä¸ªè½¯ä»¶å®ä½“åº”å½“å°½å¯èƒ½å°‘çš„ä¸å…¶ä»–å®ä½“å‘ç”Ÿç›¸äº’ä½œç”¨ã€‚</strong></p><h3 id="äºŒã€è¿ªç±³ç‰¹æ³•åˆ™æè¿°"><a href="#äºŒã€è¿ªç±³ç‰¹æ³•åˆ™æè¿°" class="headerlink" title="äºŒã€è¿ªç±³ç‰¹æ³•åˆ™æè¿°"></a>äºŒã€è¿ªç±³ç‰¹æ³•åˆ™æè¿°</h3><p>å¦‚æœä¸€ä¸ªç³»ç»Ÿæ»¡è¶³è¿ªç±³ç‰¹æ³•åˆ™ï¼Œé‚£ä¹ˆå½“å…¶ä¸­ä¸€ä¸ªè½¯ä»¶å®ä½“å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå°±ä¼šå°½é‡å°‘çš„å½±å“å…¶ä»–è½¯ä»¶å®ä½“ï¼Œæ‰©å±•ä¼šç›¸å¯¹å®¹æ˜“ï¼Œè¿™æ˜¯å¯¹è½¯ä»¶å®ä½“ä¹‹é—´é€šä¿¡çš„é™åˆ¶ï¼Œè¿ªç±³ç‰¹æ³•åˆ™è¦æ±‚é™åˆ¶è½¯ä»¶å®ä½“ä¹‹é—´é€šä¿¡çš„å®½åº¦å’Œæ·±åº¦ã€‚<strong>è¿ªç±³ç‰¹æ³•åˆ™å¯ä»¥é™ä½ç³»ç»Ÿçš„è€¦åˆåº¦ï¼Œä½¿ç±»ä¸ç±»ä¹‹é—´ä¿æŒæ¾è€¦åˆçŠ¶æ€ã€‚</strong></p><p>è¿ªç±³ç‰¹æ³•åˆ™è¿˜æœ‰å‡ ç§å®šä¹‰å½¢å¼ï¼ŒåŒ…æ‹¬ï¼š<strong>ä¸è¦å’Œâ€é™Œç”Ÿäººâ€è¯´è¯ã€åªä¸ä½ çš„ç›´æ¥æœ‹å‹é€šä¿¡</strong>ç­‰ï¼Œåœ¨è¿ªç±³ç‰¹æ³•åˆ™ä¸­ï¼Œå¯¹äºä¸€ä¸ªå¯¹è±¡ï¼Œå…¶æœ‹å‹åŒ…æ‹¬ä»¥ä¸‹å‡ ç±»ï¼š</p><ul><li>å½“å‰å¯¹è±¡æœ¬èº«(this)</li><li>ä»¥å‚æ•°å½¢å¼ä¼ å…¥åˆ°å½“å‰å¯¹è±¡æ–¹æ³•ä¸­çš„å¯¹è±¡</li><li>å½“å‰å¯¹è±¡çš„æˆå‘˜å¯¹è±¡</li><li>å¦‚æœå½“å‰å¯¹è±¡çš„æˆå‘˜å¯¹è±¡æ˜¯ä¸€ä¸ªé›†åˆï¼Œé‚£ä¹ˆé›†åˆä¸­çš„å…ƒç´ ä¹Ÿéƒ½æ˜¯æœ‹å‹ã€‚</li><li>å½“å‰å¯¹è±¡åˆ›å»ºçš„å¯¹è±¡</li></ul><p>ä»»ä½•ä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚æœæ»¡è¶³ä¸Šé¢çš„æ¡ä»¶ä¹‹ä¸€ï¼Œå°±æ˜¯å½“å‰å¯¹è±¡çš„â€œæœ‹å‹â€ï¼Œå¦åˆ™å°±æ˜¯â€œé™Œç”Ÿäººâ€ã€‚åœ¨åº”ç”¨è¿ªç±³ç‰¹æ³•åˆ™æ—¶ï¼Œä¸€ä¸ªå¯¹è±¡åªèƒ½ä¸ç›´æ¥æœ‹å‹å‘ç”Ÿäº¤äº’ï¼Œä¸èƒ½ä¸â€œé™Œç”Ÿäººâ€å‘ç”Ÿç›´æ¥äº¤äº’ï¼Œè¿™æ ·å­å¯ä»¥é™ä½ç³»ç»Ÿçš„è€¦åˆåº¦ï¼Œä¸€ä¸ªå¯¹è±¡çš„æ”¹å˜ä¸ä¼šç»™å¤ªå¤šå…¶ä»–å¯¹è±¡å¸¦æ¥å½±å“ã€‚</p><p>è¿ªç±³ç‰¹æ³•åˆ™è¦æ±‚æˆ‘ä»¬åœ¨è®¾è®¡ç³»ç»Ÿæ—¶ï¼Œ<strong>åº”è¯¥å°½é‡å‡å°‘å¯¹è±¡ä¹‹é—´çš„äº¤äº’ï¼Œå¦‚æœä¸¤ä¸ªå¯¹è±¡ä¸å¿…ç›´æ¥é€šä¿¡ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªå¯¹è±¡å°±ä¸åº”è¯¥å‘ç”Ÿä»»ä½•ç›´æ¥çš„ç›¸äº’ä½œç”¨ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªå¯¹è±¡éœ€è¦è°ƒç”¨å¦å¤–ä¸€ä¸ªå¯¹è±¡çš„æŸä¸ªæ–¹æ³•æ—¶ï¼Œå¯ä»¥é€šè¿‡ç¬¬ä¸‰è€…è½¬å‘è¿™ä¸ªè°ƒç”¨ã€‚</strong>å°±æ˜¯<strong>é€šè¿‡å¼•å…¥ä¸€ä¸ªåˆç†çš„ç¬¬ä¸‰è€…æ¥é™ä½å…ˆæœ‰å¯¹è±¡ä¹‹é—´çš„è€¦åˆåº¦</strong>ã€‚</p><p>åœ¨è¿ªç±³ç‰¹æ³•åˆ™è¿ç”¨åˆ°ç³»ç»Ÿè®¾è®¡ä¸­æ—¶ï¼Œè¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>åœ¨ç±»çš„åˆ’åˆ†ä¸Šï¼Œåº”è¯¥å°½å¯èƒ½çš„åˆ›å»ºæ¾è€¦åˆçš„ç±»ï¼Œç±»ä¹‹é—´çš„è€¦åˆåº¦è¶Šä½ï¼Œå¤ç”¨ç‡è¶Šé«˜ï¼Œä¸€ä¸ªæ¾è€¦åˆçš„ç±»å‘ç”Ÿä¿®æ”¹ä¸ä¼šå¯¹å…³è”çš„ç±»é€ æˆå¤ªå¤§çš„å½±å“ã€‚</li><li>åœ¨ç±»çš„ç»“æ„è®¾è®¡ä¸Šï¼Œæ¯ä¸€ä¸ªç±»éƒ½åº”å½“å°½å¯èƒ½çš„é™ä½å…¶æˆå‘˜å˜é‡å’Œæˆå‘˜æ–¹æ³•çš„è®¿é—®æƒé™ã€‚</li><li>åœ¨ç±»çš„è®¾è®¡ä¸Šï¼Œåªè¦æœ‰å¯èƒ½ï¼Œä¸€ä¸ªç±»å‹åº”å½“è®¾è®¡æˆä¸å˜ç±»ã€‚</li><li>åœ¨å¯¹å…¶ä»–ç±»çš„å¼•ç”¨ä¸Šï¼Œä¸€ä¸ªå¯¹è±¡å¯¹å…¶ä»–å¯¹è±¡çš„å¼•ç”¨åº”è¯¥é™åˆ°æœ€ä½ã€‚</li></ul><h3 id="ä¸‰ã€è¿ªç±³ç‰¹æ³•åˆ™æ —å­"><a href="#ä¸‰ã€è¿ªç±³ç‰¹æ³•åˆ™æ —å­" class="headerlink" title="ä¸‰ã€è¿ªç±³ç‰¹æ³•åˆ™æ —å­"></a>ä¸‰ã€è¿ªç±³ç‰¹æ³•åˆ™æ —å­</h3><h4 id="æ —å­ä¸€"><a href="#æ —å­ä¸€" class="headerlink" title="æ —å­ä¸€"></a>æ —å­ä¸€</h4><p>ä»¥ä¸‹æ˜¯å…³äºå…³é—­è®¡ç®—æœºçš„å¾ˆç»å…¸çš„æ¡ˆä¾‹ï¼Œå½“æˆ‘ä»¬æ‰‹åŠ¨æŒ‰ä¸‹è®¡ç®—æœºçš„å…³é—­æŒ‰é’®æ—¶ï¼Œç”µè„‘è¿˜ä¼šé™„å¸¦å…¶ä»–çš„åŠ¨ä½œï¼Œæ¯”å¦‚å…³é—­ç”µè„‘æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå…³é—­å…¶ä»–è¿è¡Œçš„ç¨‹åºï¼Œç„¶åå…³é—­æ˜¾ç¤ºå™¨ï¼Œæœ€åæ‰æŠŠç”µæºå…³é—­ã€‚</p><h5 id="ä¸æ»¡è¶³è¿ªç±³ç‰¹æ³•åˆ™"><a href="#ä¸æ»¡è¶³è¿ªç±³ç‰¹æ³•åˆ™" class="headerlink" title="ä¸æ»¡è¶³è¿ªç±³ç‰¹æ³•åˆ™"></a>ä¸æ»¡è¶³è¿ªç±³ç‰¹æ³•åˆ™</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Computer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveCurrentTask</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">closeService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">closeScreen</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">closePower</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">       saveCurrentTask();</span><br><span class="line">       closeService();</span><br><span class="line">       closeScreen();</span><br><span class="line">       closePower();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Computer computer;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clickCloseButton</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å…³é—­è®¡ç®—æœº, æ­£å¸¸æ¥è¯´ä½ åªè¦è°ƒç”¨close()æ–¹æ³•å³å¯</span></span><br><span class="line">        <span class="comment">// ä½†æ˜¯ä½ å‘ç°Computerç±»æ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯å…¬å¼€çš„, ä¸çŸ¥é“æ€ä¹ˆè°ƒç”¨äº†</span></span><br><span class="line">        computer.saveCurrentTask();</span><br><span class="line">        computer.closePower();</span><br><span class="line">        computer.close();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//ä¹Ÿå¯ä»¥æ˜¯</span></span><br><span class="line">        computer.closePower();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//è¿˜å¯ä»¥æ˜¯</span></span><br><span class="line">        computer.close();</span><br><span class="line">        computer.closePower();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä»¥ä¸Šçš„ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œäººè¿™ä¸ªç±»åœ¨è°ƒç”¨ç”µè„‘ç±»çš„æ–¹æ³•æ—¶å‘ç°ç”µè„‘ç±»æš´éœ²çš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œä¸çŸ¥é“è¯¥è°ƒç”¨å“ªä¸€ä¸ªï¼Œå¾ˆæ˜æ˜¾ï¼Œç”µè„‘è¿™ä¸ªç±»ä¸­çš„æ–¹æ³•æœ‰äº›æ‚ä¹±ï¼Œå¯¹äºæˆ‘ä»¬äººæ¥è¯´ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨å…³é—­ç”µè„‘çš„æ“ä½œï¼Œå…³é—­ç”µè„‘çš„æ–¹æ³•å°±å¯ä»¥äº†ï¼Œå…¶ä»–çš„æ–¹æ³•å®Œå…¨æ²¡æœ‰å¿…è¦æš´éœ²åœ¨å¤–ã€‚</p><h5 id="æ»¡è¶³è¿ªç±³ç‰¹æ³•åˆ™"><a href="#æ»¡è¶³è¿ªç±³ç‰¹æ³•åˆ™" class="headerlink" title="æ»¡è¶³è¿ªç±³ç‰¹æ³•åˆ™"></a>æ»¡è¶³è¿ªç±³ç‰¹æ³•åˆ™</h5><p>æ ¹æ®è¿ªç±³ç‰¹æ³•åˆ™åªæš´éœ²è¯¥æš´éœ²çš„æ–¹æ³•çš„è¦ä¹‰ä½œå‡ºå¦‚ä¸‹ä¿®æ”¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Computer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">saveCurrentTask</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">closeService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">closeScreen</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">closePower</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">       saveCurrentTask();</span><br><span class="line">       closeService();</span><br><span class="line">       closeScreen();</span><br><span class="line">       closePower();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Computer computer;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clickCloseButton</span><span class="params">()</span> &#123;</span><br><span class="line">        computer.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ —å­äºŒ"><a href="#æ —å­äºŒ" class="headerlink" title="æ —å­äºŒ"></a>æ —å­äºŒ</h4><p>æ˜æ˜Ÿä¸ç»çºªäººçš„ä¾‹å­ï¼Œåƒæˆ‘ä»¬æ™®é€šçš„æ˜æ˜Ÿå·¥ä½œç¹å¿™ï¼Œä»–çš„æ—¥å¸¸å·¥ä½œã€æ—¥ç¨‹å®‰æ’éƒ½æ˜¯ç”±é‚£ä¸ªç»çºªäººå¸¦åšï¼Œæ˜æ˜Ÿæ˜¯ä¸å¯èƒ½è‡ªå·±äº²åŠ›äº²ä¸ºçš„ï¼Œä¸ç„¶çš„è¯ä¼šå¾ˆç´¯ã€‚</p><h5 id="ä¸æ»¡è¶³è¿ªç±³ç‰¹æ³•åˆ™-1"><a href="#ä¸æ»¡è¶³è¿ªç±³ç‰¹æ³•åˆ™-1" class="headerlink" title="ä¸æ»¡è¶³è¿ªç±³ç‰¹æ³•åˆ™"></a>ä¸æ»¡è¶³è¿ªç±³ç‰¹æ³•åˆ™</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Star</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Project project;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">do</span><span class="params">()</span> &#123;</span><br><span class="line">        project.make();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Project</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">make</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç æ˜æ˜Ÿç›´æ¥å’Œå®‰æ’è¡Œç¨‹ç›´æ¥æœ‰å…³ç³»äº†ï¼ŒæŒ‰é“ç†æ˜æ˜Ÿä¸å¯èƒ½è‡ªå·±äº²åŠ›äº²ä¸ºï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥é€šè¿‡å¼•å…¥ä¸€ä¸ªç»çºªäººç±»å°†æ˜æ˜Ÿå’Œè¡Œç¨‹å…³è”èµ·æ¥ï¼Œä»»ä½•äº‹ç‰©éƒ½äº¤ç”±ç»çºªäººç±»ä»£ä¸ºå®‰æ’ï¼Œè¿™æ ·çš„è¯ä¾¿ç¬¦åˆæœ€å°ä¾èµ–åŸåˆ™ï¼Œæ˜æ˜Ÿç±»åªä¾èµ–ç»çºªäººç±»ï¼Œæ”¹é€ å¦‚ä¸‹ï¼š</p><h5 id="æ»¡è¶³è¿ªç±³ç‰¹æ³•åˆ™-1"><a href="#æ»¡è¶³è¿ªç±³ç‰¹æ³•åˆ™-1" class="headerlink" title="æ»¡è¶³è¿ªç±³ç‰¹æ³•åˆ™"></a>æ»¡è¶³è¿ªç±³ç‰¹æ³•åˆ™</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Star</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Business business;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">do</span><span class="params">()</span> &#123;</span><br><span class="line">        business.<span class="keyword">do</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Business</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Project project;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">do</span><span class="params">()</span> &#123;</span><br><span class="line">        project.make();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Project</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">make</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è¿ªç±³ç‰¹æ³•åˆ™ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JVM-å†…å­˜æ¨¡å‹</title>
      <link href="/2022/03/16/jvm-memory-model/"/>
      <url>/2022/03/16/jvm-memory-model/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h3 id="ä¸€ã€JDK1-6ã€JDK1-7ã€JDK1-8å†…å­˜æ¨¡å‹æ¼”å˜"><a href="#ä¸€ã€JDK1-6ã€JDK1-7ã€JDK1-8å†…å­˜æ¨¡å‹æ¼”å˜" class="headerlink" title="ä¸€ã€JDK1.6ã€JDK1.7ã€JDK1.8å†…å­˜æ¨¡å‹æ¼”å˜"></a>ä¸€ã€JDK1.6ã€JDK1.7ã€JDK1.8å†…å­˜æ¨¡å‹æ¼”å˜</h3><p>JDK1.6ã€JDK1.7ã€JDK1.8å†…å­˜æ¨¡å‹æ¼”å˜è§„ç¨‹å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://qtspace.cn/contentimg/7.jpg"></p><p>ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡ºè¿™äº›ç‰ˆæœ¬çš„JVMå†…å­˜æ¨¡å‹ä¸»è¦æœ‰ä»¥ä¸‹å·®å¼‚ï¼š</p><ul><li>JDK1.6ï¼šæœ‰æ°¸ä¹…ä»£ï¼Œé™æ€å˜é‡å­˜æ”¾åœ¨æ°¸ä¹…ä»£ï¼ˆæ–¹æ³•åŒºï¼‰ã€‚</li><li>JDK1.7ï¼šæœ‰æ°¸ä¹…ä»£ï¼Œä½†æ˜¯å·²ç»æŠŠå­—ç¬¦ä¸²å¸¸é‡æ± ã€é™æ€å˜é‡å­˜æ”¾åˆ°å †ä¸­ï¼Œé€æ¸å‡å°‘æ°¸ä¹…ä»£çš„ä½¿ç”¨ã€‚</li><li>JDK1.8ï¼šæ— æ°¸ä¹…ä»£ï¼Œè¿è¡Œæ—¶å¸¸é‡æ± ã€ç±»å¸¸é‡æ± éƒ½ä¿å­˜åˆ°å…ƒæ•°æ®åŒºï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„å…ƒç©ºé—´ã€‚ä½†å­—ç¬¦ä¸²å¸¸é‡æ± ä»å­˜åœ¨å †ä¸­ã€‚</li></ul><h3 id="äºŒã€JVMè¿è¡Œæ—¶å†…å­˜åŒºåŸŸæ¦‚è¿°"><a href="#äºŒã€JVMè¿è¡Œæ—¶å†…å­˜åŒºåŸŸæ¦‚è¿°" class="headerlink" title="äºŒã€JVMè¿è¡Œæ—¶å†…å­˜åŒºåŸŸæ¦‚è¿°"></a>äºŒã€JVMè¿è¡Œæ—¶å†…å­˜åŒºåŸŸæ¦‚è¿°</h3><p><code>JVM</code>åœ¨è¿è¡Œæ—¶<code>Javaç¨‹åº</code>æ—¶ï¼Œä¼šæŠŠç®¡ç†çš„å†…å­˜åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªåŒºåŸŸï¼Œæ¯ä¸ªåŒºåŸŸéƒ½æœ‰è‡ªå·±çš„ç”¨é€”å’Œåˆ›å»ºé”€æ¯æ—¶é—´ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¯ä»¥åˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼Œçº¿ç¨‹ç§æœ‰åŒºåŸŸå’Œçº¿ç¨‹å…±äº«åŒºåŸŸã€‚çº¿ç¨‹ç§æœ‰åŒºåŸŸåŒ…æ‹¬ï¼šè™šæ‹Ÿæœºæ ˆã€æœ¬åœ°æ–¹æ³•æ ˆã€ç¨‹åºè®¡æ•°å™¨ï¼Œçº¿ç¨‹å…±äº«åŒºåŸŸåŒ…æ‹¬ï¼šJavaå †ã€æ–¹æ³•åŒºã€‚</p><p><img src="https://qtspace.cn/contentimg/6.jpg"></p><h4 id="çº¿ç¨‹ç§æœ‰åŒºåŸŸ"><a href="#çº¿ç¨‹ç§æœ‰åŒºåŸŸ" class="headerlink" title="çº¿ç¨‹ç§æœ‰åŒºåŸŸ"></a>çº¿ç¨‹ç§æœ‰åŒºåŸŸ</h4><h5 id="è™šæ‹Ÿæœºæ ˆ"><a href="#è™šæ‹Ÿæœºæ ˆ" class="headerlink" title="è™šæ‹Ÿæœºæ ˆ"></a>è™šæ‹Ÿæœºæ ˆ</h5><p>çº¿ç¨‹ç§æœ‰çš„ï¼Œä¸çº¿ç¨‹åŒä¸€æ—¶é—´åˆ›å»ºï¼Œç®¡ç†Javaæ–¹æ³•æ‰§è¡Œæ—¶çš„å†…å­˜æ¨¡å¼ã€‚æ¯ä¸ªæ–¹æ³•æ‰§è¡Œçš„æ—¶å€™éƒ½ä¼šåˆ›å»ºä¸€ä¸ªå¸§æ ˆæ¥å‚¨å­˜æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°å¸§ã€åŠ¨æ€é“¾æ¥æ–¹æ³•ã€è¿”å›å€¼ã€è¿”å›åœ°å€ç­‰ä¿¡æ¯ã€‚æ ˆçš„å¤§å°å†³å®šäº†æ–¹æ³•å¯è°ƒç”¨çš„æ·±åº¦ï¼ˆé€’å½’å¤šå°‘å±‚æ¬¡ï¼Œæˆ–åµŒå¥—è°ƒç”¨å¤šå°‘å±‚å…¶ä»–æ–¹æ³•ï¼Œ<code>-Xss</code>å‚æ•°å¯ä»¥è®¾ç½®è™šæ‹Ÿæœºæ ˆå¤§å°ï¼‰ã€‚æ ˆçš„å¤§å°å¯ä»¥æ˜¯å›ºå®šçš„ï¼Œæˆ–è€…æ˜¯åŠ¨æ€æ‰©å±•çš„ã€‚å¦‚æœè¯·æ±‚çš„æ·±åº¦è¶…è¿‡æœ€å¤§å¯ç”¨æ·±åº¦ï¼Œåˆ™ä¼šæŠ›å‡º<code>stackOverflowError</code>é”™è¯¯ï¼›å¦‚æœæ ˆæ˜¯å¯åŠ¨æ€æ‰©å±•çš„ï¼Œä½†æ²¡æœ‰å†…å­˜ç©ºé—´æ”¯æŒæ‰©å±•ï¼Œåˆ™æŠ›å‡º<code>OutofMemeryError</code>é”™è¯¯ã€‚</p><ul><li>å±€éƒ¨å˜é‡è¡¨ï¼šæ˜¯ä¸€ç»„<strong>å˜é‡å€¼å­˜å‚¨ç©ºé—´</strong>ï¼Œå­˜æ”¾æ–¹æ³•çš„å‚æ•°ä»¥åŠå±€éƒ¨å˜é‡ï¼Œä»¥åŠç¼–è¯‘æœŸé—´å¯çŸ¥çš„å…«å¤§åŸºæœ¬æ•°æ®ç±»å‹ï¼Œå¯¹è±¡å¼•ç”¨å’Œ returnAddressç±»å‹ï¼ˆæŒ‡å‘äº†ä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ï¼‰ã€‚</li><li>æ“ä½œæ•°å¸§ï¼šä¿å­˜è®¡ç®—è¿‡ç¨‹ä¸­çš„ä¸­é—´ç»“æœï¼ŒåŒæ—¶ä½œä¸ºè®¡ç®—è¿‡ç¨‹ä¸­å˜é‡çš„ä¸´æ—¶å‚¨å­˜ç©ºé—´ã€‚</li></ul><h5 id="æœ¬åœ°æ–¹æ³•æ ˆ"><a href="#æœ¬åœ°æ–¹æ³•æ ˆ" class="headerlink" title="æœ¬åœ°æ–¹æ³•æ ˆ"></a>æœ¬åœ°æ–¹æ³•æ ˆ</h5><p>ä¸è™šæ‹Ÿæœºæ ˆç»“æ„ä½œç”¨ç›¸ä¼¼ã€‚ä¸åŒçš„æ˜¯è™šæ‹Ÿæœºæ ˆä¸ºJavaæ–¹æ³•æœåŠ¡ï¼Œæœ¬åœ°æ–¹æ³•æ ˆä¸ºæœ¬åœ°æ–¹æ³•æœåŠ¡ï¼ˆnativeæ–¹æ³•ï¼‰ã€‚</p><h5 id="ç¨‹åºè®¡æ•°å™¨"><a href="#ç¨‹åºè®¡æ•°å™¨" class="headerlink" title="ç¨‹åºè®¡æ•°å™¨"></a>ç¨‹åºè®¡æ•°å™¨</h5><p>è¾ƒå°çš„å†…å­˜ç©ºé—´ï¼Œè®°å½•è¿™å½“å‰çº¿ç¨‹æ‰€æ‰§è¡Œçš„å­—èŠ‚ç çš„è¡Œå·ï¼Œå­—èŠ‚ç è§£æçš„æ—¶å€™é€šè¿‡æ”¹å˜ç¨‹åºè®¡æ•°å™¨çš„å€¼æ¥è·å–ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„æŒ‡å®šã€‚åœ¨å¤šçº¿ç¨‹ç¨‹åºä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„ç¨‹åºè®¡æ•°å™¨ï¼Œæ‰€ä»¥ç¨‹åºè®¡æ•°å™¨æ˜¯ç§æœ‰çš„ã€‚å¦‚æœç¨‹åºæ‰§è¡Œçš„æ˜¯Javaæ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªç¨‹åºè®¡æ•°å™¨è®°å½•ç€å½“å‰æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤åœ°å€ï¼Œå¦‚æœæ‰§è¡Œçš„æ˜¯ä¸€ä¸ª<code>navtive</code>æ–¹æ³•ï¼Œåˆ™è®¡æ•°å™¨ä¸ºç©ºã€‚ç¨‹åºè®¡æ•°å™¨åŒºåŸŸæ²¡æœ‰ä»»ä½•<code>OutOfMemoryError</code>å®šä¹‰ã€‚</p><h4 id="çº¿ç¨‹å…±äº«åŒºåŸŸ"><a href="#çº¿ç¨‹å…±äº«åŒºåŸŸ" class="headerlink" title="çº¿ç¨‹å…±äº«åŒºåŸŸ"></a>çº¿ç¨‹å…±äº«åŒºåŸŸ</h4><h5 id="Javaå †"><a href="#Javaå †" class="headerlink" title="Javaå †"></a>Javaå †</h5><p>Javaå †æ˜¯è¢«æ‰€æœ‰çº¿ç¨‹å…±äº«çš„ä¸€å—å†…å­˜åŒºåŸŸï¼Œå­˜æ”¾å¯¹è±¡å®ä¾‹å’Œæ•°ç»„ï¼Œæ˜¯åƒåœ¾å›æ”¶çš„ä¸»è¦åŒºåŸŸï¼Œåˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€ç”Ÿä»£ã€‚åˆšåˆ›å»ºçš„å¯¹è±¡åœ¨æ–°ç”Ÿä»£<code>EdenåŒº</code>ä¸­ï¼Œç»è¿‡GCåè¿›å…¥æ–°ç”Ÿä»£çš„<code>S0åŒº</code>ï¼Œå†ç»è¿‡GCè¿›å…¥æ–°ç”Ÿä»£çš„<code>S1åŒº</code>ï¼Œ<code>15</code>æ¬¡GCåæ‰”å­˜åœ¨åˆ™è¿›å…¥<code>è€ç”Ÿä»£</code>ã€‚è‹¥å †çš„ç©ºé—´ä¸å¤Ÿå®ä¾‹çš„åˆ†é…ï¼Œåˆ™ä¼šæŠ›å‡º<code>OutofMemeryError</code>é”™è¯¯ã€‚</p><h5 id="JDK8å…ƒç©ºé—´"><a href="#JDK8å…ƒç©ºé—´" class="headerlink" title="JDK8å…ƒç©ºé—´"></a>JDK8å…ƒç©ºé—´</h5><p>å…ƒç©ºé—´æ˜¯ä»è™šæ‹ŸæœºJavaå †ä¸­è½¬ç§»åˆ°æœ¬åœ°å†…å­˜ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå…ƒç©ºé—´çš„å¤§å°å—æœ¬åœ°å†…å­˜çš„é™åˆ¶ï¼Œè¯´ç™½äº†ä¹Ÿå°±æ˜¯ä»¥åä¸ä¼šå› ä¸ºæ°¸ä¹…ä»£ç©ºé—´ä¸å¤Ÿè€ŒæŠ›å‡º OOM å¼‚å¸¸å‡ºç°äº†ã€‚ jdk1.8 ä»¥å‰ç‰ˆæœ¬çš„ class å’Œ JAR åŒ…æ•°æ®å­˜å‚¨åœ¨ PermGen ä¸‹é¢ PermGen å¤§å°æ˜¯å›ºå®šçš„ï¼Œè€Œä¸”é¡¹ç›®ä¹‹é—´æ— æ³•å…±ç”¨ï¼Œå…¬æœ‰çš„ class ï¼Œæ‰€ä»¥æ¯”è¾ƒå®¹æ˜“å‡ºç° OOM å¼‚å¸¸ã€‚</p><h5 id="æ–¹æ³•åŒº"><a href="#æ–¹æ³•åŒº" class="headerlink" title="æ–¹æ³•åŒº"></a>æ–¹æ³•åŒº</h5><p>æ–¹æ³•åŒºæ˜¯çº¿ç¨‹å…±äº«çš„ï¼Œç”¨äºå­˜æ”¾è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ä»¥åŠå³æ—¶ç¼–è¯‘æœŸç¼–è¯‘åçš„ä»£ç ã€‚</p><h3 id="ä¸‰ã€å †å’Œæ ˆçš„åŒºåˆ«"><a href="#ä¸‰ã€å †å’Œæ ˆçš„åŒºåˆ«" class="headerlink" title="ä¸‰ã€å †å’Œæ ˆçš„åŒºåˆ«"></a>ä¸‰ã€å †å’Œæ ˆçš„åŒºåˆ«</h3><p>æ ˆæ˜¯è¿è¡Œæ—¶å•ä½ï¼Œä»£è¡¨è¿™é€»è¾‘ï¼Œå‚¨å­˜åŸºæœ¬ç±»å‹å’Œå †ä¸­å¯¹è±¡å¼•ç”¨ï¼Œæ‰€åœ¨åŒºè¿ç»­ï¼Œæ²¡æœ‰ç¢ç‰‡ï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚</p><p>å †æ˜¯å‚¨å­˜å•ä½ï¼Œä»£è¡¨è¿™æ•°æ®ï¼Œå¯è¢«å¤šä¸ªæ ˆå…±äº«ï¼Œæ‰€åœ¨åŒºåŸŸè¿ç»­ï¼Œä¼šæœ‰ç¢ç‰‡ï¼Œæ˜¯çº¿ç¨‹å…±äº«çš„ã€‚</p><ul><li>åŠŸèƒ½ä¸åŒï¼šæ ˆå†…å­˜æ˜¯å­˜å‚¨å±€éƒ¨å˜é‡å’Œæ–¹æ³•è°ƒç”¨ã€å †ä¸­å¯¹è±¡å¼•ç”¨ï¼Œè€Œå †æ˜¯ç”¨æ¥å‚¨å­˜å¯¹è±¡çš„ï¼Œæ— è®ºæ˜¯æˆå‘˜å˜é‡ã€å±€éƒ¨å˜é‡è¿˜æ˜¯ç±»å˜é‡ï¼Œå®ƒä»¬æŒ‡å‘çš„å¯¹è±¡éƒ½å‚¨å­˜åœ¨å †å†…å­˜ä¸­ã€‚</li><li>å…±äº«æ€§ä¸åŒï¼šæ ˆæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œå †æ˜¯çº¿ç¨‹å…±äº«çš„ã€‚</li><li>å¼‚å¸¸é”™è¯¯ä¸åŒï¼šå¦‚æœæ ˆå†…å­˜æˆ–è€…å †å†…å­˜ä¸è¶³éƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ ˆæŠ›å‡ºçš„é”™æ˜¯<code>java.lang.StackOverFlowError</code>ï¼Œå †å†…å­˜æŠ›å‡ºçš„é”™æ˜¯<code>java.lang.OutOfMemoryError</code>ã€‚</li><li>ç©ºé—´å¤§å°ï¼šæ ˆçš„ç©ºé—´è¿œè¿œå°äºå †çš„ã€‚</li></ul><h3 id="å››ã€OOMå¸¸è§çš„åŸå› "><a href="#å››ã€OOMå¸¸è§çš„åŸå› " class="headerlink" title="å››ã€OOMå¸¸è§çš„åŸå› "></a>å››ã€OOMå¸¸è§çš„åŸå› </h3><ul><li>å†…å­˜åŠ è½½çš„æ•°æ®é‡å¤ªå¤§ï¼šä¸€æ¬¡æ€§ä»æ•°æ®åº“è¯»å–å¤šæ•°æ®ã€‚</li><li>é›†åˆç±»ä¸­æœ‰å¯¹å¯¹è±¡çš„å¼•ç”¨ï¼Œä½¿ç”¨åæœªæ¸…ç©ºï¼ŒGCä¸èƒ½è¿›è¡Œå›æ”¶ã€‚</li><li>ä»£ç ä¸­å­˜åœ¨å¾ªç¯äº§ç”Ÿè¿‡å¤šçš„å¯¹è±¡ã€‚</li><li>å¯åŠ¨å‚æ•°å †å†…å­˜å€¼å°ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> JVM </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…å­˜æ¨¡å‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…­å¤§è®¾è®¡æ¨¡å¼åŸåˆ™-é‡Œæ°æ›¿æ¢åŸåˆ™</title>
      <link href="/2022/03/15/design-mode-lsp/"/>
      <url>/2022/03/15/design-mode-lsp/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h3 id="ä¸€ã€é‡Œæ°æ›¿æ¢åŸåˆ™å®šä¹‰"><a href="#ä¸€ã€é‡Œæ°æ›¿æ¢åŸåˆ™å®šä¹‰" class="headerlink" title="ä¸€ã€é‡Œæ°æ›¿æ¢åŸåˆ™å®šä¹‰"></a>ä¸€ã€é‡Œæ°æ›¿æ¢åŸåˆ™å®šä¹‰</h3><p>é‡Œæ°æ›¿æ¢åŸåˆ™æ˜¯å®ç°å¼€é—­åŸåˆ™çš„é‡è¦æ–¹å¼ä¹‹ä¸€ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š<br>é‡Œæ°æ›¿æ¢åŸåˆ™ï¼ˆLiskov Substitution Principleï¼ŒLSPï¼‰ï¼š<strong>ç»§æ‰¿å¿…é¡»ç¡®ä¿è¶…ç±»æ‰€æ‹¥æœ‰çš„æ€§è´¨åœ¨å­ç±»ä¸­å¿…é¡»ä»ç„¶æˆç«‹</strong>ã€‚</p><p>é‡Œæ°æ›¿æ¢åŸåˆ™è®²è¿°äº†æœ‰å…³ç»§æ‰¿çš„ä¸€äº›åŸåˆ™ï¼Œå®šä¹‰äº†ä»€ä¹ˆæ—¶å€™è¯¥ç”¨ç»§æ‰¿ï¼Œä»€ä¹ˆæ—¶å€™ä¸è¯¥ç”¨ç»§æ‰¿ã€‚é‡Œæ°æ›¿æ¢åŸåˆ™æ˜¯ç»§æ‰¿å¤ç”¨çš„åŸºç¡€ï¼Œååº”äº†çˆ¶ç±»å’Œå­ç±»ä¹‹é—´çš„å…³ç³»ï¼Œæ˜¯å¯¹å¼€é—­åŸåˆ™çš„è¡¥å……ï¼Œæ˜¯å¯¹å®ç°æŠ½è±¡åŒ–çš„å…·ä½“æ­¥éª¤çš„è§„èŒƒã€‚</p><h3 id="äºŒã€é‡Œæ°æ›¿æ¢åŸåˆ™çš„ä½œç”¨"><a href="#äºŒã€é‡Œæ°æ›¿æ¢åŸåˆ™çš„ä½œç”¨" class="headerlink" title="äºŒã€é‡Œæ°æ›¿æ¢åŸåˆ™çš„ä½œç”¨"></a>äºŒã€é‡Œæ°æ›¿æ¢åŸåˆ™çš„ä½œç”¨</h3><p>é‡Œæ°æ›¿æ¢åŸåˆ™çš„ä½œç”¨ä¸»è¦å¦‚ä¸‹ï¼š</p><ul><li>é‡Œæ°æ›¿æ¢åŸåˆ™æ˜¯å®ç°å¼€é—­åŸåˆ™çš„é‡è¦æ–¹å¼ä¹‹ä¸€ã€‚</li><li>å…‹æœäº†ç»§æ‰¿ä¸­é‡å†™çˆ¶ç±»é€ æˆçš„å¯å¤ç”¨æ€§å˜å·®çš„ç¼ºç‚¹ã€‚</li><li>æ˜¯åŠ¨ä½œæ­£ç¡®æ€§çš„ç¡®ä¿ï¼Œå³ç±»çš„æ‰©å±•ä¸ä¼šç»™å·²æœ‰çš„ç³»ç»Ÿé€ æˆé”™è¯¯ï¼Œé™ä½ä»£ç ä»£ç å‡ºé”™çš„å¯èƒ½æ€§ã€‚</li><li>åŠ å¼ºç¨‹åºçš„å¥å£®æ€§ï¼ŒåŒæ—¶åšåˆ°éå¸¸å¥½çš„å…¼å®¹æ€§ï¼Œæé«˜ç¨‹åºçš„ç»´æŠ¤æ€§ã€å¯æ‰©å±•æ€§ï¼Œé™ä½éœ€æ±‚å˜æ›´å¸¦æ¥çš„é£é™©ã€‚</li></ul><h3 id="ä¸‰ã€é‡Œæ°æ›¿æ¢åŸåˆ™çš„å®ç°æ–¹æ³•"><a href="#ä¸‰ã€é‡Œæ°æ›¿æ¢åŸåˆ™çš„å®ç°æ–¹æ³•" class="headerlink" title="ä¸‰ã€é‡Œæ°æ›¿æ¢åŸåˆ™çš„å®ç°æ–¹æ³•"></a>ä¸‰ã€é‡Œæ°æ›¿æ¢åŸåˆ™çš„å®ç°æ–¹æ³•</h3><p>é‡Œæ°æ›¿æ¢åŸåˆ™é€šä¿—çš„è®²å°±æ˜¯ï¼š<strong>å­ç±»å¯ä»¥æ‰©å±•çˆ¶ç±»çš„åŠŸèƒ½ï¼Œä½†ä¸èƒ½æ”¹å˜çˆ¶ç±»åŸæœ‰çš„åŠŸèƒ½</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå­ç±»ç»§æ‰¿çˆ¶ç±»çš„æ—¶å€™ï¼Œé™¤äº†æ·»åŠ æ–°çš„æ–¹æ³•æ‰©å±•åŠŸèƒ½ä¹‹å¤–ï¼Œå°½é‡ä¸è¦é‡å†™çˆ¶ç±»çš„æ–¹æ³•ã€‚</p><p>æ ¹æ®ä¸Šè¿°ç†è§£ï¼Œå¯¹é‡Œæ°æ›¿æ¢åŸåˆ™çš„å®ç°å¯ä»¥æ€»ç»“å¦‚ä¸‹ï¼š</p><ul><li>å­ç±»å¯ä»¥å®ç°çˆ¶ç±»çš„æŠ½è±¡æ–¹æ³•ï¼Œä½†æ˜¯ä¸èƒ½è¦†ç›–çˆ¶ç±»éæŠ½è±¡çš„æ–¹æ³•ã€‚</li><li>å­ç±»ä¸­å¯ä»¥å¢åŠ è‡ªå·±ç‰¹æœ‰çš„æ–¹æ³•ã€‚</li><li>å½“å­ç±»é‡å†™çˆ¶ç±»çš„æ–¹æ³•æ—¶ï¼Œæ–¹æ³•çš„å…¥å‚åº”è¯¥æ¯”çˆ¶ç±»çš„æ–¹æ³•æ›´åŠ å®½æ¾ã€‚</li><li>å½“å­ç±»çš„æ–¹æ³•å®ç°çˆ¶ç±»çš„æ–¹æ³•æ—¶ï¼ˆé‡å†™&#x2F;é‡è½½&#x2F;æˆ–å®ç°æŠ½è±¡æ–¹æ³•ï¼‰ï¼Œæ–¹æ³•çš„è¿”å›å€¼åº”è¯¥æ¯”çˆ¶ç±»æ›´åŠ ä¸¥æ ¼æˆ–è€…ç›¸ç­‰ã€‚</li></ul><p>é€šè¿‡é‡å†™çˆ¶ç±»çš„æ–¹æ³•æ¥å®Œæˆæ–°çš„åŠŸèƒ½å†™èµ·æ¥ç®€å•ï¼Œä½†æ˜¯æ•´ä¸ªç»§æ‰¿ä½“ç³»ä¸­å¤ç”¨æ€§å¾ˆæ¯”è¾ƒå·®ï¼Œç‰¹åˆ«æ˜¯è¿ç”¨å¤šæ€æ¯”è¾ƒé¢‘ç¹æ—¶ï¼Œç¨‹åºå‡ºé”™çš„æ¦‚ç‡ä¼šéå¸¸å¤§ã€‚å¦‚æœè¿èƒŒäº†é‡Œæ°æ›¿æ¢åŸåˆ™ï¼Œåˆ™ç»§æ‰¿ç±»çš„å¯¹è±¡å†çˆ¶ç±»å‡ºç°çš„åœ°æ–¹å°±ä¼šå‡ºç°è¿è¡Œé”™è¯¯ï¼Œä¿®æ­£æ–¹æ³•æ˜¯ï¼šå–æ¶ˆåŸæ¥çš„ç»§æ‰¿å…³ç³»ï¼Œé‡æ–°è®¾è®¡å®ƒä»¬ä¹‹é—´çš„å…³ç³»ã€‚</p><h3 id="å››ã€é‡Œæ°æ›¿æ¢åŸåˆ™æ —å­"><a href="#å››ã€é‡Œæ°æ›¿æ¢åŸåˆ™æ —å­" class="headerlink" title="å››ã€é‡Œæ°æ›¿æ¢åŸåˆ™æ —å­"></a>å››ã€é‡Œæ°æ›¿æ¢åŸåˆ™æ —å­</h3><p>å…³äºé‡Œæ°æ›¿æ¢åŸåˆ™æœ€æœ‰åçš„æ —å­å°±æ˜¯â€œæ­£æ–¹å½¢ä¸æ˜¯é•¿æ–¹å½¢â€ã€‚å½“ç„¶ï¼Œç”Ÿæ´»ä¸­è¿˜å¾ˆå¤šç±»ä¼¼çš„æ —å­ï¼Œæ¯”å¦‚ï¼šä¼é¹…ã€é¸µé¸Ÿå’Œå‡ ç»´é¸Ÿä»ç”Ÿç‰©å­¦çš„è§’åº¦æ¥åˆ’åˆ†æ˜¯å±äºé¸Ÿç±»ï¼Œä½†æ˜¯ä»ç±»çš„ç»§æ‰¿å…³ç³»æ¥è¯´ï¼Œç”±äºå®ƒä»¬ä¸èƒ½ç»§æ‰¿â€é¸Ÿâ€ä¼šé£çš„åŠŸèƒ½ï¼Œæ‰€ä»¥ä¸èƒ½æŠŠå®ƒä»¬å®šä¹‰ä¸ºâ€é¸Ÿâ€çš„å­ç±»ã€‚</p><h4 id="ä¸æ»¡è¶³é‡Œæ°æ›¿æ¢åŸåˆ™"><a href="#ä¸æ»¡è¶³é‡Œæ°æ›¿æ¢åŸåˆ™" class="headerlink" title="ä¸æ»¡è¶³é‡Œæ°æ›¿æ¢åŸåˆ™"></a>ä¸æ»¡è¶³é‡Œæ°æ›¿æ¢åŸåˆ™</h4><p>å‡ ç»´é¸Ÿä¸æ˜¯é¸Ÿä¸æ»¡è¶³é‡Œæ°æ›¿æ¢åŸåˆ™æ —å­ã€‚</p><p>åˆ†æï¼šé¸Ÿä¸€èˆ¬éƒ½ä¼šé£è¡Œï¼Œå¦‚ç‡•å­çš„é£è¡Œé€Ÿåº¦å¤§æ¦‚æ˜¯æ¯å°æ—¶120åƒç±³ã€‚ä½†æ˜¯æ–°è¥¿å…°çš„å‡ ç»´é¸Ÿç”±äºç¿…è†€é€€åŒ–åŸºæœ¬ä¸ä¼šé£è¡Œï¼Œå‡å¦‚è¦è®¾è®¡ä¸€ä¸ªå®ä¾‹ï¼Œè®¡ç®—è¿™ä¸¤ç§é¸Ÿé£è¡Œ300åƒç±³è¦èŠ±è´¹çš„æ—¶é—´ï¼Œæ˜¾ç„¶æ‹¿ç‡•å­æ¥æµ‹è¯•è¿™æ®µä»£ç æ²¡é—®é¢˜ï¼Œä½†æ˜¯æ‹¿å‡ ç»´é¸Ÿæ¥è¿™æµ‹è¯•ï¼Œç»“æœä¼šæŠ¥é”™ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LSPTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Bird</span> <span class="variable">bird1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Swallow</span>();</span><br><span class="line">        <span class="type">Bird</span> <span class="variable">bird2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BrownKiwi</span>();</span><br><span class="line">        bird1.setFlySpeed(<span class="number">120</span>);</span><br><span class="line">        bird2.setFlySpeed(<span class="number">120</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;å¦‚æœé£è¡Œ300å…¬é‡Œï¼š&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ç‡•å­å°†é£è¡Œ&quot;</span> + bird1.getFlyTime(<span class="number">300</span>) + <span class="string">&quot;å°æ—¶.&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;å‡ ç»´é¸Ÿå°†é£è¡Œ&quot;</span> + bird2.getFlyTime(<span class="number">300</span>) + <span class="string">&quot;å°æ—¶ã€‚&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception err) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å‘ç”Ÿé”™è¯¯äº†!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bird</span> &#123;</span><br><span class="line">    <span class="type">double</span> flySpeed;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setFlySpeed</span><span class="params">(<span class="type">double</span> flySpeed)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.flySpeed = flySpeed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getFlyTime</span><span class="params">(<span class="type">double</span> distance)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (distance/ flySpeed);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Swallow</span>  <span class="keyword">extends</span> <span class="title class_">Bird</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BrownKiwi</span> <span class="keyword">extends</span> <span class="title class_">Bird</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setFlySpeed</span><span class="params">(<span class="type">double</span> speed)</span> &#123;</span><br><span class="line">        flySpeed = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å¦‚æœé£è¡Œ300å…¬é‡Œï¼š</span><br><span class="line">ç‡•å­å°†é£è¡Œ2.5å°æ—¶.</span><br><span class="line">å‡ ç»´é¸Ÿå°†é£è¡ŒInfinityå°æ—¶ã€‚</span><br></pre></td></tr></table></figure><p>ç¨‹åºå‡ºé”™çš„åŸå› æ˜¯å› ä¸ºå‡ ç»´é¸Ÿä¸ä¼šé£è¡Œï¼Œæ‰€ä»¥æ²¡æœ‰é£è¡Œé€Ÿåº¦ï¼Œæ‰€ä»¥é‡å†™äº†<code>setSpeed()</code>æ–¹æ³•ï¼Œå¯¼è‡´<code>getFlyTime()</code>æ–¹æ³•æŠ¥é”™ï¼Œè¿èƒŒäº†é‡Œæ°æ›¿æ¢åŸåˆ™ã€‚</p><h4 id="é‡æ„æ»¡è¶³é‡Œæ°æ›¿æ¢åŸåˆ™"><a href="#é‡æ„æ»¡è¶³é‡Œæ°æ›¿æ¢åŸåˆ™" class="headerlink" title="é‡æ„æ»¡è¶³é‡Œæ°æ›¿æ¢åŸåˆ™"></a>é‡æ„æ»¡è¶³é‡Œæ°æ›¿æ¢åŸåˆ™</h4><p>å–æ¶ˆå‡ ç»´é¸Ÿå’Œé¸Ÿçš„ç»§æ‰¿å…³ç³»ï¼Œå®šä¹‰é¸Ÿå’Œå‡ ç»´é¸Ÿæ›´ä¸€èˆ¬çš„çˆ¶ç±»ï¼Œå¦‚åŠ¨ç‰©ç±»ï¼Œä»–ä»¬éƒ½å…·å¤‡å¥”è·‘çš„èƒ½åŠ›ï¼Œå‡ ç»´é¸Ÿçš„é£è¡Œé€Ÿåº¦è™½ç„¶ä¸º0ï¼Œä½†æ˜¯å¥”è·‘é€Ÿåº¦ä¸ä¸º0ï¼Œæ‰€ä»¥æˆ‘ä»¬æ–°å¢ä¸€ä¸ªçˆ¶ç±»<code>Animal</code>ç±»ï¼Œ<code>BrownKiwi</code>ç±»ç»§æ‰¿<code>Animal</code>ç±»ï¼Œæ‹¥æœ‰å¥”è·‘é€Ÿåº¦ï¼Œé€šè¿‡å¥”è·‘é€Ÿåº¦è®¡ç®—æ—¶é—´ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LSPTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Bird</span> <span class="variable">bird1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Swallow</span>();</span><br><span class="line">        <span class="type">Animal</span> <span class="variable">bird2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BrownKiwi</span>();</span><br><span class="line">        bird1.setSpeed(<span class="number">120</span>);</span><br><span class="line">        bird2.setRunSpeed(<span class="number">120</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;å¦‚æœé£è¡Œ300å…¬é‡Œï¼š&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ç‡•å­å°†é£è¡Œ&quot;</span> + bird1.getFlyTime(<span class="number">300</span>) + <span class="string">&quot;å°æ—¶.&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;å‡ ç»´é¸Ÿå°†é£è¡Œ&quot;</span> + bird2.getRunTime(<span class="number">300</span>) + <span class="string">&quot;å°æ—¶ã€‚&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception err) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å‘ç”Ÿé”™è¯¯äº†!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> runSpeed;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRunSpeed</span><span class="params">(<span class="type">double</span> runSpeed)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.runSpeed = runSpeed;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getRunTime</span> <span class="params">(<span class="type">double</span> distance)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (distance/ runSpeed);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bird</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> flySpeed;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setFlySpeed</span><span class="params">(<span class="type">double</span> flySpeed)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.flySpeed = flySpeed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getFlyTime</span><span class="params">(<span class="type">double</span> distance)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (distance/ flySpeed);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Swallow</span>  <span class="keyword">extends</span> <span class="title class_">Bird</span> &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BrownKiwi</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¾“å‡ºç»“æœä¸ºï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å¦‚æœé£è¡Œ300å…¬é‡Œï¼š</span><br><span class="line">ç‡•å­å°†é£è¡Œ2.5å°æ—¶.</span><br><span class="line">å‡ ç»´é¸Ÿå°†é£è¡Œ2.5å°æ—¶ã€‚</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é‡Œæ°æ›¿æ¢åŸåˆ™ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…­å¤§è®¾è®¡æ¨¡å¼åŸåˆ™-å¼€é—­åŸåˆ™</title>
      <link href="/2022/03/14/deisgn-model-opc/"/>
      <url>/2022/03/14/deisgn-model-opc/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h3 id="ä¸€ã€å¼€é—­åŸåˆ™å®šä¹‰"><a href="#ä¸€ã€å¼€é—­åŸåˆ™å®šä¹‰" class="headerlink" title="ä¸€ã€å¼€é—­åŸåˆ™å®šä¹‰"></a>ä¸€ã€å¼€é—­åŸåˆ™å®šä¹‰</h3><p>å¼€é—­åŸåˆ™æ˜¯é¢å‘å¯¹è±¡çš„å¯å¤ç”¨è®¾è®¡çš„ç¬¬ä¸€å—åŸºçŸ³ï¼Œæ˜¯æœ€é‡è¦çš„é¢å‘å¯¹è±¡è®¾è®¡åŸåˆ™ã€‚å®šä¹‰å¦‚ä¸‹ï¼š</p><p><strong>å¼€é—­åŸåˆ™(<em>Open-Closed Principle, OCP</em>)ï¼šä¸€ä¸ªè½¯ä»¶å®ä½“åº”å½“å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ã€‚å³è½¯ä»¶å®ä½“åº”å°½é‡åœ¨ä¸ä¿®æ”¹åŸæœ‰ä»£ç çš„æƒ…å†µä¸‹è¿›è¡Œæ‰©å±•ã€‚</strong></p><p>åœ¨å¼€é—­åŸåˆ™çš„å®šä¹‰ä¸­ï¼Œè¿™ä¸ªè½¯ä»¶å®ä½“å¯ä»¥æ˜¯ä¸€ä¸ªè½¯ä»¶æ¨¡å—ã€ä¸€ä¸ªç”±å¤šä¸ªç±»ç»„æˆçš„å±€éƒ¨ç»“æ„æˆ–è€…ä¸€ä¸ªç‹¬ç«‹çš„ç±»ã€‚</p><h3 id="äºŒã€å¼€é—­åŸåˆ™æè¿°"><a href="#äºŒã€å¼€é—­åŸåˆ™æè¿°" class="headerlink" title="äºŒã€å¼€é—­åŸåˆ™æè¿°"></a>äºŒã€å¼€é—­åŸåˆ™æè¿°</h3><p>ä»»ä½•ç³»ç»Ÿéƒ½éœ€è¦é¢ä¸´ä¸€ä¸ªå¾ˆé‡è¦çš„é—®é¢˜ï¼Œå°±æ˜¯å®ƒä»¬çš„éœ€æ±‚ä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œå‘ç”Ÿå˜åŒ–ã€‚å½“è½¯ä»¶ç³»ç»Ÿéœ€è¦é¢å¯¹æ–°çš„éœ€æ±‚æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡ä¿è¯ç³»ç»Ÿçš„è®¾è®¡æ¶æ„æ˜¯ç¨³å®šçš„ã€‚å¦‚æœä¸€ä¸ªè½¯ä»¶ç³»ç»Ÿæ»¡è¶³å¼€é—­åŸåˆ™ï¼Œé‚£ä¹ˆå®ƒå¯ä»¥éå¸¸æ–¹ä¾¿çš„è¿›è¡Œæ‰©å±•ï¼Œè€Œä¸”å¯ä»¥åœ¨ä¸ä¿®æ”¹å…ˆæœ‰ä»£ç çš„å‰æä¸‹è¿›è¡Œæ‰©å±•ï¼Œä½¿å¾—è½¯ä»¶ç³»ç»Ÿåœ¨æ‹¥æœ‰é€‚åº”æ€§å’Œçµæ´»æ€§çš„åŒæ—¶å…·æœ‰å¾ˆå¥½çš„ç¨³å®šæ€§å’Œæ‰©å±•æ€§ã€‚éšç€è½¯ä»¶è§„æ¨¡è¶Šæ¥è¶Šå¤§ï¼Œè½¯ä»¶å¯¿å‘½è¶Šæ¥è¶Šå¤§ï¼Œè½¯ä»¶ç»´æŠ¤æˆæœ¬è¶Šæ¥è¶Šé«˜ï¼Œè®¾è®¡æ»¡è¶³å¼€é—­åŸåˆ™çš„è½¯ä»¶ç³»ç»Ÿä¹Ÿè¶Šæ¥è¶Šé‡è¦ã€‚</p><p>ä¸ºäº†æ»¡è¶³å¼€é—­åŸåˆ™ï¼Œéœ€è¦å¯¹ç³»ç»Ÿè¿›è¡Œ<strong>æŠ½è±¡åŒ–</strong>è®¾è®¡ï¼Œ<strong>æŠ½è±¡åŒ–æ˜¯å¼€é—­åŸåˆ™çš„å…³é”®</strong>ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œå¯ä»¥ä¸ºç³»ç»Ÿå®šä¸€ä¸ªç›¸å¯¹ç¨³å®šçš„æŠ½è±¡å±‚ï¼Œè€Œå°†ä¸åŒçš„å®ç°è¡Œä¸ºç§»è‡³å…·ä½“çš„å®ç°å±‚ä¸­å®ç°ã€‚Javaæä¾›äº†å¾ˆå¥½çš„æŠ½è±¡ã€æ¥å£ç±»æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒä»¬å®šä¹‰ç³»ç»Ÿçš„æŠ½è±¡å±‚ï¼Œå†é€šè¿‡å…·ä½“ç±»è¿›è¡Œæ‰©å±•ã€‚å¦‚æœéœ€è¦ä¿®æ”¹ç³»ç»Ÿçš„è¡Œä¸ºï¼Œæ— é¡»å¯¹æŠ½è±¡å±‚è¿›è¡Œä¿®æ”¹ï¼Œåªè¦æ–°å¢æ–°çš„å…·ä½“ç±»æ¥å®ç°æ–°çš„ä¸šåŠ¡åŠŸèƒ½å³å¯ï¼Œå®ç°åœ¨ä¸ä¿®æ”¹å·²æœ‰ä»£ç çš„åŸºç¡€ä¸Šè¿›è¡Œç³»ç»ŸåŠŸèƒ½çš„æ‰©å±•ï¼Œè¾¾åˆ°å¼€é—­åŸåˆ™ã€‚</p><h3 id="ä¸‰ã€å¼€é—­åŸåˆ™æ —å­"><a href="#ä¸‰ã€å¼€é—­åŸåˆ™æ —å­" class="headerlink" title="ä¸‰ã€å¼€é—­åŸåˆ™æ —å­"></a>ä¸‰ã€å¼€é—­åŸåˆ™æ —å­</h3><h4 id="ä¸æ»¡è¶³å¼€é—­åŸåˆ™"><a href="#ä¸æ»¡è¶³å¼€é—­åŸåˆ™" class="headerlink" title="ä¸æ»¡è¶³å¼€é—­åŸåˆ™"></a>ä¸æ»¡è¶³å¼€é—­åŸåˆ™</h4><p>å…ˆæœ‰ä¸€ä¸ªéœ€æ±‚éœ€è¦æ˜¾ç¤ºå„ç§ç±»å‹çš„å›¾è¡¨ï¼Œæ¯”å¦‚é¥¼çŠ¶å›¾å’ŒæŸ±çŠ¶å›¾ç­‰ï¼Œä¸ºäº†æ”¯æŒå¤šç§ç±»å‹çš„å›¾è¡¨æ˜¾ç¤ºæ–¹å¼ï¼ŒåŸå§‹è®¾è®¡å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PieChart</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">display</span><span class="params">()</span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BarChart</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">display</span><span class="params">()</span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChartDisPlay</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">display</span> <span class="params">(String type)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (type.equals(<span class="string">&quot;pie&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">PieChart</span> <span class="variable">pie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PieChart</span>();</span><br><span class="line">            pie.display();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type.equals(<span class="string">&quot;bar&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">BarChart</span> <span class="variable">bar</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BarChart</span>();</span><br><span class="line">            bar.display();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åœ¨è¿™ä¸ªè®¾è®¡ä¸­ï¼Œå¦‚æœéœ€è¦æ–°å¢ä¸€ä¸ªæ–°çš„å›¾è¡¨ç±»ï¼Œå¦‚æŠ˜çº¿å›¾<code>LineChart</code>ï¼Œåˆ™éœ€è¦ä¿®æ”¹<code>ChartDisPlay</code>ç±»çš„<code>display()</code>æ–¹æ³•çš„æºä»£ç ï¼Œå¢åŠ æ–°çš„åˆ¤æ–­é€»è¾‘ï¼Œä¸æ»¡è¶³å¼€é—­åŸåˆ™ï¼Œè€Œä¸”éšç€æ—¶é—´æ¨ç§»å¦‚æœç±»å‹è¶Šæ¥è¶Šå¤šï¼Œç»´æŠ¤æˆæœ¬å¤§å¤§æé«˜ã€‚</li></ul><h4 id="é‡æ„ï¼Œæ»¡è¶³å¼€é—­åŸåˆ™"><a href="#é‡æ„ï¼Œæ»¡è¶³å¼€é—­åŸåˆ™" class="headerlink" title="é‡æ„ï¼Œæ»¡è¶³å¼€é—­åŸåˆ™"></a>é‡æ„ï¼Œæ»¡è¶³å¼€é—­åŸåˆ™</h4><p>åœ¨æœ¬æ —å­ä¸­ï¼Œç”±äºåœ¨<code>ChartDisPlay</code>ç±»çš„<code>display</code>æ–¹æ³•ä¸­é’ˆå¯¹æ¯ä¸€ç§å›¾è¡¨ç±»å‹ç¼–ç¨‹ï¼Œå› æ­¤æ–°å¢æ–°çš„å›¾è¡¨ç±»ä¸å¾—ä¸ä¿®æ”¹æºä»£ç ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æŠ½è±¡çš„æ–¹æ³•è¿›è¡Œé‡æ„ï¼Œä½¿ä¹‹æ–°å¢æ–°çš„å›¾è¡¨ç±»æ—¶æ— éœ€ä¿®æ”¹æºä»£ç ï¼Œæ»¡è¶³å¼€é—­åŸåˆ™ã€‚è®¾è®¡å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> AbstractChart &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span>  <span class="title function_">display</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PieChart</span> <span class="keyword">extends</span> <span class="title class_">AbstractChart</span> &#123;</span><br><span class="line">    </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">display</span><span class="params">()</span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BarChart</span> <span class="keyword">extends</span> <span class="title class_">AbstractChart</span> &#123;</span><br><span class="line">    </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">display</span><span class="params">()</span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChartDisPlay</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> AbstractChart chart;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setChart</span><span class="params">(AbstractChart chart)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.chart = chart;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">display</span> <span class="params">(String type)</span> &#123;</span><br><span class="line">        chart.display();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ–°å¢<code>AbstractChart</code>æŠ½è±¡ç±»ï¼Œå®šä¹‰<code>display()</code>æ˜¾ç¤ºæ–¹æ³•</li><li><code>PieChart</code>å’Œ<code>PieChart</code>ç»§æ‰¿<code>AbstractChart</code>é‡å†™<code>display()</code>æ˜¾ç¤ºæ–¹æ³•ã€‚</li><li><code>ChartDisPlay</code>ç±»å‹è¿›è¡Œä¿®æ”¹ï¼Œæ–°å¢å±æ€§<code>AbstractChart chart</code>å¹¶å®šä¹‰ä¸€ä¸ª<code>setChart()</code>æ–¹æ³•æ¥è®¾ç½®å®é™…çš„å›¾è¡¨å¯¹è±¡ï¼Œç„¶åé€šè¿‡è¯¥å¯¹è±¡è°ƒç”¨<code>display()</code>æ˜¾ç¤ºæ–¹æ³•ã€‚</li></ul><p>é‡æ„å®Œä¹‹åï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœæˆ‘ä»¬éœ€è¦æ–°å¢ä¸€ä¸ªæŠ˜çº¿å›¾è¡¨ç±»å‹<code>LineChart</code>åªéœ€æ–°å¢<code>LineChart</code>ç±»å¹¶ç»§æ‰¿<code>AbstractChart</code>ç±»å‹é‡å†™<code>display()</code>æ–¹æ³•ï¼Œå‘<code>ChartDisplay</code>ä¸­æ³¨å…¥ä¸€ä¸ª<code>LineChart</code>å¯¹è±¡å³å¯ï¼Œç»­ä¿®ä¿®æ”¹å…ˆæœ‰çš„ä»£ç ï¼Œæ»¡è¶³å¼€é—­åŸåˆ™ï¼Œæ‰©å±•æ€§å¾ˆé«˜ï¼Œå¤§å¤§çš„é™ä½äº†ç»´æŠ¤æˆæœ¬ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¼€é—­åŸåˆ™ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…­å¤§è®¾è®¡æ¨¡å¼åŸåˆ™-å•ä¸€èŒè´£åŸåˆ™</title>
      <link href="/2022/03/09/deisgn-model-srp/"/>
      <url>/2022/03/09/deisgn-model-srp/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h3 id="ä¸€ã€å•ä¸€èŒè´£åŸåˆ™å®šä¹‰"><a href="#ä¸€ã€å•ä¸€èŒè´£åŸåˆ™å®šä¹‰" class="headerlink" title="ä¸€ã€å•ä¸€èŒè´£åŸåˆ™å®šä¹‰"></a>ä¸€ã€å•ä¸€èŒè´£åŸåˆ™å®šä¹‰</h3><p>å•ä¸€èŒè´£åŸåˆ™æ˜¯é¢å‘å¯¹è±¡äº”ä¸ªåŸºæœ¬åŸåˆ™ï¼ˆSOLIDï¼‰ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯æœ€ç®€å•çš„é¢å‘å¯¹è±¡è®¾è®¡åŸåˆ™ï¼Œç”¨äºæ§åˆ¶ç±»çš„é¢—ç²’å¤§å°ã€‚å•ä¸€èŒè´£å®šä¹‰å¦‚ä¸‹ï¼š</p><p><strong>å•ä¸€èŒè´£åŸåˆ™ï¼ˆSRPï¼šSingle responsibility principleï¼‰ï¼šä¸€ä¸ªç±»åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½é¢†åŸŸä¸­çš„ç›¸åº”èŒè´£ï¼Œä¹Ÿå¯ä»¥å®šä¹‰ä¸ºï¼šä¸€ä¸ªç±»åº”è¯¥åªæœ‰ä¸€ä¸ªå‘ç”Ÿå˜åŒ–çš„åŸå› ã€‚</strong></p><h3 id="äºŒã€å•ä¸€èŒè´£åŸåˆ™æè¿°"><a href="#äºŒã€å•ä¸€èŒè´£åŸåˆ™æè¿°" class="headerlink" title="äºŒã€å•ä¸€èŒè´£åŸåˆ™æè¿°"></a>äºŒã€å•ä¸€èŒè´£åŸåˆ™æè¿°</h3><p>å•ä¸€èŒè´£åŸåˆ™å‘Šè¯‰æˆ‘ä»¬ï¼šä¸€ä¸ªç±»ä¸èƒ½å¤ªâ€ç´¯â€ï¼Œåœ¨ä¸€ä¸ªç³»ç»Ÿä¸­ï¼Œå¦‚æœä¸€ä¸ªç±»ï¼ˆå¤§åˆ°æ¨¡å—ï¼Œå°åˆ°æ–¹æ³•ï¼‰æ‰¿æ‹…çš„èŒè´£è¶Šå¤šï¼Œé‚£ä¹ˆå®ƒè¢«å¤ç”¨çš„å¯èƒ½æ€§å°±è¶Šå°ï¼Œè€Œä¸”è€¦åˆåº¦å¾ˆé«˜ï¼Œå¦‚æœå½“å…¶ä¸­ä¸€ä¸ªèŒè´£å‘ç”Ÿæ”¹å˜æ—¶ï¼Œå¯èƒ½ä¼šå½±å“åˆ°å…¶ä»–èŒè´£ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è®¾è®¡å¼€å‘çš„æ—¶å€™åº”è¯¥è®²è¿™äº›èŒè´£è¿›è¡Œåˆ†ç¦»ï¼Œå°†ä¸åŒçš„èŒè´£å°è£…åœ¨ä¸åŒçš„ç±»ä¸­ï¼Œå³å°†ä¸åŒçš„å˜åŒ–åŸå› å°è£…åœ¨ä¸åŒçš„ç±»ä¸­ï¼Œå¦‚æœå¤šä¸ªèŒä¸šæ€»æ˜¯åŒæ—¶å‘ç”Ÿå˜åŒ–åˆ™å¯å°†ä»–ä»¬å°è£…åœ¨åŒä¸€ç±»ä¸­ã€‚</p><p><strong>å•ä¸€èŒè´£åŸåˆ™æ˜¯å®ç°é«˜å†…èšã€ä½è€¦åˆçš„æŒ‡å¯¼æ–¹é’ˆï¼Œå®ƒæ˜¯æœ€ç®€å•ä½†æ˜¯åˆæ˜¯æœ€éš¾è¿ç”¨çš„åŸåˆ™</strong>ï¼Œéœ€è¦è®¾è®¡äººå‘˜å‘ç°ç±»çš„ä¸åŒèŒè´£å¹¶å°†å…¶è¿›è¡Œåˆ†ç¦»ï¼Œè€Œå‘ç°ç±»çš„å¤šé‡èŒè´£éœ€è¦è®¾è®¡äººå‘˜å…·æœ‰è¾ƒå¼ºçš„åˆ†æè®¾è®¡èƒ½åŠ›å’Œç›¸å…³çš„å®è·µç»éªŒã€‚ï¼ˆå¸Œæœ›æˆ‘ä»¬éƒ½èƒ½æˆä¸ºè¿™ç±»äººï¼Œå¹²å§å¾—~ï¼‰</p><h3 id="ä¸‰ã€å•ä¸€èŒè´£åŸåˆ™æ —å­"><a href="#ä¸‰ã€å•ä¸€èŒè´£åŸåˆ™æ —å­" class="headerlink" title="ä¸‰ã€å•ä¸€èŒè´£åŸåˆ™æ —å­"></a>ä¸‰ã€å•ä¸€èŒè´£åŸåˆ™æ —å­</h3><h4 id="ä¸æ»¡è¶³å•ä¸€èŒè´£åŸåˆ™"><a href="#ä¸æ»¡è¶³å•ä¸€èŒè´£åŸåˆ™" class="headerlink" title="ä¸æ»¡è¶³å•ä¸€èŒè´£åŸåˆ™"></a>ä¸æ»¡è¶³å•ä¸€èŒè´£åŸåˆ™</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerDataChar</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Connection <span class="title function_">getConnection</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// è·å–æ•°æ®åº“è¿æ¥</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;Customer&gt; <span class="title function_">findCustomers</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// æŸ¥è¯¢å®¢æˆ·åˆ—è¡¨</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createChar</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºå›¾è¡¨</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">displayChar</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// æ˜¾ç¤ºå›¾è¡¨</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨æœ‰ä¸€ä¸ªç±»<code>CustomerDataChar</code>ï¼ŒåŒ…å«äº†4ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul><li><p><code>getConnection</code> è·å–æ•°æ®åº“è¿æ¥ã€‚</p></li><li><p><code>findCustomers</code> ç”¨äºæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨ã€‚</p></li><li><p><code>createChar</code> ç”¨äºåˆ›å»ºå›¾è¡¨ã€‚</p></li><li><p><code>displayChar</code> ç”¨äºæ˜¾ç¤ºå›¾è¡¨ã€‚</p></li></ul><p><code>CustomerDataChar</code>ç±»æ‰¿æ‹…äº†å¤ªå¤šèŒè´£ï¼ŒåŒ…å«äº†ä¸æ•°æ®åº“ç›¸å…³çš„æ–¹æ³•ï¼ŒåˆåŒ…å«äº†å›¾è¡¨ç”Ÿæˆå’Œæ˜¾ç¤ºçš„ç›¸å…³æ–¹æ³•ã€‚å¦‚æœå…¶ä»–ç±»ä¸­ä¹Ÿéœ€è¦è·å–æ•°æ®åº“è¿æ¥æˆ–è€…è°ƒç”¨<code>findCustomers</code>æ–¹æ³•ï¼Œåˆ™éš¾ä»¥å®ç°ä»£ç çš„é‡ç”¨ã€‚æ— è®ºæ˜¯è¦ä¿®æ”¹æ•°æ®åº“è¿æ¥æ–¹æ³•è¿˜æ˜¯ä¿®æ”¹å›¾è¡¨æ˜¾ç¤ºæ–¹å¼éƒ½è¦ä¿®æ”¹æ­¤ç±»ï¼Œä¸æ­¢ä¸€ä¸ªå‘ç”Ÿå˜åŒ–çš„åŸå› ï¼Œè¿èƒŒäº†å•ä¸€èŒè´£åŸåˆ™ã€‚</p><h4 id="ä¼˜åŒ–ï¼Œæ»¡è¶³å•ä¸€èŒè´£åŸåˆ™"><a href="#ä¼˜åŒ–ï¼Œæ»¡è¶³å•ä¸€èŒè´£åŸåˆ™" class="headerlink" title="ä¼˜åŒ–ï¼Œæ»¡è¶³å•ä¸€èŒè´£åŸåˆ™"></a>ä¼˜åŒ–ï¼Œæ»¡è¶³å•ä¸€èŒè´£åŸåˆ™</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DBUtil</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Connection <span class="title function_">getConnection</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// è·å–æ•°æ®åº“è¿æ¥</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerDao</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> DBUtil dButil;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;Customer&gt; <span class="title function_">findCustomers</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// æŸ¥è¯¢å®¢æˆ·åˆ—è¡¨</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerDataChar</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> CustomDao customDao;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createChar</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºå›¾è¡¨</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">displayChar</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// æ˜¾ç¤ºå›¾è¡¨</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>CustomerDataChar</code>ç±»å¯ä»¥æ‹†åˆ†ä¸ºå¦‚ä¸‹ä¸‰ä¸ªç±»ï¼š</p><ul><li><code>DBUtil</code> åªè´Ÿè´£å’Œæ•°æ®åº“ç›¸å…³çš„èŒè´£ï¼Œæ¯”å¦‚è·å–æ•°æ®åº“è¿æ¥ã€å…³é—­æ•°æ®åº“è¿æ¥ç­‰ï¼Œä¸”å¯ä»¥è¢«å…¶ä»–ç±»å¤ç”¨ã€‚</li><li><code>CustomerDao</code>åªè´Ÿè´£æ“å’Œç”¨æˆ·ç›¸å…³çš„èŒè´£ï¼Œæ¯”å¦‚ç”¨æˆ·çš„æ–°å¢ã€ç¼–è¾‘ã€åˆ é™¤ã€æŸ¥è¯¢ç­‰ï¼Œä¹Ÿå¯ä»¥è¢«å…¶ä»–ç±»å¤ç”¨ã€‚</li><li><code>CustomerDataChar</code>åªè´Ÿè´£å’Œå›¾è¡¨ç›¸å…³çš„èŒè´£ï¼Œæ¯”å¦‚ç”Ÿæˆå›¾è¡¨ã€æ˜¾ç¤ºå›¾æ ‡ç­‰ã€‚</li></ul><p>ç»è¿‡ä¸Šé¢çš„ä¼˜åŒ–ä¹‹åï¼Œå„ä¸ªç±»åªè´Ÿè´£å„è‡ªçš„èŒè´£ï¼Œæ»¡è¶³å•ä¸€èŒè´£åŸåˆ™ï¼Œä¸”å¯ä»¥è¢«å…¶ä»–ç±»å¤ç”¨ï¼Œå®ç°äº†é«˜èšåˆã€ä½è€¦åˆã€‚</p>]]></content>
      
      
      <categories>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å•ä¸€èŒè´£åŸåˆ™ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Stringç±»è¯¦è§£</title>
      <link href="/2022/03/08/string-principle/"/>
      <url>/2022/03/08/string-principle/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h3 id="ä¸€-Stringæè¿°"><a href="#ä¸€-Stringæè¿°" class="headerlink" title="ä¸€  Stringæè¿°"></a>ä¸€  Stringæè¿°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">String</span> <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable, Comparable&lt;String&gt;, CharSequence &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">char</span> value[];</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>String</code>æ˜¯ä¸€ä¸ªç”¨<code>final</code>å£°æ˜çš„å¸¸é‡ç±»ï¼Œä¸èƒ½è¢«ä»»ä½•ç±»ç»§æ‰¿ï¼Œåº•å±‚æ˜¯ç”±<code>char[]</code>æ•°ç»„å®ç°ï¼Œè¿™ä¸ªæ•°ç»„ä¹Ÿæ˜¯<code>final</code>ï¼Œä¸€æ—¦Stringå¯¹è±¡è¢«åˆ›å»ºï¼ŒåŒ…å«è¿™ä¸ªå¯¹è±¡ä¸­çš„å­—ç¬¦åºåºåˆ—æ˜¯ä¸å¯è¢«æ”¹å˜çš„ï¼Œæ”¹ç±»åç»­çš„æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯ä¸èƒ½æ”¹å˜è¯¥å¯¹è±¡çš„ï¼Œç›´è‡³è¯¥å¯¹è±¡è¢«é”€æ¯ï¼ˆè¯¥ç±»çš„æœ‰äº›æ–¹æ³•çœ‹ä¼¼æ”¹å˜äº†å­—ç¬¦ä¸²æ¯”å¦‚<code>substring</code>ã€<code>replace</code>ç­‰ï¼Œå…¶å®éƒ½æ˜¯å†…éƒ¨åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ï¼‰ã€‚å®ç°äº†<code>Serializable</code>ç³»åˆ—åŒ–æ¥å£ï¼Œå®ç°äº†<code>Comparable</code>æ¥å£ï¼Œç”¨äºæ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²çš„å¤§å°ï¼ˆæŒ‰é¡ºåºæ¯”è¾ƒå•ä¸ªå­—ç¬¦çš„ASCIIç ï¼‰ï¼Œæœ€åå®ç°<code>CharSequence</code>è¡¨ç¤ºæ˜¯ä¸€ä¸ªæœ‰åºå­—ç¬¦çš„é›†åˆã€‚</p><h3 id="äºŒ-åˆ›å»ºæ–¹æ³•"><a href="#äºŒ-åˆ›å»ºæ–¹æ³•" class="headerlink" title="äºŒ  åˆ›å»ºæ–¹æ³•"></a>äºŒ  åˆ›å»ºæ–¹æ³•</h3><p>Stringæœ€å¸¸ç”¨çš„åˆ›å»ºæ–¹æ³•å°±æ˜¯<code>String str = &quot;str&quot;</code>ï¼Œå®é™…ä¸ŠStringåº•å±‚æ˜¯ç”±ä¸€ä¸ª<code>char[]</code>æ•°ç»„å®ç°çš„ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥<code>String str = new String(new char[]&#123;&#39;s&#39;, &#39;t&#39;, &#39;r&#39;&#125;)</code>ï¼Œè¿˜å¯ä»¥ç”±ä¸‹é¢æ–¹æ³•åˆ›å»ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">str01</span> <span class="operator">=</span> <span class="string">&quot;str&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">str01</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="keyword">new</span> <span class="title class_">char</span>[]&#123;<span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;t&#x27;</span>&#125;);</span><br><span class="line"><span class="comment">// intæ–¹å¼</span></span><br><span class="line"><span class="type">String</span> <span class="variable">str02</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">0x61</span>, <span class="number">0x62</span>, <span class="number">0x63</span>&#125;, <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line"><span class="comment">// byteæ–¹å¼</span></span><br><span class="line"><span class="type">String</span> <span class="variable">str03</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">0x61</span>, <span class="number">0x62</span>, <span class="number">0x63</span>&#125;);</span><br></pre></td></tr></table></figure><p>å£°æ˜ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡çš„æ–¹æ³•ä¸€èˆ¬æœ‰ä¸¤ç§ï¼š</p><ul><li><p>é€šè¿‡â€œå­—é¢é‡â€çš„å½¢å¼ç›´æ¥èµ‹å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;str&quot;</span>;</span><br></pre></td></tr></table></figure></li><li><p>é€šè¿‡newå…³é”®å­—è°ƒç”¨æ„é€ æ–¹æ³•åˆ›å»ºå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;str&quot;</span>);</span><br></pre></td></tr></table></figure></li><li><p>é€šè¿‡â€+â€è¿ç®—ç¬¦åˆ›å»ºå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">str01</span> <span class="operator">=</span> <span class="string">&quot;s&quot;</span> + <span class="string">&quot;str&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">str02</span> <span class="operator">=</span> str01 + <span class="string">&quot;str&quot;</span>;</span><br></pre></td></tr></table></figure></li></ul><p>é‚£ä¹ˆè¿™ä¸¤ç§å£°æ˜æ–¹å¼æœ‰ä»€ä¹ˆä¸ä¸€æ ·å‘¢ï¼Ÿé¦–å…ˆæˆ‘ä»¬è¦ä»‹ç»ä¸€ä¸ªå¸¸é‡æ± ï¼ŒJavaåœ¨è¿è¡Œæ—¶ä¼šç»´æŠ¤ä¸€ä¸ªStringæ± (String Pool)ï¼Œä¹Ÿå«<strong>å­—ç¬¦ä¸²ç¼“å­˜åŒº</strong>ã€‚Stringæ± ç”¨æ¥å­˜æ”¾è¿è¡Œæ—¶ä¸­äº§ç”Ÿçš„å„ç§å­—ç¬¦ä¸²ã€‚å¹¶ä¸”å­—ç¬¦ä¸²çš„å†…å®¹ä¸é‡å¤ã€‚</p><p>åœ¨JDK1.7ä¹‹å‰ï¼Œå¸¸é‡æ± æ˜¯å­˜æ”¾åœ¨æ–¹æ³•åŒºçš„ï¼Œç”¨æ¥å‚¨å­˜ç¼–è¯‘æœŸç”Ÿæˆçš„å­—ç¬¦ä¸²å¼•ç”¨ã€‚è€Œåœ¨JDK1.7ä¹‹åï¼Œå¸¸é‡æ± å­˜æ”¾åœ¨å †ä¸­äº†ã€‚</p><ul><li>å­—é¢é‡åˆ›å»ºå­—ç¬¦ä¸²æˆ–è€…çº¯å­—ç¬¦ä¸²(å¸¸é‡)æ‹¼æ¥å­—ç¬¦ä¸²æ—¶ä¼šç°åœ¨å­—ç¬¦ä¸²æ± ä¸­æŸ¥æ‰¾ï¼Œçœ‹æ˜¯å¦æœ‰ç›¸ç­‰çš„å¯¹è±¡ï¼Œæœ‰çš„è¯åˆ™ç›´æ¥ä½¿ç”¨Stringæ± ä¸­çš„å¼•ç”¨ï¼›æ²¡æœ‰çš„è¯å°±åœ¨å­—ç¬¦ä¸²æ± ä¸­åˆ›å»ºè¯¥å¯¹è±¡ï¼Œé¿å…é‡å¤åˆ›å»ºå¯¹è±¡ã€‚</li><li>newå…³é”®å­—åˆ›å»ºæ—¶ï¼Œç›´æ¥åœ¨å †ä¸­åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œå˜é‡æ‰€å¼•ç”¨çš„éƒ½æ˜¯è¿™ä¸ªæ–°å¯¹è±¡çš„åœ°å€ï¼Œä½†æ˜¯å¦‚æœåˆ›å»ºçš„å­—ç¬¦ä¸²å†…å®¹åœ¨å¸¸é‡æ± å­˜åœ¨äº†ï¼Œé‚£ä¹ˆä¼šç”±å †å†æŒ‡å‘å¸¸é‡æ± çš„å­—ç¬¦ä¸²ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œé‚£ä¹ˆé€šè¿‡newå…³é”®å­—åˆ›å»ºçš„å­—ç¬¦ä¸²å¯¹è±¡æ˜¯ä¸ä¼šåœ¨å¸¸é‡æ± ä¸­ç»´æŠ¤çš„ã€‚</li><li>ä½¿ç”¨åŒ…å«å˜é‡è¡¨è¾¾å¼æ¥åˆ›å»ºStringå¯¹è±¡æ—¶ï¼Œä¸ä»…æ£€æŸ¥ç»´æŠ¤Stringæ± ï¼Œè¿˜ä¼šåœ¨å †åŒºåˆ›å»ºè¿™ä¸ªå¯¹è±¡ï¼Œæœ€åæŒ‡å‘å †å†…å­˜ä¸­çš„å¯¹è±¡ã€‚</li></ul><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">str1</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">str2</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">str3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">System.out.println(str1==str2);<span class="comment">//true</span></span><br><span class="line">System.out.println(str1==str3);<span class="comment">//fasle</span></span><br><span class="line">System.out.println(str2==str3);<span class="comment">//fasle</span></span><br><span class="line">System.out.println(str1.equals(str2));<span class="comment">//true</span></span><br><span class="line">System.out.println(str1.equals(str3));<span class="comment">//true</span></span><br><span class="line">System.out.println(str2.equals(str3));<span class="comment">//true</span></span><br></pre></td></tr></table></figure><p>å¯¹äºä¸Šé¢æƒ…å†µï¼Œé¦–å…ˆ<code>String str1 = &quot;hello&quot;</code>ï¼Œä¼šå…ˆåœ¨å¸¸é‡æ± æ£€æŸ¥æ˜¯å¦æœ‰<code>hello</code>å­˜åœ¨ï¼Œå‘ç°æ˜¯ä¸å­˜åœ¨çš„ï¼Œåˆ™åœ¨å¸¸é‡æ± ä¸­åˆ›å»º<code>hello</code>å¯¹è±¡ï¼Œå¹¶å°†å¸¸é‡æ± ä¸­çš„å¼•ç”¨èµ‹å€¼ç»™str1ï¼›ç´§æ¥ç€<code>String str2 = &quot;hello&quot;</code>ï¼Œåœ¨å¸¸é‡æ± ä¸­æ£€æµ‹åˆ°æœ‰<code>hello</code>ï¼Œæ‰€ä»¥è®²å¸¸é‡æ± ä¸­çš„å¼•ç”¨èµ‹å€¼ç»™str2ï¼Œæ‰€ä»¥<code>str1 == str2</code>æ˜¯<code>true</code>ï¼›ç´§æ¥ç€<code>String str3 = new String(&quot;hello&quot;)</code>ï¼Œå¸¸é‡æ± ä¸­æœ‰äº†<code>hello</code>ï¼Œæ‰€ä»¥ä¸ç”¨åœ¨å¸¸é‡æ± ä¸­åˆ›å»ºï¼Œç„¶ååœ¨å †ä¸­åˆ›å»ºè¯¥å¯¹è±¡å¹¶å°†å¯¹è±¡çš„å¼•ç”¨èµ‹å€¼ç»™str3ï¼Œå†å°†è¯¥å¯¹è±¡æŒ‡å‘å¸¸é‡æ± ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://qtspace.cn/contentimg/1.jpg"></p><p>ä½¿ç”¨åŒ…å«å˜é‡è¡¨è¾¾å¼åˆ›å»ºå¯¹è±¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">str1</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">str2</span> <span class="operator">=</span> <span class="string">&quot;helloworld&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">str3</span> <span class="operator">=</span> str1+<span class="string">&quot;world&quot;</span>;<span class="comment">//ç¼–è¯‘å™¨ä¸èƒ½ç¡®å®šä¸ºå¸¸é‡(ä¼šåœ¨å †åŒºåˆ›å»ºä¸€ä¸ªStringå¯¹è±¡)</span></span><br><span class="line"><span class="type">String</span> <span class="variable">str4</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span>+<span class="string">&quot;world&quot;</span>;<span class="comment">//ç¼–è¯‘å™¨ç¡®å®šä¸ºå¸¸é‡ï¼Œç›´æ¥åˆ°å¸¸é‡æ± ä¸­å¼•ç”¨</span></span><br><span class="line"></span><br><span class="line">System.out.println(str2==str3);<span class="comment">//fasle</span></span><br><span class="line">System.out.println(str2==str4);<span class="comment">//true</span></span><br><span class="line">System.out.println(str3==str4);<span class="comment">//fasle</span></span><br></pre></td></tr></table></figure><p>str3ç”±äºå«æœ‰å˜é‡str1ï¼Œç¼–è¯‘å™¨ä¸èƒ½ç¡®å®šæ˜¯å¸¸é‡ï¼Œä¼šåœ¨å †ä¸­åˆ›å»ºä¸€ä¸ªStringå¯¹è±¡ã€‚è€Œstr4æ˜¯ä¸¤ä¸ªå¸¸é‡ç›¸åŠ ï¼Œç¼–è¯‘å™¨ç¡®å®šä¼šå¸¸é‡ï¼Œç›´æ¥é¥®ç”¨å¸¸é‡æ± ä¸­çš„å¯¹è±¡ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://qtspace.cn/contentimg/2.jpg"></p><h3 id="ä¸‰-ä¸å¯å˜ï¼ˆfinalï¼‰"><a href="#ä¸‰-ä¸å¯å˜ï¼ˆfinalï¼‰" class="headerlink" title="ä¸‰  ä¸å¯å˜ï¼ˆfinalï¼‰"></a>ä¸‰  ä¸å¯å˜ï¼ˆfinalï¼‰</h3><p>Stringæœ€é‡è¦çš„ç‰¹æ€§å°±æ˜¯ä¸å¯å˜ï¼Œè¿™ç§ä¸å¯å˜æ€§æ˜¯é€šè¿‡åº•å±‚<code>private final char value[]</code>å±æ€§ï¼Œä»¥åŠæ²¡æœ‰ä»»åŠ¡ä¿®æ”¹<code>char[]</code>çš„æ–¹æ³•å®ç°ã€‚ä¸¾ä¸ªç»å…¸çš„ä¾‹å­ï¼Œä¸è€ƒè™‘å…¶ä»–æƒ…å†µï¼Œä¸‹é¢åˆå§‹åŒ–Stringåˆ†åˆ«åˆ›å»ºäº†å‡ ä¸ªå¯¹è±¡å‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">str01</span> <span class="operator">=</span> <span class="string">&quot;abc&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">str02</span> <span class="operator">=</span> <span class="string">&quot;abc&quot;</span> + <span class="string">&quot;def&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">str03</span> <span class="operator">=</span> str01 + <span class="string">&quot;def&quot;</span>;</span><br></pre></td></tr></table></figure><ul><li>str01åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå¼•ç”¨æŒ‡å‘abc</li><li>str02åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå¼•ç”¨æŒ‡å‘abcdefï¼Œè¿™æ˜¯å› ä¸ºJVMç¼–è¯‘æœŸçš„ä¼˜åŒ–ä¸¤ä¸ªå­—ç¬¦ä¸²ä¼šæ‹¼æ¥èµ·æ¥ã€‚</li><li>str03ä¼šåˆ›å»ºä¸‰ä¸ªå¯¹è±¡ï¼Œstr01å¯¹è±¡ï¼Œ+çš„æ—¶å€™ä¼šåˆ›å»ºStringBuilderå¯¹è±¡è¿›è¡Œappendæ“ä½œï¼Œappendå®ŒæˆtoStringåˆ›å»ºå¯¹è±¡ã€‚</li></ul><p>ä½†æ˜¯çœŸçš„ä¸å¯ä»¥å˜å—ï¼Ÿ</p><p>æˆ‘ä»¬çŸ¥é“Stringåº•å±‚æ˜¯ç”±<code>char[] value</code>å®ç°ï¼Œ<code>value</code>è¢«<code>final</code>ä¿®é¥°ï¼Œåªèƒ½ä¿è¯å¼•ç”¨ä¸è¢«æ”¹å˜ï¼Œ<code>value</code>æ˜¯å¯ä»¥è¢«æ”¹å˜çš„ï¼Œå³ä½¿è¢«<code>private</code>å£°æ˜ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¯ä»¥é€šè¿‡åå°„æ¥æ”¹å˜<code>value</code>å€¼çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;str&quot;</span>;</span><br><span class="line"><span class="comment">// è¾“å‡º str</span></span><br><span class="line">System.out.println(str);</span><br><span class="line"><span class="comment">// é€šè¿‡åå°„è·å–Stringç±»ä¸­çš„valueå­—æ®µ</span></span><br><span class="line"><span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> String.class.getDeclaredField(<span class="string">&quot;value&quot;</span>);</span><br><span class="line"><span class="comment">// å› ä¸ºvalueæ˜¯privateçš„, æ‰€ä»¥è¦ä¿®æ”¹å…¶è®¿é—®æƒé™</span></span><br><span class="line">field.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">// è·å–strå¯¹è±¡çš„valueå€¼</span></span><br><span class="line"><span class="type">char</span>[] value = (<span class="type">char</span>[])field.get(str);</span><br><span class="line"><span class="comment">// ä¿®æ”¹valueå€¼</span></span><br><span class="line">value[<span class="number">0</span>] = <span class="string">&#x27;S&#x27;</span>;</span><br><span class="line"><span class="comment">// è¾“å‡º Str</span></span><br><span class="line">System.out.println(str);</span><br></pre></td></tr></table></figure><p>é€šè¿‡å‰åçš„ä¸¤æ¬¡æ‰“å°çš„ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°Stringè¢«æ”¹å˜äº†ï¼Œä½†æ˜¯åœ¨ä»£ç é‡Œé¢å‡ ä¹ä¸ä¼šç”¨åå°„å»æ”¹å˜Stringçš„å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬è®¤ä¸ºStringç±»å‹æ˜¯ä¸å¯ä»¥å˜çš„ã€‚</p><p>é‚£ä¹ˆï¼ŒStringç±»ä¸ºä»€ä¹ˆè¦è®¾è®¡æˆä¸å¯å˜å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä»å®‰å…¨å’Œæ€§èƒ½ä¸¤ä¸ªæ–¹é¢æ¥è€ƒè™‘ï¼š</p><ul><li>å®‰å…¨ï¼š<ol><li>å¼•å‘å®‰å…¨é—®é¢˜ï¼Œè­¬å¦‚æ•°æ®åº“åç§°ã€å¯†ç éƒ½æ˜¯å­—ç¬¦ä¸²çš„çš„å½¢å¼ä¼ å…¥è·å–æ•°æ®åº“è¿æ¥ï¼Œæˆ–è€…åœ¨socketç¼–ç¨‹ä¸­ä¸»æœºåå’Œç«¯å£éƒ½æ˜¯ä»¥å­—ç¬¦ä¸²çš„å½¢å¼ä¼ å…¥ã€‚å› ä¸ºå­—ç¬¦ä¸²æ˜¯ä¸å¯ä»¥å˜çš„ï¼Œæ‰€ä»¥å®ƒçš„å€¼æ˜¯ä¸å¯å˜çš„ï¼Œå¦åˆ™é»‘å®¢ä»¬å¯ä»¥é’»åˆ°ç©ºå­ï¼Œæ”¹å˜å­—ç¬¦ä¸²æŒ‡å‘çš„å¯¹è±¡çš„å€¼ï¼Œææˆå®‰å…¨æ¼æ´ã€‚</li><li>ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œåœ¨å¹¶å‘ç¯å¢ƒä¸­å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å†™èµ„æºæ—¶ï¼Œä¼šå¼•èµ·çº¿ç¨‹ä¸å®‰å…¨ï¼Œç”±äºStringæ˜¯ä¸å¯ä»¥å˜çš„ï¼Œä¸ä¼šå¼•èµ·çº¿ç¨‹é—®é¢˜ã€‚</li><li>HashCodeï¼Œå½“Stringè¢«åˆ›å»ºçš„æ—¶å€™ï¼ŒHashCodeçš„å€¼ä¹Ÿä¼šè¢«ç¼“å­˜ï¼ŒHashCodeçš„å€¼ä¸valueæœ‰å…³ï¼Œå¦‚æœStringæ”¹å˜ï¼Œé‚£ä¹ˆHashCodeä¹Ÿä¼šéšä¹‹æ”¹å˜ï¼Œé’ˆå¯¹Mapã€Setç­‰å®¹å™¨çš„é”®å€¼éœ€è¦ä¿è¯å”¯ä¸€æ€§å’Œä¸€è‡´æ€§ï¼ŒStringä¸å¯ä»¥å˜ä¿è¯äº†è¿™ä¸ªç‰¹æ€§ã€‚</li></ol></li><li>æ€§èƒ½<ol><li>å½“å­—ç¬¦ä¸²ä¸å¯å˜æ—¶ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± æ‰æœ‰æ„ä¹‰ã€‚å­—ç¬¦ä¸²å¸¸é‡æ± çš„å‡ºç°ï¼Œå¯ä»¥å‡å°‘åˆ›å»ºç›¸åŒå­—ç¬¦çš„å­—ç¬¦ä¸²ï¼Œè®©ä¸åŒçš„å¼•ç”¨æŒ‡å‘åŒä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¸ºè¿è¡Œæ—¶èŠ‚çº¦äº†å¾ˆå¤šå †å†…å­˜ã€‚è‹¥å­—ç¬¦ä¸²æ”¹å˜ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± åˆ™å¤±å»æ„ä¹‰ï¼ŒåŸºäºå¸¸é‡æ± çš„<code>String.intern()</code>æ–¹æ³•ä¹Ÿä¼šå¤±æ•ˆï¼Œæ¯æ¬¡åˆ›å»ºæ–°çš„Stringå°†åœ¨å †å†…å­˜åˆ›å»ºæ–°çš„ç©ºé—´ï¼Œå ç”¨æ›´å¤šæ›´å¤šçš„å†…å­˜ã€‚</li></ol></li></ul><h3 id="å››-intern-æ–¹æ³•"><a href="#å››-intern-æ–¹æ³•" class="headerlink" title="å››  intern()æ–¹æ³•"></a>å››  intern()æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Returns a canonical representation for the string object. </span></span><br><span class="line"><span class="comment"> * &lt;p&gt; </span></span><br><span class="line"><span class="comment"> * A pool of strings, initially empty, is maintained privately by the </span></span><br><span class="line"><span class="comment"> * class &lt;code&gt;String&lt;/code&gt;. </span></span><br><span class="line"><span class="comment"> * &lt;p&gt; </span></span><br><span class="line"><span class="comment"> * When the intern method is invoked, if the pool already contains a </span></span><br><span class="line"><span class="comment"> * string equal to this &lt;code&gt;String&lt;/code&gt; object as determined by </span></span><br><span class="line"><span class="comment"> * the &#123;<span class="doctag">@link</span> #equals(Object)&#125; method, then the string from the pool is </span></span><br><span class="line"><span class="comment"> * returned. Otherwise, this &lt;code&gt;String&lt;/code&gt; object is added to the </span></span><br><span class="line"><span class="comment"> * pool and a reference to this &lt;code&gt;String&lt;/code&gt; object is returned. </span></span><br><span class="line"><span class="comment"> * &lt;p&gt; </span></span><br><span class="line"><span class="comment"> * It follows that for any two strings &lt;code&gt;s&lt;/code&gt; and &lt;code&gt;t&lt;/code&gt;, </span></span><br><span class="line"><span class="comment"> * &lt;code&gt;s.intern() == t.intern()&lt;/code&gt; is &lt;code&gt;true&lt;/code&gt; </span></span><br><span class="line"><span class="comment"> * if and only if &lt;code&gt;s.equals(t)&lt;/code&gt; is &lt;code&gt;true&lt;/code&gt;. </span></span><br><span class="line"><span class="comment"> * &lt;p&gt; </span></span><br><span class="line"><span class="comment"> * All literal strings and string-valued constant expressions are </span></span><br><span class="line"><span class="comment"> * interned. String literals are defined in section 3.10.5 of the </span></span><br><span class="line"><span class="comment"> * &lt;cite&gt;The Javaâ„¢ Language Specification&lt;/cite&gt;. </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  a string that has the same contents as this string, but is </span></span><br><span class="line"><span class="comment"> *          guaranteed to be from a pool of unique strings. </span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">intern</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure><p>ä»æºç ä¸­å¯ä»¥çœ‹å‡º<code>intern()</code>æ˜¯ä¸€ä¸ª<code>native</code>æ–¹æ³•ï¼Œä½†æ˜¯æ³¨é‡Šå†™çš„éå¸¸æ¸…æ¥šäº†ã€‚â€å¦‚æœå¸¸é‡æ± ä¸­å­˜åœ¨å½“å‰å­—ç¬¦ä¸²ï¼Œåˆ™ç›´æ¥è¿”å›å½“å‰å­—ç¬¦ä¸²ï¼Œå¦‚æœå¸¸é‡æ± ä¸­æ²¡æœ‰è¯¥å­—ç¬¦ä¸²ï¼Œä¼šå°†æ­¤å­—ç¬¦ä¸²æ”¾å…¥å¸¸é‡æ± ä¸­åï¼Œå†è¿”å›â€ã€‚</p><p><code>native</code>æ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•ï¼Œåº•å±‚é€šè¿‡JNIè°ƒç”¨C++æ–¹æ³•ï¼Œæ ¸å¿ƒæ–¹æ³•å¦‚ä¸‹ï¼š<br>\openjdk8\jdk\src\share\native\java\lang\String.c</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Java_java_lang_String_intern</span>(JNIEnv *env, jobject <span class="keyword">this</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">JVM_InternString</span>(env, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">oop result = StringTable::<span class="built_in">intern</span>(string, CHECK_NULL);</span><br><span class="line"></span><br><span class="line"><span class="function">oop <span class="title">StringTable::intern</span><span class="params">(Handle string_or_null, jchar* name,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">int</span> len, TRAPS)</span> </span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> hashValue = java_lang_String::<span class="built_in">hash_string</span>(name, len);</span><br><span class="line">  <span class="type">int</span> index = <span class="built_in">the_table</span>()-&gt;<span class="built_in">hash_to_index</span>(hashValue);</span><br><span class="line">  oop string = <span class="built_in">the_table</span>()-&gt;<span class="built_in">lookup</span>(index, name, len, hashValue);</span><br><span class="line">  <span class="comment">// Found</span></span><br><span class="line">  <span class="keyword">if</span> (string != <span class="literal">NULL</span>) <span class="keyword">return</span> string;</span><br><span class="line">  <span class="comment">// Otherwise, add to symbol to table</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">the_table</span>()-&gt;<span class="built_in">basic_add</span>(index, string_or_null, name, len,</span><br><span class="line">                                hashValue, CHECK_NULL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒçš„å¤§ä½“å®ç°å°±æ˜¯ï¼šJavaé€šè¿‡JNIè°ƒç”¨C++å®ç°çš„<code>StringTable.intern</code>æ–¹æ³•ï¼ŒStringTable.internæ–¹æ³•è·ŸJavaä¸­çš„<code>HashMap</code>å®ç°å·®ä¸å¤šï¼Œåªæ˜¯ä¸èƒ½æ‰©å®¹ï¼Œé»˜è®¤å¤§å°1009ã€‚è¦æ³¨æ„çš„æ˜¯Stringçš„String Poolæ˜¯ä¸€ä¸ªå›ºå®šçš„å¤§å°<code>HashTable</code>ï¼Œé»˜è®¤å€¼å¤§å°æ˜¯1009ï¼Œå¦‚æœæ”¾è¿›String Poolçš„Stringéå¸¸å¤šï¼Œå°±ä¼šé€ æˆHashå†²çªä¸¥é‡ï¼Œä»è€Œå¯¼è‡´é“¾è¡¨å¾ˆé•¿ï¼Œè€Œé“¾è¡¨é•¿äº†å°±ä¼šç›´æ¥é€ æˆè°ƒç”¨<code>String.intern</code>æ€§èƒ½ä¸‹é™ã€‚åœ¨JDK6ä¸­<code>StringTable</code>æ˜¯å›ºå®šçš„ï¼ŒJDK7å¯ä»¥é€šè¿‡å‚æ•°<code>-XX:StringTableSize=99991</code>æŒ‡å®šã€‚</p><h4 id="JDK6å’ŒJDK7ä¸‹internçš„åŒºåˆ«"><a href="#JDK6å’ŒJDK7ä¸‹internçš„åŒºåˆ«" class="headerlink" title="JDK6å’ŒJDK7ä¸‹internçš„åŒºåˆ«"></a>JDK6å’ŒJDK7ä¸‹internçš„åŒºåˆ«</h4><p>æˆ‘ä»¬éƒ½åšè¿‡ç±»ä¼¼<code>String abc = new String(&quot;abc&quot;)</code>è¿™ä¸ªè¯­å¥åˆ›å»ºäº†å‡ ä¸ªå¯¹è±¡çš„é¢˜ç›®ã€‚è¿™ç§é¢˜ç›®ä¸»è¦æ˜¯ä¸ºäº†è€ƒå¯Ÿæˆ‘ä»¬å¯¹å­—ç¬¦ä¸²å¯¹è±¡çš„å¸¸é‡æ± æŒæ¡ä¸å¦ã€‚ä¸Šé¢çš„è¯­å¥åˆ›å»ºäº†2ä¸ªå¯¹è±¡ï¼Œä¸€ä¸ªå¯¹è±¡æ˜¯â€abcâ€å­—ç¬¦ä¸²å‚¨å­˜åœ¨å¸¸é‡æ± ï¼Œå¦ä¸€ä¸ªæ˜¯åœ¨Javaå †ä¸­çš„Stringå¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">s.intern();</span><br><span class="line"><span class="type">String</span> <span class="variable">s2</span> <span class="operator">=</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">System.out.println(s == <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">s3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;1&quot;</span>) + <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">s3.intern();</span><br><span class="line"><span class="type">String</span> <span class="variable">s4</span> <span class="operator">=</span> <span class="string">&quot;11&quot;</span>;</span><br><span class="line">System.out.println(s3 == s4);</span><br></pre></td></tr></table></figure><p>æ‰“å°ç»“æœæ˜¯</p><ul><li>JDK6 <code>false</code> <code>false</code></li><li>JDK7 <code>false</code> <code>true</code></li></ul><h5 id="JDK6ä¸­çš„è§£é‡Š"><a href="#JDK6ä¸­çš„è§£é‡Š" class="headerlink" title="JDK6ä¸­çš„è§£é‡Š"></a>JDK6ä¸­çš„è§£é‡Š</h5><p><img src="https://qtspace.cn/contentimg/3.png"></p><p>æ³¨ï¼šå›¾ä¸­çº¢è‰²çº¿æ¡ä»£è¡¨ string å¯¹è±¡çš„å†…å®¹æŒ‡å‘ã€‚ é»‘è‰²çº¿æ¡ä»£è¡¨åœ°å€æŒ‡å‘ã€‚</p><p>åœ¨JDK6ä¸­éƒ½æ˜¯<code>false</code>ï¼Œå› ä¸ºJDK6ä¸­å¸¸é‡æ± æ˜¯åœ¨æ–¹æ³•åŒºä¸­ï¼Œæ–¹æ³•(Perm)åŒºå’Œå †(Heap)æ˜¯å®Œå…¨åˆ†å¼€çš„ã€‚ä¸Šé¢ä»£ç ä¸­ç”¨å¼•å·ç›´æ¥åˆ›å»ºçš„å¯¹è±¡ä¼šç›´æ¥åœ¨å¸¸é‡æ± ä¸­ï¼Œè€Œnewå‡ºæ¥çš„Stringå¯¹è±¡æ˜¯åœ¨å †ä¸­çš„ï¼Œæ‰€ä»¥æ‹¿ä¸€ä¸ªæ–¹æ³•(Perm)åŒºçš„å¯¹è±¡åœ°å€å’Œå †(Heap)ä¸­çš„å¯¹è±¡åœ°å€åšæ¯”è¾ƒæ˜¯è‚¯å®šä¸ç›¸åŒçš„ã€‚</p><h5 id="JDK7ä¸­çš„è§£é‡Š"><a href="#JDK7ä¸­çš„è§£é‡Š" class="headerlink" title="JDK7ä¸­çš„è§£é‡Š"></a>JDK7ä¸­çš„è§£é‡Š</h5><p><img src="https://qtspace.cn/contentimg/4.jpg"></p><p>åœ¨JDK7ä¸­ï¼Œæ‰“å°ç»“æœæ˜¯<code>false true</code>ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± æ˜¯åœ¨å †(Heap)ä¸­çš„ï¼Œè§£é‡Šå¦‚ä¸‹ï¼š</p><ul><li>åœ¨ç¬¬ä¸€æ®µä»£ç <code>String s = new String(&quot;1&quot;);</code>ç”Ÿæˆä¸¤ä¸ªå¯¹è±¡ï¼Œä¸€ä¸ªæ˜¯å¸¸é‡æ± ä¸­çš„â€œ1â€å’ŒJAVAå †(Heap)ä¸­çš„å­—ç¬¦ä¸²å¯¹è±¡ã€‚<code>s.intern;</code>è¿™ä¸€å¥æ˜¯så¯¹è±¡å»å¸¸é‡æ± ä¸­å¯»å€åå‘ç°æœ‰â€1â€å·²ç»æ‰å¸¸é‡æ± ä¸­äº†ã€‚</li><li>æ¥ä¸‹æ¥<code>String s2 = &quot;1&quot;;</code>è¿™å¥ä»£ç æ˜¯ç”Ÿæˆs2çš„å¼•ç”¨å¯¹è±¡æŒ‡å‘å¸¸é‡æ± ä¸­çš„â€1â€å¯¹è±¡ï¼Œs1å’Œs2çš„å¼•ç”¨åœ°å€æ˜æ˜¾ä¸åŒï¼Œæ‰€ä»¥æ˜¯<code>false</code>ã€‚</li><li>å†çœ‹<code>String s3 = new String(&quot;1&quot;) + new String(&quot;1&quot;);</code>è¿™å¥ä»£ç æœ€ç»ˆç”Ÿæˆ2ä¸ªå¯¹è±¡ï¼Œæ˜¯å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„â€1â€å’Œå †(Heap)ä¸­s3å¼•ç”¨çš„å¯¹è±¡ï¼Œä¸­é—´è¿˜æœ‰ä¸¤ä¸ªåŒ¿åå¯¹è±¡å…ˆä¸è®¨è®ºã€‚æ­¤æ—¶s3å¼•ç”¨å¯¹è±¡çš„å†…å®¹æ˜¯â€11â€ï¼Œè€Œä¸”â€11â€åœ¨å¸¸é‡æ± ä¸­æ˜¯ä¸å­˜åœ¨çš„ã€‚</li><li>æ¥ä¸‹æ¥<code>s3.intern();</code>ï¼Œå°†s3ä¸­çš„â€11â€å­—ç¬¦ä¸²å­˜å…¥Stringå¸¸é‡æ± ï¼Œå› ä¸ºæ­¤æ—¶å¸¸é‡æ± ä¸­æ²¡æœ‰â€11â€ï¼Œæ‰€ä»¥åœ¨å¸¸é‡æ± ä¸­ç”Ÿæˆâ€11â€å¯¹è±¡ï¼Œå…³é”®JDKä¸­å¸¸é‡æ± ä¸å­˜åœ¨æ–¹æ³•åŒºäº†ï¼Œè€Œæ˜¯å­˜åœ¨å †ä¸­ï¼Œå¸¸é‡æ± ä¸­ä¸éœ€è¦åœ¨å‚¨å­˜ä¸€ä»½å¯¹è±¡äº†ï¼Œå¯ä»¥ç›´æ¥å­˜å‚¨å †ä¸­çš„å¼•ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´å¼•ç”¨åœ°å€å°±æ˜¯s3çš„å¼•ç”¨åœ°å€ã€‚</li><li>æœ€å<code>String s4 = &quot;11&quot;;</code>æ˜¯å£°æ˜åˆ›å»ºå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥æ˜¯ç›´æ¥å»å¸¸é‡æ± åˆ›å»ºï¼Œæ­¤æ—¶å¸¸é‡æ± å­˜åœ¨â€11â€å¯¹è±¡äº†ï¼Œæ‰€ä»¥ä¼šs4å¼•ç”¨æŒ‡å‘è¯¥å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯æŒ‡å‘s3çš„å¼•ç”¨äº†ï¼Œæ‰€ä»¥s3å’Œs4å¼•ç”¨æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥<code>s3 == s4</code>æ˜¯<code>true</code>ã€‚</li></ul><p>å†çœ‹ä¸€æ®µä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">s2</span> <span class="operator">=</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">s.intern();</span><br><span class="line">System.out.println(s == s2);</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">s3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;1&quot;</span>) + <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">s4</span> <span class="operator">=</span> <span class="string">&quot;11&quot;</span>;</span><br><span class="line">s3.intern();</span><br><span class="line">System.out.println(s3 == s4);</span><br></pre></td></tr></table></figure><p>æ‰“å°ç»“æœæ˜¯ï¼š</p><ul><li>JDK6 <code>false</code> <code>false</code></li><li>JDK7 <code>false</code> <code>false</code></li></ul><p>JDK6ä¸­è§£é‡Šæ˜¯å’Œä¸Šé¢ä¸€æ ·çš„ï¼Œåœ¨JDK7ä¸­è§£é‡Šæœ‰ç‚¹ä¸ä¸€æ ·ï¼Œå¦‚å›¾ï¼š</p><p><img src="https://qtspace.cn/contentimg/5.jpg"></p><ul><li>åœ¨ä»£ç så’Œs1ä¸­ï¼Œså¼•ç”¨å¯¹è±¡æ˜¯æŒ‡å‘å †ä¸­ï¼Œs2å¼•ç”¨å¯¹è±¡æ˜¯æŒ‡å‘å¸¸é‡æ± ä¸­ï¼Œ<code>s.intern();</code>è¿™è¡Œä»£ç å¾€åæ‰§è¡Œä¸ä¼šæœ‰ä»€ä¹ˆå½±å“ï¼Œå› ä¸ºâ€1â€åœ¨å¸¸é‡æ± ä¸­å·²ç»å­˜åœ¨äº†ï¼Œæ‰€ä»¥så’Œs1çš„å¼•ç”¨å¯¹è±¡æ˜¯ä¸åŒçš„ã€‚</li><li>å†çœ‹s3å’Œs4ï¼ŒåŒºåˆ«å°±æ˜¯<code>s3.intern();</code>å¾€åæ‰§è¡Œï¼Œé¦–å…ˆå…ˆæ‰§è¡Œ<code>String s4 = &quot;11&quot;; </code>å¸¸é‡æ± ä¸å­˜åœ¨â€11â€ï¼Œæ‰€ä»¥ç”Ÿæˆâ€11â€å¯¹è±¡ï¼Œs4å¼•ç”¨å¹¶æŒ‡å‘è¯¥å¯¹è±¡ï¼Œç„¶å<code>s3.intern();</code>æ­¤æ—¶â€11â€åœ¨å¸¸é‡æ± ä¸­å·²ç»å­˜åœ¨äº†ï¼Œæ‰€ä»¥æ²¡æœ‰ä»€ä¹ˆå½±å“ï¼Œs3å¼•ç”¨å¯¹è±¡åœ¨å †ä¸­ï¼Œs4å¼•ç”¨å¯¹è±¡åœ¨å¸¸é‡æ± ä¸­ï¼Œæ‰€ä»¥å¼•ç”¨å¯¹è±¡æ˜¯ä¸åŒçš„ï¼Œæ‰€ä»¥<code>s3 == s4</code>æ˜¯<code>false</code>ã€‚</li></ul><p>ä»ä¸Šè¿°çš„ä¾‹å­ä»£ç å¯ä»¥çœ‹å‡º jdk7 ç‰ˆæœ¬å¯¹ intern æ“ä½œå’Œå¸¸é‡æ± éƒ½åšäº†ä¸€å®šçš„ä¿®æ”¹ã€‚ä¸»è¦åŒ…æ‹¬2ç‚¹ï¼š</p><ul><li>å°†Stringå¸¸é‡æ± ä»PermåŒºç§»åŠ¨åˆ°äº†Java HeapåŒº</li><li><code>String.intern</code> æ–¹æ³•æ—¶ï¼Œå¦‚æœå­˜åœ¨å †ä¸­çš„å¯¹è±¡ï¼Œä¼šç›´æ¥ä¿å­˜å¯¹è±¡çš„å¼•ç”¨ï¼Œè€Œä¸ä¼šé‡æ–°åˆ›å»ºå¯¹è±¡ã€‚</li></ul><h3 id="äº”-å¸¸ç”¨API"><a href="#äº”-å¸¸ç”¨API" class="headerlink" title="äº”  å¸¸ç”¨API"></a>äº”  å¸¸ç”¨API</h3><table><thead><tr><th align="center">æ–¹æ³•</th><th align="center">æè¿°</th></tr></thead><tbody><tr><td align="center"><code>str.concat()</code></td><td align="center">å­—ç¬¦ä¸²è¿æ¥ï¼Œæ›¿æ¢+å·</td></tr><tr><td align="center"><code>str.lengt()</code></td><td align="center">è·å–å­—ç¬¦ä¸²é•¿åº¦</td></tr><tr><td align="center"><code>isEmpty()</code></td><td align="center">åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä¸ºç©º</td></tr><tr><td align="center"><code>str.charAt(0)</code></td><td align="center">è·å–æŒ‡å®šä½ç½®å…ƒç´ </td></tr><tr><td align="center"><code>str.codePointAt(0)</code></td><td align="center">è·å–æŒ‡å®šä½ç½®å…ƒç´ ï¼Œå¹¶è¿”å›ASCIIç å€¼</td></tr><tr><td align="center"><code>str.getBytes()</code></td><td align="center">è·å–byte[]</td></tr><tr><td align="center"><code>str.equals(&quot;abc&quot;)</code></td><td align="center">å­—ç¬¦ä¸²å†…å®¹æ¯”è¾ƒ</td></tr><tr><td align="center"><code>str.equalsIgnoreCase(&quot;abc&quot;)</code></td><td align="center">å¿½ç•¥å¤§å°å†™å†…å®¹æ¯”è¾ƒ</td></tr><tr><td align="center"><code>str.startsWith(&quot;abc&quot;)</code></td><td align="center">å¼€å§‹ä½ç½®å€¼åˆ¤æ–­</td></tr><tr><td align="center"><code>str.endsWith(&quot;abc&quot;)</code></td><td align="center">ç»“æŸä½ç½®å€¼åˆ¤æ–­</td></tr><tr><td align="center"><code>str.indexOf(&quot;abc&quot;)</code></td><td align="center">åˆ¤æ–­å…ƒç´ å¼€å§‹ä½ç½®</td></tr><tr><td align="center"><code>str.lastIndexOf(&quot;abc&quot;)</code></td><td align="center">åˆ¤æ–­å…ƒç´ ç»“æŸä½ç½®</td></tr><tr><td align="center"><code>str.substring(0 ,1)</code></td><td align="center">å­—ç¬¦ä¸²æˆªå–</td></tr><tr><td align="center"><code>str.split(&quot;,&quot;)</code></td><td align="center">å­—ç¬¦ä¸²æ‹†åˆ†ï¼Œæ”¯æŒæ­£åˆ™</td></tr><tr><td align="center"><code>str.replace(&quot;a&quot;,&quot;b&quot;)</code><br /><code>str.replaceAll</code></td><td align="center">å­—ç¬¦ä¸²æ›¿æ¢</td></tr><tr><td align="center"><code>str.toUpperCase()</code></td><td align="center">è½¬å¤§å†™</td></tr><tr><td align="center"><code>str.toLowerCase()</code></td><td align="center">è½¬å°å†™</td></tr><tr><td align="center"><code>str.toCharArray()</code></td><td align="center">è½¬char[]</td></tr><tr><td align="center"><code>String.format(str, &quot;&quot;)</code></td><td align="center">æ ¼å¼åŒ–</td></tr><tr><td align="center"><code>str.valueOf(&quot;123&quot;)</code></td><td align="center">è½¬å­—ç¬¦ä¸²</td></tr><tr><td align="center"><code>str.trim()</code></td><td align="center">é¦–ä½å»ç©ºæ ¼</td></tr><tr><td align="center"><code>str.hashCode()</code></td><td align="center">è·å–hashcodeå€¼</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> String </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HashCode &amp; HashMapæ‰°åŠ¨å‡½æ•°</title>
      <link href="/2022/03/05/HashCode-HashMap/"/>
      <url>/2022/03/05/HashCode-HashMap/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h3 id="1-HashCodeä¸ºä»€ä¹ˆç”¨31ä½œä¸ºä¹˜æ•°ï¼Ÿ"><a href="#1-HashCodeä¸ºä»€ä¹ˆç”¨31ä½œä¸ºä¹˜æ•°ï¼Ÿ" class="headerlink" title="1.HashCodeä¸ºä»€ä¹ˆç”¨31ä½œä¸ºä¹˜æ•°ï¼Ÿ"></a>1.HashCodeä¸ºä»€ä¹ˆç”¨31ä½œä¸ºä¹˜æ•°ï¼Ÿ</h3><p>String.classçš„hashCodeæ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> hash;</span><br><span class="line">    <span class="keyword">if</span> (h == <span class="number">0</span> &amp;&amp; value.lengt &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">char</span>[] val = value;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; value.length; i++) &#123;</span><br><span class="line">            h = <span class="number">31</span> * h + val[i]</span><br><span class="line">        &#125;</span><br><span class="line">        hash = h</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ–¹æ³•ä¸­æœ‰ä¸€ä¸ªå†™æ­»å›ºå®šå€¼31ï¼Œæƒ³å¿…å¤§å®¶åœ¨çœ‹Stringçš„hashCodeæ–¹æ³•æºç æ—¶éƒ½ä¼šæœ‰è¿™ä¸ªç–‘é—®ï¼Œä¸ºä»€ä¹ˆæ˜¯31ï¼Ÿ</p><ul><li>hashå‡½æ•°å¿…é¡»é€‰ç”¨è´¨æ•°ï¼Œè¿™æ˜¯è¢«ç§‘å­¦å®¶è®ºè¯è¿‡çš„hashå‡½æ•°å‡å°‘å†²çªçš„ç†è®ºã€‚</li><li>å¦‚æœä¹˜æ•°æ˜¯å¶æ•°ï¼Œå¹¶ä¸”ä¹˜æ³•æº¢å‡ºçš„è¯ï¼Œä¿¡æ¯å°±ä¼šä¸¢å¤±ï¼Œå› ä¸ºä½¿ç”¨å¶æ•°ç›¸å½“äºä½è¿ç®—ï¼ˆä½ä½è¡¥0ï¼‰ã€‚</li><li>ä½¿ç”¨31æœ‰ä¸ªå¾ˆå¥½çš„æ€§èƒ½ï¼Œå³ç”¨ç§»ä½å’Œå‡æ³•æ¥ä»£æ›¿ä¹˜æ³•ï¼Œå¯ä»¥å¾—åˆ°æ›´å¥½çš„æ€§èƒ½ï¼š31*i &#x3D; (i &lt;&lt; 5) - iï¼Œç›®å‰ä½¿ç”¨çš„JVMè‡ªåŠ¨å®Œæˆæ­¤ç±»ä¼˜åŒ–ã€‚</li><li>31æ˜¯ä¸ªä¸å¤§ä¸å°çš„è´¨æ•°ï¼Œhashç¢°æ’æ¦‚ç‡å¾ˆä½ï¼Œè€Œä¸”ç”Ÿæˆçš„hashå€¼å¾ˆå‡åŒ€çš„æ•£åˆ—ã€‚ï¼ˆå¯ä»¥é€šè¿‡å®éªŒå¾—å‡ºï¼‰</li></ul><h3 id="2-HashMap"><a href="#2-HashMap" class="headerlink" title="2. HashMap"></a>2. HashMap</h3><h4 id="2-1-HashMapæ‰°åŠ¨å‡½æ•°"><a href="#2-1-HashMapæ‰°åŠ¨å‡½æ•°" class="headerlink" title="2.1 HashMapæ‰°åŠ¨å‡½æ•°"></a>2.1 HashMapæ‰°åŠ¨å‡½æ•°</h4><p>Java8ä¸­HashMapè·å–hashå€¼çš„æ–¹æ³•ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="type">int</span> h;</span><br><span class="line">   <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode() ^ (h &gt;&gt;&gt; <span class="number">16</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>getæ–¹æ³•ä¸­è·å–keyçš„ä¸‹æ ‡å€¼æ–¹æ³•ä¸ºï¼šnæ˜¯mapçš„å¤§å°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(n - <span class="number">1</span>) &amp; hash</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°HashMapçš„è·å–hashæ–¹æ³•çš„æºç æ—¶ï¼Œéƒ½ä¼šæ€è€ƒä¸ºä»€ä¹ˆä½¿ç”¨æ‰°åŠ¨å‡½æ•°è®¡ç®—ï¼Œä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥ç”¨keyçš„hashCodeçš„å€¼ï¼Ÿ</p><ul><li>é¦–å…ˆï¼ŒhashCodeçš„å–å€¼èŒƒå›´æ˜¯[-2^32, 2^31]ï¼Œä¹Ÿå°±æ˜¯[[-2147483648, 2147483647]ï¼Œæœ‰å°†è¿‘40äº¿çš„é•¿åº¦ï¼Œä¸å¯èƒ½æŠŠæ•°ç»„åˆå§‹åŒ–å¾—è¿™ä¹ˆå¤§ï¼Œå†…å­˜ä¹Ÿæ”¾ä¸ä¸‹ã€‚</li><li>æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦å°†hashCodeçš„å€¼è¿›è¡Œæ‰°åŠ¨è®¡ç®—ï¼ˆh &#x3D; key.hashCode() ^ (h &gt;&gt;&gt; 16)ï¼‰,æŠŠhashå€¼å¾€å³ç§»16ä½ï¼Œå³ç§»é«˜ä½è¡¥0ï¼Œç›¸å½“äºæŠŠé«˜ä½ç§»åˆ°äº†ä½ä½ï¼Œç„¶åå†ä¸åŸå…ˆçš„hashå€¼åšå¼‚æˆ–è¿ç®—(ç›¸åŒä¸º0ï¼Œä¸ç›¸åŒä¸º1)ï¼Œè¿™å°±ç›¸å½“äºæ··åˆäº†åŸhashå€¼ä¸­çš„é«˜ä½å’Œä½ä½ï¼Œå¾—åˆ°ä¸€ä¸ªæ›´åŠ æ•£åˆ—çš„ä½ 16 ä½çš„ Hash å€¼ï¼Œå¢å¤§äº†éšæœºæ€§ã€‚æœ€åä¸mapæ•°ç»„çš„å¤§å°-1åšä¸è¿ç®—ï¼Œé«˜ä½å…¨éƒ¨å½’0ï¼Œåªä¿ç•™æœ«å››ä½<br>è®¡ç®—æ–¹å¼å¦‚ä¸‹å›¾ï¼šæ¯”å¦‚åŸhashå€¼ä¸ºï¼š00000000 11111111 00000000 00001010</li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hashCode()      00000000 11111111 00000000 00001010hashå€¼</span><br><span class="line">hashCode() &gt;&gt;&gt; 16     00000000 00000000 00000000 11111111å³ç§»16ä½</span><br><span class="line">hashCode() ^ (hashCode() &gt;&gt;&gt; 16)    00000000 11111111 00000000 11110101  å¼‚æˆ–é«˜ä½ä½(ç›¸åŒä¸º0,ä¸ç›¸åŒä¸º1)</span><br><span class="line">hashCode() ^ (hashCode() &gt;&gt;&gt; 16) &amp; 15 00000000 00000000 00000000 00001111 ä¸è¿ç®—ä¸‹æ ‡(éƒ½ä¸º1åˆ™ä¸º1,å¦åˆ™ä¸º0)</span><br><span class="line">  00000000 00000000 00000000 00000101</span><br><span class="line">                                         = 0101 </span><br><span class="line">                                         = 5</span><br></pre></td></tr></table></figure><ul><li>ä¸€å¥è¯ï¼Œä½¿ç”¨æ‰°åŠ¨å‡½æ•°å°±æ˜¯ä¸ºäº†å¢åŠ éšæœºæ€§ï¼Œè®©æ•°æ®å…ƒç´ æ›´åŠ å‡åŒ€çš„æ•£åˆ—ï¼Œå‡å°‘ç¢°æ’ã€‚</li></ul><h4 id="2-2-HashMapåˆå§‹åŒ–å®¹é‡"><a href="#2-2-HashMapåˆå§‹åŒ–å®¹é‡" class="headerlink" title="2.2 HashMapåˆå§‹åŒ–å®¹é‡"></a>2.2 HashMapåˆå§‹åŒ–å®¹é‡</h4><p>HashMapçš„åˆå§‹åŒ–å«é‡æ˜¯16ï¼Œæœ€å¤§å®¹é‡æ˜¯2çš„30æ¬¡æ–¹ï¼Œè€Œä¸”å®¹é‡å¤§å°å¿…é¡»æ˜¯2çš„å€æ•°ï¼Œå› ä¸ºåªæœ‰2çš„å€æ•°åœ¨å‡1çš„æ—¶å€™ï¼ŒäºŒè¿›åˆ¶éƒ½æ˜¯1ï¼Œä»è€Œåœ¨ä¸hashå€¼åšä¸è¿ç®—çš„æ—¶å€™éšæœºæ€§æ›´å¤§ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The default initial capacity - MUST be a power of two.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_INITAL_CAPCITY</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">4</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬ä¼ çš„å€¼ä¸æ˜¯2çš„å€æ•°ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¼ 17ï¼Œè¿™ä¸ªæ—¶å€™HashMapä¼šæ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ</p><p>HashMapæ„é€ æ–¹æ³•é‡Œé¢ï¼Œä¼šè°ƒç”¨ä¸€ä¸ªtableSizeForæ–¹æ³•è¿›è¡Œè®¡ç®—ï¼Œå¾—åˆ°å¤§äºæˆ‘ä»¬ä¼ çš„å€¼æœ€å°çš„2å€æ•°çš„æ•°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">HashMap</span><span class="params">(<span class="type">int</span> initialCapacity, <span class="type">float</span> loadFactor)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">this</span>.loadFactor = loadlFactor;</span><br><span class="line">    <span class="built_in">this</span>.threshold = tablSizeFor(initialCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">tableSizeFor</span><span class="params">(<span class="type">int</span> cap)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> cap - <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUN_CAPACITY ? MAXIMUM_CAPACITY : n + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>MAXIMUN_CAPACITY  &#x3D; 1 &lt;&lt; 30ï¼Œè¿™ä¸ªæ˜¯ä¸´ç•ŒèŒƒå›´ï¼Œä¹Ÿå°±æ˜¯æœ€å¤§çš„Mapé›†åˆã€‚</p></li><li><p>tableSizeForéƒ½æ˜¯åœ¨å‘å³ç§»1ã€2ã€4ã€8ã€16ä½ï¼Œç„¶ååšæˆ–è¿ç®—(ä¸¤ä¸ªä½éƒ½ä¸º0åˆ™ä¸º0ï¼Œå¦åˆ™ä¸º1)ï¼Œå› ä¸ºè¿™æ ·å­å¯æŠŠäºŒè¿›åˆ¶çš„å„ä¸ªä½ç½®éƒ½å¡«ä¸Š1ï¼ŒåŠ ä¸Š1ä¹‹åï¼Œå°±æ˜¯ä¸€ä¸ªæ ‡å‡†çš„2çš„å€æ•°çš„æ•°äº†ã€‚</p></li><li><p>å¯ä»¥æŠŠä¼ å…¥17åˆå§‹åŒ–è®¡ç®—é˜™å€¼çš„è¿‡ç¨‹ç”¨å›¾å±•ç¤ºå‡ºæ¥ï¼Œæ–¹ä¾¿ç†è§£ï¼Œæœ€åå¾—åˆ°çš„æ•°å°±æ˜¯32</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">17</span> - <span class="number">1</span> <span class="number">10000</span></span><br><span class="line">n &gt;&gt;&gt; <span class="number">1</span>  <span class="number">01000</span> </span><br><span class="line">n | n &gt;&gt;&gt; <span class="number">1</span><span class="number">11000</span></span><br><span class="line">n &gt;&gt;&gt; <span class="number">2</span><span class="number">00110</span></span><br><span class="line">n | n &gt;&gt;&gt; <span class="number">2</span><span class="number">11110</span></span><br><span class="line">n &gt;&gt;&gt; <span class="number">4</span> <span class="number">00001</span></span><br><span class="line">n | n &gt;&gt;&gt; <span class="number">4</span><span class="number">11111</span></span><br><span class="line">n &gt;&gt;&gt; <span class="number">8</span><span class="number">00000</span></span><br><span class="line">n | n &gt;&gt;&gt; <span class="number">8</span>     <span class="number">11111</span></span><br><span class="line">n &gt;&gt;&gt; <span class="number">16</span><span class="number">00000</span></span><br><span class="line">n | n &gt;&gt;&gt; <span class="number">16</span>    <span class="number">11111</span> = <span class="number">31</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="2-3-HashMapè´Ÿè½½å› å­"><a href="#2-3-HashMapè´Ÿè½½å› å­" class="headerlink" title="2.3 HashMapè´Ÿè½½å› å­"></a>2.3 HashMapè´Ÿè½½å› å­</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">float</span> <span class="variable">DEFAULT_LOAD_FACTOR</span> <span class="operator">=</span> <span class="number">0.75f</span>;</span><br></pre></td></tr></table></figure><p>è´Ÿè½½å› å­ç”¨äºå½“å®¹é‡è¶…è¿‡æŸä¸ªé˜™å€¼æ—¶ï¼Œè¦è¿›è¡Œæ‰©å®¹æ“ä½œã€‚åœ¨HashMapä¸­ï¼Œè´Ÿè½½å› å­å†³å®šäº†æ•°æ®é‡å¤šå°‘äº†ä»¥åå¯ä»¥è¿›è¡Œæ‰©å®¹ã€‚æ¯”å¦‚HashMapçš„å®¹é‡å¤§å°ä¸º16ï¼Œå½“å®¹é‡è¶…è¿‡ 16*0.75&#x3D;12ä¸ªå…ƒç´ æ—¶ï¼Œå°±è¦è¿›è¡Œæ‰©å®¹æ“ä½œäº†ï¼Œè¿™æ ·å­åšçš„åŸå› æ˜¯å› ä¸ºå¯èƒ½å‡ºç°å³ä½¿ä½ çš„å…ƒç´ æ•°é‡æ¯”å®¹é‡å¤§æ—¶ä¹Ÿä¸ä¸€å®šèƒ½å¡«æ»¡å®¹é‡ï¼Œå› ä¸ºæŸäº›ä½ç½®ä¼šå‡ºç°ç¢°æ’ï¼Œä½¿ç”¨é“¾è¡¨å­˜æ”¾äº†ï¼Œå¦‚æœå­˜åœ¨å¤§é‡çš„é“¾è¡¨ï¼Œè¿™æ ·å­å°±å¤±å»äº†Mapçš„æ•°ç»„çš„æ€§èƒ½äº†ã€‚æ‰€ä»¥è¦é€‰æ‹©ä¸€ä¸ªåˆç†çš„å¤§å°è¿›è¡Œæ‰©å®¹ï¼ŒHashMapé»˜è®¤å€¼æ˜¯0.75ï¼Œå½“é˜™å€¼å®¹é‡å äº†3&#x2F;4æ—¶è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œå‡å°‘Hashç¢°æ’ã€‚åŒæ—¶0.75æ˜¯ä¸€ä¸ªé»˜è®¤æ„é€ å€¼ï¼Œåœ¨åˆ›å»ºHashMapä¹Ÿå¯ä»¥åšè°ƒæ•´ï¼Œæ¯”å¦‚ä½ å¸Œæœ›ç”¨æ›´å¤šçš„ç©ºé—´æ¢å–æ—¶é—´ï¼Œå¯ä»¥æŠŠè´Ÿè½½å› å­è°ƒçš„æ›´å°ä¸€ç‚¹ï¼Œå‡å°‘ç¢°æ’ã€‚</p><h6 id="2-4-HashMapæ‰©å®¹å…ƒç´ æ‹†åˆ†"><a href="#2-4-HashMapæ‰©å®¹å…ƒç´ æ‹†åˆ†" class="headerlink" title="2.4 HashMapæ‰©å®¹å…ƒç´ æ‹†åˆ†"></a>2.4 HashMapæ‰©å®¹å…ƒç´ æ‹†åˆ†</h6><p>HashMapåœ¨æ‰©å®¹çš„æ—¶å€™è¦æŠŠåŸå…ˆçš„å…ƒç´ æ‹†åˆ†åˆ°æ–°çš„æ•°ç»„ä¸­ï¼Œæ‹†åˆ†è¿‡ç¨‹ä¸­ï¼ŒåŸjdk1.7ä¸­ä¼šéœ€è¦é‡æ–°è®¡ç®—å“ˆå¸Œå€¼ï¼Œä½†åœ¨jdk1.8ä¸­è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä¸å†é‡æ–°è®¡ç®—ï¼Œæå‡äº†æ‹†åˆ†çš„æ€§èƒ½ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;zuio&quot;</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> key.hashCode() ^ (key.hashCode() &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;zuioçš„æ‰°åŠ¨hashå€¼ï¼š&quot;</span> + Integer.toBinaryString(hash));</span><br><span class="line">System.out.println(<span class="string">&quot;å®¹é‡ä¸º16çš„ä¸‹æ ‡äºŒè¿›åˆ¶å€¼ï¼š&quot;</span> + Integer.toBinaryString(hash &amp; (<span class="number">16</span> - <span class="number">1</span>) ));</span><br><span class="line">System.out.println(<span class="string">&quot;å®¹é‡ä¸º16çš„ä¸‹æ ‡åè¿›åˆ¶å€¼ï¼š&quot;</span> + ((<span class="number">16</span> - <span class="number">1</span>) &amp; hash));</span><br><span class="line">System.out.println(<span class="string">&quot;zuio hashå€¼åŸå®¹é‡16ä¸è¿ç®—ç»“æœä¸ºï¼š&quot;</span> + (hash &amp; <span class="number">16</span>));</span><br><span class="line">System.out.println(<span class="string">&quot;å®¹é‡ä¸º32çš„ä¸‹æ ‡äºŒè¿›åˆ¶å€¼ï¼š&quot;</span> + Integer.toBinaryString(hash &amp; (<span class="number">32</span> - <span class="number">1</span>) ));</span><br><span class="line">System.out.println(<span class="string">&quot;å®¹é‡ä¸º32çš„ä¸‹æ ‡åè¿›åˆ¶å€¼ï¼š&quot;</span> + ((<span class="number">32</span> - <span class="number">1</span>) &amp; hash));</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">key2</span> <span class="operator">=</span> <span class="string">&quot;plop&quot;</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">hash2</span> <span class="operator">=</span> key2.hashCode() ^ (key2.hashCode() &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;zuioçš„æ‰°åŠ¨hashå€¼ï¼š&quot;</span> + Integer.toBinaryString(hash2));</span><br><span class="line">System.out.println(<span class="string">&quot;å®¹é‡ä¸º16çš„ä¸‹æ ‡äºŒè¿›åˆ¶å€¼ï¼š&quot;</span> + Integer.toBinaryString(hash2 &amp; (<span class="number">16</span> - <span class="number">1</span>) ));</span><br><span class="line">System.out.println(<span class="string">&quot;å®¹é‡ä¸º16çš„ä¸‹æ ‡åè¿›åˆ¶å€¼ï¼š&quot;</span> + ((<span class="number">16</span> - <span class="number">1</span>) &amp; hash2));</span><br><span class="line">System.out.println(<span class="string">&quot;plop hashå€¼ä¸åŸå®¹é‡16ä¸è¿ç®—ç»“æœä¸ºï¼š&quot;</span> + (hash2 &amp; <span class="number">16</span>));</span><br><span class="line">System.out.println(<span class="string">&quot;å®¹é‡ä¸º32çš„ä¸‹æ ‡äºŒè¿›åˆ¶å€¼ï¼š&quot;</span> + Integer.toBinaryString(hash2 &amp; (<span class="number">32</span> - <span class="number">1</span>) ));</span><br><span class="line">System.out.println(<span class="string">&quot;å®¹é‡ä¸º32çš„ä¸‹æ ‡åè¿›åˆ¶å€¼ï¼š&quot;</span> + ((<span class="number">32</span> - <span class="number">1</span>) &amp; hash2));</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸Šé¢è¾“å‡ºç»“æœä¸º</span></span><br><span class="line"><span class="comment">// zuioçš„æ‰°åŠ¨hashå€¼ï¼š1110010011100110011000</span></span><br><span class="line"><span class="comment">// å®¹é‡ä¸º16çš„ä¸‹æ ‡äºŒè¿›åˆ¶å€¼ï¼š1000</span></span><br><span class="line"><span class="comment">// å®¹é‡ä¸º16çš„ä¸‹æ ‡åè¿›åˆ¶å€¼ï¼š8</span></span><br><span class="line"><span class="comment">// zuio hashå€¼ä¸åŸå®¹é‡16ä¸è¿ç®—ç»“æœä¸ºï¼š16</span></span><br><span class="line"><span class="comment">// å®¹é‡ä¸º32çš„ä¸‹æ ‡äºŒè¿›åˆ¶å€¼ï¼š11000</span></span><br><span class="line"><span class="comment">// å®¹é‡ä¸º32çš„ä¸‹æ ‡åè¿›åˆ¶å€¼ï¼š24</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// plopçš„æ‰°åŠ¨hashå€¼ï¼š1101001000110011101001</span></span><br><span class="line"><span class="comment">// å®¹é‡ä¸º16çš„ä¸‹æ ‡äºŒè¿›åˆ¶å€¼ï¼š1001</span></span><br><span class="line"><span class="comment">// å®¹é‡ä¸º16çš„ä¸‹æ ‡åè¿›åˆ¶å€¼ï¼š9</span></span><br><span class="line"><span class="comment">// plop hashå€¼ä¸åŸå®¹é‡16ä¸è¿ç®—ç»“æœä¸ºï¼š0</span></span><br><span class="line"><span class="comment">// å®¹é‡ä¸º32çš„ä¸‹æ ‡äºŒè¿›åˆ¶å€¼ï¼š1001</span></span><br><span class="line"><span class="comment">// å®¹é‡ä¸º32çš„ä¸‹æ ‡åè¿›åˆ¶å€¼ï¼š9</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢ä¸¤ä¸ªä¾‹å­å¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼šåŸhashå€¼ä¸åŸå®¹é‡è¿›è¡Œ&amp;è¿ç®—ï¼Œå¦‚æœç»“æœä¸º0ï¼Œåˆ™ä¸‹æ ‡ä½ç½®ä¸å˜ï¼Œå¦‚æœä¸ä¸º0ï¼Œåˆ™æ–°çš„ä¸‹æ ‡åœ¨åŸå…ˆçš„ä½ç½®ä¸ŠåŠ ä¸ŠåŸå…ˆçš„å®¹é‡ï¼ˆæˆ‘åªä¸¾äº†ä¸¤ä¸ªä¾‹ï¼Œå¯ä»¥å¤šä¸¾äº›ä¾‹å­ï¼Œæœ€åéƒ½å¯ä»¥å¾—åˆ°ä¸Šé¢ç»“è®ºï¼‰ã€‚åœ¨HashMapæ‰©å®¹æ–¹æ³•resizeæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K, V&gt;[] resize() &#123;</span><br><span class="line">...</span><br><span class="line"><span class="comment">// hashå€¼ä¸åŸå®¹é‡&amp;è¿ç®—</span></span><br><span class="line"><span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">// åŸç´¢å¼•</span></span><br><span class="line">    <span class="keyword">if</span> (loTail == <span class="literal">null</span>)</span><br><span class="line">    loHead = e;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    loTail.next = e;</span><br><span class="line">    loTail = e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// åŸç´¢å¼• + åŸå®¹é‡</span></span><br><span class="line">    <span class="keyword">if</span> (hiTail == <span class="literal">null</span>)</span><br><span class="line">    hiHead = e;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    hiTail.next = e;</span><br><span class="line">    hiTail = e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>HashMapæ¯ä¸€æ¬¡æ‰§è¡Œæ‰©å®¹åï¼Œæ•°ç»„é•¿åº¦éƒ½å˜æˆåŸæ¥çš„2å€ï¼Œæ‰€ä»¥å°±æ˜¯æ•°ç»„é•¿åº¦è½¬ä¸ºäºŒè¿›åˆ¶åæ¯”åŸæ¥å¤šäº†ä¸€ä½ï¼Œæ¯”å¦‚åŸå…ˆ16-1ï¼ŒäºŒè¿›åˆ¶ä¸º1111ï¼Œæ‰©å®¹ä¹‹åä¸º32-1ï¼ŒäºŒè¿›åˆ¶ä¸º11111ï¼ŒäºŒè¿›åˆ¶éƒ½å¤šäº†ä¸€ä½ã€‚å¤šå‡ºæ¥çš„è¿™ä¸€ä½ä¸hashå€¼çš„åŒä¸€ä½åš&amp;è¿ç®—ï¼Œç»“æœä¸º0åˆ™ç´¢å¼•ä¸å˜ï¼Œç»“æœä¸º1åˆ™ç´¢å¼•ä¸ºåŸç´¢å¼•+åŸæ•°ç»„é•¿åº¦ï¼Œæ —å­å¦‚ä¸‹ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">å¤šå‡ºæ¥çš„äºŒè¿›åˆ¶ä¸€ä½1ä¸hashåšä¸è¿ç®—ä¸º1, ä¸ºç´¢å¼•ä¸ºåŸç´¢å¼• + åŸæ•°ç»„é•¿åº¦</span><br><span class="line">åŸæ•°ç»„ä¸Šæ¬¡16-1çš„äºŒè¿›åˆ¶:   0000 0000 0000 0000 0000 0000 0000 1111</span><br><span class="line">æ–°æ•°ç»„é•¿åº¦32-1çš„äºŒè¿›åˆ¶:    0000 0000 0000 0000 0000 0000 0001 1111</span><br><span class="line">å­—ç¬¦ä¸²zuioçš„æ‰°åŠ¨hashå€¼:   0000 0000 0011 1001 0011 1001 1001 1000</span><br><span class="line">å¤šå‡ºæ¥çš„è¿™ä¸€ä½ä¸è¿ç®—ç»“æœ     1 </span><br><span class="line"> </span><br><span class="line">å¤šå‡ºæ¥çš„äºŒè¿›åˆ¶ä¸€ä½1ä¸hashåšä¸è¿ç®—ä¸º0, ä¸ºç´¢å¼•ä¸ºåŸç´¢å¼•    </span><br><span class="line">åŸæ•°ç»„ä¸Šæ¬¡16-1çš„äºŒè¿›åˆ¶:   0000 0000 0000 0000 0000 0000 0000 1111</span><br><span class="line">æ–°æ•°ç»„é•¿åº¦32-1çš„äºŒè¿›åˆ¶:    0000 0000 0000 0000 0000 0000 0001 1111</span><br><span class="line">å­—ç¬¦ä¸²plopçš„æ‰°åŠ¨hashå€¼:   0000 0000 0011 0100 1000 1100 1110 1001</span><br><span class="line">        å¤šå‡ºæ¥çš„è¿™ä¸€ä½ä¸è¿ç®—ç»“æœ     0</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HashCode </tag>
            
            <tag> HashMap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Githubä¸Šä¼ æœ¬åœ°é¡¹ç›®</title>
      <link href="/2022/03/02/github-push-local-project/"/>
      <url>/2022/03/02/github-push-local-project/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><p>1.é€‰æ‹©é¡¹ç›®ï¼Œå³é”®Git Bash Hereï¼ˆéœ€è¦å®‰è£…Gitï¼‰</p><p>2.åœ¨Gitå‘½ä»¤çª—å£è¾“å…¥git initå‘½ä»¤ä¹‹åï¼Œä¼šç”Ÿæˆä¸€ä¸ª.gitæ–‡ä»¶å¤¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br></pre></td></tr></table></figure><p>3.è¾“å…¥git add . å‘½ä»¤å°†å…¨éƒ¨çš„æ–‡ä»¶æ·»åŠ åˆ°ç¼“å­˜å»(æ³¨æ„è¿™ä¸ªâ€.â€ï¼Œæ˜¯æœ‰ç©ºæ ¼çš„ï¼Œâ€.â€ä»£è¡¨è¿™ä¸ªtestè¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹çš„ç›®å½•å…¨éƒ¨éƒ½æäº¤ã€‚ä½ ä¹Ÿå¯ä»¥é€šè¿‡git add æ–‡ä»¶å  æäº¤æŒ‡å®šçš„æ–‡ä»¶)ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git add .</span><br></pre></td></tr></table></figure><p>4.è¾“å…¥git commit -m â€œè¿™é‡Œæ˜¯æ³¨é‡Šâ€ï¼ŒæŠŠæ–‡ä»¶æäº¤åˆ°æœ¬åœ°ä»“åº“</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git commit-m &quot;åˆå§‹åŒ–é¡¹ç›®&quot;</span><br></pre></td></tr></table></figure><p>5.è¿æ¥è¿œç¨‹ä»“åº“ï¼Œå…‹éš†è‡ªå·±çš„githubé¡¹ç›®åœ°å€ï¼Œæ¯”å¦‚ä¸º<a href="https://gitcode.net/CreativeAlliance/lottery-1195-qingtian.git%EF%BC%8C%E8%BE%93%E5%85%A5%E5%91%BD%E4%BB%A4%E3%80%82%E8%BF%9E%E6%8E%A5%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%9C%80%E8%A6%81%E8%BE%93%E5%85%A5github%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81">https://gitcode.net/CreativeAlliance/lottery-1195-qingtian.gitï¼Œè¾“å…¥å‘½ä»¤ã€‚è¿æ¥è¿‡ç¨‹ä¸­éœ€è¦è¾“å…¥githubè´¦å·å¯†ç </a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin https://gitcode.net/CreativeAlliance/lottery-1195-qingtian.git</span><br></pre></td></tr></table></figure><p>6.è¾“å…¥å‘½ä»¤git push -u origin master ç”±äºæ–°å»ºçš„è¿œç¨‹ä»“åº“æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥è¦åŠ ä¸Š-uè¿™ä¸ªå‚æ•°ã€‚ç„¶åè¿›å»GitHubä»“åº“åˆ·æ–°ä¸‹å°±ä¼šæœ‰å·²ç»ä¸Šä¼ çš„æ–‡ä»¶å¤¹äº†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure><p>7.æœ€åè¾“å…¥git push origin master å°†æœ¬åœ°ä»“åº“æ¨é€åˆ°è¿œç¨‹masteråˆ†æ”¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push origin master</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Github </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Github </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexoæ­å»ºä¸ªäººåšå®¢(ä¸€)</title>
      <link href="/2022/03/02/hexo-build-blog/"/>
      <url>/2022/03/02/hexo-build-blog/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h3 id="ä»€ä¹ˆæ˜¯Hexo"><a href="#ä»€ä¹ˆæ˜¯Hexo" class="headerlink" title="ä»€ä¹ˆæ˜¯Hexo?"></a>ä»€ä¹ˆæ˜¯Hexo?</h3><p><a href="https://hexo.io/zh-cn/docs/">Hexo</a> æ˜¯ä¸€ä¸ªå¿«é€Ÿã€ç®€æ´ä¸”é«˜æ•ˆçš„åšå®¢æ¡†æ¶ã€‚Hexo ä½¿ç”¨ <a href="http://daringfireball.net/projects/markdown/">Markdown</a>ï¼ˆæˆ–å…¶ä»–æ¸²æŸ“å¼•æ“ï¼‰è§£ææ–‡ç« ï¼Œåœ¨å‡ ç§’å†…ï¼Œå³å¯åˆ©ç”¨é“ä¸½çš„ä¸»é¢˜ç”Ÿæˆé™æ€ç½‘é¡µã€‚</p><h3 id="å®‰è£…Hexoå‰æ"><a href="#å®‰è£…Hexoå‰æ" class="headerlink" title="å®‰è£…Hexoå‰æ"></a>å®‰è£…Hexoå‰æ</h3><p>å®‰è£… Hexo ç›¸å½“ç®€å•ï¼Œåªéœ€è¦å…ˆå®‰è£…ä¸‹åˆ—åº”ç”¨ç¨‹åºå³å¯ï¼š</p><ul><li><a href="http://nodejs.org/">Node.js</a> (Node.js ç‰ˆæœ¬éœ€ä¸ä½äº 10.13ï¼Œå»ºè®®ä½¿ç”¨ Node.js 12.0 åŠä»¥ä¸Šç‰ˆæœ¬)</li><li><a href="http://git-scm.com/">Git</a></li></ul><p>æˆåŠŸå®‰è£…å¥½Gitï¼ŒNode.jsä¹‹åå¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤è¡ŒæŸ¥çœ‹ç‰ˆæœ¬ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git --version</span><br><span class="line">node -v</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…Hexo"><a href="#å®‰è£…Hexo" class="headerlink" title="å®‰è£…Hexo"></a>å®‰è£…Hexo</h3><p>Gitå’ŒNodejså®‰è£…å¥½åï¼Œå°±å¯ä»¥å®‰è£…Hexoäº†ï¼Œä½ å¯ä»¥å…ˆåˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹blogï¼Œç„¶å<code>cd</code>åˆ°è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹ï¼ˆæˆ–è€…åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹ç›´æ¥å³é”®git bashæ‰“å¼€ï¼‰</p><p>è¾“å…¥ä»¥ä¸‹å‘½ä»¤å®‰è£…Hexo</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g hexo-cli</span><br></pre></td></tr></table></figure><p>å®‰è£…å®Œæˆä¹‹åè¾“å…¥<code>hexo -v</code>æŸ¥çœ‹ä¸€ä¸‹ç‰ˆæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo -v</span><br></pre></td></tr></table></figure><p>å®‰è£… Hexo å®Œæˆåï¼Œè¯·æ‰§è¡Œä¸‹åˆ—å‘½ä»¤ï¼ŒHexo å°†ä¼šåœ¨æŒ‡å®šæ–‡ä»¶å¤¹ä¸­æ–°å»ºæ‰€éœ€è¦çš„æ–‡ä»¶ã€‚folderæ˜¯è‡ªå·±å»ºçš„æ–‡ä»¶å¤¹ï¼Œä¹Ÿå¯ä»¥å»ºå¥½æ–‡ä»¶å¤¹ç„¶åå³é”®git bashæ‰“å¼€ï¼Œè¾“å…¥<code>hexo init</code>ã€<code>npm install</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo init &lt;folder&gt;</span><br><span class="line"><span class="built_in">cd</span> &lt;folder&gt;</span><br><span class="line">npm install</span><br></pre></td></tr></table></figure><p>åˆå§‹åŒ–å®Œæˆä¹‹åï¼ŒæŒ‡å®šæ–‡ä»¶å¤¹çš„ç›®å½•å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ _config.yml   #é…ç½®æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ package.json  #åº”ç”¨ç¨‹åºçš„ä¿¡æ¯</span><br><span class="line">â”œâ”€â”€ scaffolds     #ç”Ÿæˆæ–‡ä»¶çš„ä¸€äº›æ¨¡ç‰ˆ</span><br><span class="line">â”œâ”€â”€ source        #å­˜æ”¾å†™çš„æ–‡ç« </span><br><span class="line">|   â”œâ”€â”€ _drafts</span><br><span class="line">|   â””â”€â”€ _posts</span><br><span class="line">â””â”€â”€ themes        #ä¸»é¢˜</span><br></pre></td></tr></table></figure><p>è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œç”Ÿæˆé™æ€æ–‡ä»¶å’Œå¯åŠ¨HexoæœåŠ¡ï¼Œåœ¨æµè§ˆå™¨è¾“å…¥<code>localhost:4000</code>å°±å¯ä»¥çœ‹åˆ°ä½ ç”Ÿæˆçš„åšå®¢äº†ï¼Œå¯ä»¥<code>ctrl + c</code>åœæ­¢æœåŠ¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hexo g</span><br><span class="line">hexo server</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡ŒHexoå·²ç»å…¨éƒ¨å®‰è£…å®Œæ¯•ï¼Œå¦‚æœè¦è®¿é—®è‡ªå·±çš„åšå®¢å°±æ˜¯ä¸€ç›´å¯åŠ¨HexoæœåŠ¡ï¼Œè€Œä¸”æ˜¯åœ¨æœ¬åœ°è¿™è‚¯å®šæ˜¯ä¸è¡Œï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬è¦ç™½å«–GitHubã€‚</p><h3 id="åˆ›å»ºGitHubä¸ªäººä»“åº“"><a href="#åˆ›å»ºGitHubä¸ªäººä»“åº“" class="headerlink" title="åˆ›å»ºGitHubä¸ªäººä»“åº“"></a>åˆ›å»ºGitHubä¸ªäººä»“åº“</h3><p>é¦–å…ˆï¼Œä½ å…ˆæœ‰ä¸€ä¸ªGithubè´¦æˆ·ï¼Œå¦‚æœæ²¡æœ‰å…ˆæ³¨å†Œï¼Œæœ‰äº†è´¦å·ä¹‹åï¼Œåˆ›å»ºä¸€ä¸ªå’Œä½ ç”¨æˆ·åç›¸åŒçš„ä»“åº“ï¼Œåé¢åŠ .github.ioï¼Œåªæœ‰è¿™æ ·ï¼Œå°†æ¥è¦éƒ¨ç½²åˆ°GitHub pageçš„æ—¶å€™ï¼Œæ‰ä¼šè¢«è¯†åˆ«ï¼Œä¹Ÿå°±æ˜¯xxxx.github.ioï¼Œå…¶ä¸­xxxå°±æ˜¯ä½ æ³¨å†ŒGitHubçš„ç”¨æˆ·åã€‚æ¯”å¦‚æˆ‘åˆ›å»ºçš„æ˜¯<code>qingtian-space.github.io) </code>ã€‚</p><h3 id="ç”ŸæˆSSHæ·»åŠ åˆ°GitHub"><a href="#ç”ŸæˆSSHæ·»åŠ åˆ°GitHub" class="headerlink" title="ç”ŸæˆSSHæ·»åŠ åˆ°GitHub"></a>ç”ŸæˆSSHæ·»åŠ åˆ°GitHub</h3><p>å›åˆ° git bashä¸­ï¼Œè¿™é‡Œçš„yournameè¾“å…¥ä½ çš„GitHubç”¨æˆ·åï¼Œyouremailè¾“å…¥ä½ GitHubçš„é‚®ç®±ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name <span class="string">&quot;yourname&quot;</span></span><br><span class="line">git config --global user.email <span class="string">&quot;youremail&quot;</span></span><br></pre></td></tr></table></figure><p>åˆ›å»ºSSHï¼Œä¸€è·¯å›è½¦</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C <span class="string">&quot;240661198@qq.com&quot;</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™å®ƒä¼šå‘Šè¯‰ä½ å·²ç»ç”Ÿæˆäº†.sshçš„æ–‡ä»¶å¤¹ã€‚åœ¨ä½ çš„ç”µè„‘ä¸­æ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶å¤¹<code>C:\Users\ç”¨æˆ·\.ssh</code>çš„<code>id_rsa</code>æ–‡ä»¶ã€‚</p><p>ç„¶ååœ¨GitHubçš„settingä¸­(ç‚¹å‡»å¤´åƒçš„setting)ï¼Œæ‰¾åˆ°SSH keysçš„è®¾ç½®é€‰é¡¹ï¼Œç‚¹å‡»New SSH key æŠŠä½ çš„id_rsa.pubé‡Œé¢çš„ä¿¡æ¯å¤åˆ¶è¿›å»ã€‚</p><p>åœ¨gitbashä¸­ï¼Œè¾“å…¥ä¸‹é¢å‘½ä»¤æŸ¥çœ‹æ˜¯å¦æˆåŠŸ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -T git@github.com</span><br></pre></td></tr></table></figure><h3 id="Hexoéƒ¨ç½²åˆ°GitHub"><a href="#Hexoéƒ¨ç½²åˆ°GitHub" class="headerlink" title="Hexoéƒ¨ç½²åˆ°GitHub"></a>Hexoéƒ¨ç½²åˆ°GitHub</h3><p>è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†hexoå’ŒGitHubå…³è”èµ·æ¥ï¼Œä¹Ÿå°±æ˜¯å°†hexoç”Ÿæˆçš„æ–‡ç« éƒ¨ç½²åˆ°GitHubä¸Šï¼Œæ‰“å¼€ç«™ç‚¹é…ç½®æ–‡ä»¶ <code>_config.yml</code>ï¼Œç¿»åˆ°æœ€åï¼Œä¿®æ”¹ä¸ºYourgithubNameå°±æ˜¯ä½ çš„GitHubè´¦æˆ·ï¼Œæˆ‘è¿™é‡Œæ˜¯<code>qingtian-space.github.io</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">https://github.com/qingtian-space/qingtian-space.github.io.git</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™éœ€è¦å…ˆå®‰è£…deploy-git ï¼Œä¹Ÿå°±æ˜¯éƒ¨ç½²çš„å‘½ä»¤,è¿™æ ·ä½ æ‰èƒ½ç”¨å‘½ä»¤éƒ¨ç½²åˆ°GitHubã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure><p>ç„¶åè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œå…¶ä¸­ <code>hexo clean</code>æ¸…é™¤äº†ä½ ä¹‹å‰ç”Ÿæˆçš„ä¸œè¥¿ï¼Œä¹Ÿå¯ä»¥ä¸åŠ ã€‚<br><code>hexo generate</code> é¡¾åæ€ä¹‰ï¼Œç”Ÿæˆé™æ€æ–‡ç« ï¼Œå¯ä»¥ç”¨ <code>hexo g</code>ç¼©å†™<br><code>hexo deploy</code> éƒ¨ç½²æ–‡ç« ï¼Œå¯ä»¥ç”¨<code>hexo d</code>ç¼©å†™</p><p>æ³¨æ„deployæ—¶å¯èƒ½è¦ä½ è¾“å…¥usernameå’Œpasswordã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">hexo generate</span><br><span class="line">hexo deploy</span><br></pre></td></tr></table></figure><p>æˆåŠŸä¹‹åï¼Œå¯ä»¥å†æµè§ˆå™¨è¾“å…¥<code>http://qingtian-space.github.io</code>å°±å¯ä»¥çœ‹åˆ°è‡ªå·±çš„åšå®¢å•¦ï¼</p><h3 id="è®¾ç½®ä¸ªäººåŸŸå"><a href="#è®¾ç½®ä¸ªäººåŸŸå" class="headerlink" title="è®¾ç½®ä¸ªäººåŸŸå"></a>è®¾ç½®ä¸ªäººåŸŸå</h3><p>ç°åœ¨ä½ çš„ä¸ªäººç½‘ç«™çš„åœ°å€æ˜¯ yourname.github.ioï¼Œå¦‚æœè§‰å¾—è¿™ä¸ªç½‘å€é€¼æ ¼ä¸å¤ªå¤Ÿï¼Œè¿™å°±éœ€è¦ä½ è®¾ç½®ä¸ªäººåŸŸåäº†ã€‚ä½†æ˜¯éœ€è¦èŠ±é’±ã€‚</p><p>æ³¨å†Œä¸€ä¸ªé˜¿é‡Œäº‘è´¦æˆ·,åœ¨é˜¿é‡Œäº‘ä¸Šä¹°ä¸€ä¸ªåŸŸåï¼Œæˆ‘ä¹°çš„æ˜¯<code> qtspace.cn</code>ï¼Œå„ä¸ªåç¼€çš„ä»·æ ¼ä¸å¤ªä¸€æ ·ï¼Œæ¯”å¦‚æœ€å¹¿æ³›çš„.comå°±æ¯”è¾ƒè´µï¼Œçœ‹ä¸ªäººå–œå¥½å’¯ã€‚ä¹°å¥½åŸŸåä¹‹åï¼Œæ·»åŠ è§£æå…¶ä¸­ï¼Œ192.30.252.153 å’Œ 192.30.252.154 æ˜¯GitHubçš„æœåŠ¡å™¨åœ°å€ã€‚<strong>æ³¨æ„ï¼Œè§£æçº¿è·¯é€‰æ‹©é»˜è®¤</strong>ã€‚</p><p>ç™»å½•GitHubï¼Œè¿›å…¥ä¹‹å‰åˆ›å»ºçš„ä»“åº“ï¼Œç‚¹å‡»settingsï¼Œæ‰“å¼€GitHub Pages è®¾ç½®Custom domainï¼Œè¾“å…¥ä½ çš„åŸŸå<code>qtspace.cn</code></p><p>ç„¶ååœ¨ä½ çš„åšå®¢æ–‡ä»¶sourceä¸­åˆ›å»ºä¸€ä¸ªåä¸ºCNAMEæ–‡ä»¶ï¼Œä¸è¦åç¼€ã€‚å†™ä¸Šä½ çš„åŸŸåã€‚</p><p>è®¾ç½®å®Œä¹‹åï¼Œæœ€åå†git bashè¾“å…¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">hexo g</span><br><span class="line">hexo d</span><br></pre></td></tr></table></figure><p>æ‰“å¼€ä½ çš„æµè§ˆå™¨ï¼Œè¾“å…¥ä½ è‡ªå·±çš„åŸŸåï¼Œå°±å¯ä»¥çœ‹åˆ°æ­å»ºçš„ç½‘ç«™å•¦ï¼</p><p>è¿™ä¸€ç¯‡å°±æ˜¯Hexo+GitHubæ­å»ºä¸ªäººåšå®¢ï¼Œå¹¶è®¾ç½®ä¸ªäººåŸŸåï¼Œä¸‹ä¸€ç¯‡Hexoçš„åŸºæœ¬é…ç½®ï¼Œæ›´æ¢ä¸»é¢˜ç­‰ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŒç«¯é˜Ÿåˆ—ArrayDequeã€LinkedList</title>
      <link href="/2022/03/02/java-arraydeque-linkedlist/"/>
      <url>/2022/03/02/java-arraydeque-linkedlist/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h3 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h3><p>Stackæ ˆï¼šå…ˆè¿›åå‡º</p><p>Queueé˜Ÿåˆ—ï¼šå…ˆè¿›å…ˆå‡º</p><p>åœ¨Javaé‡Œæœ‰ä¸€ä¸ªStackç±»ï¼Œä½†æ˜¯è¿™ä¸ªç±»å·²ç»ä¸æ¨èä½¿ç”¨äº†ï¼Œè€ŒQueueæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå½“æˆ‘ä»¬éœ€è¦ä½¿ç”¨æ ˆå’Œé˜Ÿåˆ—æ—¶ï¼Œæ¨èä½¿ç”¨æ›´åŠ é«˜æ•ˆçš„ArrayDequeè¯¥ç±»å®ç°Dequeæ¥å£ï¼Œæ¬¡é€‰ä½¿ç”¨LinkedListã€‚</p><h3 id="äºŒã€æ€»ä½“ä»‹ç»"><a href="#äºŒã€æ€»ä½“ä»‹ç»" class="headerlink" title="äºŒã€æ€»ä½“ä»‹ç»"></a>äºŒã€æ€»ä½“ä»‹ç»</h3><p>è¦è®²æ ˆå’Œé˜Ÿåˆ—ï¼Œé¦–å…ˆè¦è®²Dequeæ¥å£ã€‚Dequeçš„å«ä¹‰æ˜¯â€double ended queueâ€ï¼Œå³åŒç«¯é˜Ÿåˆ—ï¼Œæ—¢å¯ä»¥å½“æ ˆä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥å½“é˜Ÿåˆ—ä½¿ç”¨ã€‚</p><p>ä¸‹è¡¨åˆ—å‡ºDequeå’ŒQueueç›¸å¯¹åº”çš„æ¥å£ï¼š</p><table><thead><tr><th>Queue æ–¹æ³•</th><th>Deque æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>add(e)</code></td><td><code>addLast(e)</code></td><td>å‘é˜Ÿå°¾æ’å…¥å…ƒç´ ï¼Œå¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸</td></tr><tr><td><code>offer(e)</code></td><td><code>offerLast(e)</code></td><td>å‘é˜Ÿå°¾æ’å…¥å…ƒç´ ï¼Œå¤±è´¥åˆ™è¿”å›<code>false</code></td></tr><tr><td><code>remove()</code></td><td><code>removeFirst()</code></td><td>è·å–å¹¶åˆ é™¤é˜Ÿé¦–å…ƒç´ ï¼Œå¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸</td></tr><tr><td><code>poll()</code></td><td><code>pollFirst()</code></td><td>è·å–å¹¶åˆ é™¤é˜Ÿé¦–å…ƒç´ ï¼Œå¤±è´¥åˆ™è¿”å›<code>null</code></td></tr><tr><td><code>element()</code></td><td><code>getFirst()</code></td><td>è·å–ä½†ä¸åˆ é™¤é˜Ÿé¦–å…ƒç´ ï¼Œå¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸</td></tr><tr><td><code>peek()</code></td><td><code>peekFirst()</code></td><td>è·å–ä½†ä¸åˆ é™¤é˜Ÿé¦–å…ƒç´ ï¼Œå¤±è´¥åˆ™è¿”å›<code>null</code></td></tr></tbody></table><p>ä¸‹æ ‡åˆ—å‡ºDequeå’ŒStackå¯¹åº”çš„æ¥å£ï¼š</p><table><thead><tr><th>Stack æ–¹æ³•</th><th>Deque æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>push(e)</code></td><td><code>addFirst(e)</code></td><td>å‘æ ˆé¡¶æ’å…¥å…ƒç´ ï¼Œå¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸</td></tr><tr><td>æ— </td><td><code>offerFirst(e)</code></td><td>å‘æ ˆé¡¶æ’å…¥å…ƒç´ ï¼Œå¤±è´¥åˆ™è¿”å›<code>false</code></td></tr><tr><td><code>pop()</code></td><td><code>removeFirst()</code></td><td>è·å–å¹¶åˆ é™¤æ ˆé¡¶å…ƒç´ ï¼Œå¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸</td></tr><tr><td>æ— </td><td><code>pollFirst()</code></td><td>è·å–å¹¶åˆ é™¤æ ˆé¡¶å…ƒç´ ï¼Œå¤±è´¥åˆ™è¿”å›<code>null</code></td></tr><tr><td><code>peek()</code></td><td><code>peekFirst()</code></td><td>è·å–ä½†ä¸åˆ é™¤æ ˆé¡¶å…ƒç´ ï¼Œå¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸</td></tr><tr><td>æ— </td><td><code>peekFirst()</code></td><td>è·å–ä½†ä¸åˆ é™¤æ ˆé¡¶å…ƒç´ ï¼Œå¤±è´¥åˆ™è¿”å›<code>null</code></td></tr></tbody></table><p>ä¸Šè¡¨Dequeæ€»å…±å®šä¹‰äº†Dequeçš„12ä¸ªæ¥å£ã€‚æ·»åŠ ï¼Œåˆ é™¤ï¼Œå–å€¼éƒ½æœ‰ä¸¤å¥—æ¥å£ï¼Œå®ƒä»¬åŠŸèƒ½ç›¸åŒï¼ŒåŒºåˆ«æ˜¯å¯¹å¤±è´¥æƒ…å†µçš„å¤„ç†ä¸åŒã€‚<strong>ä¸€å¥—æ¥å£é‡åˆ°å¤±è´¥å°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¦ä¸€å¥—é‡åˆ°å¤±è´¥ä¼šè¿”å›ç‰¹æ®Šå€¼ï¼ˆ<code>false</code>æˆ–<code>null</code>ï¼‰</strong>ã€‚é™¤éæŸç§å®ç°å¯¹å®¹é‡æœ‰é™åˆ¶ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ·»åŠ æ“ä½œæ˜¯ä¸ä¼šå¤±è´¥çš„ã€‚<strong>è™½ç„¶Dequeçš„æ¥å£æœ‰12ä¸ªä¹‹å¤šï¼Œä½†æ— éå°±æ˜¯å¯¹å®¹å™¨çš„ä¸¤ç«¯è¿›è¡Œæ“ä½œï¼Œæˆ–æ·»åŠ ï¼Œæˆ–åˆ é™¤ï¼Œæˆ–æŸ¥çœ‹</strong>ã€‚æ˜ç™½äº†è¿™ä¸€ç‚¹è®²è§£èµ·æ¥å°±ä¼šéå¸¸ç®€å•ã€‚</p><h3 id="ä¸‰ã€ArrayDeque"><a href="#ä¸‰ã€ArrayDeque" class="headerlink" title="ä¸‰ã€ArrayDeque"></a>ä¸‰ã€ArrayDeque</h3><p>ArrayDequeæ˜¯åŸºäºæ•°ç»„å®ç°çš„å¯åŠ¨æ€æ‰©å®¹çš„åŒç«¯é˜Ÿåˆ—ï¼Œå®šä¹‰å’Œ<strong>headã€tailå¤´å°¾</strong>ä¸¤ä¸ªä¸‹æ ‡å€¼ï¼Œé»˜è®¤ä¸º0ã€‚ä¸ºäº†æ»¡è¶³å¯ä»¥åŒæ—¶åœ¨æ•°ç»„ä¸¤ç«¯æ’å…¥æˆ–è€…åˆ é™¤å…ƒç´ ï¼Œè¯¥æ•°ç»„è¿˜å¿…é¡»æ˜¯å¾ªç¯çš„ï¼Œå³<strong>å¾ªç¯æ•°ç»„ï¼ˆcircular arrayï¼‰</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´æ•°ç»„çš„ä»»ä½•ä¸€ç‚¹éƒ½å¯ä»¥è¢«çœ‹ä½œæ˜¯èµ·ç‚¹æˆ–è€…ç»ˆç‚¹ã€‚ArrayDequeæ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œå¦å¤–ä¸å…è®¸æ’å…¥nullå…ƒç´ ã€‚</p><p>å½“ArrayDequeä½œä¸º<strong>é˜Ÿåˆ—</strong>ä½¿ç”¨æ—¶ï¼Œæ ¸å¿ƒæ–¹æ³•æ˜¯<strong>addLast()<strong>ï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯åœ¨ArrayDequeçš„å°¾éƒ¨æ’å…¥å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯åœ¨</strong>tail</strong>çš„ä½ç½®æ’å…¥å…ƒç´ ï¼Œtailæ€»æ˜¯æŒ‡å‘ä¸‹ä¸€ä¸ªå¯ä»¥æ’å…¥å…ƒç´ çš„ç©ºä½ï¼Œæ‰€ä»¥åœ¨æºç ä¸­åªéœ€<strong>elements[tali] &#x3D; e;</strong> æ’å…¥å®Œæˆä¹‹åå†æ£€æŸ¥ç©ºé—´æ˜¯å¦éœ€è¦æ‰©å®¹ï¼Œå¦‚æœéœ€è¦æ‰©å®¹åˆ™è°ƒç”¨**doubleCapacity()**è¿›è¡Œæ‰©å®¹ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addList</span><span class="params">(E e)</span>&#123;</span><br><span class="line">    <span class="comment">// ä¸å…è®¸æ’å…¥nullå€¼</span></span><br><span class="line">    <span class="keyword">if</span> (e == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="comment">// å°¾éƒ¨èµ‹å€¼</span></span><br><span class="line">    elements[tail] = e;</span><br><span class="line">    <span class="comment">// å› ä¸ºæ•°ç»„é•¿åº¦æ˜¯2^nçš„å€æ•°,æ‰€ä»¥é•¿åº¦-1å°±æ˜¯ä¸€ä¸ªå…¨æ˜¯1çš„äºŒè¿›åˆ¶, å¯ä»¥ç”¨äºä¸è¿ç®—å¾—å‡ºä¸‹æ ‡</span></span><br><span class="line">    <span class="comment">// è®¡ç®—ä¸‹æ ‡æ˜¯å¦è¶Šç•Œ</span></span><br><span class="line">    <span class="keyword">if</span> ((tail = (tail + <span class="number">1</span>) &amp; (elements.length - <span class="number">1</span>)) == head)</span><br><span class="line">        <span class="comment">// æ‰©å®¹</span></span><br><span class="line">        doubleCapacity();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰©å®¹æ–¹æ³•ï¼šä¸¤å€æ‰©å®¹ï¼Œé€šè¿‡æ•°ç»„copyæ•°æ®ä½ç§»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doubleCapacity</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">assert</span> <span class="variable">head</span> <span class="operator">=</span>= tail;</span><br><span class="line">        <span class="type">int</span> <span class="variable">p</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> elements.length;</span><br><span class="line">        <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> n - p; <span class="comment">// number of elements to the right of p</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">newCapacity</span> <span class="operator">=</span> n &lt;&lt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (newCapacity &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Sorry, deque too big&quot;</span>);</span><br><span class="line">        Object[] a = <span class="keyword">new</span> <span class="title class_">Object</span>[newCapacity];</span><br><span class="line">        System.arraycopy(elements, p, a, <span class="number">0</span>, r);</span><br><span class="line">        System.arraycopy(elements, <span class="number">0</span>, a, r, p);</span><br><span class="line">        elements = a;</span><br><span class="line">        head = <span class="number">0</span>;</span><br><span class="line">        tail = n;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å½“Dequeä½œä¸º<strong>æ ˆ</strong>ä½¿ç”¨æ—¶ï¼Œæ ¸å¿ƒæ–¹æ³•ä¸º<strong>addFirst()<strong>ï¼Œä¹Ÿå°±æ˜¯åœ¨ArrayDequeé¦–æ®µæ’å…¥å…ƒç´ ï¼Œåœ¨æ•°ç»„ç©ºé—´æ²¡æœ‰è¶Šç•Œçš„æƒ…å†µä¸‹</strong>elements[â€“elements.length] &#x3D; e</strong> å³å¯ã€‚æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addFirst</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸å…è®¸æ’å…¥nullå€¼</span></span><br><span class="line">    <span class="keyword">if</span> (e == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="comment">// èµ‹å€¼å¹¶è®¡ç®—ä¸‹æ ‡æ˜¯å¦è¶Šç•Œ</span></span><br><span class="line">    elements[head = (head - <span class="number">1</span>) &amp; (elements.length - <span class="number">1</span>)] = e;</span><br><span class="line">    <span class="keyword">if</span> (head == tail)</span><br><span class="line">        <span class="comment">// æ‰©å®¹</span></span><br><span class="line">        doubleCapacity();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å››ã€LinkedList"><a href="#å››ã€LinkedList" class="headerlink" title="å››ã€LinkedList"></a>å››ã€LinkedList</h3><p>LinkedListæ˜¯ç”±åŒå‘é“¾è¡¨å®ç°çš„åŒç«¯é˜Ÿåˆ—ï¼Œå®šä¹‰äº†<strong>firstã€last</strong>é¦–å°¾ä¸¤ä¸ªèŠ‚ç‚¹ç”¨äºè¿æ¥é“¾è¡¨ï¼Œæ ¸å¿ƒæ–¹æ³•åŒæ ·æ˜¯**addFirst()<strong>å’Œ</strong>addLast()**ã€‚</p><p>LinkedListä½œä¸ºé˜Ÿåˆ—ä½¿ç”¨ï¼ŒaddLast()æºç ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addLast</span><span class="params">(E e)</span> &#123;</span><br><span class="line">linkLast(e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">linkLast</span><span class="params">(E e)</span>&#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰å°¾èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; l = last;</span><br><span class="line">    <span class="comment">// åˆ›å»ºè¦æ’å…¥çš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> <span class="title class_">Node</span>(l, e <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">// è¦æ’å…¥çš„èŠ‚ç‚¹èµ‹æˆæœ€åä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    last = newNode;</span><br><span class="line">    <span class="comment">// å¦‚æœå°¾èŠ‚ç‚¹ä¸ºnull(ç¬¬ä¸€æ¬¡æ’å…¥çš„æ—¶å€™ä¸ºnull)</span></span><br><span class="line">    <span class="keyword">if</span> (l == <span class="literal">null</span>)</span><br><span class="line">        <span class="comment">// è¦æ’å…¥çš„èŠ‚ç‚¹ä¸ºèŠ‚ç‚¹</span></span><br><span class="line">        first = newNode;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// å½“å‰å°¾èŠ‚ç‚¹çš„ä¸‹ä¸€èŠ‚ç‚¹é“¾ä¸Šè¦æ’å…¥çš„èŠ‚ç‚¹</span></span><br><span class="line">        l.next = newNode;</span><br><span class="line">    size++;</span><br><span class="line">    modCount++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>LinkedListä½œä¸ºæ ˆä½¿ç”¨ï¼ŒaddFirst()æºç ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addFirst</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    linkFirst(e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">linkFirst</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰é¦–èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; f = first;</span><br><span class="line">     <span class="comment">// åˆ›å»ºè¦æ’å…¥çš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> <span class="title class_">Node</span>(l, e <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">// è¦æ’å…¥çš„èŠ‚ç‚¹èµ‹æˆé¦–èŠ‚ç‚¹</span></span><br><span class="line">    first = newNode;</span><br><span class="line">    <span class="comment">// å¦‚æœé¦–èŠ‚ç‚¹ä¸ºnull(ç¬¬ä¸€æ¬¡æ’å…¥çš„æ—¶å€™ä¸ºnull)</span></span><br><span class="line">    <span class="keyword">if</span> (f == <span class="literal">null</span>)</span><br><span class="line">        <span class="comment">// è¦æ’å…¥çš„èŠ‚ç‚¹ä¸ºå°¾èŠ‚ç‚¹</span></span><br><span class="line">        last = newNode;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// å½“å‰é¦–èŠ‚ç‚¹çš„ä¸Šä¸€èŠ‚ç‚¹é“¾ä¸Šè¦æ’å…¥çš„èŠ‚ç‚¹</span></span><br><span class="line">        f.prev = newNode;</span><br><span class="line">    size++;</span><br><span class="line">    modCount++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> æ•°æ®ç»“æ„ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ArrayDeque </tag>
            
            <tag> LinkedList </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaä¸­ArrayListå’ŒLinkedListçš„åŒºåˆ«</title>
      <link href="/2022/03/02/java-arraylist-linkedlist/"/>
      <url>/2022/03/02/java-arraylist-linkedlist/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><p>ä¸¤è€…æ•°æ®ç»“æ„ä¸åŒï¼ŒArrayListæ˜¯åŸºäºæ•°ç»„å®ç°ã€LinkedListæ˜¯åŸºäºåŒå‘é“¾è¡¨å®ç°ã€‚ä»è·å–ã€åˆ é™¤ã€æ’å…¥ã€å†…å­˜å¼€é”€è¿™å‡ ä¸ªç‚¹æ¥è¯´æ˜ä¸¤è€…çš„åŒºåˆ«ã€‚</p><h3 id="1ã€-è·å–ï¼š"><a href="#1ã€-è·å–ï¼š" class="headerlink" title="1ã€ è·å–ï¼š"></a>1ã€ è·å–ï¼š</h3><p>ArrayListçš„è·å–æ¯”LinkedListè·å–ç›¸æ¯”éå¸¸å¿«ï¼Œå› ä¸ºArrayListçš„getæ–¹æ³•çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(1)ï¼Œè€ŒLinkListçš„ä¸ºO(n)ã€‚</p><p>ArrayListçš„getæ–¹æ³•æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E <span class="title function_">get</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">    rangeCheck(index);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> elementData(index);</span><br><span class="line">&#125;</span><br><span class="line">E <span class="title function_">elementData</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">    <span class="comment">// ç›´æ¥ä¸‹æ ‡è·å–æ•°ç»„å€¼, æ—¶é—´å¤æ‚åº¦ä¸ºO(1)</span></span><br><span class="line">    <span class="keyword">return</span> (E) elementData[index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>LinkListçš„getæ–¹æ³•æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E <span class="title function_">get</span><span class="params">(<span class="type">int</span> index)</span>&#123;</span><br><span class="line">    checkElementIndex(index);</span><br><span class="line">    <span class="keyword">return</span> node(index).item;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Node&lt;E&gt; <span class="title function_">node</span><span class="params">(<span class="type">int</span> index)</span>&#123;</span><br><span class="line">    <span class="comment">// assert isElementIndex(index);</span></span><br><span class="line">    <span class="keyword">if</span> (index &lt; (size &gt;&gt; <span class="number">1</span>)) &#123;</span><br><span class="line">        Node&lt;E&gt; x = first;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; index; i++)</span><br><span class="line">            x = x.next;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Node&lt;E&gt; x = last;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> size - <span class="number">1</span>; i &gt; index; i--)</span><br><span class="line">            x = x.prev;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>LinkListè¿˜æä¾›è·å–é¦–ä½å…ƒç´ çš„æ–¹æ³•ï¼ŒgetFirstã€getListï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(1)ã€‚</p><p>ç»“è®ºï¼šArrayListå…ƒç´ çš„è·å–æ€§èƒ½æ¯”LinkedListé«˜ã€‚</p><h3 id="2ã€åˆ é™¤ï¼š"><a href="#2ã€åˆ é™¤ï¼š" class="headerlink" title="2ã€åˆ é™¤ï¼š"></a>2ã€åˆ é™¤ï¼š</h3><p>LinkedListåˆ é™¤æ—¶é—´å¤æ‚åº¦ä¸ºO(1)ï¼Œè¿™ä¸ªO(1)åªæ˜¯ä»åˆ é™¤çš„æ“ä½œæ¥è¯´ï¼Œå› ä¸ºLinkedListåœ¨åˆ é™¤çš„æ—¶å€™ä¹Ÿä¼šè¿›è¡Œforå¾ªç¯è·å–åˆ é™¤çš„èŠ‚ç‚¹ã€‚è€ŒArrayListåˆ é™¤æ—¶é—´å¤æ‚åº¦æ˜¯å¯å˜çš„ï¼Œåˆ é™¤ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯æœ€åçš„æƒ…å†µæ—¶é—´å¤æ‚åº¦ä¸ºO(n)ï¼Œè¿™æ˜¯å› ä¸ºåˆ é™¤ç¬¬ä¸€ä¸ªå…ƒç´ è¦è¿›è¡Œæ•°ç»„çš„copyä»è€Œç§»åŠ¨æ•°ç»„ï¼Œåˆ é™¤æœ€åä¸€ä¸ªå…ƒç´ æ˜¯æœ€å¥½çš„æƒ…å†µæ—¶é—´å¤æ‚åº¦ä¸ºO(1)ï¼Œè¿™æ˜¯å› ä¸ºArrayListåˆ é™¤æœ€åä¸€ä¸ªå…ƒç´ æ—¶å°±æ˜¯æŠŠæœ€åä¸€ä¸ªå…ƒç´ ç½®ä¸ºnullã€‚</p><p>LinkedListåˆ é™¤æ–¹æ³•æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E <span class="title function_">remove</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">    checkElementIndex(index);</span><br><span class="line">    <span class="keyword">return</span> unlink(node(index));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (o == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;E&gt; x = first; x != <span class="literal">null</span>; x = x.next) &#123;</span><br><span class="line">            <span class="keyword">if</span> (x.item == <span class="literal">null</span>) &#123;</span><br><span class="line">                unlink(x);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;E&gt; x = first; x != <span class="literal">null</span>; x = x.next) &#123;</span><br><span class="line">            <span class="keyword">if</span> (o.equals(x.item)) &#123;</span><br><span class="line">                unlink(x);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">E <span class="title function_">unlink</span><span class="params">(Node&lt;E&gt; x)</span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">E</span> <span class="variable">emelemt</span> <span class="operator">=</span> x.item;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; next = x.next;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; prev = x.prev;</span><br><span class="line">    <span class="keyword">if</span> (prev == <span class="literal">null</span>) &#123;</span><br><span class="line">        first = next;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        prev.next = next;</span><br><span class="line">        x.prev = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (next == <span class="literal">null</span>) &#123;</span><br><span class="line">        last = prev;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        next.prev = prev;</span><br><span class="line">        x.next = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    x.item = <span class="literal">null</span>;</span><br><span class="line">    size--;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="keyword">return</span> element;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>LinkedListè¿˜æä¾›äº†åˆ é™¤æ”¶å°¾å…ƒç´ çš„æ–¹æ³•ï¼ŒremoveFirst()ã€removeLast()ã€‚</p><p>ArrayListåˆ é™¤æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (o == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; size; index++)</span><br><span class="line">            <span class="keyword">if</span> (elementData[index] == <span class="literal">null</span>) &#123;</span><br><span class="line">                fastRemove(index);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; size; index++)</span><br><span class="line">            <span class="keyword">if</span> (o.equals(elementData[index])) &#123;</span><br><span class="line">                fastRemove(index);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> E <span class="title function_">remove</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">     rangeCheck(index);</span><br><span class="line"></span><br><span class="line">     modCount++;</span><br><span class="line">     <span class="type">E</span> <span class="variable">oldValue</span> <span class="operator">=</span> elementData(index);</span><br><span class="line"></span><br><span class="line">     <span class="type">int</span> <span class="variable">numMoved</span> <span class="operator">=</span> size - index - <span class="number">1</span>;</span><br><span class="line">     <span class="keyword">if</span> (numMoved &gt; <span class="number">0</span>)</span><br><span class="line">         System.arraycopy(elementData, index+<span class="number">1</span>, elementData, index,</span><br><span class="line">                          numMoved);</span><br><span class="line">     elementData[--size] = <span class="literal">null</span>; <span class="comment">// clear to let GC do its work</span></span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> oldValue;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>ç»“è®ºï¼šLinkedListå…ƒç´ åˆ é™¤æ¯”ArrayListè¦å¿«ã€‚</p><p>åŸå› ï¼šLinkedListçš„æ¯ä¸ªå…ƒç´ éƒ½ç»´æŠ¤ç€ä¸¤ä¸ªæŒ‡é’ˆï¼Œå®ƒä»¬æŒ‡å‘åˆ—è¡¨ä¸­çš„ä¸¤ä¸ªç›¸é‚»å…ƒç´ ã€‚å› æ­¤åˆ é™¤åªéœ€è¦æ›´æ”¹å°†è¦åˆ é™¤çš„èŠ‚ç‚¹çš„ä¸¤ä¸ªç›¸é‚»èŠ‚ç‚¹ä¸­çš„æŒ‡é’ˆä½ç½®ã€‚è€ŒArrayListéƒ½è¦è¿›è¡Œæ•°ç»„copyç§»åŠ¨å¡«å……åˆ é™¤å…ƒç´ åˆ›å»ºçš„ç©ºé—´ã€‚</p><h3 id="3ã€-æ’å…¥"><a href="#3ã€-æ’å…¥" class="headerlink" title="3ã€ æ’å…¥"></a>3ã€ æ’å…¥</h3><p>LinkedList addæ–¹æ³•å°±æ˜¯å‘å°¾éƒ¨æ’å…¥æ–¹æ³•ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(1)ï¼Œè€ŒArrayList addæ–¹æ³•æ—¶é—´å¤æ‚åº¦æ˜¯å¯å˜çš„æœ€åä¸ºO(n)ï¼ŒåŸå› æ˜¯ArrayListæ‰©å®¹çš„æ—¶å€™éœ€è¦å…ƒç´ çš„å¤åˆ¶ç§»åŠ¨ã€‚</p><p>LinkedList addæ–¹æ³•æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span>&#123;</span><br><span class="line">    linkLast(e);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">linkLast</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; l = last;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;&gt;(l, e, <span class="literal">null</span>);</span><br><span class="line">    last = newNode;</span><br><span class="line">    <span class="keyword">if</span> (l == <span class="literal">null</span>)</span><br><span class="line">        first = newNode;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        l.next = newNode;</span><br><span class="line">    size++;</span><br><span class="line">    modCount++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ArrayList addæ–¹æ³•æ‰©å®¹æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">grow</span><span class="params">(<span class="type">int</span> minCapacity)</span> &#123;</span><br><span class="line">    <span class="comment">// overflow-conscious code</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">oldCapacity</span> <span class="operator">=</span> elementData.length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">newCapacity</span> <span class="operator">=</span> oldCapacity + (oldCapacity &gt;&gt; <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (newCapacity - minCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = minCapacity;</span><br><span class="line">    <span class="keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = hugeCapacity(minCapacity);</span><br><span class="line">    <span class="comment">// minCapacity is usually close to size, so this is a win:</span></span><br><span class="line">    elementData = Arrays.copyOf(elementData, newCapacity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬æƒ…å†µä¸‹æ’å…¥LinkedListæ€§èƒ½æ¯”ArrayListæ€§èƒ½è¦é«˜ï¼Œä½†æ˜¯ä¹Ÿä¸èƒ½ç»å¯¹çš„è¯´LinkedListæ’å…¥çš„æ€§èƒ½é«˜ï¼Œå› ä¸ºè¿™ä¸ªè¦æ ¹æ®å®¹é‡å’Œæ’å…¥æ“ä½œï¼ˆå¤´æ’ã€å°¾æ’ã€ä¸­é—´æ’ï¼‰æ¥å†³å®šã€‚å¯ä»¥é€šè¿‡å®éªŒå¾—å‡ºä»¥ä¸‹ç»“è®ºï¼Œ10ä¸‡ã€100ä¸‡ã€1000ä¸‡æ•°æ®æ’å…¥çš„æ—¶å€™ï¼š</p><p>å¤´æ’ï¼šLinkedListæ€§èƒ½æ¯”ArrayListé«˜ï¼Œå› ä¸ºArrayListè¦è¿›è¡Œå¤§é‡çš„å¤åˆ¶å’Œä½ç½®æ“ä½œï¼Œè€ŒLinkedListåªæ˜¯ä¸€ä¸ªå¯¹è±¡çš„å®ä¾‹åŒ–ã€‚</p><p>å°¾æ’ï¼šArrayListæ€§èƒ½æ¯”LinkedListé«˜ï¼Œå› ä¸ºArrayListä¸éœ€è¦é¢‘ç¹çš„æ‰©å®¹ï¼Œè€ŒLinkedListéœ€è¦å¤§é‡çš„åˆ›å»ºå¯¹è±¡ã€‚</p><p>ä¸­é—´æ’ï¼šArrayListæ€§èƒ½æ¯”LinkedListé«˜ï¼Œå› ä¸ºLinkedListéœ€è¦éå†å¯»å€ã€‚</p><p>æ‰€ä»¥åœ¨ä¸åŒçš„æƒ…å†µä¸‹ï¼Œéœ€è¦é€‰æ‹©ä¸åŒçš„Listé›†åˆåšä¸šåŠ¡ã€‚</p><h3 id="4ã€å†…å­˜å¼€é”€"><a href="#4ã€å†…å­˜å¼€é”€" class="headerlink" title="4ã€å†…å­˜å¼€é”€"></a>4ã€å†…å­˜å¼€é”€</h3><p>ArrayListç»´æŠ¤ç´¢å¼•å’Œå…ƒç´ æ•°æ®ï¼Œè€ŒLinkedListç»´æŠ¤å…ƒç´ æ•°æ®å’Œç›¸é‚»èŠ‚ç‚¹çš„ä¸¤ä¸ªæŒ‡é’ˆï¼Œæ‰€ä»¥LinkedListçš„å†…å­˜æ¶ˆè€—ç›¸å¯¹è¾ƒé«˜ã€‚</p><h4 id="ä»€ä¹ˆæ—¶å€™ç”¨LinkedListï¼Œä»€ä¹ˆæ—¶å€™ç”¨ArrayListï¼Ÿ"><a href="#ä»€ä¹ˆæ—¶å€™ç”¨LinkedListï¼Œä»€ä¹ˆæ—¶å€™ç”¨ArrayListï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ—¶å€™ç”¨LinkedListï¼Œä»€ä¹ˆæ—¶å€™ç”¨ArrayListï¼Ÿ"></a>ä»€ä¹ˆæ—¶å€™ç”¨LinkedListï¼Œä»€ä¹ˆæ—¶å€™ç”¨ArrayListï¼Ÿ</h4><p>é€šè¿‡ä¸Šé¢å¯¹æ¯”ï¼Œä»æ—¶é—´å¤æ‚åº¦æ¥è¯´ï¼ŒLinkedListçš„æ’å…¥å’Œåˆ é™¤æä¾›äº†æ›´å¥½çš„æ€§èƒ½ï¼Œå› æ­¤åœ¨ä¸šåŠ¡ä¸­éœ€è¦é¢‘ç¹çš„å¢åˆ æ“ä½œï¼ŒæŸ¥è¯¢è¾ƒå°‘é€‰æ‹©LinkedListè¾ƒåˆé€‚ã€‚è€ŒArrayListçš„è·å–æ€§èƒ½æ¯”LinkedListé«˜ï¼Œå› æ­¤åœ¨ä¸šåŠ¡ä¸­å¢åˆ æ“ä½œè¾ƒå°‘ï¼Œè·å–æ“ä½œæ¯”è¾ƒå¤šé€‰æ‹©ArrayListè¾ƒåˆé€‚ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> æ•°æ®ç»“æ„ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LinkedList </tag>
            
            <tag> ArrayList </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½è¿ç®—</title>
      <link href="/2022/03/02/java-bit-operation/"/>
      <url>/2022/03/02/java-bit-operation/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><table><thead><tr><th align="center">ç¬¦å·</th><th align="center">æè¿°</th><th align="center">æ —å­</th></tr></thead><tbody><tr><td align="center">&amp;</td><td align="center">ä¸è¿ç®—ï¼Œä¸¤ä¸ªä½éƒ½ä¸º1æ—¶ï¼Œç»“æœä¸º1ï¼Œå¦åˆ™ä¸º0</td><td align="center">æ¯”å¦‚2 &amp; 3ï¼Œ2çš„äºŒè¿›åˆ¶ä¸º10ï¼Œ3çš„äºŒè¿›åˆ¶ä¸º11ï¼Œä¸è¿ç®—ä¸º10ï¼Œè½¬æˆåè¿›åˆ¶ä¸º2</td></tr><tr><td align="center">|</td><td align="center">æˆ–è¿ç®—ï¼Œä¸¤ä¸ªä½éƒ½ä¸º0æ—¶ï¼Œç»“æœä¸º0ï¼Œå¦åˆ™ä¸º1</td><td align="center">æ¯”å¦‚2 | 3ï¼Œ2çš„äºŒè¿›åˆ¶ä¸º10ï¼Œ3çš„äºŒè¿›åˆ¶ä¸º11ï¼Œæˆ–è¿ç®—ä¸º11ï¼Œè½¬æˆåè¿›åˆ¶ä¸º3</td></tr><tr><td align="center">^</td><td align="center">å¼‚æˆ–è¿ç®—ï¼Œä¸¤ä¸ªä½ç›¸åŒä¸º0ï¼Œä¸ç›¸åŒä¸º1</td><td align="center">æ¯”å¦‚2 ^ 3ï¼Œ2çš„äºŒè¿›åˆ¶ä¸º10ï¼Œ3çš„äºŒè¿›åˆ¶ä¸º11ï¼Œä¸æˆ–è¿ç®—ä¸º01ï¼Œè½¬æˆåè¿›åˆ¶ä¸º1</td></tr><tr><td align="center">~</td><td align="center">å–åè¿ç®—ï¼Œ1å˜0ï¼Œ0å˜1</td><td align="center">æ¯”å¦‚~2 ï¼Œ2çš„äºŒè¿›åˆ¶ä¸º10ï¼Œå–åè¿ç®—ä¸º01ï¼Œè½¬æˆåè¿›åˆ¶ä¸º1</td></tr><tr><td align="center">&gt;&gt;</td><td align="center">æŒ‰ä½å³ç§»è¿ç®—ï¼Œé«˜ä½è¡¥0</td><td align="center">æ¯”å¦‚10&gt;&gt;2ï¼Œ10çš„äºŒè¿›åˆ¶ä¸º1010ï¼Œå¾€å³ç§»2ä½é«˜ä½è¡¥0ä¸º0010ï¼Œè½¬æˆåè¿›åˆ¶å°±ä¸º2</td></tr><tr><td align="center">&lt;&lt;</td><td align="center">æŒ‰ä½å·¦ç§»è¿ç®—ï¼Œä½ä½è¡¥0</td><td align="center">æ¯”å¦‚10&lt;&lt;2ï¼Œ10çš„äºŒè¿›åˆ¶ä¸º1010ï¼Œå¾€å·¦ç§»2ä½ä½ä½è¡¥0ä¸º101000ï¼Œè½¬æˆåè¿›åˆ¶ä¸º40</td></tr><tr><td align="center">&gt;&gt;&gt;</td><td align="center">æŒ‰ä½å³ç§»è¡¥0æ“ä½œè¿ç®—</td><td align="center">æ¯”å¦‚10&gt;&gt;&gt;2ï¼Œ10çš„äºŒè¿›åˆ¶ä¸º1010ï¼Œå³ç§»2ä½è¡¥0ä¸º0010ï¼Œè½¬æˆåè¿›åˆ¶ä¸º2</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> ä½è¿ç®— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ä½è¿ç®— </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Collcetions å·¥å…·ç±»</title>
      <link href="/2022/03/02/java-collections/"/>
      <url>/2022/03/02/java-collections/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><p><code>java.util.Collections</code> æ˜¯javaé›†åˆæ¡†æ¶ä¸­çš„ä¸€ä¸ªå·¥å…·ç±»ï¼Œä¸»è¦ç”¨äºCollectiontæä¾›çš„é€šç”¨ç®—æ³•ï¼Œæ¯”å¦‚ï¼š<strong>æ’åº</strong>(<code>sort</code>)ã€<strong>äºŒåˆ†æŸ¥æ‰¾</strong>(<code>binarySearch</code>)ã€<strong>æ´—ç‰Œ</strong>(<code>shuffle</code>)ã€<strong>æ—‹è½¬</strong>(<code>rotate</code>)</p><h3 id="1-Collections-sort-æ’åº"><a href="#1-Collections-sort-æ’åº" class="headerlink" title="1.  Collections.sort æ’åº"></a>1.  Collections.sort æ’åº</h3><ul><li><p>æ–¹æ³•ä½¿ç”¨ï¼Œä»£ç æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">list.add(<span class="string">&quot;7&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;4&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;8&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;9&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// é»˜è®¤æ’åº(æ­£åº) æµ‹è¯•ç»“æœä¸º3, 4, 7, 8, 9</span></span><br><span class="line">list.sort(); </span><br><span class="line"></span><br><span class="line"><span class="comment">// Comparatoræ’åº å¯ä»¥å·²å®šä¹‰æ­£åºã€å€’å™, è¿˜å¯ä»¥æ”¯æŒä»¥å¯¹è±¡çš„æŸä¸ªå­—æ®µè¿›è¡Œæ’åº</span></span><br><span class="line">Collections.sort(list, <span class="keyword">new</span> <span class="title class_">Comparator</span>&lt;String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(String o1, String o2)</span> &#123;</span><br><span class="line">        <span class="comment">// å€’å™ æ­£åºçš„è¯ return o1.compareTo(o2);</span></span><br><span class="line">        <span class="keyword">return</span> o2.compareTo(o1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// reverseOrder å€’å™ </span></span><br><span class="line">Collections.sort(list, Collections.&lt;String&gt;reverseOrder());</span><br></pre></td></tr></table></figure></li><li><p>æºç åˆ†æ</p><p>Collections.sorté›†åˆæ’åºæœ€ç»ˆè°ƒç”¨çš„æ˜¯<code>java.util</code>åŒ…ä¸‹<code>Arrays</code>ç±»çš„  <code>Arrays.sort(T[] a, Comparator&lt;? super T&gt; c)</code>ï¼Œè¿™ä¸ªæ–¹æ³•æ ¹æ®æœ‰æ²¡æœ‰ä¼ å…¥<code>Compararot c</code> è°ƒç”¨å¿«é€Ÿæ’åº(<code>sort()</code>)å’Œä¼˜åŒ–çš„å½’å¹¶æ’åº(<code>TimSort.sort()</code>)ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">sort</span><span class="params">(T[] a, Comparator&lt;? <span class="built_in">super</span> T&gt; c)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å®é™…è°ƒç”¨çš„æ˜¯ComparableTimSort.sort</span></span><br><span class="line">        sort();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// é»˜è®¤å…³é—­</span></span><br><span class="line">        <span class="keyword">if</span> (LegacyMergeSort.userRequested)</span><br><span class="line">            legacyMergeSort(a, c);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            TimSort.sort(a, <span class="number">0</span>, a.length, c, <span class="literal">null</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sort</span><span class="params">(Object[] a)</span> &#123;</span><br><span class="line">    <span class="comment">// é»˜è®¤å…³é—­</span></span><br><span class="line">    <span class="keyword">if</span> (LegacyMergeSort.userRequested)</span><br><span class="line">        legacyMergeSort(a);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        ComparableTimSort.sort(a, <span class="number">0</span>, a.length, <span class="literal">null</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ—¶åœ¨å¿«é€Ÿæ’åºå’Œå½’å¹¶æ’åºä¸­ï¼Œä¼šåˆ¤æ–­ä¸ªæ•°æ˜¯å¦å¤§äº32ï¼Œä»è€Œé€‰æ‹©åˆ†æ®µæ’åºå’ŒäºŒåˆ†æ’å…¥æ’åºï¼Œéƒ¨åˆ†æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ComparableTimSortç±» å’ŒTimSortç±»æ–¹æ³•ä¸€æ ·</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sort</span><span class="params">(Object[] a, <span class="type">int</span> lo, <span class="type">int</span> hi, Object[] work, <span class="type">int</span> workBase, <span class="type">int</span> workLen)</span> &#123;</span><br><span class="line">    <span class="comment">// ... çœç•¥ä»£ç </span></span><br><span class="line">    <span class="keyword">if</span> (nRemaining &lt; MIN_MERGE) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">initRunLen</span> <span class="operator">=</span> countRunAndMakeAscending(a, lo, hi);</span><br><span class="line">        <span class="comment">// äºŒåˆ†æ’å…¥æ’åº</span></span><br><span class="line">        binarySort(a, lo, hi, lo + initRunLen);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ†æ®µæ’åº</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="2-Collections-binarySearch-äºŒåˆ†æŸ¥æ‰¾"><a href="#2-Collections-binarySearch-äºŒåˆ†æŸ¥æ‰¾" class="headerlink" title="2. Collections.binarySearch äºŒåˆ†æŸ¥æ‰¾"></a>2. Collections.binarySearch äºŒåˆ†æŸ¥æ‰¾</h3><p>äºŒåˆ†æŸ¥æ‰¾çš„å‰ææ˜¯é›†åˆæœ‰åºï¼Œå¦åˆ™ä¸èƒ½æ»¡è¶³äºŒåˆ†ç®—æ³•çš„æŸ¥æ‰¾è¿‡ç¨‹ã€‚</p><ul><li><p>æ–¹æ³•ä½¿ç”¨ï¼Œä»£ç æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">list.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;4&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;5&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;6&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;7&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;8&quot;</span>);</span><br><span class="line"><span class="comment">// äºŒåˆ†æŸ¥æ‰¾, ä¼ å…¥listå’Œéœ€è¦æŸ¥æ‰¾çš„å…ƒç´ </span></span><br><span class="line"><span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> Collections.binarySearch(list, <span class="string">&quot;5&quot;</span>);</span><br><span class="line"><span class="comment">// è¾“å‡º4</span></span><br><span class="line">System.out.println(<span class="string">&quot;äºŒåˆ†æŸ¥æ‰¾ï¼š&quot;</span> + idx);</span><br></pre></td></tr></table></figure></li><li><p>æºç åˆ†æ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span>&lt;T&gt; <span class="title function_">binarySearch</span> <span class="params">(List&lt;? extends Comparable&lt;? <span class="built_in">super</span> T&gt;&gt; list, T key)</span> &#123;</span><br><span class="line">    <span class="comment">// listç»§æ‰¿RandAccessæˆ–è€…listçš„å¤§å°å°äºäºŒåˆ†æŸ¥æ‰¾æœ€å¤§é˜™å€¼5000</span></span><br><span class="line">    <span class="keyword">if</span> (list <span class="keyword">instanceof</span> RandomAccess || list.size() &lt; BINARYSEARCH_THRESHOLD)</span><br><span class="line">        <span class="comment">// è°ƒç”¨ä¸‹æ ‡äºŒåˆ†æŸ¥æ‰¾</span></span><br><span class="line">        <span class="keyword">return</span> Collections.indexedBinarySearch(list, key);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// è°ƒç”¨è¿­ä»£å™¨äºŒåˆ†æŸ¥æ‰¾ è€ƒè™‘åˆ°LinkedListçš„getæ–¹æ³•æ—¶é—´å¤æ‚åº¦æ˜¯O(n)</span></span><br><span class="line">        <span class="keyword">return</span> Collections.iteartorBinarySearch(list, key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸‹æ ‡äºŒåˆ†æŸ¥æ‰¾</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="type">int</span> <span class="title function_">indexedBinarySearch</span><span class="params">(List&lt;? extends Comparable&lt;? <span class="built_in">super</span> T&gt;&gt; list, T key)</span> &#123;</span><br><span class="line">    <span class="comment">// åˆå§‹ä½ä½ä¸º0</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">low</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// åˆå§‹é«˜ä½ä¸ºlist.size() - 1</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">high</span> <span class="operator">=</span> list.size() - <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// whileå¾ªç¯ä½ä½å°äºç­‰äºé«˜ä½</span></span><br><span class="line">    <span class="keyword">while</span>(low &lt;= high) &#123;</span><br><span class="line">        <span class="comment">// ä½è¿ç®—è·å–ä¸­é—´ä¸‹æ ‡</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> (low + high) &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// è·å–ä¸­é—´ä¸‹æ ‡å…ƒç´ </span></span><br><span class="line">        Comparable&lt;? <span class="built_in">super</span> T&gt; midVal = list.get(mid);</span><br><span class="line">        <span class="comment">// è°ƒç”¨compareToæ–¹æ³•, ä¸­é—´å…ƒç´ å’Œå¯»æ‰¾å…ƒç´ åšå¯¹æ¯” å¤§äºè¿”å›å¤§äº0, å°äºè¿”å›å°äº0, ç›¸ç­‰è¿”å›0</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">cmp</span> <span class="operator">=</span> midVal.compareTo(key);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// å°äº0è¯´æ˜ä¸­é—´å…ƒç´ å°äºå¯»æ‰¾å…ƒç´ , è¯´æ˜å¯»æ‰¾å…ƒç´ åœ¨å³è¾¹, ä½ä½ = ä¸­é—´ä¸‹æ ‡ + 1</span></span><br><span class="line">            low = mit + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// å¤§äº0è¯´æ˜ä¸­é—´å…ƒç´ å¤§äºå¯»æ‰¾å…ƒç´ , è¯´æ˜å¯»æ‰¾å…ƒç´ åœ¨å·¦è¾¹, é«˜ä½ = ä¸­é—´ä¸‹æ ‡ - 1</span></span><br><span class="line">            high = mit - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            <span class="comment">// ç›¸ç­‰ æ‰¾åˆ°è¯¥å€¼ è¿”å›ä¸­é—´ä¸‹æ ‡</span></span><br><span class="line">            <span class="keyword">return</span> mid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰æ‰¾åˆ°è¿”å› -(low + 1)</span></span><br><span class="line">    <span class="keyword">return</span> -(low + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿­ä»£å™¨äºŒåˆ†æŸ¥æ‰¾, åŸç†å’Œä¸‹æ ‡äºŒåˆ†æŸ¥æ‰¾ä¸€æ ·, æ ¸å¿ƒé€šè¿‡compareToåšæ¯”è¾ƒæŸ¥æ‰¾å…ƒç´ , åŒºåˆ«å°±æ˜¯åœ¨è·å–ä¸­é—´ä¸‹æ ‡å…ƒç´ ä¸Š</span></span><br><span class="line"><span class="comment">// è¿­ä»£å™¨äºŒåˆ†æŸ¥æ‰¾é€šè¿‡è¿­ä»£å™¨è·å–å…ƒç´ , æ—¶é—´å¤æ‚åº¦ä¸ºO(n), ä¹Ÿåšäº†ä¼˜åŒ–,é€šè¿‡è¿­ä»£å™¨çš„ä¸‹ä¸€ä¸ªå…ƒç´ çš„ä¸‹æ ‡å’Œä¸­é—´ä¸‹æ ‡åšæ¯”è¾ƒ,</span></span><br><span class="line"><span class="comment">// åˆ¤æ–­ä¸­é—´ä¸‹æ ‡å…ƒç´ æ˜¯åœ¨å‰é¢(previous)è¿˜æ˜¯åé¢(next)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="type">int</span> <span class="title function_">iteratorBinarySearch</span><span class="params">(List&lt;? extends Comparable&lt;? <span class="built_in">super</span> T&gt;&gt; list, T key)</span> &#123;</span><br><span class="line">    <span class="comment">// åˆå§‹ä½ä½ä¸º0</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">low</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// åˆå§‹é«˜ä½ä¸ºé›†åˆå¤§å° - 1</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">high</span> <span class="operator">=</span> list.size() - <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// è·å–é›†åˆè¿­ä»£å™¨</span></span><br><span class="line">    ListIterator&lt;? <span class="keyword">extends</span> <span class="title class_">Comparable</span>&lt;? <span class="built_in">super</span> T&gt;&gt; i = list.listIterator();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// whileå¾ªç¯ä½ä½å°äºç­‰äºé«˜ä½</span></span><br><span class="line">    <span class="keyword">while</span> (low &lt;= high) &#123;</span><br><span class="line">        <span class="comment">// é€šè¿‡ä½è¿ç®—è·å–ä¸­é—´ä¸‹æ ‡</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> (low + high) &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// é€šè¿‡è¿­ä»£å™¨è·å–ä¸­é—´ä¸‹æ ‡å…ƒç´ å€¼</span></span><br><span class="line">        Comparable&lt;? <span class="built_in">super</span> T&gt; mitVal = get(i, mid);</span><br><span class="line">        <span class="comment">// ä¸­é—´å€¼å’Œå¯»æ‰¾å€¼åšå¯¹äº å¤§äºè¿”å›å¤§äº0, å°äºè¿”å›å°äº0, ç›¸ç­‰è¿”å›ç­‰äº0</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">cmp</span> <span class="operator">=</span> mitVal.compareTo(key);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// ä¸­é—´å€¼å°äºå¯»æ‰¾å€¼, è¯´æ˜å¯»æ‰¾å€¼åœ¨å³è¾¹, ä½ä½ = ä¸­é—´ä¸‹æ ‡ + 1 </span></span><br><span class="line">            low = mid + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// ä¸­é—´å€¼å¤§äºå¯»æ‰¾å€¼, è¯´æ˜å¯»æ‰¾å€¼åœ¨å·¦è¾¹, é«˜ä½ = ä¸­é—´ä¸‹æ ‡ - 1</span></span><br><span class="line">            high = mid - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// æ‰¾åˆ°è¯¥å€¼ è¿”å›ä¸‹æ ‡</span></span><br><span class="line">            <span class="keyword">return</span> mid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰æ‰¾åˆ°è¿”å› -(low + 1)</span></span><br><span class="line">    <span class="keyword">return</span> -(low + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿­ä»£å™¨è·å–ä¸­é—´ä¸‹æ ‡å…ƒç´ </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">get</span><span class="params">(ListIterator&lt;? extends T&gt; i, <span class="type">int</span> index)</span> &#123;</span><br><span class="line">    <span class="type">T</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// è¿­ä»£å™¨ä¸‹ä¸€ä¸ªå…ƒç´ ä¸‹æ ‡</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> i.nextIndex();</span><br><span class="line">    <span class="keyword">if</span> (pos &lt;= inde)&#123;</span><br><span class="line">        <span class="comment">// ä¸‹ä¸€ä¸ªå…ƒç´ ä¸‹æ ‡å€¼å°äºç­‰äºå¯»æ‰¾ä¸‹æ ‡å€¼, æ‰€ä»¥å¯»æ‰¾ä¸‹æ ‡å€¼åœ¨é“¾è¡¨çš„åé¢(next)</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            obj = i.next();</span><br><span class="line">        &#125; <span class="keyword">while</span> (pos++ &lt; index);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸‹ä¸€ä¸ªå…ƒç´ ä¸‹æ ‡å€¼å°äºå¯»æ‰¾ä¸‹æ ‡å€¼, æ‰€ä»¥å¯»æ‰¾ä¸‹æ ‡å€¼åœ¨é“¾è¡¨çš„å‰é¢(prev)</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            obj = i.previous();</span><br><span class="line">        &#125; <span class="keyword">while</span> (--pos &gt; index);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ä¸Šé¢äºŒåˆ†æŸ¥æ‰¾æºç æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>åˆ¤æ–­listæ˜¯RandomAccessæˆ–è€…listçš„å®¹é‡å°äºäºŒåˆ†æŸ¥æ‰¾é˜™å€¼5000ï¼Œåˆ™è°ƒç”¨ä¸‹æ ‡äºŒåˆ†æŸ¥æ‰¾ï¼Œå¦åˆ™è°ƒç”¨è¿­ä»£å™¨äºŒåˆ†æŸ¥æ‰¾ã€‚</li><li>åˆå§‹åŒ–ä½ä½ä¸º0ï¼Œé«˜ä½ä¸º<code>list.size()-1</code>ï¼Œwhileå¾ªç¯çŸ¥é“ç›´åˆ°å…ƒç´ æˆ–è€…<code>low &gt; high</code> </li><li>é€šè¿‡ä½è¿ç®—è·å–ä¸­é—´ä¸‹æ ‡<code>(low + high) &gt;&gt;&gt; 1</code> è¿”å›<code>mid</code></li><li>é€šè¿‡<code>mid</code>ä¸‹æ ‡å…ƒç´ (äºŒåˆ†æŸ¥æ‰¾ç›´æ¥é€šè¿‡<code>list.get()</code>è·å–ï¼Œè¿­ä»£å™¨äºŒåˆ†æŸ¥æ‰¾é€šè¿‡è¿­ä»£å™¨<code>get()</code>è·å–)ã€‚</li><li>ä¸­é—´å…ƒç´ å’Œå¯»æ‰¾å…ƒç´ è°ƒç”¨<code>comparteTo()</code>æ–¹æ³•åšæ¯”è¾ƒè¿”å›<code>cmp</code>ï¼Œå¦‚æœ<code>cmp &lt; 0</code>ï¼Œè¯´æ˜ä¸­é—´å€¼å°äºå¯»æ‰¾å€¼ï¼Œåˆ™å¯»æ‰¾å…ƒç´ åœ¨å³è¾¹ï¼Œä½ä½ &#x3D; <code>mid + 1</code>ï¼Œå¦‚æœ<code>cmp &gt; 0</code>ï¼Œè¯´æ˜ä¸­é—´å€¼å¤§äºå¯»æ‰¾å€¼ï¼Œåˆ™å¯»æ‰¾å…ƒç´ åœ¨å·¦è¾¹ï¼Œé«˜ä½ &#x3D; <code>mid - 1</code>ï¼Œå¦‚æœ<code>mid = 0</code>è¯´æ˜æ‰¾åˆ°å¯»æ‰¾å…ƒç´ ï¼Œè¿”å›ä¸­é—´ä¸‹æ ‡ã€‚</li></ol></li></ul><h3 id="3-Collections-shuffle-æ´—ç‰Œç®—æ³•"><a href="#3-Collections-shuffle-æ´—ç‰Œç®—æ³•" class="headerlink" title="3. Collections.shuffle æ´—ç‰Œç®—æ³•"></a>3. Collections.shuffle æ´—ç‰Œç®—æ³•</h3><p>æ´—ç‰Œç®—æ³•å°±æ˜¯å°†Listé›†åˆä¸­çš„å…ƒç´ æ‰“ä¹±ï¼Œä¸€èˆ¬å¯ä»¥ç”¨äºæŠ½å¥–ã€æ‘‡å·ã€æ´—ç‰Œç­‰åœºæ™¯ã€‚</p><ul><li><p>æ–¹æ³•ä½¿ç”¨ï¼Œä»£ç æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">list.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;4&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;5&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;6&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;7&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;8&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸¤ç§ä½¿ç”¨æ–¹å¼ ä¸€ç§æ˜¯ç›´æ¥ä¼ å…¥list </span></span><br><span class="line"><span class="comment">//å¦ä¸€ç§è¿˜å¯ä»¥ä¼ å…¥å›ºå®šéšæœºç§å­, è¿™ç§æ–¹å¼å¯ä»¥æ§åˆ¶æ´—ç‰ŒèŒƒå›´</span></span><br><span class="line">Collections.shuffle(list);</span><br><span class="line">Collections.shuffle(list, <span class="keyword">new</span> <span class="title class_">Random</span>(<span class="number">100</span>));</span><br></pre></td></tr></table></figure></li><li><p>æºç åˆ†æ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">shuffle</span><span class="params">(List&lt;?&gt; list)</span> &#123;</span><br><span class="line">    <span class="type">Random</span> <span class="variable">rnd</span> <span class="operator">=</span> r;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰ä¼ å…¥å›ºå®šéšæœºç§å­åˆ™åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> (rnd == <span class="literal">null</span>)</span><br><span class="line">        r = rnd = <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">    <span class="comment">// æ´—ç‰Œç®—æ³•</span></span><br><span class="line">    shuffle(list, rnd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">shuffle</span><span class="params">(List&lt;?&gt; list, Random rnd)</span> &#123;</span><br><span class="line">    <span class="comment">// é›†åˆå®¹é‡</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> list.size();</span><br><span class="line">    <span class="comment">// é›†åˆå®¹é‡å°äºæ´—ç‰Œé˜™å€¼5 æˆ–è€… æ˜¯RandomAccess</span></span><br><span class="line">    <span class="keyword">if</span> (size &lt; SHUFFLE_THRESHOLD || list.<span class="keyword">instanceof</span> RandomAccess) &#123;</span><br><span class="line">        <span class="comment">// forå¾ªç¯è°ƒç”¨äº¤æ¢ç®—æ³•</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> size; i &gt; <span class="number">1</span>; i--)</span><br><span class="line">            swap(list, i - <span class="number">1</span>, rnd.nextInt(i));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// é›†åˆå®¹é‡å¤§äºæ´—ç‰Œé˜™å€¼5, ä¸”ä¸æ˜¯RandomAccess, æ¯”å¦‚LindedList</span></span><br><span class="line">        <span class="comment">// è½¬æˆæ•°ç»„,å¯¹æ•°ç»„åšè°ƒæ¢æ“ä½œ, ä¸è°ƒç”¨listçš„setæ–¹æ³•ä¸»è¦æ˜¯å› ä¸ºLindedListçš„setæ–¹æ³•è¦è·å–ä¼ å…¥ä¸‹æ ‡çš„å…ƒç´ ,è·å–å…ƒç´ </span></span><br><span class="line">        <span class="comment">// æ—¶é—´å¤æ‚åº¦ä¸ºO(n)æ€§èƒ½ä½</span></span><br><span class="line">        Object[] arr = list.toArray();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// forå¾ªç¯å¯¹æ•°ç»„è¿›è¡Œè°ƒæ¢ç®—æ³•</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> size; i &gt; <span class="number">1</span>; i--)</span><br><span class="line">            swap(arr, i - <span class="number">1</span>, rnd,nextInt(i));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é€šè¿‡è¿­ä»£å™¨è¿›è¡Œå…ƒç´ çš„è°ƒæ¢, ä½¿ç”¨è¿­ä»£å™¨çš„setæ–¹æ³•æ€§èƒ½å°±æ˜¯å¾ˆé«˜,å› ä¸ºå¯ä»¥é€šè¿‡è¿­ä»£å™¨è·å–å…ƒç´ </span></span><br><span class="line">        <span class="type">ListIterator</span> <span class="variable">it</span> <span class="operator">=</span> list.listIterator();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; arr.length; i++)&#123;</span><br><span class="line">            it.next();</span><br><span class="line">        it.set(arr[i]);</span><br><span class="line">        &#125;     </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">swap</span> <span class="params">(List&lt;?&gt; list, <span class="type">int</span> i, <span class="type">int</span> j)</span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">List</span> <span class="variable">l</span> <span class="operator">=</span> list;</span><br><span class="line">    <span class="comment">// é€šè¿‡list.set(int index, E e)æ–¹æ³•è¿›è¡Œå…ƒç´ è°ƒæ¢, è¯¥æ–¹æ³•è¿”å›åŸå…ƒç´ </span></span><br><span class="line">    <span class="comment">// æ¯”å¦‚list(1, 2, 3, 4, 5, 6, 7, 8) i = 7, j = 0</span></span><br><span class="line">    <span class="comment">// é¦–å…ˆ l.set(j, l.get(i)) å°†ä¸‹æ ‡ä¸º7çš„å…ƒç´ è°ƒåˆ°ä¸‹ä½ä¸º0çš„ä½ç½®,å¹¶è¿”å›å…ƒç´ 1, æ­¤æ—¶listä¸º(8,2,3,4,5,6,7,8)</span></span><br><span class="line">    <span class="comment">// l.set(i, 1), å°†å…ƒç´ 1è®¾ç½®åˆ°ä¸‹æ ‡7, æ­¤æ—¶listä¸º(8,2,3,4,5,6,7,1)</span></span><br><span class="line">    <span class="comment">// è¿™æ ·å­å°±å®Œæˆäº†å…ƒç´ è°ƒæ¢</span></span><br><span class="line">    l.set(i, l.set(j, l.get(i)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">swap</span><span class="params">(Object[] arr, <span class="type">int</span> i, <span class="type">int</span> j)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸‹æ ‡iå…ƒç´ </span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">tmp</span> <span class="operator">=</span> arr[i];</span><br><span class="line">    <span class="comment">// å°†ä¸‹æ ‡jå…ƒç´ èµ‹å€¼åˆ°ä¸‹æ ‡iä½ç½®</span></span><br><span class="line">    arr[i] = arr[j];</span><br><span class="line">    <span class="comment">// ä¸‹æ ‡iå…ƒç´ èµ‹å€¼åˆ°ä¸‹æ ‡jä½ç½®</span></span><br><span class="line">    <span class="comment">// å®Œæˆä¸‹æ ‡i, jçš„è°ƒæ¢</span></span><br><span class="line">    arr[j] = tmp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ä¸Šé¢æ´—ç‰Œç®—æ³•<code>shuffle(List&lt;?&gt; list, Random rnd)</code>æµç¨‹å¦‚ä¸‹</p><ol><li>åˆ¤æ–­å®¹é‡æ˜¯å¦å°äºæ´—ç‰Œé˜™å€¼<code>5</code>æˆ–è€…æ˜¯<code>RandomAccess</code>ï¼Œæ¥è°ƒç”¨ä¸åŒçš„è°ƒæ¢ç®—æ³•</li><li>å®¹é‡å°äº<code>5</code>æˆ–è€…æ˜¯<code>RandomAccess</code>ï¼Œé€šè¿‡å¾ªç¯å®¹é‡å¤§å°å¾—åˆ°å½“å‰ä¸‹æ ‡å’Œéšæœºä¸‹æ ‡ï¼Œç„¶åé€šè¿‡<code>list.set(int index, E e)</code>æ–¹æ³•å°†ä¸¤ä¸ªä¸‹æ ‡å…ƒç´ è°ƒæ¢ã€‚</li><li>å¦‚æœå®¹é‡å¤§äº<code>5</code>ä¸”ä¸æ˜¯<code>RandomAccess</code>ï¼Œé€šè¿‡å°†<code>list</code>è½¬æˆæ•°ç»„ï¼Œç„¶åå¾ªç¯å®¹é‡å¤§å°å¾—åˆ°å½“å‰ä¸‹æ ‡å’Œéšæœºä¸‹æ ‡ï¼Œç„¶åé€šè¿‡æ•°ç»„èµ‹å€¼è°ƒæ¢å…ƒç´ ï¼Œæœ€åé€šè¿‡å¾ªç¯æ•°ç»„ï¼Œé€šè¿‡listçš„è¿­ä»£å™¨å°†æ•°ç»„é‡Œé¢çš„å…ƒç´ èµ‹å€¼åˆ°<code>list</code>ã€‚</li></ol></li></ul><h3 id="1-4-Collections-rotate-æ—‹è½¬ç®—æ³•"><a href="#1-4-Collections-rotate-æ—‹è½¬ç®—æ³•" class="headerlink" title="1.4 Collections.rotate æ—‹è½¬ç®—æ³•"></a>1.4 Collections.rotate æ—‹è½¬ç®—æ³•</h3><p><code>rotate</code>æ—‹è½¬ç®—æ³•å¯ä»¥æŠŠ<code>ArrayList</code>ã€<code>LinkedList</code>ä»æŒ‡å®šçš„ä½ç½®å¼€å§‹ï¼Œè¿›è¡Œé¡ºæ—¶é’ˆæˆ–è€…é€†æ—¶é’ˆæ—‹è½¬æ“ä½œã€‚</p><ul><li><p>æ–¹æ³•ä½¿ç”¨ï¼Œä»£ç æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">list.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;4&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;5&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†listé¡ºæ—¶é’ˆæ—‹è½¬2ä½, é€†æ—¶é’ˆæ—‹è½¬ä¸ºè´Ÿæ•°</span></span><br><span class="line"><span class="comment">// è¾“å‡ºä¸º 4,5,1,2,3</span></span><br><span class="line">Collections.rotate(list, <span class="number">2</span>);</span><br><span class="line"><span class="comment">// è¾“å‡ºä¸º 3,4,5,1,2</span></span><br><span class="line">Collections.rotate(list, -<span class="number">2</span>);</span><br></pre></td></tr></table></figure></li><li><p>æºç åˆ†æ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">rotate</span><span class="params">(List&lt;?&gt; list, <span class="type">int</span> distance)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (list <span class="keyword">instanceof</span> RandomAccess || list.size() &lt; ROTATE_THRESHOLD)</span><br><span class="line">        rotate1(list, distance);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        rotate2(list, distance);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">rotate1</span><span class="params">(List&lt;?&gt; list, <span class="type">int</span> distance)</span> &#123;</span><br><span class="line">    <span class="comment">// é›†åˆå®¹é‡</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> list.size();</span><br><span class="line">    <span class="comment">// é›†åˆå®¹é‡ä¸º0ç›´æ¥ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// è®¡ç®—æ—‹è½¬çš„è·ç¦»</span></span><br><span class="line">    distance = distance % size;</span><br><span class="line">    <span class="keyword">if</span> (distance &lt; <span class="number">0</span>)</span><br><span class="line">        distance += size;</span><br><span class="line">    <span class="keyword">if</span> (distance == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// forå¾ªç¯å’Œdo while,é…åˆæ¯æ¬¡çš„æ—‹è½¬æ“ä½œ</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">cycleStart</span> <span class="operator">=</span> <span class="number">0</span>, nMoved = <span class="number">0</span>; nMoved != size; cycleStart++) &#123;</span><br><span class="line">        <span class="comment">// æ—‹è½¬çš„å…ƒç´ </span></span><br><span class="line">        <span class="type">T</span> <span class="variable">displaced</span> <span class="operator">=</span> list.get(cycleStart);</span><br><span class="line">        <span class="comment">// æ—‹è½¬çš„å…ƒç´ ä¸‹æ ‡</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> cycleStart;</span><br><span class="line">        <span class="keyword">do</span> &#123; </span><br><span class="line">           i += distance;</span><br><span class="line">           <span class="keyword">if</span> (i &gt; size)</span><br><span class="line">               i -= size;</span><br><span class="line">            <span class="comment">// é€šè¿‡list.setæ–¹æ³•æ—‹è½¬å…ƒç´ </span></span><br><span class="line">            displaced = list.set(i, displaced);</span><br><span class="line">            nMoved++;</span><br><span class="line">        &#125; <span class="keyword">while</span> (i != cycleStart);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">rotate2</span><span class="params">(List&lt;?&gt; list, <span class="type">int</span> distance)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> list.size();</span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span>  -distance % size;</span><br><span class="line">    <span class="keyword">if</span> (mid &lt; <span class="number">0</span>)</span><br><span class="line">        mid += size;</span><br><span class="line">    <span class="keyword">if</span> (mid == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    reverse(list.subList(<span class="number">0</span>, mid));</span><br><span class="line">        reverse(list.subList(mid, size));</span><br><span class="line">        reverse(list);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">reverse</span><span class="params">(List&lt;?&gt; list)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> list.size();</span><br><span class="line">    <span class="keyword">if</span> (size &lt; REVERSE_THRESHOLD || list <span class="keyword">instanceof</span> RandomAccess) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>, mid=size&gt;&gt;<span class="number">1</span>, j=size-<span class="number">1</span>; i&lt;mid; i++, j--)</span><br><span class="line">            swap(list, i, j);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// instead of using a raw type here, it&#x27;s possible to capture</span></span><br><span class="line">        <span class="comment">// the wildcard but it will require a call to a supplementary</span></span><br><span class="line">        <span class="comment">// private method</span></span><br><span class="line">        <span class="type">ListIterator</span> <span class="variable">fwd</span> <span class="operator">=</span> list.listIterator();</span><br><span class="line">        <span class="type">ListIterator</span> <span class="variable">rev</span> <span class="operator">=</span> list.listIterator(size);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>, mid=list.size()&gt;&gt;<span class="number">1</span>; i&lt;mid; i++) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">tmp</span> <span class="operator">=</span> fwd.next();</span><br><span class="line">            fwd.set(rev.previous());</span><br><span class="line">            rev.set(tmp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>rotate1</code>æ–¹æ³•æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>åˆ¤æ–­é›†åˆå®¹é‡ï¼Œå¹¶è®¡ç®—æ—‹è½¬çš„è·ç¦»ã€‚</li><li><code>for</code>å¾ªç¯å’Œ<code>do while</code>é…åˆæ¯æ¬¡çš„æ—‹è½¬ï¼Œæ¯”å¦‚è¿™é‡Œç¬¬ä¸€æ¬¡ä¼šæŠŠ0ä½ç½®å…ƒç´ æ›¿æ¢åˆ°2ä½ç½®ï¼Œæ­¤æ—¶<code>list</code>æ˜¯<code>1,2,1,4,5</code>,<code>do while</code>ä¸­ä¼šåˆ¤æ–­<code>i != cycleStart</code>ï¼Œå½“<code>i == cycleStart</code>çš„æ—¶å€™è¯´æ˜æ—‹è½¬å…¨éƒ¨çš„å…ƒç´ äº†ï¼Œç„¶åç»§ç»­æŠŠè¢«æ›¿æ¢2ä½ç½®çš„å…ƒç´ ç»§ç»­å¾€ä¸‹æ›¿æ¢ï¼Œæ¯”å¦‚è¿™é‡Œç¬¬äºŒæ¬¡ä¼šæŠŠè¢«æ›¿æ¢2ä½ç½®æ›¿æ¢åˆ°4ä½ç½®ï¼Œæ­¤æ—¶listæ˜¯<code>1,2,1,4,3</code>ï¼Œç›´åˆ°ä¸€è½®å¾ªç¯æŠŠæ‰€æœ‰å…ƒç´ éƒ½æ”¾ç½®åˆ°æ­£ç¡®ä½ç½®ã€‚</li><li>ç§»åŠ¨çš„æ¬¡æ•°ä¸º<code>size</code>è¡¨æ˜<code>list</code>å…¨éƒ¨å…ƒç´ éƒ½æ—‹è½¬ï¼Œç»“æŸforå¾ªç¯ã€‚</li></ol><p><code>rotate2</code>æ–¹æ³•æµç¨‹å¦‚ä¸‹ï¼šè¯¥æ–¹æ³•ä¸»è¦é’ˆå¯¹å¤§äº100ä¸ªå…ƒç´ çš„LinkedListè¿›è¡Œæ“ä½œã€‚</p><ol><li>å®šä½æ‹†é“¾ä½ç½®ï¼Œ distance % size + size ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¦æ—‹è½¬åæ‰¾åˆ°çš„å…ƒç´ ä½ç½®ã€‚</li><li>ç¬¬ä¸€æ¬¡ç¿»è½¬ï¼ŒæŠŠä»ä½ç½® 0 åˆ°æ‹†é“¾ä½ç½®</li><li>ç¬¬ä¸‰æ¬¡ç¿»è½¬ï¼Œç¿»è½¬æ•´ä¸ªé“¾è¡¨ã€‚</li></ol></li></ul><h3 id="1-5-Collectionså…¶ä»–API"><a href="#1-5-Collectionså…¶ä»–API" class="headerlink" title="1.5 Collectionså…¶ä»–API"></a>1.5 Collectionså…¶ä»–API</h3><ul><li><p>æœ€å¤§æœ€å°å€¼ï¼Œä¸»è¦ä¾èµ–compareToæ–¹æ³•æ¯”è¾ƒå¤§å°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">list.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;4&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;5&quot;</span>);</span><br><span class="line"><span class="comment">// æœ€å°å€¼ </span></span><br><span class="line"><span class="type">String</span> <span class="variable">min</span> <span class="operator">=</span> Collections.min(list);</span><br><span class="line"><span class="comment">// æœ€å¤§å€¼</span></span><br><span class="line"><span class="type">String</span> <span class="variable">max</span> <span class="operator">=</span> Collections.max(list);</span><br></pre></td></tr></table></figure></li><li><p>å…ƒç´ æ›¿æ¢ï¼Œä¼šåˆ¤æ–­listæ˜¯RandomAccessï¼Œå°äºæ›¿æ¢é˜™å€¼11ï¼Œè°ƒç”¨ä¸åŒçš„æ›¿æ¢å€¼æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ä½¿ç”¨listçš„setæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ä½¿ç”¨è¿­ä»£å™¨çš„setæ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">list.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;4&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;5&quot;</span>);</span><br><span class="line">Collections.replaceAll(list, <span class="string">&quot;5&quot;</span>, <span class="string">&quot;6&quot;</span>);</span><br></pre></td></tr></table></figure></li><li><p>è¿ç»­é›†åˆä½ç½®åˆ¤æ–­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;(); </span><br><span class="line">list.add(<span class="string">&quot;7&quot;</span>); </span><br><span class="line">list.add(<span class="string">&quot;4&quot;</span>); </span><br><span class="line">list.add(<span class="string">&quot;8&quot;</span>); </span><br><span class="line">list.add(<span class="string">&quot;3&quot;</span>); </span><br><span class="line">list.add(<span class="string">&quot;9&quot;</span>); </span><br><span class="line"><span class="comment">// è¿”å›2</span></span><br><span class="line"><span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> Collections.indexOfSubList(list, Arrays.asList(<span class="string">&quot;8&quot;</span>, <span class="string">&quot;3&quot;</span>));</span><br></pre></td></tr></table></figure></li><li><p>synchronizedæ–¹æ³•ï¼Œå°†éçº¿ç¨‹å®‰å…¨çš„é›†åˆè½¬æ¢æˆçº¿ç¨‹å®‰å…¨é›†åˆã€‚Collectionså†…éƒ¨å®šä¹‰äº†é™æ€ç±»<code>SynchronizedList</code>ã€<code>SynchronizedMap</code>ï¼Œè¿™ä¸¤ä¸ªç±»å®šä¹‰Listã€Mapç„¶åæ“ä½œæ–¹æ³•åŠ é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = Collections.synchronizedList(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;());</span><br><span class="line">Map&lt;String, String&gt; map = Collections.synchronizedMap(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;()</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Collections </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaåˆ›å»ºçº¿ç¨‹æ± çš„å››ç§æ–¹å¼</title>
      <link href="/2022/03/02/java-create-threadpool/"/>
      <url>/2022/03/02/java-create-threadpool/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h3 id="ä¸€ã€newCachedThreadPoolçš„æ–¹å¼"><a href="#ä¸€ã€newCachedThreadPoolçš„æ–¹å¼" class="headerlink" title="ä¸€ã€newCachedThreadPoolçš„æ–¹å¼"></a>ä¸€ã€newCachedThreadPoolçš„æ–¹å¼</h3><p>è¿™ç§æ–¹å¼åˆ›å»ºä¸€ä¸ªå¯ç¼“å­˜çº¿ç¨‹æ± ï¼Œå¦‚æœçº¿ç¨‹æ± é•¿åº¦è¶…è¿‡å¤„ç†éœ€è¦ï¼Œå¯çµæ´»å›æ”¶ç©ºé—²çº¿ç¨‹ç”¨äºæ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœæ²¡æœ‰ç©ºé—²çº¿ç¨‹åˆ™æ–°å»ºçº¿ç¨‹ç”¨äºæ‰§è¡Œä»»åŠ¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolDemo</span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">15</span>; i++)&#123;</span><br><span class="line">      <span class="type">Runnable</span> <span class="variable">run</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;</span><br><span class="line">          <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();<span class="comment">//è·å–å½“å‰çº¿ç¨‹</span></span><br><span class="line">          System.out.println(t + <span class="string">&quot;æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      threadPool.execute(run);<span class="comment">//å°†ä»»åŠ¡æŒ‡æ´¾ç»™çº¿ç¨‹æ± </span></span><br><span class="line">    &#125;</span><br><span class="line">    threadPool.shutdown();<span class="comment">//å…³é—­çº¿ç¨‹æ± </span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼Œå‘ç°æ‰§è¡Œä»»åŠ¡æœ‰ç›¸åŒçº¿ç¨‹ï¼Œè¯´æ˜äº†çº¿ç¨‹æ± å¯¹ç©ºé—²çº¿ç¨‹çµæ´»å›æ”¶å†åˆ©ç”¨äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">1</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">3</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">2</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">4</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">4</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">1</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">2</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">3</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">7</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">8</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">5</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">9</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">11</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">10</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">6</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br></pre></td></tr></table></figure><h3 id="äºŒã€newFixedThreadPoolçš„æ–¹å¼"><a href="#äºŒã€newFixedThreadPoolçš„æ–¹å¼" class="headerlink" title="äºŒã€newFixedThreadPoolçš„æ–¹å¼"></a>äºŒã€newFixedThreadPoolçš„æ–¹å¼</h3><p>è¿™ç§æ–¹å¼åˆ›å»ºä¸€ä¸ªå®šé•¿çº¿ç¨‹æ± ï¼Œå¯æ§åˆ¶çº¿ç¨‹çš„æœ€å¤§å¹¶å‘æ•°ï¼Œå¦‚æœè¶…å‡ºè¯¥å¹¶å‘æ•°ï¼Œåˆ™è¶…å‡ºçš„çº¿ç¨‹ä¼šåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolDemo</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>);<span class="comment">//åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ä¸ªæ•°ä¸º2çš„çº¿ç¨‹æ± </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)&#123;</span><br><span class="line">      <span class="type">Runnable</span> <span class="variable">run</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;</span><br><span class="line">          <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();<span class="comment">//è·å–å½“å‰çº¿ç¨‹</span></span><br><span class="line">          System.out.println(t + <span class="string">&quot;æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      threadPool.execute(run);<span class="comment">//å°†ä»»åŠ¡æŒ‡æ´¾ä¸ºçº¿ç¨‹æ± </span></span><br><span class="line">    &#125;</span><br><span class="line">    threadPool.shutdown();<span class="comment">//å…³é—­çº¿ç¨‹æ± </span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼Œè¯´æ˜æ‰§è¡Œä»»åŠ¡åªæœ‰2ä¸¤ä¸ªçº¿ç¨‹ï¼Œæ§åˆ¶äº†å¹¶å‘æ•°ï¼Œè¶…å‡ºçš„çº¿ç¨‹ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Thread[pool-1-thread-1,5,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-1-thread-2,5,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-1-thread-1,5,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-1-thread-1,5,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-1-thread-2,5,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br></pre></td></tr></table></figure><h3 id="ä¸‰ã€newScheduledThreadPoolçš„æ–¹å¼"><a href="#ä¸‰ã€newScheduledThreadPoolçš„æ–¹å¼" class="headerlink" title="ä¸‰ã€newScheduledThreadPoolçš„æ–¹å¼"></a>ä¸‰ã€newScheduledThreadPoolçš„æ–¹å¼</h3><p>åˆ›å»ºä¸€ä¸ªå®šé•¿çº¿ç¨‹æ± ï¼Œä½†æ˜¯è¯¥çº¿ç¨‹æ± æ”¯æŒå®šæ—¶åŠå‘¨æœŸæ€§æ‰§è¡Œä»»åŠ¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolDemo</span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ä¸ªæ•°ä¸º2çš„çº¿ç¨‹æ± </span></span><br><span class="line">    <span class="type">ScheduledExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span> ;i &lt; <span class="number">5</span>; i++)&#123;</span><br><span class="line">      <span class="type">Runnable</span> <span class="variable">run</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;</span><br><span class="line">          <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();<span class="comment">//è·å–å½“å‰çº¿ç¨‹</span></span><br><span class="line">       System.out.println(t + <span class="string">&quot;æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      threadPool.schedule(run, <span class="number">3</span>, TimeUnit.SECONDS);<span class="comment">//å»¶è¿Ÿ3ç§’æ‰§è¡Œ</span></span><br><span class="line">    &#125;</span><br><span class="line">    threadPool.shutdown();<span class="comment">//å…³é—­çº¿ç¨‹æ± </span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼Œä¼šå»¶è¿Ÿ3ç§’æ‰§è¡Œï¼Œä¸”æ‰§è¡Œä»»åŠ¡åªæœ‰2ä¸¤ä¸ªçº¿ç¨‹ï¼Œæ§åˆ¶äº†å¹¶å‘æ•°ï¼Œè¶…å‡ºçš„çº¿ç¨‹ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">2</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">1</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">2</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">1</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">1</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="å››ã€newSingleThreadExecutorçš„æ–¹å¼"><a href="#å››ã€newSingleThreadExecutorçš„æ–¹å¼" class="headerlink" title="å››ã€newSingleThreadExecutorçš„æ–¹å¼"></a>å››ã€newSingleThreadExecutorçš„æ–¹å¼</h3><p>åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹åŒ–çš„çº¿ç¨‹æ± ï¼Œå®ƒåªä¼šç”¨å”¯ä¸€çš„å·¥ä½œçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œä¿è¯æ‰€æœ‰ä»»åŠ¡æŒ‰ç…§æŒ‡å®šé¡ºåº(FIFOï¼ŒLIFO)æ‰§è¡Œã€‚è¿™ä¸ªçº¿ç¨‹æ± åªæ˜¯åªèƒ½å­˜åœ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹æ­»åå¦å¤–ä¸€ä¸ªçº¿ç¨‹ä¼šè¡¥ä¸Šã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolDemo</span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span> ; i++)&#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> i;</span><br><span class="line">      <span class="type">Runnable</span> <span class="variable">run</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;</span><br><span class="line">          <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">          System.out.println(t + <span class="string">&quot;æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚&quot;</span>);</span><br><span class="line">          <span class="keyword">if</span>(index == <span class="number">5</span>) &#123; <span class="comment">//æ¨¡æ‹Ÿçº¿ç¨‹æ­»æ‰äº†</span></span><br><span class="line">            System.out.println(t + <span class="string">&quot;æ­»æ‰äº†ã€‚&quot;</span>);</span><br><span class="line">            t.stop();<span class="comment">//è°ƒç”¨destoryæ–¹æ³•ä¼šæŠ¥é”™</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      threadPool.execute<span class="comment">//å°†ä»»åŠ¡æŒ‡æ´¾ä¸ºçº¿ç¨‹æ± </span></span><br><span class="line">    &#125;</span><br><span class="line">    threadPool.shutdown();<span class="comment">//å…³é—­çº¿ç¨‹æ± </span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç åœ¨æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼Œè¯´æ˜å½“çº¿ç¨‹Thread[pool-1-thread-1,5,main]æ­»æ‰ä¹‹åï¼Œè¯¥çº¿ç¨‹æ± ä¼šåˆ›å»ºThread[pool-1-thread-2,5,main]çº¿ç¨‹ç»§ç»­æ‰§è¡Œä»»åŠ¡ï¼Œçº¿ç¨‹æ± é‡Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">1</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">1</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">1</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">1</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">1</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">1</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">1</span>,<span class="number">5</span>,main]æ­»æ‰äº†ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">2</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">2</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">2</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">2</span>,<span class="number">5</span>,main]æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> çº¿ç¨‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> çº¿ç¨‹æ±  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JDK8-HashMapå®ç°åŸç†</title>
      <link href="/2022/03/02/jdk8-hashmap-principle/"/>
      <url>/2022/03/02/jdk8-hashmap-principle/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h3 id="ä¸€ã€HashMapæ’å…¥"><a href="#ä¸€ã€HashMapæ’å…¥" class="headerlink" title="ä¸€ã€HashMapæ’å…¥"></a>ä¸€ã€HashMapæ’å…¥</h3><p>HashMapæ’å…¥çš„æµç¨‹ä¸»è¦åŒ…æ‹¬ï¼šè®¡ç®—ä¸‹æ ‡ã€ä½•æ—¶æ‰©å®¹ã€ä½•æ—¶é“¾è¡¨è½¬çº¢é»‘æ ‘ç­‰ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><ol><li><p>é¦–å…ˆå¯¹keyè¿›è¡Œhashå€¼çš„æ‰°åŠ¨ï¼Œè·å–ä¸€ä¸ªæ–°çš„hashå€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(key == <span class="literal">null</span>) ? <span class="number">0</span> : h = key.hashCode() ^ (h &gt;&gt;&gt; <span class="number">16</span>)</span><br></pre></td></tr></table></figure></li><li><p>åˆ¤æ–­tabæ˜¯å¦ä¸ºnullæˆ–è€…é•¿åº¦ä¸º0ï¼Œå¦‚æœæ˜¯åˆ™è¿›è¡Œæ‰©å®¹æ“ä½œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((tab == table) == <span class="literal">null</span> || (n = tab.length == <span class="number">0</span>))</span><br><span class="line">n = (tab = resize()).length;</span><br></pre></td></tr></table></figure></li><li><p>æ ¹æ®hashå€¼è®¡ç®—ä¸‹æ ‡ï¼Œå¦‚æœtabå¯¹åº”ä¸‹æ ‡æ²¡æœ‰å­˜æ”¾æ•°æ®ï¼Œåˆ™ç›´æ¥æ’å…¥è¯¥æ•°æ®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((p = tab[i = (n-<span class="number">1</span>) &amp; hash]) == <span class="literal">null</span>)</span><br><span class="line">tab[i] = newNode(hash, key, value, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure></li><li><p>å¦‚æœé”®å€¼å¯¹é”®çš„å€¼ä»¥åŠèŠ‚ç‚¹ hash ç­‰äºé“¾è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªé”®å€¼å¯¹èŠ‚ç‚¹æ—¶ï¼Œåˆ™å°†eæŒ‡å‘è¯¥é”®å€¼å¯¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (p.hash == hash &amp;&amp; </span><br><span class="line">((k = p.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">e = p;</span><br></pre></td></tr></table></figure></li><li><p>å¦‚æœæ¡¶ä¸­å¼•ç”¨ç±»å‹æ˜¯æ ‘èŠ‚ç‚¹ï¼Œåˆ™å‘æ ‘æ’å…¥è¯¥èŠ‚ç‚¹ï¼Œå¦åˆ™å‘é“¾è¡¨ä¸­æ’å…¥è¯¥èŠ‚ç‚¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">    e = ((TreeNode&lt;K, V&gt;)p).putTreeVal(<span class="built_in">this</span>, tab, hash, key, value);</span><br></pre></td></tr></table></figure></li><li><p>å¦‚æœé“¾è¡¨æ’å…¥èŠ‚ç‚¹çš„æ—¶å€™ï¼Œé“¾è¡¨é•¿åº¦å¤§äºç­‰äº8ï¼Œåˆ™éœ€è¦å°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ã€‚treeifyBinæ˜¯ä¸€ä¸ªé“¾è¡¨è½¬æ ‘çš„æ–¹æ³•ï¼Œä½†ä¸æ˜¯æ‰€æœ‰é“¾è¡¨é•¿åº¦å¤§äºç­‰äº8æ—¶éƒ½ä¼šè½¬æˆæ ‘ï¼Œè¿˜éœ€è¦å¯¹å½“å‰æ•°ç»„æ¡¶é•¿åº¦æ˜¯å¦å°äº64åšåˆ¤æ–­ï¼Œå¦‚æœå°äºåˆ™éœ€è¦æ‰©å®¹ï¼Œå¤§äº64åˆ™è¿›è¡Œé“¾è¡¨è½¬æ ‘æ“ä½œã€‚å› ä¸ºå½“æ•°ç»„é•¿åº¦å°äº64æ—¶ï¼Œä½¿ç”¨é“¾è¡¨æ¯”ä½¿ç”¨çº¢é»‘æ ‘æŸ¥è¯¢é€Ÿåº¦æ›´å¿«ã€‚æ•°ç»„é•¿åº¦è¾ƒå°æ—¶åº”è¯¥å°½é‡é¿å¼€çº¢é»‘æ ‘ï¼Œå› ä¸ºçº¢é»‘æ ‘éœ€è¦è¿›è¡Œå·¦æ—‹ã€å³æ—‹ã€å˜è‰²æ“ä½œæ¥ä¿æŒå¹³è¡¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>)</span><br><span class="line">treeifyBin(tab, hash);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (tab == <span class="literal">null</span> || (n = tab.length) &lt; MIN_TREEIFY_CAPACITY)</span><br><span class="line">    resize();</span><br></pre></td></tr></table></figure></li><li><p>åˆ¤æ–­éœ€è¦æ’å…¥çš„é”®å€¼å¯¹æ˜¯å¦å­˜åœ¨HashMapä¸­ï¼Œå¦‚æœå­˜åœ¨æ ¹æ®onlyIfAbsent(é»˜è®¤false)æˆ–è€…å€¼ä¸ºnullï¼Œåˆ™æ›´æ–°å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> e.value;</span><br><span class="line">    <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="literal">null</span>) &#123;</span><br><span class="line">        e.value = value;</span><br><span class="line">        afterNodeAccess(e);</span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æœ€åå…ƒç´ å¤„ç†å®Œæˆä¹‹åï¼Œåˆ¤æ–­å®¹é‡æ˜¯å¦è¶…è¿‡é˜™å€¼ï¼Œå¦‚æœè¶…è¿‡åˆ™è¿›è¡Œæ‰©å®¹æ“ä½œã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if (++size &gt; threshold)</span><br><span class="line">resize();</span><br></pre></td></tr></table></figure></li></ol><p>JDK1.8 HashMapçš„putæ–¹æ³•æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> V <span class="title function_">putVal</span><span class="params">(<span class="type">int</span> hash, K key, V value, <span class="type">boolean</span> onlyIfAbsent, <span class="type">boolean</span> evict)</span> &#123;</span><br><span class="line">    Node&lt;K, V&gt;[] tab; Node&lt;K, V&gt; p; <span class="type">int</span> n, i;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ•°ç»„æ¡¶tabæ˜¯å¦ä¸ºnullæˆ–è€…é•¿åº¦ä¸º0ï¼Œå¦‚æœæ˜¯åˆ™è¿›è¡Œæ‰©å®¹æ“ä½œ</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) == <span class="literal">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="comment">// å¦‚æœæ¡¶ä¸­ä¸åŒ…å«é”®å€¼å¯¹èŠ‚ç‚¹å¼•ç”¨, åˆ™å°†æ–°é”®å€¼å¯¹èŠ‚ç‚¹çš„å¼•ç”¨å­˜å…¥æ¡¶ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="literal">null</span>)</span><br><span class="line">        tab[i] = newNode(hash, key, value, <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        Node&lt;K, V&gt; e; K k;</span><br><span class="line">        <span class="comment">// å¦‚æœé”®å€¼å¯¹é”®çš„å€¼ä»¥åŠèŠ‚ç‚¹hashç­‰äºé“¾è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªé”®å€¼å¯¹èŠ‚ç‚¹æ—¶, åˆ™å°†eæŒ‡å‘è¯¥é”®å€¼å¯¹</span></span><br><span class="line">        <span class="keyword">if</span> (p.hash == hash &amp;&amp; ((k = p.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            e = p;</span><br><span class="line">        <span class="comment">// å¦‚æœæ¡¶ä¸­çš„å¼•ç”¨ç±»å‹ä¸ºTreeNode, åˆ™è°ƒç”¨çº¢é»‘æ ‘æ’å…¥å€¼</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            e = ((TreeNode&lt;K, V&gt;)p).putTreeVal(<span class="built_in">this</span>, tab, hash, key, value);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¯¹é“¾è¡¨è¿›è¡Œéå†, å¹¶ç»Ÿè®¡é“¾è¡¨é•¿åº¦</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">binCount</span> <span class="operator">=</span> <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                <span class="comment">// é“¾è¡¨ä¸­ä¸åŒ…å«è¦æ’å…¥çš„é”®å€¼å¯¹èŠ‚ç‚¹æ—¶, åˆ™å°†è¯¥èŠ‚ç‚¹æ¥åœ¨é“¾è¡¨çš„æœ€å</span></span><br><span class="line">                <span class="keyword">if</span> ((e = p.next) == <span class="literal">null</span>)&#123;</span><br><span class="line">                    p.next = newNode(hash, key, value, <span class="literal">null</span>);</span><br><span class="line">                    <span class="comment">// å¦‚æœé“¾è¡¨é•¿åº¦å¤§äºæˆ–ç­‰äºæ ‘åŒ–é˜™å€¼æ—¶, åˆ™è¿›è¡Œé“¾è¡¨è½¬çº¢é»‘æ ‘æ“ä½œ</span></span><br><span class="line">                    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>)</span><br><span class="line">                        treeifyBin(tab, hash);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å¦‚æœå½“å‰é“¾è¡¨åŒ…å«éœ€è¦æ’å…¥çš„é”®å€¼å¯¹æ—¶, ç»ˆæ­¢éå†</span></span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash </span><br><span class="line">                    &amp;&amp; ((k = e.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                p = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­è¦æ’å…¥çš„é”®å€¼å¯¹æ˜¯å¦å­˜åœ¨HashMapä¸­,</span></span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123; <span class="comment">// existing mapping for key</span></span><br><span class="line">            <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> e.value;</span><br><span class="line">            <span class="comment">// onlyIfAbsent è¡¨ç¤ºæ˜¯å¦ä»…åœ¨ oldValue ä¸º null çš„æƒ…å†µä¸‹æ›´æ–°é”®å€¼å¯¹çš„å€¼</span></span><br><span class="line">            <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="literal">null</span>)</span><br><span class="line">                e.value = value;</span><br><span class="line">            afterNodeAccess(e);</span><br><span class="line">            =<span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ++modCount;</span><br><span class="line">    <span class="comment">// é”®å€¼å¯¹æ•°é‡è¶…è¿‡é˜™å€¼æ—¶, åˆ™è¿›è¡Œæ‰©å®¹æ“ä½œ</span></span><br><span class="line">    <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line">        resize();</span><br><span class="line">    afterNodeInsertion(evict);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="äºŒã€HashMapæ‰©å®¹æœºåˆ¶"><a href="#äºŒã€HashMapæ‰©å®¹æœºåˆ¶" class="headerlink" title="äºŒã€HashMapæ‰©å®¹æœºåˆ¶"></a>äºŒã€HashMapæ‰©å®¹æœºåˆ¶</h3><ol><li>æ‰©å®¹æ—¶è®¡ç®—å‡ºæ–°çš„newCapã€newThrï¼Œè¿™ä¸¤ä¸ªå•è¯æ˜¯Capacityã€Thresholdï¼Œåˆ†åˆ«ä»£è¡¨å®¹é‡ã€é˜™ã€‚</li><li>newCapç”¨äºåˆ›å»ºæ–°çš„æ•°ç»„æ¡¶new Node[new Cap]ã€‚</li><li>éšç€æ‰©å®¹åï¼ŒåŸæ¥é‚£äº›å› ä¸ºhashç¢°æ’ï¼Œå­˜æ”¾æˆé“¾è¡¨å’Œçº¢é»‘æ ‘çš„å…ƒç´ ï¼Œéƒ½éœ€è¦è¿›è¡Œæ‹†åˆ†å­˜æ”¾åˆ°æ–°çš„ä½ç½®ä¸­ã€‚</li></ol><h3 id="ä¸‰ã€é“¾è¡¨æ ‘åŒ–"><a href="#ä¸‰ã€é“¾è¡¨æ ‘åŒ–" class="headerlink" title="ä¸‰ã€é“¾è¡¨æ ‘åŒ–"></a>ä¸‰ã€é“¾è¡¨æ ‘åŒ–</h3><p>HashMapè¿™ç§æ•£åˆ—è¡¨çš„æ•°æ®ç»“æ„ï¼Œæœ€å¤§çš„æ€§èƒ½åœ¨äºå¯ä»¥O(1)æ—¶é—´å¤æ‚åº¦å®šä½åˆ°å…ƒç´ ï¼Œä½†æ˜¯å› ä¸ºå“ˆå¸Œç¢°æ’ä¸å¾—å·²åœ¨ä¸€ä¸ªä¸‹æ ‡é‡Œå­˜æ”¾å¤šç»„æ•°æ®ï¼Œåœ¨jdk1.8ä¹‹å‰çš„è®¾è®¡åªæ˜¯é‡‡ç”¨é“¾è¡¨çš„æ–¹å¼è¿›è¡Œå­˜æ”¾ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(n)ï¼Œé“¾è¡¨è¶Šé•¿æ€§èƒ½è¶Šä½ã€‚æ‰€ä»¥åœ¨jdk1.8æŠŠé“¾è¡¨é•¿åº¦è¶…è¿‡8ä¸ª(åŒ…å«8ä¸ª)çš„é“¾è¡¨è½¬æˆè‡ªå¹³è¡¡çš„çº¢é»‘æ ‘ç»“æ„ï¼Œä»¥æ­¤è®©å®šä½å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(logn)æå‡æŸ¥æ‰¾æ•ˆç‡ã€‚</p><p>é“¾è¡¨æ ‘åŒ–æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">treefyBin</span><span class="params">(Node&lt;K, V&gt;[] tab, <span class="type">int</span> hash)</span> &#123;</span><br><span class="line">    <span class="type">int</span> n, index; Node&lt;K, V&gt; e;</span><br><span class="line">    <span class="comment">// æ•°ç»„å®¹é‡å¤§äº64æ‰è¿›è¡Œé“¾è¡¨æ ‘åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> (tab == <span class="literal">null</span> || (n = tab.length) &lt; MIN_TREEIFY_CAPACITY)</span><br><span class="line">        resize();</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((e = tab[index = (n - <span class="number">1</span>) &amp; hash]) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å¤´éƒ¨ã€å°¾éƒ¨</span></span><br><span class="line">        TreeNode&lt;K, V&gt; hd = <span class="literal">null</span>, tl = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">while</span> ((e = e.next) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å°†æ™®é€šèŠ‚ç‚¹è½¬æ¢ä¸ºæ ‘èŠ‚ç‚¹, æ­¤æ—¶è¿˜ä¸æ˜¯çº¢é»‘æ ‘</span></span><br><span class="line">            TreeNode&lt;K, V&gt; p = replacementTreeNode(e, <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (t1 == <span class="literal">null</span>)</span><br><span class="line">                hd = p;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                p.prev = tl;</span><br><span class="line">                tl.next = p;</span><br><span class="line">            &#125;</span><br><span class="line">            tl = p;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">if</span>((tab[index] == hd) != <span class="literal">null</span>)</span><br><span class="line">            <span class="comment">// è½¬çº¢é»‘æ ‘æ“ä½œ</span></span><br><span class="line">            hd.treeify(tab);</span><br><span class="line">    &#125;     </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>é“¾è¡¨æ ‘åŒ–çš„æ¡ä»¶æœ‰ä¸¤ä¸ªï¼šé“¾è¡¨é•¿åº¦å¤§äºç­‰äº8ã€æ¡¶å®¹é‡å¤§äº64ï¼Œå¦åˆ™åªæ˜¯æ‰©å®¹ï¼Œä¸ä¼šæ ‘åŒ–ã€‚</li><li>é“¾è¡¨æ ‘åŒ–çš„è¿‡ç¨‹ä¸­æ˜¯å…ˆç”±é“¾è¡¨è½¬æˆæ ‘èŠ‚ç‚¹ï¼Œæ­¤æ—¶çš„æ ‘è¿˜ä¸æ˜¯å¹³è¡¡æ ‘ã€‚åŒæ—¶åœ¨æ ‘è½¬æ¢è¿‡ç¨‹ä¸­ä¼šè®°å½•é“¾è¡¨çš„é¡ºåºï¼Œtl.next &#x3D; pï¼Œè¿™ä¸»è¦æ˜¯æ–¹ä¾¿åç»­æ ‘è½¬é“¾è¡¨å’Œæ‹†åˆ†æ›´æ–¹ä¾¿ã€‚</li><li>é“¾è¡¨è½¬æ¢æˆæ ‘å®Œæˆä¹‹åï¼Œå†è¿›è¡Œçº¢é»‘æ ‘çš„è½¬æ¢ã€‚</li></ol><h3 id="å››ã€çº¢é»‘æ ‘è½¬é“¾"><a href="#å››ã€çº¢é»‘æ ‘è½¬é“¾" class="headerlink" title="å››ã€çº¢é»‘æ ‘è½¬é“¾"></a>å››ã€çº¢é»‘æ ‘è½¬é“¾</h3><p>å› ä¸ºåœ¨é“¾è¡¨æ ‘åŒ–çš„æ—¶å€™ï¼Œè®°å½•äº†åŸæœ‰é“¾è¡¨çš„é¡ºåºï¼Œæ‰€ä»¥ç›´æ¥æŠŠTreeNodeè½¬æ¢æˆNodeå³å¯ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K, V&gt; <span class="title function_">untreeify</span><span class="params">(HashMap&lt;K, V&gt; map)</span> &#123;</span><br><span class="line">    Node&lt;K, V&gt; hd = <span class="literal">null</span>, tl = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// éå†TreeNode</span></span><br><span class="line">    <span class="keyword">for</span> (Node&lt;K, V&gt; q = <span class="built_in">this</span>; q != <span class="literal">null</span>; q = q.next) &#123;</span><br><span class="line">        <span class="comment">// TreeNodeè½¬æˆNode</span></span><br><span class="line">        Node&lt;K, V&gt; p = map.replacementNode(q, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (tl = <span class="literal">null</span>)</span><br><span class="line">            hd = p;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            t1.next = p;</span><br><span class="line">        tl = p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Node&lt;K, V&gt; <span class="title function_">replacementNode</span><span class="params">(Node&lt;K, V&gt; p, Node&lt;K, V&gt; next)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K, V&gt;(p.hash, p.key, p.value, next);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="äº”ã€HashMapæŸ¥æ‰¾getæ–¹æ³•"><a href="#äº”ã€HashMapæŸ¥æ‰¾getæ–¹æ³•" class="headerlink" title="äº”ã€HashMapæŸ¥æ‰¾getæ–¹æ³•"></a>äº”ã€HashMapæŸ¥æ‰¾getæ–¹æ³•</h3><p>getæ–¹æ³•æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(Object key)</span>&#123;</span><br><span class="line">    Node&lt;K, V&gt; e;</span><br><span class="line">    <span class="comment">// é€šè¿‡æ‰°åŠ¨å‡½æ•°è®¡ç®—hashå€¼</span></span><br><span class="line">    <span class="keyword">return</span> (e = getNode(hash(key), key)) == <span class="literal">null</span> ? <span class="literal">null</span> : e.value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Node&lt;K, V&gt; <span class="title function_">getNode</span><span class="params">()</span> &#123;</span><br><span class="line">    Node&lt;K, V&gt;[] tab; Node&lt;K, V&gt; first, e; <span class="type">int</span> n; K k;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ¡¶æ•°ç»„ä¸ä¸ºç©º, ä¸”é€šè¿‡hashå€¼è®¡ç®—ä¸‹æ ‡å­˜åœ¨èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="literal">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">       (first = tab[(n - <span class="number">1</span>) &amp; hash]) != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (first.hash == hash &amp;&amp; ((k = first.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            <span class="keyword">return</span> first;</span><br><span class="line">        <span class="keyword">if</span>((e = first.next) != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">// å¦‚æœä¸ºçº¢é»‘æ ‘èŠ‚ç‚¹ è°ƒç”¨çº¢é»‘æ ‘æŸ¥æ‰¾æ–¹æ³•</span></span><br><span class="line">            <span class="keyword">if</span>(first <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                <span class="keyword">return</span> ((TreeNode&lt;K, V&gt; first)).getTreeNode(hash, key);</span><br><span class="line">            <span class="comment">// å¦‚æœæ˜¯é“¾è¡¨èŠ‚ç‚¹éå†æŸ¥æ‰¾</span></span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (e.hash == hash </span><br><span class="line">                   &amp;&amp; ((k = e.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k)))) </span><br><span class="line">                   <span class="keyword">return</span> e;</span><br><span class="line">            &#125; <span class="keyword">while</span>((e = e.next) != <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>é€šè¿‡æ‰°åŠ¨å‡½æ•°è®¡ç®—hashå€¼ã€‚</li><li>é€šè¿‡hashå€¼è®¡ç®—ä¸‹æ ‡ï¼Œå¹¶åˆ¤æ–­æ•°ç»„æ¡¶ä¸ä¸ºç©ºä¸”è¯¥ä¸‹æ ‡å­˜åœ¨èŠ‚ç‚¹ã€‚</li><li>åˆ¤æ–­å­˜åœ¨çš„èŠ‚ç‚¹æ˜¯å¦ä¸ºç¬¬ä¸€ä¸ªèŠ‚ç‚¹ã€‚</li><li>åˆ¤æ–­èŠ‚ç‚¹æ˜¯çº¢é»‘æ ‘èŠ‚ç‚¹è¿˜æ˜¯é“¾è¡¨èŠ‚ç‚¹ï¼Œå†è¿›è¡ŒèŠ‚ç‚¹è·å–ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> æ•°æ®ç»“æ„ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HashMap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>windowså®‰è£…kafka</title>
      <link href="/2022/03/02/windows-install-kafka/"/>
      <url>/2022/03/02/windows-install-kafka/</url>
      
        <content type="html"><![CDATA[<blockquote><p>çƒ­è¡·å­¦ä¹ ï¼Œçƒ­è¡·ç”Ÿæ´»ï¼ğŸ˜„</p><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h5 id="1-å…ˆä¸‹è½½å¹¶å¯åŠ¨zookeeperï¼ˆå¯åŠ¨çª—å£ä¸èƒ½å…³é—­ï¼‰"><a href="#1-å…ˆä¸‹è½½å¹¶å¯åŠ¨zookeeperï¼ˆå¯åŠ¨çª—å£ä¸èƒ½å…³é—­ï¼‰" class="headerlink" title="1. å…ˆä¸‹è½½å¹¶å¯åŠ¨zookeeperï¼ˆå¯åŠ¨çª—å£ä¸èƒ½å…³é—­ï¼‰"></a>1. å…ˆä¸‹è½½å¹¶å¯åŠ¨zookeeperï¼ˆå¯åŠ¨çª—å£ä¸èƒ½å…³é—­ï¼‰</h5><h5 id="2-ä¸‹è½½kafkaï¼šhttp-kafka-apache-org-downloads-html-ï¼ˆæ³¨æ„ä¸‹è½½binaryç‰ˆæœ¬çš„ï¼Œä¸è¦ä¸‹è½½3-0ç‰ˆæœ¬çš„ï¼Œ3-0windowsä¸‹æœ‰é—®é¢˜ï¼Œå¯åŠ¨æŠ¥é”™ï¼Œæ¢æˆ2-8å°±æ²¡é—®é¢˜ï¼‰"><a href="#2-ä¸‹è½½kafkaï¼šhttp-kafka-apache-org-downloads-html-ï¼ˆæ³¨æ„ä¸‹è½½binaryç‰ˆæœ¬çš„ï¼Œä¸è¦ä¸‹è½½3-0ç‰ˆæœ¬çš„ï¼Œ3-0windowsä¸‹æœ‰é—®é¢˜ï¼Œå¯åŠ¨æŠ¥é”™ï¼Œæ¢æˆ2-8å°±æ²¡é—®é¢˜ï¼‰" class="headerlink" title="2. ä¸‹è½½kafkaï¼šhttp://kafka.apache.org/downloads.html ï¼ˆæ³¨æ„ä¸‹è½½binaryç‰ˆæœ¬çš„ï¼Œä¸è¦ä¸‹è½½3.0ç‰ˆæœ¬çš„ï¼Œ3.0windowsä¸‹æœ‰é—®é¢˜ï¼Œå¯åŠ¨æŠ¥é”™ï¼Œæ¢æˆ2.8å°±æ²¡é—®é¢˜ï¼‰"></a>2. ä¸‹è½½kafkaï¼š<a href="http://kafka.apache.org/downloads.html">http://kafka.apache.org/downloads.html</a> ï¼ˆæ³¨æ„ä¸‹è½½binaryç‰ˆæœ¬çš„ï¼Œä¸è¦ä¸‹è½½3.0ç‰ˆæœ¬çš„ï¼Œ3.0windowsä¸‹æœ‰é—®é¢˜ï¼Œå¯åŠ¨æŠ¥é”™ï¼Œæ¢æˆ2.8å°±æ²¡é—®é¢˜ï¼‰</h5><h5 id="3-è§£å‹åˆ°ç›¸åº”æ–‡ä»¶å¤¹ï¼Œè¿›å…¥configç›®å½•ä¸‹ï¼Œæ‰¾åˆ°server-propertiesæ–‡ä»¶ï¼Œå¹¶ä½œä»¥ä¸‹ä¿®æ”¹ï¼š"><a href="#3-è§£å‹åˆ°ç›¸åº”æ–‡ä»¶å¤¹ï¼Œè¿›å…¥configç›®å½•ä¸‹ï¼Œæ‰¾åˆ°server-propertiesæ–‡ä»¶ï¼Œå¹¶ä½œä»¥ä¸‹ä¿®æ”¹ï¼š" class="headerlink" title="3. è§£å‹åˆ°ç›¸åº”æ–‡ä»¶å¤¹ï¼Œè¿›å…¥configç›®å½•ä¸‹ï¼Œæ‰¾åˆ°server.propertiesæ–‡ä»¶ï¼Œå¹¶ä½œä»¥ä¸‹ä¿®æ”¹ï¼š"></a>3. è§£å‹åˆ°ç›¸åº”æ–‡ä»¶å¤¹ï¼Œè¿›å…¥configç›®å½•ä¸‹ï¼Œæ‰¾åˆ°server.propertiesæ–‡ä»¶ï¼Œå¹¶ä½œä»¥ä¸‹ä¿®æ”¹ï¼š</h5><p>ã€€ã€€æ‰¾åˆ°å¹¶ç¼–è¾‘ log.dirs&#x3D;D:\soft\kafka\kafka_2.13-2.8.0\kafka-logs  (kafkaçš„è§£å‹ç›®å½•ï¼Œkafka-logsæ–‡ä»¶å¤¹ä¸ç”¨è‡ªå·±æ–°å»º)</p><p>ã€€ã€€æ‰¾åˆ°å¹¶ç¼–è¾‘zookeeper.connect&#x3D;localhost:2181 ï¼ˆä¸€èˆ¬é»˜è®¤å°±æ˜¯localhost:2181ï¼‰</p><h5 id="4-æ‰“å¼€å‘½ä»¤å‘½ä»¤è¿›åˆ°kafkaç›®å½•ï¼Œè¾“å…¥ä¸‹é¢å‘½ä»¤å¯åŠ¨kakfaï¼ˆçª—å£ä¸èƒ½å…³é—­ï¼‰"><a href="#4-æ‰“å¼€å‘½ä»¤å‘½ä»¤è¿›åˆ°kafkaç›®å½•ï¼Œè¾“å…¥ä¸‹é¢å‘½ä»¤å¯åŠ¨kakfaï¼ˆçª—å£ä¸èƒ½å…³é—­ï¼‰" class="headerlink" title="4. æ‰“å¼€å‘½ä»¤å‘½ä»¤è¿›åˆ°kafkaç›®å½•ï¼Œè¾“å…¥ä¸‹é¢å‘½ä»¤å¯åŠ¨kakfaï¼ˆçª—å£ä¸èƒ½å…³é—­ï¼‰"></a>4. æ‰“å¼€å‘½ä»¤å‘½ä»¤è¿›åˆ°kafkaç›®å½•ï¼Œè¾“å…¥ä¸‹é¢å‘½ä»¤å¯åŠ¨kakfaï¼ˆçª—å£ä¸èƒ½å…³é—­ï¼‰</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\bin\windows\kafka-server-start.bat .\config\server.properties</span><br></pre></td></tr></table></figure><h5 id="5-æµ‹è¯•"><a href="#5-æµ‹è¯•" class="headerlink" title="5. æµ‹è¯•"></a>5. æµ‹è¯•</h5><h6 id="1ï¼‰æ‰“å¼€ä¸€ä¸ªæ–°çš„å‘½ä»¤çª—å£ï¼Œè¾“å…¥ä¸‹é¢å‘½ä»¤åˆ›å»ºä¸»é¢˜ï¼Œæç¤ºCreated-topic-ä¸»é¢˜ååˆ™è¡¨ç¤ºæˆåŠŸ"><a href="#1ï¼‰æ‰“å¼€ä¸€ä¸ªæ–°çš„å‘½ä»¤çª—å£ï¼Œè¾“å…¥ä¸‹é¢å‘½ä»¤åˆ›å»ºä¸»é¢˜ï¼Œæç¤ºCreated-topic-ä¸»é¢˜ååˆ™è¡¨ç¤ºæˆåŠŸ" class="headerlink" title="1ï¼‰æ‰“å¼€ä¸€ä¸ªæ–°çš„å‘½ä»¤çª—å£ï¼Œè¾“å…¥ä¸‹é¢å‘½ä»¤åˆ›å»ºä¸»é¢˜ï¼Œæç¤ºCreated topic ä¸»é¢˜ååˆ™è¡¨ç¤ºæˆåŠŸ"></a>1ï¼‰æ‰“å¼€ä¸€ä¸ªæ–°çš„å‘½ä»¤çª—å£ï¼Œè¾“å…¥ä¸‹é¢å‘½ä»¤åˆ›å»ºä¸»é¢˜ï¼Œæç¤ºCreated topic ä¸»é¢˜ååˆ™è¡¨ç¤ºæˆåŠŸ</h6><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\bin\windows\kafka-topics.bat --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic <span class="built_in">test</span></span><br></pre></td></tr></table></figure><h6 id="2ï¼‰æŸ¥çœ‹å·²ç»åˆ›å»ºçš„ä¸»é¢˜å‘½ä»¤ï¼š"><a href="#2ï¼‰æŸ¥çœ‹å·²ç»åˆ›å»ºçš„ä¸»é¢˜å‘½ä»¤ï¼š" class="headerlink" title="2ï¼‰æŸ¥çœ‹å·²ç»åˆ›å»ºçš„ä¸»é¢˜å‘½ä»¤ï¼š"></a>2ï¼‰æŸ¥çœ‹å·²ç»åˆ›å»ºçš„ä¸»é¢˜å‘½ä»¤ï¼š</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\bin\windows\kafka-topics.bat --list --zookeeper localhost:2181</span><br></pre></td></tr></table></figure><h6 id="3ï¼‰æ‰“å¼€ä¸€ä¸ªæ–°çš„å‘½ä»¤çª—å£ï¼Œåˆ›å»ºç”Ÿäº§è€…ï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œåˆ›å»ºå®Œæ¯•ä¹‹åå¯ä»¥è¾“å…¥-hello-worldæ¶ˆæ¯"><a href="#3ï¼‰æ‰“å¼€ä¸€ä¸ªæ–°çš„å‘½ä»¤çª—å£ï¼Œåˆ›å»ºç”Ÿäº§è€…ï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œåˆ›å»ºå®Œæ¯•ä¹‹åå¯ä»¥è¾“å…¥-hello-worldæ¶ˆæ¯" class="headerlink" title="3ï¼‰æ‰“å¼€ä¸€ä¸ªæ–°çš„å‘½ä»¤çª—å£ï¼Œåˆ›å»ºç”Ÿäº§è€…ï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œåˆ›å»ºå®Œæ¯•ä¹‹åå¯ä»¥è¾“å…¥ hello worldæ¶ˆæ¯"></a>3ï¼‰æ‰“å¼€ä¸€ä¸ªæ–°çš„å‘½ä»¤çª—å£ï¼Œåˆ›å»ºç”Ÿäº§è€…ï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œåˆ›å»ºå®Œæ¯•ä¹‹åå¯ä»¥è¾“å…¥ hello worldæ¶ˆæ¯</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\bin\windows\kafka-console-producer.bat --broker-list localhost:9092 --topic <span class="built_in">test</span></span><br></pre></td></tr></table></figure><h6 id="4ï¼‰æ‰“å¼€ä¸€ä¸ªæ–°çš„å‘½ä»¤çª—å£ï¼Œåˆ›å»ºæ¶ˆè´¹è€…ï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œå¯ä»¥çœ‹åˆ°æ¶ˆè´¹äº†hello-worldæ¶ˆæ¯"><a href="#4ï¼‰æ‰“å¼€ä¸€ä¸ªæ–°çš„å‘½ä»¤çª—å£ï¼Œåˆ›å»ºæ¶ˆè´¹è€…ï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œå¯ä»¥çœ‹åˆ°æ¶ˆè´¹äº†hello-worldæ¶ˆæ¯" class="headerlink" title="4ï¼‰æ‰“å¼€ä¸€ä¸ªæ–°çš„å‘½ä»¤çª—å£ï¼Œåˆ›å»ºæ¶ˆè´¹è€…ï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œå¯ä»¥çœ‹åˆ°æ¶ˆè´¹äº†hello worldæ¶ˆæ¯"></a>4ï¼‰æ‰“å¼€ä¸€ä¸ªæ–°çš„å‘½ä»¤çª—å£ï¼Œåˆ›å»ºæ¶ˆè´¹è€…ï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œå¯ä»¥çœ‹åˆ°æ¶ˆè´¹äº†hello worldæ¶ˆæ¯</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\bin\windows\kafka-console-consumer.bat --bootstrap-server localhost:9092 --topic <span class="built_in">test</span> --from-beginning</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Kafka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kafka </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
